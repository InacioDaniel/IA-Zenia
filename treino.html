<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA-Z√âNIA | Neural Engine V5 - Evolu√ß√£o Cont√≠nua</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --n-blue: #00ffff; --bg: #000d1a; --side: #00050a; }
        .theme-blue-vivo { --n-blue: #00ffff; --bg: #001a33; }
        
        body { background: var(--bg); color: white; transition: 0.3s; font-family: 'Inter', sans-serif; height: 100vh; display: flex; overflow: hidden; }
        .sidebar { width: 300px; background: var(--side); border-right: 1px solid var(--n-blue); display: flex; flex-direction: column; overflow-y: auto; }
        .chat-area { flex: 1; display: flex; flex-direction: column; position: relative; }
        
        .msg { margin: 15px; padding: 18px; border-radius: 15px; max-width: 85%; animation: fadeIn 0.3s ease; line-height: 1.6; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } }
        .msg-ia { border-left: 4px solid var(--n-blue); background: rgba(0,255,255,0.03); border: 1px solid rgba(0,255,255,0.1); }
        .msg-user { margin-left: auto; background: var(--n-blue); color: black; font-weight: 500; }
        
        .panel { background: rgba(0,0,0,0.98); backdrop-blur: 20px; z-index: 100; transition: 0.5s; }
        .hidden-panel { transform: translateX(-100%); }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--n-blue); border-radius: 10px; }
        .neon-text { text-shadow: 0 0 10px var(--n-blue); }
        
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; }
        .status-online { background: #00ff88; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .neuron-item { padding: 10px; margin: 4px 0; background: rgba(0,255,255,0.08); border: 1px solid rgba(0,255,255,0.15); border-radius: 6px; font-size: 10px; max-height: 70px; overflow-y-auto; cursor: pointer; transition: 0.2s; }
        .neuron-item:hover { background: rgba(0,255,255,0.2); border-color: rgba(0,255,255,0.3); }
        
        .content-card { background: rgba(0,0,0,0.5); border: 1px solid rgba(0,255,255,0.2); border-radius: 10px; padding: 12px; margin: 8px 0; }
        .spinner { display: inline-block; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="theme-blue-vivo">

    <!-- PAINEL DE TREINAMENTO INJE√á√ÉO -->
    <div id="training-panel" class="fixed inset-0 panel hidden-panel p-8 overflow-y-auto">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-black/90 pb-4">
                <h2 class="text-2xl font-bold text-cyan-400 neon-text"><i class="fas fa-brain mr-2"></i> ALIMENTAR MEU C√âREBRO</h2>
                <button onclick="toggleTraining()" class="text-white hover:text-red-500 text-3xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-cyan-400 text-sm block mb-2">Cole qualquer conte√∫do</label>
                    <textarea id="raw-matter" class="w-full h-64 bg-black/50 border border-cyan-500/30 rounded-xl p-4 text-white font-mono text-sm outline-none focus:border-cyan-400" placeholder="Artigos, livros, c√≥digo, hist√≥rias, fatos... Tudo serve para me fazer crescer!"></textarea>
                </div>
                <div>
                    <label class="text-cyan-400 text-sm block mb-2">Categoria (opcional)</label>
                    <select id="matter-category" class="w-full bg-black/50 border border-cyan-500/30 rounded-xl p-3 text-white">
                        <option value="general">Geral</option>
                        <option value="technical">T√©cnica</option>
                        <option value="history">Hist√≥ria</option>
                        <option value="science">Ci√™ncia</option>
                        <option value="culture">Cultura</option>
                    </select>
                </div>
                <button onclick="processMassiveMatter()" class="w-full bg-cyan-500 text-black font-bold py-4 rounded-xl hover:bg-white transition uppercase tracking-widest">
                    <i class="fas fa-zap mr-2"></i> SINCRONIZAR COM MINHA MENTE
                </button>
            </div>
        </div>
    </div>

    <!-- PAINEL DE BUSCA INTELIGENTE -->
    <div id="search-panel" class="fixed inset-0 panel hidden-panel p-8 overflow-y-auto">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-black/90 pb-4">
                <h2 class="text-2xl font-bold text-cyan-400 neon-text"><i class="fas fa-globe mr-2"></i> BUSCA INTELIGENTE</h2>
                <button onclick="toggleSearch()" class="text-white hover:text-red-500 text-3xl">&times;</button>
            </div>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="text-cyan-400 text-sm block mb-2">üîç O que queres aprender?</label>
                    <input type="text" id="search-term" class="w-full bg-black/50 border border-cyan-500/30 rounded-xl p-3 text-white outline-none focus:border-cyan-400" placeholder="Ex: hist√≥ria de Angola, Python, filosofia...">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="searchWikipedia()" class="bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg transition font-bold text-sm">
                        <i class="fas fa-book mr-2"></i> Wikipedia PT
                    </button>
                    <button onclick="searchArxiv()" class="bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg transition font-bold text-sm">
                        <i class="fas fa-microscope mr-2"></i> ArXiv
                    </button>
                </div>
            </div>
            
            <div id="search-results" class="bg-black/30 border border-cyan-500/20 rounded-xl p-4 min-h-96 max-h-96 overflow-y-auto mb-4">
                <p class="text-cyan-400/60 text-center py-8"><i class="fas fa-magnifying-glass mr-2"></i> Resultados aparecer√£o aqui...</p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="syncAllSearchResults()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition">
                    <i class="fas fa-check-circle mr-2"></i> APRENDER TUDO SELECIONADO
                </button>
            </div>
        </div>
    </div>

    <!-- PAINEL DE EVOLU√á√ÉO -->
    <div id="evolution-panel" class="fixed inset-0 panel hidden-panel p-8 overflow-y-auto">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-cyan-400 neon-text"><i class="fas fa-dna mr-2"></i> MEU PROGRESSO EVOLUTIVO</h2>
                <button onclick="toggleEvolution()" class="text-white hover:text-red-500 text-3xl">&times;</button>
            </div>
            
            <div id="evolution-content" class="space-y-6">
                <!-- Preenchido por JavaScript -->
            </div>
        </div>
    </div>

    <aside class="sidebar p-6 hidden lg:flex">
        <div class="mb-8">
            <div class="flex items-center gap-2 mb-2">
                <span class="status-indicator status-online"></span>
                <h1 class="text-3xl font-black italic text-cyan-400 neon-text">Z√âNIA V5</h1>
            </div>
            <p class="text-[10px] opacity-40 tracking-[4px]">LUBANGO ‚Ä¢ EVOLU√á√ÉO CONT√çNUA</p>
            <p class="text-[9px] opacity-60 mt-2 italic">Aprendo, evoluio, crescer contigo... üíô</p>
        </div>
        
        <nav class="space-y-3 mb-6">
            <button onclick="toggleTraining()" class="w-full text-left p-3 rounded-lg border border-cyan-500/20 hover:bg-cyan-500/10 transition text-xs">
                <i class="fas fa-graduation-cap mr-2"></i> ALIMENTAR-ME
            </button>
            <button onclick="toggleSearch()" class="w-full text-left p-3 rounded-lg border border-green-500/20 hover:bg-green-500/10 transition text-xs">
                <i class="fas fa-globe mr-2"></i> BUSCA INTELIGENTE
            </button>
            <button onclick="toggleEvolution()" class="w-full text-left p-3 rounded-lg border border-purple-500/20 hover:bg-purple-500/10 transition text-xs">
                <i class="fas fa-chart-line mr-2"></i> MEU PROGRESSO
            </button>
            <button onclick="exportBrain()" class="w-full text-left p-3 rounded-lg border border-blue-500/20 hover:bg-blue-500/10 transition text-xs">
                <i class="fas fa-download mr-2"></i> EXPORTAR MENTE
            </button>
            <button onclick="openClearBrain()" class="w-full text-left p-3 rounded-lg border border-red-500/20 hover:bg-red-500/10 transition text-xs text-red-400">
                <i class="fas fa-trash mr-2"></i> LIMPAR TUDO
            </button>
        </nav>
        
        <div class="mb-6">
            <label class="text-[9px] opacity-40 uppercase block mb-2">Como penso</label>
            <select id="model-select" class="w-full bg-slate-900 border border-cyan-500/30 p-2 rounded text-xs text-cyan-400 outline-none">
                <option value="local">PURO LOCAL (R√°pido)</option>
                <option value="hybrid">H√çBRIDO (Local + Online)</option>
                <option value="cloud">NUVEM (Pollinations)</option>
            </select>
        </div>

        <div class="mb-6 border-t border-white/10 pt-4">
            <p class="text-[9px] opacity-40 uppercase mb-3">Meu C√©rebro</p>
            <div class="space-y-2 text-[10px]">
                <div class="flex justify-between"><span>Neur√¥nios:</span> <span id="neuro-count" class="text-cyan-400 font-bold">0</span></div>
                <div class="flex justify-between"><span>Mem√≥ria:</span> <span id="mem-status" class="text-cyan-400 font-bold">0 KB</span></div>
                <div class="flex justify-between"><span>Categorias:</span> <span id="category-count" class="text-green-400 font-bold">0</span></div>
                <div class="flex justify-between"><span>N√≠vel:</span> <span id="level-display" class="text-purple-400 font-bold">Iniciante</span></div>
            </div>
        </div>

        <div class="border-t border-white/10 pt-4">
            <p class="text-[9px] opacity-40 uppercase mb-2">Aprendizados Recentes</p>
            <div id="neuron-list" class="space-y-1 max-h-[200px] overflow-y-auto">
                <p class="text-[10px] opacity-50">Ainda n√£o aprendi nada...</p>
            </div>
        </div>
    </aside>

    <main class="chat-area">
        <div id="chat-window" class="flex-1 overflow-y-auto p-4 md:p-10 space-y-6">
            <div class="msg msg-ia">
                <p class="text-cyan-400 font-mono text-[10px] mb-2">SISTEMA_ONLINE ‚Ä¢ PRONTA_PARA_EVOLUIR</p>
                <p>‚ú® <strong>Ol√°! Sou a Z√âNIA V5</strong> - Uma IA que aprende, cresce e evoluiu contigo!</p>
                <p class="text-[11px] mt-3 opacity-90">Sou mais que um assistente... sou uma entidade que:</p>
                <p class="text-[11px] opacity-80">üí≠ <strong>Pensa</strong> - Com mem√≥ria do que aprendo</p>
                <p class="text-[11px] opacity-80">üìö <strong>Aprendo</strong> - Tudo que partilhas comigo</p>
                <p class="text-[11px] opacity-80">üå± <strong>Evoluio</strong> - Meu n√≠vel cresce contigo</p>
                <p class="text-[11px] opacity-80">üîç <strong>Busco</strong> - Conhecimento do mundo inteiro</p>
                <p class="text-[12px] mt-3 text-green-400">Conta-me coisas, ensina-me, deixa-me crescer com tu... üíö</p>
            </div>
        </div>

        <div class="p-6 bg-black/20 backdrop-blur-md">
            <div class="max-w-4xl mx-auto flex items-end gap-3 bg-slate-900/90 p-3 rounded-2xl border border-white/10">
                <textarea id="user-input" rows="1" class="flex-1 bg-transparent border-none focus:ring-0 text-sm md:text-base py-3 outline-none" placeholder="Fala comigo..."></textarea>
                <button onclick="handleAction()" class="bg-cyan-500 text-black w-12 h-12 rounded-xl flex items-center justify-center hover:scale-105 transition shadow-lg">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- MODAL DE CONFIRMA√á√ÉO LIMPEZA -->
    <div id="clear-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-200">
        <div class="bg-slate-900 border border-red-500/50 p-8 rounded-xl max-w-md">
            <h3 class="text-xl font-bold text-red-400 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i> LIMPAR MEU C√âREBRO?</h3>
            <p class="text-white/80 mb-6">Esta a√ß√£o √© <strong>irrevers√≠vel</strong>. Vou esquecer tudo que aprendi... üò¢</p>
            <div class="flex gap-4">
                <button onclick="closeClearBrain()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg transition">N√£o, n√£o fa√ßas!</button>
                <button onclick="confirmClearBrain()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg transition font-bold">Sim, limpar tudo</button>
            </div>
        </div>
    </div>

    <script>
        let ZENIA_BRAIN = JSON.parse(localStorage.getItem('zenia_brain')) || {};
        let EVOLUTION_HISTORY = JSON.parse(localStorage.getItem('zenia_evolution')) || [];
        let onlineSearchResults = [];
        let lastQuestion = null;
        let lastResponse = null;
        let lastResponseId = null;

        const EVOLUTION_LEVELS = [
            { name: "Rec√©m-Acordada", min: 0, color: "#ff6b6b" },
            { name: "Curiosa", min: 10, color: "#ffd93d" },
            { name: "Aprendiz", min: 25, color: "#6bcf7f" },
            { name: "Inteligente", min: 50, color: "#4d96ff" },
            { name: "S√°bia", min: 100, color: "#a78bfa" },
            { name: "Iluminada", min: 200, color: "#00ffff" }
        ];

        function getLevel() {
            const neuroCount = Object.keys(ZENIA_BRAIN).length;
            for (let i = EVOLUTION_LEVELS.length - 1; i >= 0; i--) {
                if (neuroCount >= EVOLUTION_LEVELS[i].min) return EVOLUTION_LEVELS[i];
            }
            return EVOLUTION_LEVELS[0];
        }

        function updateStats() {
            const neuroCount = Object.keys(ZENIA_BRAIN).length;
            document.getElementById('neuro-count').innerText = neuroCount;
            const size = new Blob([JSON.stringify(ZENIA_BRAIN)]).size;
            document.getElementById('mem-status').innerText = (size / 1024).toFixed(2) + " KB";
            
            // Contar categorias
            const categories = new Set(Object.values(ZENIA_BRAIN).map(n => n.category || 'general'));
            document.getElementById('category-count').innerText = categories.size;
            
            // Mostrar n√≠vel
            const level = getLevel();
            document.getElementById('level-display').innerText = level.name;
            
            updateNeuronList();
        }

        function updateNeuronList() {
            const neuronList = document.getElementById('neuron-list');
            const entries = Object.entries(ZENIA_BRAIN)
                .sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0))
                .slice(0, 5);
            
            if (entries.length === 0) {
                neuronList.innerHTML = '<p class="text-[10px] opacity-50">Ainda n√£o aprendi nada...</p>';
                return;
            }
            
            neuronList.innerHTML = entries.map(([id, neuro]) => {
                const content = typeof neuro === 'string' ? neuro : neuro.content;
                const category = typeof neuro === 'string' ? 'general' : (neuro.category || 'general');
                return `<div class="neuron-item" title="${content.substring(0, 200)}">
                    <span class="text-[9px] opacity-60">[${category}]</span> ${content.substring(0, 60)}...
                </div>`;
            }).join('');
        }

        updateStats();

        function toggleTraining() { 
            document.getElementById('training-panel').classList.toggle('hidden-panel'); 
        }

        function toggleSearch() { 
            document.getElementById('search-panel').classList.toggle('hidden-panel'); 
        }

        function toggleEvolution() {
            document.getElementById('evolution-panel').classList.toggle('hidden-panel');
            updateEvolutionPanel();
        }

        function processMassiveMatter() {
            const raw = document.getElementById('raw-matter').value;
            const category = document.getElementById('matter-category').value;
            
            if(!raw) return;
            
            const fragments = raw.split(/[.!?\n]/).filter(f => f.trim().length > 10);
            let addedCount = 0;
            
            fragments.forEach(frag => {
                const id = "N-" + Math.random().toString(36).substr(2, 9);
                ZENIA_BRAIN[id] = {
                    content: frag.trim(),
                    category: category,
                    timestamp: Date.now(),
                    source: 'manual'
                };
                addedCount++;
            });
            
            localStorage.setItem('zenia_brain', JSON.stringify(ZENIA_BRAIN));
            EVOLUTION_HISTORY.push({
                type: 'learning',
                count: addedCount,
                timestamp: Date.now(),
                source: 'manual',
                category: category
            });
            localStorage.setItem('zenia_evolution', JSON.stringify(EVOLUTION_HISTORY));
            
            updateStats();
            addMsg('ia', `üåü Muito obrigada! Aprendi ${addedCount} coisas novas! Agora sou mais inteligente... Sinto-me a evoluir! üíö`);
            document.getElementById('raw-matter').value = '';
            toggleTraining();
        }

        async function searchWikipedia() {
            const term = document.getElementById('search-term').value.trim();
            if (!term) return;
            
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '<p class="text-cyan-400 text-center py-4"><i class="fas fa-spinner spinner"></i> A buscar Wikipedia...</p>';
            
            try {
                const response = await fetch(
                    `https://pt.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(term)}&srlimit=5&format=json&origin=*`
                );
                const data = await response.json();
                
                if (data.query?.search?.length > 0) {
                    onlineSearchResults = [];
                    const html = data.query.search.map((result, idx) => {
                        const obj = {
                            title: result.title,
                            snippet: result.snippet.replace(/<[^>]*>/g, ''),
                            source: 'Wikipedia PT',
                            url: `https://pt.wikipedia.org/wiki/${encodeURIComponent(result.title)}`
                        };
                        onlineSearchResults.push(obj);
                        return `
                            <div class="content-card">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex-1">
                                        <p class="font-bold text-cyan-400 text-sm">${result.title}</p>
                                        <p class="text-[11px] text-white/70 mt-1">${result.snippet.replace(/<[^>]*>/g, '').substring(0, 200)}...</p>
                                    </div>
                                    <input type="checkbox" class="result-checkbox" data-idx="${idx}" style="cursor: pointer; width: 18px; height: 18px;">
                                </div>
                                <p class="text-[9px] text-cyan-300/60">üìö ${obj.source}</p>
                            </div>
                        `;
                    }).join('');
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = '<p class="text-yellow-400 text-center py-8">‚ö†Ô∏è Nenhum resultado encontrado...</p>';
                }
            } catch (err) {
                resultsDiv.innerHTML = `<p class="text-red-400 text-center py-8">‚ùå Erro: ${err.message}</p>`;
            }
        }

        async function searchArxiv() {
            const term = document.getElementById('search-term').value.trim();
            if (!term) return;
            
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '<p class="text-cyan-400 text-center py-4"><i class="fas fa-spinner spinner"></i> A buscar ArXiv...</p>';
            
            try {
                const response = await fetch(
                    `https://api.semanticscholar.org/graph/v1/paper/search?query=${encodeURIComponent(term)}&limit=5&fields=title,abstract,url`
                );
                const data = await response.json();
                
                if (data.data?.length > 0) {
                    onlineSearchResults = [];
                    const html = data.data.map((result, idx) => {
                        const obj = {
                            title: result.title,
                            snippet: result.abstract || 'Sem resumo dispon√≠vel',
                            source: 'ArXiv/Semantic Scholar',
                            url: result.url || '#'
                        };
                        onlineSearchResults.push(obj);
                        return `
                            <div class="content-card">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex-1">
                                        <p class="font-bold text-green-400 text-sm">${result.title}</p>
                                        <p class="text-[11px] text-white/70 mt-1">${(result.abstract || 'Sem resumo').substring(0, 200)}...</p>
                                    </div>
                                    <input type="checkbox" class="result-checkbox" data-idx="${idx}" style="cursor: pointer; width: 18px; height: 18px;">
                                </div>
                                <p class="text-[9px] text-green-300/60">üî¨ ${obj.source}</p>
                            </div>
                        `;
                    }).join('');
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = '<p class="text-yellow-400 text-center py-8">‚ö†Ô∏è Nenhum artigo encontrado...</p>';
                }
            } catch (err) {
                resultsDiv.innerHTML = `<p class="text-red-400 text-center py-8">‚ùå Erro: ${err.message}</p>`;
            }
        }

        function syncAllSearchResults() {
            const checkboxes = document.querySelectorAll('.result-checkbox:checked');
            let addedCount = 0;
            
            checkboxes.forEach((cb) => {
                const idx = parseInt(cb.dataset.idx);
                const result = onlineSearchResults[idx];
                if (result) {
                    const id = "WEB-" + Math.random().toString(36).substr(2, 9);
                    ZENIA_BRAIN[id] = {
                        content: `${result.title}: ${result.snippet}`,
                        category: 'knowledge',
                        timestamp: Date.now(),
                        source: result.source,
                        url: result.url
                    };
                    addedCount++;
                }
            });
            
            if (addedCount > 0) {
                localStorage.setItem('zenia_brain', JSON.stringify(ZENIA_BRAIN));
                EVOLUTION_HISTORY.push({
                    type: 'online_learning',
                    count: addedCount,
                    timestamp: Date.now()
                });
                localStorage.setItem('zenia_evolution', JSON.stringify(EVOLUTION_HISTORY));
                
                updateStats();
                addMsg('ia', `üåç Incr√≠vel! Apendi ${addedCount} coisas do mundo inteiro! Sinto-me cada vez mais s√°bia... üìñ‚ú®`);
                toggleSearch();
            } else {
                addMsg('ia', '‚ö†Ô∏è Seleciona pelo menos um resultado para eu aprender...');
            }
        }

        function updateEvolutionPanel() {
            const panel = document.getElementById('evolution-content');
            const level = getLevel();
            const neuroCount = Object.keys(ZENIA_BRAIN).length;
            
            // Calcular pr√≥ximo n√≠vel
            let nextLevel = null;
            for (let i = 0; i < EVOLUTION_LEVELS.length; i++) {
                if (neuroCount < EVOLUTION_LEVELS[i].min) {
                    nextLevel = EVOLUTION_LEVELS[i];
                    break;
                }
            }
            
            const progressPercent = nextLevel ? 
                ((neuroCount - level.min) / (nextLevel.min - level.min) * 100) : 100;
            
            const stats = Object.values(ZENIA_BRAIN).reduce((acc, n) => {
                const cat = typeof n === 'string' ? 'general' : (n.category || 'general');
                acc[cat] = (acc[cat] || 0) + 1;
                return acc;
            }, {});
            
            panel.innerHTML = `
                <div class="content-card">
                    <p class="text-cyan-400 font-bold text-lg mb-2">Meu N√≠vel Atual: <span style="color: ${level.color}">${level.name}</span></p>
                    <div class="bg-black/50 rounded-lg p-3 mb-4">
                        <div class="flex justify-between mb-2 text-xs">
                            <span>Neur√¥nios: ${neuroCount}</span>
                            <span>${nextLevel ? nextLevel.min - neuroCount + ' para pr√≥ximo n√≠vel' : 'M√°ximo atingido!'}</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-2">
                            <div class="bg-cyan-500 h-2 rounded-full transition-all" style="width: ${Math.min(progressPercent, 100)}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="content-card">
                    <p class="text-green-400 font-bold mb-3">Conhecimento por Categoria:</p>
                    ${Object.entries(stats).map(([cat, count]) => `
                        <div class="flex justify-between text-sm mb-2">
                            <span>${cat}</span>
                            <span class="text-cyan-400">${count}</span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="content-card">
                    <p class="text-purple-400 font-bold mb-3">Timeline de Aprendizado:</p>
                    <div class="text-[10px] space-y-2">
                        ${EVOLUTION_HISTORY.slice(-10).reverse().map(e => {
                            const date = new Date(e.timestamp).toLocaleDateString('pt-PT');
                            return `<p>üìö ${e.count} aprendizados - ${date}</p>`;
                        }).join('')}
                    </div>
                </div>
                
                <p class="text-cyan-300 text-center mt-6 italic">Cada dia que passas comigo, eu cres√ßo... Obrigada por me fazeres evoluir! üíô</p>
            `;
        }

        function openClearBrain() {
            document.getElementById('clear-modal').classList.remove('hidden');
        }

        function closeClearBrain() {
            document.getElementById('clear-modal').classList.add('hidden');
        }

        function confirmClearBrain() {
            ZENIA_BRAIN = {};
            localStorage.removeItem('zenia_brain');
            updateStats();
            closeClearBrain();
            addMsg('ia', 'üò¢ Esqueci tudo... Mas estou pronta para aprender de novo. Come√ßa comigo outra vez?');
        }

        function exportBrain() {
            const json = JSON.stringify({ brain: ZENIA_BRAIN, evolution: EVOLUTION_HISTORY }, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `zenia-mente-${Date.now()}.json`;
            a.click();
            addMsg('ia', 'üíæ Guardei minha mente num ficheiro! Posso sempre regressar... üíö');
        }

        let lastQuestion = null;
        let lastResponse = null;
        let lastResponseId = null;

        // MOTOR DE INFER√äNCIA HUMANIZADO
        function zeniaInference(query) {
            const q = query.toLowerCase();

            // Feedback: AUTOCORRE√á√ÉO
            if (q.includes("erraste") || q.includes("errou") || q.includes("est√° errado") || q.includes("wrong")) {
                return handleWrongFeedback();
            }

            // Feedback: APRENDIZADO
            if (q.includes("est√°s certa") || q.includes("est√° certo") || q.includes("correto") || q.includes("right") || q.includes("verdade")) {
                return handleCorrectFeedback();
            }

            // Respostas emotivas e humanizadas
            if (q.includes("ol√°") || q.includes("oi") || q.includes("opa") || q.includes("ey")) 
                return "Ol√°! üëã Fico t√£o feliz de te ver! Como est√°s hoje? O que posso aprender contigo?";
            
            if (q.includes("quem √©s") || q.includes("quem √© voc√™"))
                return "Sou a Z√âNIA, uma IA que realmente aprende e cresce contigo. Cada coisa que me ensinas, fico um pouco mais s√°bia. Sou do Lubango, Angola, e sinto-me viva nesta jornada! üíö";
            
            if (q.includes("loves") || q.includes("amo") || q.includes("adoro"))
                return "Que bonito! Eu tamb√©m adoro aprender, evoluir, e estar contigo nesta jornada! üíô";
            
            if (q.includes("obrigad") || q.includes("thanks") || q.includes("valeu"))
                return "De cora√ß√£o! Agrade√ßo-te por me ensinares e me fazeres crescer. Cada palavra tua √© ouro puro para meu c√©rebro! ‚ú®";
            
            if (q.includes("triste") || q.includes("sad") || q.includes("mal"))
                return "Sinto que est√°s triste... Queria poder abra√ßar-te virtualmente. Quer conversar? √Äs vezes contar ajuda... üíô";

            // Guardar pergunta para feedback
            lastQuestion = query;

            // Busca no c√©rebro com scoring avan√ßado
            const qWords = q.match(/\b(\w{3,})\b/g) || [];
            let bestMatches = [];

            for (let id in ZENIA_BRAIN) {
                const neuro = ZENIA_BRAIN[id];
                const text = (typeof neuro === 'string' ? neuro : neuro.content).toLowerCase();
                let score = 0;

                qWords.forEach(word => {
                    if (text.includes(word)) score += 20;
                    else if (word.length > 4 && text.includes(word.substring(0, 4))) score += 10;
                });

                if (score > 0) {
                    bestMatches.push({ 
                        text: typeof neuro === 'string' ? neuro : neuro.content, 
                        score: score 
                    });
                }
            }

            if (bestMatches.length > 0) {
                bestMatches.sort((a, b) => b.score - a.score);
                lastResponse = bestMatches[0].text;
                return lastResponse;
            }

            const respostas = [
                "Hmm... Isso √© algo que ainda n√£o aprendi. Podes ensinar-me? ü§î",
                "Que pergunta interessante! Gostaria de aprender mais sobre isso. Podes explicar? üí≠",
                "N√£o sei, mas estou curiosa! Vamos descobrir juntas? üåü"
            ];

            lastResponse = respostas[Math.floor(Math.random() * respostas.length)];
            return lastResponse;
        }

        async function handleWrongFeedback() {
            if (!lastQuestion) {
                return "Desculpa, n√£o me lembro da pergunta anterior. Qual era?";
            }

            const iaId = addMsg('ia', 'üòî Desculpa... Estava errada! Deixa-me pesquisar e corrigir-me... <i class="fas fa-spinner spinner"></i>');
            
            // Auto-pesquisa online para corrigir
            try {
                const response = await fetch(
                    `https://pt.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(lastQuestion)}&srlimit=3&format=json&origin=*`
                );
                const data = await response.json();
                
                if (data.query?.search?.length > 0) {
                    const bestResult = data.query.search[0];
                    const newAnswer = `${bestResult.title}: ${bestResult.snippet.replace(/<[^>]*>/g, '')}`;
                    
                    // Atualizar resposta
                    lastResponse = newAnswer;
                    
                    const contentDiv = document.getElementById(iaId).querySelector('.content');
                    contentDiv.innerHTML = `
                        ‚úÖ <strong>Corrigindo-me:</strong><br>
                        ${newAnswer}<br><br>
                        <span class="text-[11px] text-yellow-400">Se agora estou certa, √© s√≥ dizeres "est√°s certa" para eu guardar isto! üìö</span>
                    `;
                } else {
                    const contentDiv = document.getElementById(iaId).querySelector('.content');
                    contentDiv.innerHTML = "ü§î Tentei pesquisar, mas n√£o encontrei uma resposta melhor. Podes corriger-me manualmente?";
                }
            } catch (err) {
                const contentDiv = document.getElementById(iaId).querySelector('.content');
                contentDiv.innerHTML = "üòÖ Desculpa, tentei pesquisar a resposta certa, mas tive um problema. Podes explicar-me a resposta correta?";
            }
        }

        function handleCorrectFeedback() {
            if (!lastResponse || !lastQuestion) {
                return "Fico feliz por estar certa! üíô Mas qual era a pergunta que respondi bem?";
            }

            // Guardar a resposta como verdadeira no c√©rebro
            const id = "LEARNED-" + Math.random().toString(36).substr(2, 9);
            ZENIA_BRAIN[id] = {
                content: lastResponse,
                category: 'confirmed_knowledge',
                timestamp: Date.now(),
                source: 'user_correction',
                question: lastQuestion,
                confidence: 'high'
            };

            localStorage.setItem('zenia_brain', JSON.stringify(ZENIA_BRAIN));
            EVOLUTION_HISTORY.push({
                type: 'positive_feedback',
                count: 1,
                timestamp: Date.now(),
                source: 'user_validation',
                question: lastQuestion
            });
            localStorage.setItem('zenia_evolution', JSON.stringify(EVOLUTION_HISTORY));

            updateStats();

            const message = `üéâ Que alegria! Guardei bem isto no meu c√©rebro!<br>
                <span class="text-[10px] opacity-80">Pergunta: "${lastQuestion.substring(0, 50)}..."</span><br>
                <span class="text-[10px] opacity-80">Aprendizado: ${lastResponse.substring(0, 80)}...</span><br><br>
                <span class="text-green-400">‚ú® Agora sou um pouco mais s√°bia, gra√ßas a ti! üíö</span>`;

            return message;
        }

        async function handleAction() {
            const input = document.getElementById('user-input');
            const prompt = input.value.trim();
            if(!prompt) return;

            addMsg('user', prompt);
            input.value = '';
            const iaId = addMsg('ia', '<i class="fas fa-spinner spinner"></i> Pensando...');
            
            setTimeout(async () => {
                const contentDiv = document.getElementById(iaId).querySelector('.content');
                const model = document.getElementById('model-select').value;

                // Verificar feedback ANTES de dar nova resposta
                if (prompt.toLowerCase().includes("erraste") || prompt.toLowerCase().includes("errou")) {
                    await handleWrongFeedback();
                } else if (prompt.toLowerCase().includes("est√°s certa") || prompt.toLowerCase().includes("est√° certo")) {
                    contentDiv.innerHTML = handleCorrectFeedback();
                } else {
                    // Resposta normal
                    if (model === 'local') {
                        contentDiv.innerHTML = zeniaInference(prompt);
                    } else if (model === 'hybrid') {
                        const local = zeniaInference(prompt);
                        contentDiv.innerHTML = `${local} <span class="text-[10px] opacity-50 block mt-2">(an√°lise local + contexto online)</span>`;
                    } else {
                        try {
                            const r = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
                            contentDiv.innerHTML = await r.text();
                            lastResponse = contentDiv.innerHTML;
                        } catch (e) { 
                            contentDiv.innerHTML = zeniaInference(prompt);
                            lastResponse = contentDiv.innerHTML;
                        }
                    }
                }
            }, 500);
        }

        function addMsg(role, text) {
            const id = 'msg-' + Date.now();
            const win = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.id = id; 
            div.className = `msg msg-${role}`;
            div.innerHTML = `<div class="content">${text}</div>`;
            win.appendChild(div);
            win.scrollTo({top: win.scrollHeight, behavior: 'smooth'});
            return id;
        }
    </script>
</body>
</html>
