<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>IA-Zenia v3</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&family=Sora:wght@300;400;600;700;800&family=Orbitron:wght@400;700;900&family=Nunito:wght@400;600;700;800&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;600&family=DM+Sans:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700;800&family=Lexend:wght@300;400;500;600;700&family=Figtree:wght@300;400;500;600;700&display=swap" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<style>
:root{
  --bg-primary:#0b0d11;--bg-secondary:#111318;--bg-tertiary:#151b2d;--bg-input:#151c2e;
  --border-color:#1e2330;--border-accent:#252c3b;--text-primary:#e5e7eb;--text-secondary:#9ca3af;
  --text-muted:#6b7280;--accent-primary:#3b5bdb;--accent-secondary:#7c3aed;--accent-glow:rgba(59,91,219,0.25);
  --msg-ai-bg:transparent;--msg-user-bg:#1d3461;--msg-user-text:#e8f0fe;
  --sidebar-bg:#0f1117;--topbar-bg:#0b0d11;--send-btn:#3b5bdb;--send-btn-hover:#4c6ef5;--user-av:#1e3a5f;
  --font-ui:'Plus Jakarta Sans','Outfit',system-ui,sans-serif;--font-msg:'DM Sans','Plus Jakarta Sans',sans-serif;
  --font-code:'JetBrains Mono',monospace;--radius-main:14px;--shadow-main:0 4px 24px rgba(0,0,0,0.4);
}
[data-theme="cyberpunk"]{--bg-primary:#0a0010;--bg-secondary:#0d0018;--bg-tertiary:#110022;--bg-input:#0f0020;--border-color:#2a0050;--border-accent:#3d0070;--text-primary:#f0e6ff;--text-secondary:#b892ff;--text-muted:#7c52cc;--accent-primary:#bf00ff;--accent-secondary:#00f5ff;--accent-glow:rgba(191,0,255,0.25);--msg-user-bg:#1a003a;--msg-user-text:#e8d5ff;--sidebar-bg:#0d0018;--topbar-bg:#080012;--send-btn:#bf00ff;--send-btn-hover:#d333ff;--user-av:#330066;--font-ui:'Orbitron','Space Mono',monospace;--font-msg:'Space Mono',monospace;--radius-main:4px;}
[data-theme="aurora"]{--bg-primary:#020f0a;--bg-secondary:#041a10;--bg-tertiary:#062018;--bg-input:#052818;--border-color:#0d3d20;--border-accent:#155230;--text-primary:#d1fae5;--text-secondary:#6ee7b7;--text-muted:#34d399;--accent-primary:#10b981;--accent-secondary:#06b6d4;--accent-glow:rgba(16,185,129,0.25);--msg-user-bg:#063d20;--msg-user-text:#d1fae5;--sidebar-bg:#041a10;--topbar-bg:#020f0a;--send-btn:#10b981;--send-btn-hover:#34d399;--user-av:#064e2a;--font-ui:'Nunito',system-ui,sans-serif;--font-msg:'Nunito',sans-serif;--radius-main:18px;}
[data-theme="solar"]{--bg-primary:#faf8f4;--bg-secondary:#f3f0e8;--bg-tertiary:#ece8dc;--bg-input:#ede9de;--border-color:#d8d0bc;--border-accent:#c5baa8;--text-primary:#2c2416;--text-secondary:#5a4e38;--text-muted:#8a7a60;--accent-primary:#c4862a;--accent-secondary:#d44a00;--accent-glow:rgba(196,134,42,0.15);--msg-user-bg:#c4862a;--msg-user-text:#fff8ee;--sidebar-bg:#f3f0e8;--topbar-bg:#faf8f4;--send-btn:#c4862a;--send-btn-hover:#d4922a;--user-av:#7a4a10;--font-ui:'Playfair Display',serif;--font-msg:'DM Sans',sans-serif;--radius-main:10px;}
[data-theme="bloodmoon"]{--bg-primary:#0d0505;--bg-secondary:#140808;--bg-tertiary:#1a0a0a;--bg-input:#180808;--border-color:#3a0f0f;--border-accent:#4d1515;--text-primary:#ffe4e4;--text-secondary:#f87171;--text-muted:#dc2626;--accent-primary:#ef4444;--accent-secondary:#f97316;--accent-glow:rgba(239,68,68,0.25);--msg-user-bg:#3a1010;--msg-user-text:#ffe4e4;--sidebar-bg:#140808;--topbar-bg:#0d0505;--send-btn:#ef4444;--send-btn-hover:#f87171;--user-av:#4d1515;--font-ui:'Space Mono',monospace;--font-msg:'Space Mono',monospace;--radius-main:6px;}
[data-theme="ocean"]{--bg-primary:#010d1a;--bg-secondary:#021525;--bg-tertiary:#032030;--bg-input:#03223a;--border-color:#0a3a5a;--border-accent:#0d4e78;--text-primary:#caf0f8;--text-secondary:#90e0ef;--text-muted:#48cae4;--accent-primary:#0096c7;--accent-secondary:#023e8a;--accent-glow:rgba(0,150,199,0.25);--msg-user-bg:#023e8a;--msg-user-text:#caf0f8;--sidebar-bg:#021525;--topbar-bg:#010d1a;--send-btn:#0096c7;--send-btn-hover:#00b4d8;--user-av:#03045e;--font-ui:'Outfit',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:16px;}
[data-theme="violet"]{--bg-primary:#0d0a1a;--bg-secondary:#130f25;--bg-tertiary:#1a1430;--bg-input:#161128;--border-color:#2d2550;--border-accent:#3d3366;--text-primary:#ede8ff;--text-secondary:#b8aaff;--text-muted:#8070cc;--accent-primary:#8b5cf6;--accent-secondary:#ec4899;--accent-glow:rgba(139,92,246,0.25);--msg-user-bg:#2d1a5a;--msg-user-text:#ede8ff;--sidebar-bg:#130f25;--topbar-bg:#0d0a1a;--send-btn:#8b5cf6;--send-btn-hover:#a78bfa;--user-av:#2d1a5a;--font-ui:'Outfit',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:16px;}
[data-theme="forest"]{--bg-primary:#0a110a;--bg-secondary:#0f180f;--bg-tertiary:#152015;--bg-input:#121a12;--border-color:#203520;--border-accent:#2d4a2d;--text-primary:#d4edda;--text-secondary:#81c784;--text-muted:#4caf50;--accent-primary:#66bb6a;--accent-secondary:#26a69a;--accent-glow:rgba(102,187,106,0.2);--msg-user-bg:#1b3a1b;--msg-user-text:#d4edda;--sidebar-bg:#0f180f;--topbar-bg:#0a110a;--send-btn:#66bb6a;--send-btn-hover:#81c784;--user-av:#1b3a1b;--font-ui:'DM Sans',sans-serif;--font-msg:'Outfit',sans-serif;--radius-main:14px;}
[data-theme="rose"]{--bg-primary:#0f050a;--bg-secondary:#1a0810;--bg-tertiary:#240c18;--bg-input:#1e0a14;--border-color:#3d1028;--border-accent:#561638;--text-primary:#ffd6e8;--text-secondary:#ff85b0;--text-muted:#cc4478;--accent-primary:#ff3377;--accent-secondary:#ff8c42;--accent-glow:rgba(255,51,119,0.25);--msg-user-bg:#3d1030;--msg-user-text:#ffd6e8;--sidebar-bg:#1a0810;--topbar-bg:#0f050a;--send-btn:#ff3377;--send-btn-hover:#ff5590;--user-av:#4d1040;--font-ui:'Sora',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:18px;}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:var(--bg-primary);color:var(--text-primary);font-family:var(--font-ui);font-size:14px;transition:background .4s,color .4s}
#app{display:flex;height:100vh;width:100%;overflow:hidden}
#sidebar{width:255px;min-width:255px;background:var(--sidebar-bg);border-right:1px solid var(--border-color);display:flex;flex-direction:column;height:100vh;transition:all .3s;overflow:hidden;z-index:100;position:relative;flex-shrink:0}
#sidebar.collapsed{width:0;min-width:0;border:none}
#sidebar-inner{width:255px;min-width:255px;display:flex;flex-direction:column;height:100%}
#sidebar-scroll{flex:1;overflow-y:auto}
#sidebar-scroll::-webkit-scrollbar{width:3px}
#sidebar-scroll::-webkit-scrollbar-thumb{background:var(--border-accent);border-radius:4px}
.sb-section{border-bottom:1px solid var(--border-color)}
.sb-section-hdr{width:100%;display:flex;align-items:center;justify-content:space-between;padding:7px 13px;background:transparent;border:none;cursor:pointer;color:var(--text-muted);font-family:var(--font-ui);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;transition:background .15s}
.sb-section-hdr:hover{background:var(--bg-secondary);color:var(--text-primary)}
.sb-section-body{overflow:hidden;transition:max-height .28s ease,opacity .2s;max-height:600px;opacity:1;padding:3px 0 6px}
.sb-section-body.collapsed{max-height:0!important;opacity:0;padding:0;pointer-events:none}
.sb-chev{transition:transform .25s}
.sb-chev.rotated{transform:rotate(-90deg)}
.sb-item{width:100%;display:flex;align-items:center;gap:7px;padding:5px 13px;background:transparent;border:none;cursor:pointer;color:var(--text-secondary);font-size:12px;text-align:left;font-family:var(--font-ui);transition:background .15s,color .15s;text-decoration:none}
.sb-item:hover{background:var(--bg-secondary);color:var(--text-primary)}
#sidebar-toggle{position:absolute;top:50%;right:-17px;transform:translateY(-50%);background:var(--bg-secondary);border:1px solid var(--border-color);width:17px;height:44px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:101;border-radius:0 7px 7px 0;color:var(--text-muted);transition:background .2s;flex-shrink:0}
#sidebar-toggle:hover{background:var(--border-accent);color:var(--text-primary)}
#mob-toggle{display:none;position:fixed;top:10px;left:10px;z-index:300;background:var(--bg-secondary);border:1px solid var(--border-color);width:36px;height:36px;border-radius:9px;align-items:center;justify-content:center;cursor:pointer;color:var(--text-secondary)}
#mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:190}
#main{flex:1;display:flex;flex-direction:column;min-width:0;height:100vh;overflow:hidden}
#topbar{height:50px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;padding:0 14px;gap:8px;flex-shrink:0;background:var(--topbar-bg)}
.tbLeft{display:flex;align-items:center;gap:7px;flex-wrap:nowrap;min-width:0;overflow:hidden}
.tbRight{display:flex;align-items:center;gap:7px;flex-shrink:0}
#chat-window{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:4px}
#chat-window::-webkit-scrollbar{width:4px}
#chat-window::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:4px}
#input-area{border-top:1px solid var(--border-color);padding:9px 12px;background:var(--topbar-bg);flex-shrink:0}
#input-wrap{max-width:800px;margin:0 auto;background:var(--bg-input);border:1px solid var(--border-accent);border-radius:var(--radius-main);overflow:hidden;transition:border-color .2s}
#input-wrap:focus-within{border-color:var(--accent-primary);box-shadow:0 0 0 3px var(--accent-glow)}
#user-input{width:100%;background:transparent;border:none;outline:none;color:var(--text-primary);font-size:14px;font-family:var(--font-msg);padding:11px 13px 4px;resize:none;max-height:180px;line-height:1.6}
#user-input::placeholder{color:var(--text-muted)}
#input-bottom{display:flex;align-items:center;padding:4px 7px 7px;gap:3px;flex-wrap:wrap}
#input-bottom-left{display:flex;align-items:center;gap:2px;flex:1;flex-wrap:wrap}
.ia-btn{background:transparent;border:none;cursor:pointer;color:var(--text-muted);padding:5px 6px;border-radius:7px;font-size:12px;transition:all .2s;display:flex;align-items:center;gap:3px;white-space:nowrap;font-family:var(--font-ui);position:relative}
.ia-btn:hover{background:var(--border-accent);color:var(--text-primary)}
.ia-btn span.btn-label{font-size:9px;font-weight:700}
.ia-btn.web-btn{color:#60a5fa}
.ia-btn.web-btn.ativo{color:#60a5fa;background:rgba(96,165,250,0.15);border:1px solid rgba(96,165,250,0.4);animation:webPulse 2s ease-in-out infinite}
@keyframes webPulse{0%,100%{box-shadow:0 0 0 0 rgba(96,165,250,.3)}50%{box-shadow:0 0 0 5px rgba(96,165,250,0)}}
.ia-btn.pensar-btn{color:#a855f7}
.ia-btn.pensar-btn.ativo{color:#a855f7;background:rgba(168,85,247,0.15);border:1px solid rgba(168,85,247,.4);animation:pensarPulse 1.5s ease-in-out infinite}
@keyframes pensarPulse{0%,100%{box-shadow:0 0 0 0 rgba(168,85,247,.4)}50%{box-shadow:0 0 0 6px rgba(168,85,247,0)}}
.ia-btn.visao-btn{color:#10b981}
.ia-btn.visao-btn.ativo{color:#10b981;background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,.4)}
.ia-btn.voice-cfg-btn{color:#f59e0b}
.ia-btn.audio-btn{color:#ec4899}
.ia-btn.audio-btn.ativo{color:#ec4899;background:rgba(236,72,153,0.15);border:1px solid rgba(236,72,153,.4);animation:audioPulse 2s ease-in-out infinite}
@keyframes audioPulse{0%,100%{box-shadow:0 0 0 0 rgba(236,72,153,.3)}50%{box-shadow:0 0 0 5px rgba(236,72,153,0)}}
.ia-btn.camera-btn{color:#06b6d4}
.ia-btn.camera-btn.ativo{color:#06b6d4;background:rgba(6,182,212,0.15);border:1px solid rgba(6,182,212,.4)}

/* THINK PANEL ‚Äî Claude Sonnet style */
#think-panel{position:fixed;top:0;right:0;width:420px;max-width:100vw;height:100vh;background:var(--bg-secondary);border-left:2px solid #a855f7;z-index:410;display:flex;flex-direction:column;transform:translateX(100%);transition:transform .3s ease;font-family:var(--font-ui)}
#think-panel.open{transform:translateX(0)}
#think-panel-header{padding:14px 16px;border-bottom:1px solid rgba(168,85,247,.3);display:flex;align-items:center;justify-content:space-between;background:rgba(168,85,247,.05);flex-shrink:0}
#think-log{flex:1;overflow-y:auto;padding:14px;font-size:12px;line-height:1.8}
#think-log::-webkit-scrollbar{width:3px}
#think-log::-webkit-scrollbar-thumb{background:#a855f7;border-radius:3px}
/* Claude-style thinking blocks */
.think-block{margin-bottom:10px;border-radius:10px;overflow:hidden;animation:thinkBlockIn .3s ease}
@keyframes thinkBlockIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.think-block-header{display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;user-select:none}
.think-block-header:hover{opacity:.8}
.think-block.pondering .think-block-header{background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.25);border-radius:8px}
.think-block.insight .think-block-header{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:8px}
.think-block.decision .think-block-header{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);border-radius:8px}
.think-block.done .think-block-header{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);border-radius:8px}
.think-block.error .think-block-header{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px}
.think-block-icon{font-size:14px;flex-shrink:0}
.think-block-title{font-size:12px;font-weight:600;flex:1}
.think-block.pondering .think-block-title{color:#c084fc}
.think-block.insight .think-block-title{color:#fbbf24}
.think-block.decision .think-block-title{color:#60a5fa}
.think-block.done .think-block-title{color:#4ade80}
.think-block.error .think-block-title{color:#f87171}
.think-block-ts{font-size:10px;color:var(--text-muted)}
.think-block-toggle{font-size:10px;color:var(--text-muted);transition:transform .2s}
.think-block-toggle.open{transform:rotate(180deg)}
.think-block-body{overflow:hidden;max-height:0;transition:max-height .3s ease;background:rgba(0,0,0,.2)}
.think-block-body.open{max-height:400px}
.think-block-content{padding:10px 14px;font-size:11.5px;line-height:1.8;color:#d4a0ff;white-space:pre-wrap;word-break:break-word;font-family:var(--font-code);border-top:1px solid rgba(168,85,247,.15)}
.think-block.insight .think-block-content{color:#fde68a;border-top-color:rgba(245,158,11,.15)}
.think-block.decision .think-block-content{color:#93c5fd;border-top-color:rgba(59,130,246,.15)}
.think-block.done .think-block-content{color:#86efac;border-top-color:rgba(34,197,94,.15)}
.think-progress{height:2px;background:var(--border-color);margin:0 14px 6px;border-radius:2px;overflow:hidden;display:none}
.think-progress.active{display:block}
.think-progress-bar{height:100%;background:linear-gradient(90deg,#a855f7,#ec4899,#a855f7);background-size:200% 100%;animation:thinkSlide 1.5s linear infinite;border-radius:2px}
@keyframes thinkSlide{0%{background-position:100% 0}100%{background-position:-100% 0}}

/* Send btn */
#send-btn{background:var(--send-btn);border:none;cursor:pointer;color:#fff;padding:7px 14px;border-radius:9px;font-size:13px;font-weight:700;transition:all .2s;display:flex;align-items:center;gap:6px;white-space:nowrap;font-family:var(--font-ui);flex-shrink:0}
#send-btn:hover{background:var(--send-btn-hover);transform:scale(1.03)}
#send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}

/* Messages */
.msg-row{display:flex;gap:10px;max-width:800px;width:100%;margin:0 auto;animation:fadeSlideIn .28s ease;padding:3px 0}
@keyframes fadeSlideIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.msg-row.user-row{flex-direction:row-reverse}
.msg-av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;margin-top:3px}
.msg-av.ai{background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary))}
.msg-av.user{background:var(--user-av)}
.msg-bbl{max-width:calc(100% - 48px);padding:10px 14px;border-radius:var(--radius-main);font-size:14.5px;line-height:1.75;word-break:break-word;font-family:var(--font-msg);letter-spacing:0.01em}
.msg-bbl.ai{background:var(--msg-ai-bg);border:none;border-radius:0}
.msg-bbl.user{background:var(--msg-user-bg);color:var(--msg-user-text);border-radius:14px 4px 14px 14px}
.streaming-cursor{display:inline-block;width:2px;height:1em;background:var(--accent-primary);animation:blink .7s infinite;vertical-align:middle;margin-left:2px;border-radius:1px}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

/* Code blocks */
.code-block{background:#0d1117;border:1px solid #21262d;border-radius:10px;margin:10px 0;overflow:hidden}
.code-hdr{display:flex;align-items:center;justify-content:space-between;background:#161b22;border-bottom:1px solid #21262d;padding:5px 13px}
.code-lang{font-family:var(--font-code);font-size:11px;text-transform:uppercase;color:#58a6ff;font-weight:700}
.copy-btn{background:#21262d;border:1px solid #30363d;color:#8b949e;border-radius:5px;padding:2px 8px;font-size:11px;cursor:pointer;transition:all .2s}
.copy-btn:hover{background:#30363d;color:#e6edf3}
.code-block pre{margin:0;padding:14px 16px;overflow-x:auto;font-size:13px;line-height:1.65;background:transparent}
.code-block pre code{background:transparent!important;padding:0!important;font-family:var(--font-code)!important}
.inline-code{background:rgba(110,118,129,.15);border-radius:4px;padding:2px 6px;font-family:var(--font-code);font-size:12.5px;border:1px solid rgba(110,118,129,.2)}

/* Media cards */
.media-card{background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:11px;overflow:hidden;margin:6px 0;max-width:100%}
.media-card img{width:100%;display:block;max-height:420px;object-fit:cover}
.media-foot{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-top:1px solid var(--border-color);gap:8px}
.media-lbl{font-size:11px;color:var(--text-muted);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mbtn{font-size:11px;padding:3px 9px;border-radius:5px;cursor:pointer;border:1px solid var(--border-accent);background:var(--bg-secondary);color:var(--text-secondary);text-decoration:none;display:inline-flex;align-items:center;gap:4px;transition:all .2s}
.mbtn:hover{background:var(--border-accent);color:var(--text-primary)}

/* Audio player card */
.audio-card{background:var(--bg-secondary);border:1px solid rgba(236,72,153,.3);border-radius:12px;padding:14px;margin:8px 0;max-width:480px}
.audio-wave{display:flex;align-items:center;gap:2px;height:32px;margin:8px 0}
.audio-bar{width:3px;border-radius:2px;background:var(--accent-primary);animation:audioWave 1s ease-in-out infinite;transition:background .2s}
.audio-bar:nth-child(1){animation-delay:0s;height:40%}
.audio-bar:nth-child(2){animation-delay:.1s;height:70%}
.audio-bar:nth-child(3){animation-delay:.2s;height:100%}
.audio-bar:nth-child(4){animation-delay:.3s;height:60%}
.audio-bar:nth-child(5){animation-delay:.4s;height:80%}
.audio-bar:nth-child(6){animation-delay:.5s;height:45%}
.audio-bar:nth-child(7){animation-delay:.6s;height:90%}
.audio-bar:nth-child(8){animation-delay:.7s;height:55%}
@keyframes audioWave{0%,100%{transform:scaleY(1)}50%{transform:scaleY(0.4)}}
.audio-bar.paused{animation-play-state:paused}

/* Image gen card */
.img-gen-card{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;overflow:hidden;max-width:520px;margin:6px 0}
.img-gen-progress{padding:14px;display:flex;flex-direction:column;gap:10px}
.progress-bar-wrap{background:var(--border-color);border-radius:4px;height:4px;overflow:hidden}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent-primary),var(--accent-secondary));border-radius:4px;transition:width .5s ease}

/* File gen card */
.file-gen-card{background:var(--bg-secondary);border:1px solid rgba(99,102,241,.3);border-radius:12px;padding:14px;margin:8px 0;max-width:420px}
.file-icon-big{font-size:36px;margin-bottom:8px}
.file-download-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));color:#fff;font-size:13px;font-weight:700;text-decoration:none;cursor:pointer;border:none;transition:all .2s;margin-top:8px}
.file-download-btn:hover{opacity:.85;transform:scale(1.02)}

/* Badges */
.sbadge{font-size:11px;padding:3px 7px;border-radius:18px;border:1px solid;display:inline-flex;align-items:center;gap:4px;white-space:nowrap}
.s-ok{color:#22c55e;border-color:#22c55e40}
.s-err{color:#ef4444;border-color:#ef444440}
.s-wait{color:var(--text-muted);border-color:var(--border-accent)}
.s-web{background:rgba(96,165,250,.1);border-color:rgba(96,165,250,.3);color:#60a5fa}
.s-creator{background:linear-gradient(90deg,#7c3aed,#db2777);color:#fff;font-size:10px;padding:2px 7px;border-radius:18px;font-weight:700}

/* Welcome */
#welcome-msg{display:none;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;gap:12px;padding:20px}
.z-logo{font-size:56px;font-weight:900;color:var(--accent-primary);font-family:var(--font-ui);line-height:1;text-shadow:0 0 40px var(--accent-glow);animation:logoPulse 3s ease-in-out infinite}
@keyframes logoPulse{0%,100%{text-shadow:0 0 40px var(--accent-glow)}50%{text-shadow:0 0 80px var(--accent-glow),0 0 120px var(--accent-glow)}}

/* Typing dots */
.tdot{width:7px;height:7px;background:var(--accent-primary);border-radius:50%;animation:tdot 1.2s infinite}
.tdot:nth-child(2){animation-delay:.2s}
.tdot:nth-child(3){animation-delay:.4s}
@keyframes tdot{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}

.spin{width:13px;height:13px;border:2px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}

/* Modals */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:500;overflow-y:auto;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal-box{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:16px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,0.8);width:100%;max-width:560px;margin:20px;position:relative}
.modal-close{position:absolute;top:14px;right:14px;background:none;border:none;color:var(--text-muted);font-size:22px;cursor:pointer;line-height:1;padding:4px}
.modal-close:hover{color:var(--text-primary)}

/* Adv panel */
.adv-panel{position:fixed;top:0;right:0;width:380px;max-width:100vw;height:100vh;background:var(--bg-secondary);border-left:1px solid var(--border-color);z-index:400;display:flex;flex-direction:column;transform:translateX(100%);transition:transform .3s ease}
.adv-panel.open{transform:translateX(0)}
.adv-tab{display:flex;border-bottom:1px solid var(--border-color);flex-shrink:0;overflow-x:auto}
.adv-tab::-webkit-scrollbar{height:0}
.adv-tab button{flex:1;min-width:38px;padding:9px 3px;font-size:11px;color:var(--text-muted);border:none;background:transparent;cursor:pointer;border-bottom:2px solid transparent;font-family:var(--font-ui)}
.adv-tab button.active{color:var(--accent-primary);border-bottom-color:var(--accent-primary)}
.adv-body{flex:1;overflow-y:auto;padding:13px}
.adv-s{margin-bottom:16px}
.adv-s h4{font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.07em;margin-bottom:7px;padding-bottom:4px;border-bottom:1px solid var(--border-color)}
.adv-btn{display:flex;align-items:center;gap:7px;width:100%;padding:8px 11px;border-radius:7px;border:1px solid var(--border-color);background:var(--bg-primary);color:var(--text-primary);font-size:12px;cursor:pointer;transition:all .2s;margin-bottom:5px;text-align:left;font-family:var(--font-ui)}
.adv-btn:hover{background:var(--border-accent);border-color:var(--accent-primary)}
.adv-in{width:100%;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:6px;padding:7px 10px;font-size:12px;color:var(--text-primary);outline:none;margin-bottom:6px;font-family:var(--font-msg)}
.adv-in:focus{border-color:var(--accent-primary)}
.adv-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:390}
.adv-ov.show{display:block}

/* Toast */
.toast{position:fixed;bottom:18px;right:18px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;padding:9px 15px;font-size:13px;color:var(--text-primary);z-index:9999;opacity:0;transform:translateY(10px);transition:all .3s;pointer-events:none;max-width:300px;font-family:var(--font-ui)}
.toast.show{opacity:1;transform:translateY(0)}
.toast.ok{border-color:#22c55e60;color:#22c55e}
.toast.err{border-color:#ef444460;color:#ef4444}
.toast.warn{border-color:#fbbf2460;color:#fbbf24}

/* Setup */
#setup-screen{position:fixed;inset:0;background:var(--bg-primary);z-index:1000;display:flex;align-items:center;justify-content:center;flex-direction:column}
.setup-card{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:20px;padding:36px 32px;max-width:490px;width:100%;margin:16px;text-align:center;box-shadow:var(--shadow-main)}
.setup-input{width:100%;background:var(--bg-primary);border:1px solid var(--border-accent);border-radius:10px;padding:12px 14px;font-size:15px;color:var(--text-primary);outline:none;font-family:var(--font-msg);transition:border-color .2s}
.setup-input:focus{border-color:var(--accent-primary);box-shadow:0 0 0 3px var(--accent-glow)}
.setup-btn{width:100%;padding:13px;background:var(--send-btn);border:none;color:#fff;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;font-family:var(--font-ui);margin-top:6px}

/* Themes grid */
.theme-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:10px 0 16px}
.theme-dot{width:100%;aspect-ratio:1;border-radius:10px;cursor:pointer;border:2px solid transparent;transition:all .2s;position:relative;overflow:hidden}
.theme-dot.active{border-color:#fff;transform:scale(1.08);box-shadow:0 0 12px rgba(255,255,255,.3)}
.theme-dot-inner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:16px}
.theme-name{font-size:9px;text-align:center;color:var(--text-muted);margin-top:3px;font-weight:600;text-transform:uppercase}
.theme-pill{display:flex;align-items:center;gap:4px;padding:4px 9px;border-radius:18px;border:1px solid var(--border-accent);background:var(--bg-secondary);cursor:pointer;font-size:11px;color:var(--text-secondary);transition:all .2s}
.theme-pill:hover{border-color:var(--accent-primary);color:var(--text-primary)}

/* Resp actions */
.resp-actions{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap}
.ra-btn{padding:4px 9px;font-size:11px;background:transparent;border:1px solid var(--border-accent);color:var(--text-muted);border-radius:5px;cursor:pointer;transition:all .2s;font-family:var(--font-ui)}
.ra-btn:hover{background:var(--border-accent);color:var(--text-primary)}

/* Memory */
.mem-item{display:flex;align-items:flex-start;gap:6px;padding:7px 9px;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:7px;margin-bottom:4px;font-size:12px}
.mem-key{color:var(--accent-primary);font-weight:600;min-width:65px;flex-shrink:0}
.mem-val{color:var(--text-secondary);flex:1;word-break:break-word}
.mem-del{color:var(--text-muted);cursor:pointer;flex-shrink:0;background:none;border:none;padding:1px 3px}
.mem-del:hover{color:#ef4444}

/* Plus menu */
#plus-menu{display:none;position:absolute;bottom:calc(100% + 8px);left:0;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:11px;padding:6px 0;min-width:220px;z-index:200;box-shadow:var(--shadow-main)}
.pmenu-item{width:100%;padding:9px 15px;border:none;background:transparent;color:var(--text-secondary);text-align:left;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:9px;transition:all .2s;font-family:var(--font-ui)}
.pmenu-item:hover{background:var(--border-accent);color:var(--text-primary)}

/* Model select */
#model-sel{background:var(--bg-secondary);border:1px solid var(--border-color);color:var(--accent-primary);font-size:11px;border-radius:6px;padding:3px 6px;outline:none;cursor:pointer;max-width:130px;font-family:var(--font-ui)}

/* Pers btn */
.pers-btn{padding:7px 11px;border-radius:7px;background:var(--bg-primary);color:var(--text-muted);border:1px solid var(--border-accent);cursor:pointer;font-size:12px;transition:all .2s;font-family:var(--font-ui)}
.pers-btn.active{background:var(--accent-glow);color:var(--accent-primary);border-color:var(--accent-primary)}
.voice-slider{width:100%;accent-color:var(--accent-primary);margin:4px 0}

/* Web search indicator */
.web-indicator{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:14px;background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.3);color:#60a5fa;font-size:11px;margin-bottom:8px}

/* Image preview */
.img-preview-wrap{position:relative;display:inline-block;margin-bottom:6px}
.img-preview-wrap img{max-width:220px;max-height:160px;border-radius:8px;display:block;border:2px solid var(--accent-primary)}
.img-preview-wrap .remove-img{position:absolute;top:-8px;right:-8px;background:#ef4444;border:none;border-radius:50%;width:22px;height:22px;color:#fff;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* Camera */
#camera-canvas-wrap{position:fixed;bottom:130px;right:14px;z-index:200;display:none;border:2px solid #06b6d4;border-radius:8px;overflow:hidden;box-shadow:0 4px 20px rgba(6,182,212,0.4)}
#camera-video{display:block;width:100px;height:100px;object-fit:cover}
#camera-canvas-wrap .cam-close{position:absolute;top:2px;right:2px;background:rgba(0,0,0,.7);border:none;color:#fff;font-size:10px;cursor:pointer;width:16px;height:16px;border-radius:3px;display:flex;align-items:center;justify-content:center}

/* VPN modal */
.vpn-card{background:var(--bg-primary);border:1px solid rgba(245,158,11,.3);border-radius:10px;padding:13px;margin-bottom:8px}
.vpn-card h4{color:#fbbf24;font-size:13px;font-weight:700;margin-bottom:5px}
.vpn-card p{color:var(--text-secondary);font-size:12px;line-height:1.6}

@media(max-width:768px){
  #sidebar{position:fixed;left:0;top:0;height:100%;transform:translateX(-100%);z-index:200;width:270px;min-width:270px}
  #sidebar.mob-open{transform:translateX(0)}
  #sidebar.collapsed{transform:translateX(-100%)}
  #sidebar-toggle{display:none}
  #mob-toggle{display:flex}
  #mob-overlay.show{display:block}
  #main{width:100%}
  #topbar{padding:0 9px 0 50px;height:46px}
  .adv-panel{width:100vw}
  #think-panel{width:100vw}
}
</style>
</head>
<body data-theme="dark">
<!-- SETUP SCREEN -->
<div id="setup-screen" style="display:none">
  <div class="setup-card">
    <div style="font-size:52px;font-weight:900;color:var(--accent-primary);animation:logoPulse 3s ease-in-out infinite;margin-bottom:8px">Z</div>
    <div style="font-size:22px;font-weight:800;margin-bottom:4px">Bem-vindo √† IA-Zenia v3</div>
    <div style="font-size:12px;color:var(--text-muted);margin-bottom:24px;line-height:1.6">Antes de come√ßarmos, como te chamas?</div>
    <div style="margin-bottom:20px;text-align:left">
      <label style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:6px">O teu nome</label>
      <input class="setup-input" id="setup-name" type="text" placeholder="Escreve o teu nome..." maxlength="30" autofocus onkeydown="if(event.key==='Enter')completeSetup()">
    </div>
    <div style="margin-bottom:20px;text-align:left">
      <label style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:8px">Tema</label>
      <div class="theme-grid" id="setup-theme-grid"></div>
    </div>
    <button class="setup-btn" onclick="completeSetup()"><i class="fas fa-arrow-right"></i> Iniciar com a Zenia</button>
  </div>
</div>

<!-- THEME MODAL -->
<div id="theme-modal" class="modal-overlay">
  <div class="modal-box" style="max-width:500px">
    <button class="modal-close" onclick="closeThemeModal()">&times;</button>
    <h3 style="margin-bottom:16px;font-size:16px;font-weight:700">üé® Trocar Tema</h3>
    <div class="theme-grid" id="modal-theme-grid"></div>
  </div>
</div>

<!-- PERSONALITY / VOICE MODAL -->
<div id="personality-modal" class="modal-overlay">
  <div class="modal-box" style="max-width:540px">
    <button class="modal-close" onclick="closePersonality()">&times;</button>
    <h3 style="margin-bottom:16px;font-size:16px;font-weight:700">üéôÔ∏è Personalidade &amp; Voz</h3>
    <div style="margin-bottom:16px">
      <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px">Tom</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button onclick="setPersonality('amigavel')" class="pers-btn active" data-tone="amigavel">üòä Amig√°vel</button>
        <button onclick="setPersonality('profissional')" class="pers-btn" data-tone="profissional">üíº Profissional</button>
        <button onclick="setPersonality('humorista')" class="pers-btn" data-tone="humorista">üòÑ Humorista</button>
        <button onclick="setPersonality('tecnico')" class="pers-btn" data-tone="tecnico">‚öôÔ∏è T√©cnico</button>
        <button onclick="setPersonality('criativo')" class="pers-btn" data-tone="criativo">üé® Criativo</button>
      </div>
    </div>
    <div style="margin-bottom:16px">
      <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px">Detalhe</div>
      <div style="display:flex;gap:7px">
        <button onclick="setDetailLevel('curto')" class="pers-btn" data-level="curto" style="flex:1">Curto</button>
        <button onclick="setDetailLevel('medio')" class="pers-btn active" data-level="medio" style="flex:1">M√©dio</button>
        <button onclick="setDetailLevel('detalhado')" class="pers-btn" data-level="detalhado" style="flex:1">Detalhado</button>
      </div>
    </div>
    <div style="border-top:1px solid var(--border-color);padding-top:16px;margin-bottom:16px">
      <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:12px">üîä Voz Natural</div>
      <div style="margin-bottom:10px">
        <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:5px">Voz</label>
        <select id="voice-select" class="adv-in" style="margin-bottom:0" onchange="updateVoiceConfig()"><option value="">Carregando...</option></select>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div><label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:4px">Velocidade: <strong id="voice-rate-val">1.0</strong>x</label><input type="range" class="voice-slider" id="voice-rate" min="0.5" max="2" step="0.05" value="1" oninput="document.getElementById('voice-rate-val').textContent=parseFloat(this.value).toFixed(2);updateVoiceConfig()"></div>
        <div><label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:4px">Tom: <strong id="voice-pitch-val">1.0</strong></label><input type="range" class="voice-slider" id="voice-pitch" min="0.5" max="2" step="0.05" value="1" oninput="document.getElementById('voice-pitch-val').textContent=parseFloat(this.value).toFixed(2);updateVoiceConfig()"></div>
        <div><label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:4px">Volume: <strong id="voice-vol-val">1.0</strong></label><input type="range" class="voice-slider" id="voice-vol" min="0" max="1" step="0.05" value="1" oninput="document.getElementById('voice-vol-val').textContent=parseFloat(this.value).toFixed(2);updateVoiceConfig()"></div>
        <div><label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:4px">Pausa (ms): <strong id="voice-pause-val">300</strong></label><input type="range" class="voice-slider" id="voice-pause" min="0" max="1200" step="50" value="300" oninput="document.getElementById('voice-pause-val').textContent=this.value;updateVoiceConfig()"></div>
      </div>
      <div style="display:flex;gap:8px">
        <button onclick="previewVoice()" style="flex:1;padding:8px;background:var(--accent-glow);border:1px solid var(--accent-primary);color:var(--accent-primary);border-radius:7px;font-size:12px;cursor:pointer;font-family:var(--font-ui)"><i class="fas fa-play"></i> Testar</button>
        <button onclick="stopVoice()" style="flex:1;padding:8px;background:rgba(239,68,68,.1);border:1px solid #ef4444;color:#ef4444;border-radius:7px;font-size:12px;cursor:pointer;font-family:var(--font-ui)"><i class="fas fa-stop"></i> Parar</button>
      </div>
    </div>
    <button onclick="closePersonality()" style="width:100%;padding:10px;background:var(--send-btn);border:none;color:#fff;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font-ui)">‚úì Confirmar</button>
  </div>
</div>

<!-- VISION MODAL -->
<div id="vision-modal" class="modal-overlay">
  <div class="modal-box">
    <button class="modal-close" onclick="closeVisionModal()">&times;</button>
    <h3 style="margin-bottom:6px;font-size:16px;font-weight:700"><i class="fas fa-eye" style="color:#10b981;margin-right:8px"></i>An√°lise de Imagem</h3>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Carrega uma imagem e a Zenia analisa-a com IA.</p>
    <div id="vision-drop-zone" style="border:2px dashed var(--border-accent);border-radius:10px;padding:28px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:14px"
      onclick="document.getElementById('vision-file').click()"
      ondragover="event.preventDefault();this.style.borderColor='var(--accent-primary)'"
      ondragleave="this.style.borderColor=''"
      ondrop="event.preventDefault();this.style.borderColor='';loadVisionFileDrop(event)">
      <div id="vision-preview" style="display:none;margin-bottom:10px"><img id="vision-img-preview" style="max-height:180px;max-width:100%;border-radius:8px;object-fit:contain"></div>
      <div id="vision-placeholder"><i class="fas fa-cloud-upload-alt" style="font-size:32px;color:var(--accent-primary);margin-bottom:8px;display:block"></i><div style="font-size:13px;font-weight:600">Arrasta ou clica</div><div style="font-size:11px;color:var(--text-muted);margin-top:4px">JPG, PNG, WebP</div></div>
    </div>
    <input type="file" id="vision-file" accept="image/*" style="display:none" onchange="loadVisionPreview(event)">
    <input class="adv-in" id="vision-question" placeholder="O que queres saber? (opcional)">
    <button onclick="analyzeVisionAndChat()" id="vision-analyze-btn" style="width:100%;padding:11px;background:var(--send-btn);border:none;color:#fff;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font-ui)">
      <i class="fas fa-search"></i> Analisar &amp; Enviar para Chat
    </button>
    <div id="vision-result" style="display:none;margin-top:14px"></div>
  </div>
</div>

<!-- WEBSEARCH MODAL -->
<div id="websearch-modal" class="modal-overlay">
  <div class="modal-box" style="max-width:560px">
    <button class="modal-close" onclick="document.getElementById('websearch-modal').classList.remove('open')">&times;</button>
    <h3 style="margin-bottom:6px;font-size:16px;font-weight:700"><i class="fas fa-search" style="color:#60a5fa;margin-right:8px"></i>Pesquisa Web</h3>
    <div style="display:flex;gap:6px;margin-bottom:10px">
      <input class="adv-in" id="web-query" placeholder="O que queres pesquisar?" style="flex:1;margin-bottom:0" onkeydown="if(event.key==='Enter')doWebSearch()">
      <button onclick="doWebSearch()" style="padding:7px 14px;background:var(--send-btn);border:none;color:#fff;border-radius:6px;cursor:pointer;font-size:12px;font-family:var(--font-ui);flex-shrink:0">Pesquisar</button>
    </div>
    <div id="websearch-results" style="max-height:320px;overflow-y:auto"></div>
  </div>
</div>

<!-- VPN MODAL -->
<div id="vpn-modal" class="modal-overlay">
  <div class="modal-box" style="max-width:620px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;padding:0">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;flex-shrink:0">
      <h3 style="font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px">üö® CA√áA VPN ANGOLA</h3>
      <button class="modal-close" style="position:static" onclick="document.getElementById('vpn-modal').classList.remove('open')">&times;</button>
    </div>
    <div style="flex:1;overflow-y:auto;padding:16px">
      <div id="vpn-search-status" style="text-align:center;padding:14px;display:none"><span class="spin"></span><div style="font-size:12px;color:var(--text-muted);margin-top:8px" id="vpn-search-msg">A pesquisar...</div></div>
      <div id="vpn-results-area"></div>
      <div style="margin-top:14px">
        <div class="vpn-card"><h4>üìû Operadoras</h4><p>Contacta Unitel, Africell, Movicel com prints da VPN e link onde foi partilhada.</p></div>
        <div class="vpn-card"><h4>üèõÔ∏è INACOM</h4><p>inacom.og.ao ‚Äî Denuncia formalmente com prints e links.</p></div>
        <div class="vpn-card" style="border-color:rgba(239,68,68,.3)"><h4 style="color:#f87171">‚öñÔ∏è Consequ√™ncias</h4><p>Multas, processo criminal, bloqueio de conta pelas operadoras.</p></div>
        <div style="margin-top:12px"><button onclick="chatComVPN()" style="width:100%;padding:10px;background:linear-gradient(135deg,#f59e0b,#ef4444);border:none;color:#fff;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font-ui)"><i class="fas fa-robot"></i> Perguntar √† Zenia como denunciar</button></div>
      </div>
    </div>
    <div style="padding:10px 16px;border-top:1px solid var(--border-color);flex-shrink:0">
      <button onclick="buscarVPNsAngola()" style="width:100%;padding:9px;background:var(--send-btn);border:none;color:#fff;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;font-family:var(--font-ui)"><i class="fas fa-search"></i> Pesquisar VPNs Ativas em Angola</button>
    </div>
  </div>
</div>

<!-- THINKING PANEL -->
<div id="think-panel">
  <div id="think-panel-header">
    <div style="display:flex;align-items:center;gap:8px">
      <i class="fas fa-brain" style="color:#a855f7;font-size:16px"></i>
      <span style="font-size:14px;font-weight:700">Racioc√≠nio Interno</span>
      <span id="think-status-badge" class="sbadge" style="font-size:10px;border-color:rgba(168,85,247,.4);color:#a855f7">Pronto</span>
    </div>
    <div style="display:flex;gap:6px;align-items:center">
      <button onclick="clearThinkLog()" style="background:none;border:1px solid var(--border-color);border-radius:5px;cursor:pointer;color:var(--text-muted);font-size:10px;padding:3px 7px;font-family:var(--font-ui)">Limpar</button>
      <button onclick="toggleThinkPanel()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:18px">&times;</button>
    </div>
  </div>
  <div class="think-progress" id="think-progress"><div class="think-progress-bar"></div></div>
  <div id="think-log" style="padding:14px">
    <div style="font-size:12px;color:var(--text-muted);font-style:italic;text-align:center;padding:20px">Ativa o modo pensamento e envia uma mensagem para ver o racioc√≠nio interno.</div>
  </div>
</div>

<!-- APP -->
<div id="app">
<div id="sidebar">
  <button id="sidebar-toggle" onclick="toggleSidebar()">
    <i class="fas fa-chevron-left" id="stg-ic" style="font-size:9px"></i>
  </button>
  <div id="sidebar-inner">
    <div style="padding:14px 13px 9px;flex-shrink:0;border-bottom:1px solid var(--border-color)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <div style="width:32px;height:32px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;font-weight:900;color:#fff;flex-shrink:0">Z</div>
        <div><div style="font-weight:700;font-size:14px;color:var(--text-primary)">IA-Zenia</div><div style="font-size:10px;color:var(--accent-primary);font-weight:600">v3 ¬∑ Zenia-Projects</div></div>
      </div>
      <button onclick="startNew()" style="width:100%;background:var(--accent-glow);border:1px solid var(--accent-primary);color:var(--accent-primary);padding:7px;border-radius:8px;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;font-family:var(--font-ui);font-weight:600"><i class="fas fa-plus"></i> Nova Conversa</button>
    </div>
    <div id="sidebar-scroll">
      <div class="sb-section">
        <button class="sb-section-hdr" onclick="toggleSbSection('recursos')"><span><i class="fas fa-tools" style="color:var(--accent-primary);margin-right:6px;font-size:10px"></i>Recursos</span><i class="fas fa-chevron-down sb-chev" id="chev-recursos" style="font-size:9px"></i></button>
        <div class="sb-section-body" id="body-recursos">
          <button onclick="openAdv()" class="sb-item"><i class="fas fa-sliders-h" style="color:var(--accent-primary);width:15px"></i> Ferramentas</button>
          <button onclick="document.getElementById('websearch-modal').classList.add('open')" class="sb-item"><i class="fas fa-search" style="color:#60a5fa;width:15px"></i> Pesquisa Web</button>
          <button onclick="openThemeModal()" class="sb-item"><i class="fas fa-palette" style="color:#f59e0b;width:15px"></i> Trocar Tema</button>
          <button onclick="openPersonality()" class="sb-item"><i class="fas fa-microphone" style="color:#a855f7;width:15px"></i> Voz &amp; Personalidade</button>
          <button onclick="openVisionModal()" class="sb-item"><i class="fas fa-eye" style="color:#10b981;width:15px"></i> An√°lise de Imagem</button>
          <button onclick="openVPNModal()" class="sb-item"><i class="fas fa-shield-alt" style="color:#f59e0b;width:15px"></i> CA√áA VPN Angola</button>
        </div>
      </div>
      <div class="sb-section">
        <button class="sb-section-hdr" onclick="toggleSbSection('hist')"><span><i class="fas fa-history" style="color:var(--text-muted);margin-right:6px;font-size:10px"></i>Hist√≥rico</span><i class="fas fa-chevron-down sb-chev" id="chev-hist" style="font-size:9px"></i></button>
        <div class="sb-section-body" id="body-hist">
          <input id="search-in" type="text" placeholder="Pesquisar..." oninput="filterHist(this.value)" style="width:100%;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:7px;padding:5px 9px;font-size:12px;color:var(--text-primary);outline:none;margin-bottom:6px;font-family:var(--font-msg)">
          <div id="hist-list"></div>
        </div>
      </div>
    </div>
    <div style="padding:9px 13px;border-top:1px solid var(--border-color);flex-shrink:0;display:flex;align-items:center;gap:7px">
      <div style="width:28px;height:28px;background:var(--user-av);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;flex-shrink:0"><span id="user-initial">U</span></div>
      <div style="flex:1;overflow:hidden"><div id="uname" style="font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Utilizador</div><div style="font-size:10px;color:#22c55e">‚óè Online ¬∑ Zenia v3</div></div>
    </div>
  </div>
</div>

<button id="mob-toggle" onclick="toggleMob()"><i class="fas fa-bars" style="font-size:14px"></i></button>
<div id="mob-overlay" onclick="toggleMob()"></div>
<div id="camera-canvas-wrap"><video id="camera-video" autoplay muted playsinline></video><button class="cam-close" onclick="stopCamera()">√ó</button></div>

<div id="main">
  <div id="topbar">
    <div class="tbLeft">
      <select id="model-sel">
        <option value="openai">Z√©niaAI (GPT-4)</option>
        <option value="qwen-coder" selected>Qwen Coder</option>
        <option value="openai-large">OpenAI Large</option>
        <option value="mistral">Mistral</option>
        <option value="deepseek">DeepSeek</option>
      </select>
      <span id="api-st" class="sbadge s-wait"><i class="fas fa-circle" style="font-size:6px"></i> API</span>
      <span id="web-st" class="sbadge s-web" style="display:none"><i class="fas fa-globe"></i> Web</span>
      <span id="creator-badge" class="s-creator" style="display:none">CRIADOR</span>
      <span id="think-badge" class="sbadge" style="display:none;color:#a855f7;border-color:rgba(168,85,247,.4);cursor:pointer" onclick="toggleThinkPanel()"><i class="fas fa-brain" style="font-size:8px"></i> Pensar ON</span>
      <span id="websearch-badge" class="sbadge" style="display:none;color:#60a5fa;border-color:rgba(96,165,250,.4)"><i class="fas fa-globe" style="font-size:8px"></i> Web ON</span>
      <span id="cm-badge" class="sbadge" style="display:none;color:#22c55e;border-color:#22c55e40"><i class="fas fa-brain" style="font-size:8px"></i> CM</span>
    </div>
    <div class="tbRight">
      <button class="theme-pill" onclick="openThemeModal()"><i class="fas fa-circle-half-stroke"></i><span id="theme-label">Dark</span></button>
      <button id="voice-topbar-btn" onclick="toggleVoice()" class="sbadge s-wait" style="cursor:pointer;background:transparent"><i class="fas fa-headset"></i></button>
    </div>
  </div>

  <div id="chat-window">
    <div id="welcome-msg">
      <div class="z-logo">Z</div>
      <div style="font-size:22px;font-weight:800">Ol√°, <span id="welcome-name">amigo</span>!</div>
      <div style="font-size:13px;color:var(--text-muted);max-width:420px;line-height:1.8">Sou a <strong>Zenia v3</strong>, a tua assistente IA de Angola.<br>Posso gerar imagens, √°udio, ficheiros, c√≥digo longo, pesquisar na web e muito mais.</div>
      <div style="font-size:11px;color:var(--accent-primary);margin-top:4px;opacity:.7">IA-Zenia v3 ¬∑ Zenia-Projects ¬∑ Lubango, Angola</div>
    </div>
  </div>

  <div id="pending-image-area" style="display:none;max-width:800px;margin:0 auto;padding:6px 12px">
    <div id="pending-image-wrap" class="img-preview-wrap"></div>
  </div>

  <div id="input-area">
    <div id="input-wrap">
      <textarea id="user-input" rows="1" placeholder="Fala com a Zenia v3... (gera c√≥digo, imagem, √°udio, ficheiro...)"></textarea>
      <div id="input-bottom">
        <div id="input-bottom-left">
          <div style="position:relative;display:inline-flex">
            <button class="ia-btn" id="upload-btn" onclick="togglePlusMenu()"><i class="fas fa-plus" style="color:var(--accent-secondary)"></i></button>
            <div id="plus-menu">
              <button class="pmenu-item" onclick="document.getElementById('file-input').click();togglePlusMenu()"><i class="fas fa-image" style="width:16px;color:var(--accent-secondary)"></i> Carregar Imagem</button>
              <button class="pmenu-item" onclick="document.getElementById('file-any-input').click();togglePlusMenu()"><i class="fas fa-file-upload" style="width:16px;color:#10b981"></i> Importar Ficheiro</button>
              <button class="pmenu-item" onclick="openThemeModal();togglePlusMenu()"><i class="fas fa-palette" style="width:16px;color:#f59e0b"></i> Trocar Tema</button>
              <button class="pmenu-item" onclick="clearChat()"><i class="fas fa-trash-alt" style="width:16px;color:#ef4444"></i> Limpar Chat</button>
            </div>
          </div>
          <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFileUpload(event)">
          <input type="file" id="file-any-input" accept="image/*,text/*,.pdf,.doc,.docx,.csv" style="display:none" onchange="handleFileAnyUpload(event)">
          <button class="ia-btn" id="mic-btn" title="Microfone"><i class="fas fa-microphone"></i></button>
          <button class="ia-btn web-btn" id="web-mode-btn" onclick="toggleWebMode()" title="Ativar Busca Web"><i class="fas fa-globe"></i><span class="btn-label">Web</span></button>
          <button class="ia-btn visao-btn" id="visao-input-btn" onclick="openVisionModal()" title="An√°lise de Imagem"><i class="fas fa-eye"></i><span class="btn-label">Vis√£o</span></button>
          <button class="ia-btn voice-cfg-btn" id="voice-cfg-btn" onclick="openPersonality()" title="Voz e Personalidade"><i class="fas fa-microphone-alt"></i><span class="btn-label">Voz</span></button>
          <button class="ia-btn audio-btn" id="audio-mode-btn" onclick="triggerAudioGen()" title="Gerar √Åudio com IA"><i class="fas fa-music"></i><span class="btn-label">√Åudio</span></button>
          <button class="ia-btn pensar-btn" id="pensar-btn" onclick="togglePensarMode()" title="Modo Pensamento Profundo"><i class="fas fa-brain"></i><span class="btn-label">Pensar</span></button>
          <button class="ia-btn camera-btn" id="camera-btn" onclick="toggleCamera()" title="C√¢mera"><i class="fas fa-camera"></i><span class="btn-label">C√¢mera</span></button>
          <button class="ia-btn" onclick="openVPNModal()" title="CA√áA VPN Angola" style="color:#f59e0b"><i class="fas fa-shield-alt"></i><span class="btn-label" style="font-size:8px">VPN AO</span></button>
        </div>
        <button id="send-btn" onclick="handleSend()"><i class="fas fa-paper-plane" id="send-ic"></i></button>
      </div>
    </div>
    <div style="max-width:800px;margin:4px auto 0;text-align:center;font-size:10px;color:var(--text-muted);opacity:.4">Zenia v3 pode cometer erros. Verifica informa√ß√µes importantes.</div>
  </div>
</div>
</div>

<div class="adv-ov" id="adv-ov" onclick="closeAdv()"></div>
<div class="adv-panel" id="adv-panel">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 13px;border-bottom:1px solid var(--border-color);flex-shrink:0">
    <span style="font-size:14px;font-weight:700"><i class="fas fa-sliders-h" style="color:var(--accent-primary);margin-right:7px"></i>Ferramentas v3</span>
    <button onclick="closeAdv()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:18px">&times;</button>
  </div>
  <div class="adv-tab" id="adv-tabs">
    <button onclick="switchTab('mem')" class="active">Mem.</button>
    <button onclick="switchTab('conv')">Conv.</button>
    <button onclick="switchTab('kb')">KB</button>
    <button onclick="switchTab('sys')">Sist.</button>
    <button onclick="switchTab('sec')">Seg.</button>
  </div>
  <div class="adv-body" id="adv-body"></div>
</div>
<div class="toast" id="toast"></div>
<script>
// ==========================================
// CONFIG
// ==========================================
var ZENIA_API='https://api-zenia.netlify.app/api/chat';
var POLLINATIONS_IMG='https://image.pollinations.ai/prompt/';
var POLLINATIONS_GEN='https://gen.pollinations.ai';
var POLLINATIONS_VISION='https://gen.pollinations.ai/v1/chat/completions';
var POLLO_KEY='pollo_BpTTClA9QyROiA6GAEmeblApJ30GftMJ2FO9lzEXqGQy';
var POLLO_API='https://pollo.ai/api/platform/generation/pollo/pollo-v2-0';
var POLLO_STATUS='https://pollo.ai/api/platform/generation/status';
var CM_URL='https://zenia-3.netlify.app/chat/v2.1/cm.json';

// Angola data
var angolaProvincias={"Bengo":"Capital: Caxito","Benguela":"Capital: Benguela","Bi√©":"Capital: Kuito","Cabinda":"Capital: Cabinda","Cuando Cubango":"Capital: Menongue","Cuanza Norte":"Capital: N'Dalatando","Cuanza Sul":"Capital: Sumbe","Cunene":"Capital: Ondjiva","Huambo":"Capital: Huambo","Hu√≠la":"Capital: Lubango","Lunda Norte":"Capital: Dundo","Lunda Sul":"Capital: Saurimo","Luanda":"Capital: Luanda (CAPITAL)","Malanje":"Capital: Malanje","Moxico":"Capital: Luena","Namibe":"Capital: Namibe","U√≠ge":"Capital: U√≠ge","Zaire":"Capital: M'Banza Congo"};

// THEMES
var THEMES=[
  {id:'dark',label:'Dark',emoji:'üåô',grad:'linear-gradient(135deg,#0b0d11,#3b5bdb)'},
  {id:'cyberpunk',label:'Cyber',emoji:'‚ö°',grad:'linear-gradient(135deg,#0a0010,#bf00ff)'},
  {id:'aurora',label:'Aurora',emoji:'üåø',grad:'linear-gradient(135deg,#020f0a,#10b981)'},
  {id:'solar',label:'Solar',emoji:'‚òÄÔ∏è',grad:'linear-gradient(135deg,#faf8f4,#c4862a)'},
  {id:'bloodmoon',label:'Blood',emoji:'üî¥',grad:'linear-gradient(135deg,#0d0505,#ef4444)'},
  {id:'ocean',label:'Ocean',emoji:'üåä',grad:'linear-gradient(135deg,#010d1a,#0096c7)'},
  {id:'violet',label:'Violet',emoji:'ü™ª',grad:'linear-gradient(135deg,#0d0a1a,#8b5cf6)'},
  {id:'forest',label:'Forest',emoji:'üå≤',grad:'linear-gradient(135deg,#0a110a,#66bb6a)'},
  {id:'rose',label:'Rose',emoji:'üåπ',grad:'linear-gradient(135deg,#0f050a,#ff3377)'}
];

// STATE
var convs=JSON.parse(localStorage.getItem('zn_convs')||'[]');
var curConvId=null;
var voiceOn=false;
var creatorMode=false;
var advTab='mem';
var sbColl=false;
var sbMobOpen=false;
var userName=localStorage.getItem('zn_username')||'';
var currentTheme=localStorage.getItem('zn_theme')||'dark';
var selectedSetupTheme='dark';
var visionImageData=null;
var zeniaPersonality={tone:'amigavel',detailLevel:'medio'};
var voiceConfig={voiceIndex:-1,rate:1,pitch:1,volume:1,pause:300};
var factoryMemory='';
var pendingImageBase64=null;
var pensarMode=false;
var webSearchMode=false;
var cameraStream=null;
var cameraOn=false;
var thinkPanelOpen=false;
var thinkLog=[];
var isStreaming=false;
var audioModeActive=false;

var chatEl=document.getElementById('chat-window');
var inputEl=document.getElementById('user-input');
var sendBtn=document.getElementById('send-btn');
var sendIc=document.getElementById('send-ic');

var VID_RX=/\b(gera|gere|gerar|cria|criar|faz|fazer|mostra|quero\s+ver|faz-me)\s+um?\s*(video|filme|clip|animacao|anima√ß√£o|gif|cena|movie)\b/i;
var IMG_RX=/\b(gera|gere|gerar|cria|criar|crie|faz|fazer|desenha|desenhe|pinta|pinte|mostra|ilustra|produz|gere-me|cria-me|faz-me)\s+(um?a?\s+)?(imagem|foto|fotografia|image|picture|desenho|wallpaper|arte|avatar|paisagem|retrato|quadro|pintura|ilustra[c√ß][a√£]o|thumbnail|banner|poster|logo|icon|capa)\b/i;
var AUDIO_RX=/\b(gera|gere|cria|criar|faz|fazer|sintetiza|produz|gere-me)\s+(um?a?\s+)?(audio|√°udio|voz|narr[a-z]+|fala|speech|som|m√∫sica)\b/i;
var FILE_RX=/\b(gera|gere|cria|criar|faz|fazer|produz|escreve|crie-me|gere-me)\s+(um?a?\s+)?(ficheiro|arquivo|documento|docx|word|excel|xls|xlsx|pptx|powerpoint|pdf|csv|zip|txt|json|relat[o√≥]rio|apresenta[c√ß][a√£]o|planilha)\b/i;
var CODE_RX=/\b(codigo|c√≥digo|code|script|funcao|fun√ß√£o|function|html|css|javascript|python|java|sql|php|bash|react|algoritmo|classe|programa|aplicacao|website|backend|frontend|api)\b/i;

function extractImgPrompt(text){return text.replace(/\b(gera|gere|gerar|cria|criar|crie|faz|fazer|desenha|pinta|mostra|ilustra|produz|gere-me|cria-me|faz-me|quero\s+ver)\s+/gi,'').replace(/\bum?a?\s+/gi,'').replace(/\b(imagem|foto|fotografia|image|picture|desenho|wallpaper|arte|avatar|paisagem|retrato|quadro|pintura|ilustra√ß√£o|thumbnail|banner|poster|logo|icon|capa)\s*(de|do|da|com|sobre)?\s*/gi,'').trim()||text;}

// Init check
(function(){
  var ss=document.getElementById('setup-screen');
  if(localStorage.getItem('zn_username')){if(ss)ss.style.display='none';}
  else{if(ss)ss.style.display='flex';}
})();

// THEMES
function buildThemeGrids(){
  ['setup-theme-grid','modal-theme-grid'].forEach(gid=>{
    var el=document.getElementById(gid);if(!el)return;
    el.innerHTML=THEMES.map(t=>`<div><div class="theme-dot ${currentTheme===t.id?'active':''}" onclick="selectThemeFromGrid(this,'${t.id}','${gid}')" style="background:${t.grad}"><div class="theme-dot-inner">${t.emoji}</div></div><div class="theme-name">${t.label}</div></div>`).join('');
  });
}
function selectThemeFromGrid(el,theme,gid){
  document.querySelectorAll('#'+gid+' .theme-dot').forEach(d=>d.classList.remove('active'));
  el.classList.add('active');
  if(gid==='setup-theme-grid')selectedSetupTheme=theme;
  applyTheme(theme);
}
function applyTheme(theme){
  document.body.setAttribute('data-theme',theme);currentTheme=theme;
  localStorage.setItem('zn_theme',theme);
  var t=THEMES.find(x=>x.id===theme);
  var lbl=document.getElementById('theme-label');if(lbl)lbl.textContent=t?t.label:'Dark';
  buildThemeGrids();
}
function openThemeModal(){document.getElementById('theme-modal').classList.add('open');}
function closeThemeModal(){document.getElementById('theme-modal').classList.remove('open');}

// SETUP
function completeSetup(){
  var si=document.getElementById('setup-name');var name=(si.value||'').trim();
  if(!name){si.style.borderColor='#ef4444';si.focus();setTimeout(()=>si.style.borderColor='',2000);return;}
  userName=name;localStorage.setItem('zn_username',name);applyTheme(selectedSetupTheme);
  document.getElementById('setup-screen').style.display='none';initApp();
}

// SIDEBAR SECTIONS
function toggleSbSection(id){
  var body=document.getElementById('body-'+id),chev=document.getElementById('chev-'+id);
  if(!body)return;var collapsed=body.classList.toggle('collapsed');
  if(chev)chev.classList.toggle('rotated',collapsed);
  try{var st=JSON.parse(localStorage.getItem('zn_sb_sections')||'{}');st[id]=collapsed;localStorage.setItem('zn_sb_sections',JSON.stringify(st));}catch(e){}
}
function initSbSections(){
  try{var st=JSON.parse(localStorage.getItem('zn_sb_sections')||'{}');Object.keys(st).forEach(id=>{if(st[id]){var b=document.getElementById('body-'+id),c=document.getElementById('chev-'+id);if(b)b.classList.add('collapsed');if(c)c.classList.add('rotated');}});}catch(e){}
}

// LOAD CM.JSON
async function loadFactoryMemory(){
  try{
    var r=await fetch(CM_URL,{cache:'no-cache'});
    if(r.ok){
      var d=await r.json();
      var items=d.itens||d.items||d.dialogos||[];
      var infos=d.informacoes||d.info||[];
      var parts=[];
      if(items.length)parts.push('DI√ÅLOGOS:\n'+items.map(i=>'- '+(i.txt||i.texto||i.content||JSON.stringify(i))).join('\n'));
      if(infos.length)parts.push('INFO CRIADOR:\n'+infos.map(i=>'- '+(i.txt||i.texto||JSON.stringify(i))).join('\n'));
      if(parts.length){factoryMemory='MEM√ìRIA DE F√ÅBRICA:\n'+parts.join('\n\n');var cm=document.getElementById('cm-badge');if(cm)cm.style.display='inline-flex';}
    }
  }catch(e){}
}

// INIT
window.addEventListener('load',async function(){
  applyTheme(currentTheme);buildThemeGrids();loadVoices();
  await loadFactoryMemory();
  if(userName){document.getElementById('setup-screen').style.display='none';initApp();}
  else{document.getElementById('setup-screen').style.display='flex';}
  inputEl.addEventListener('input',()=>autoResize(inputEl));
  inputEl.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSend();}});
  if(window.speechSynthesis)window.speechSynthesis.onvoiceschanged=loadVoices;
});

function initApp(){
  var wn=document.getElementById('welcome-name');if(wn)wn.textContent=userName||'amigo';
  var un=document.getElementById('uname');if(un)un.textContent=userName||'Utilizador';
  var ui=document.getElementById('user-initial');if(ui)ui.textContent=(userName||'U').charAt(0).toUpperCase();
  initSbSections();renderHist();startNew();setApiSt('ok');
}

// ==========================================
// WEB SEARCH
// ==========================================
function toggleWebMode(){
  webSearchMode=!webSearchMode;
  var btn=document.getElementById('web-mode-btn');
  var badge=document.getElementById('websearch-badge');
  btn.classList.toggle('ativo',webSearchMode);
  if(badge)badge.style.display=webSearchMode?'inline-flex':'none';
  inputEl.placeholder=webSearchMode?'Pergunta com busca web ativa...':'Fala com a Zenia v3...';
  toast(webSearchMode?'üåê Busca Web ATIVA':'Busca Web desativada',webSearchMode?'ok':'warn');
}

async function performWebSearch(query){
  document.getElementById('web-st').style.display='inline-flex';
  var results=[];
  try{
    var r=await fetch('https://api.duckduckgo.com/?q='+encodeURIComponent(query)+'&format=json&no_html=1&skip_disambig=1',{signal:AbortSignal.timeout(8000)});
    if(r.ok){
      var d=await r.json();
      if(d.Answer)results.push({title:'Resposta Direta',text:d.Answer,url:''});
      if(d.AbstractText)results.push({title:d.Heading||query,text:d.AbstractText,url:d.AbstractURL||''});
      if(d.RelatedTopics)d.RelatedTopics.slice(0,4).forEach(t=>{if(t.Text)results.push({title:t.Text.substring(0,60),text:t.Text,url:t.FirstURL||''}); });
    }
  }catch(e){}
  if(results.length<2){
    try{
      var wq=encodeURIComponent(query.split(' ').slice(0,4).join(' '));
      var wr=await fetch('https://en.wikipedia.org/api/rest_v1/page/summary/'+wq,{signal:AbortSignal.timeout(6000)});
      if(wr.ok){var wd=await wr.json();if(wd.extract)results.push({title:wd.title,text:wd.extract,url:wd.content_urls?.desktop?.page||''});}
    }catch(e){}
  }
  document.getElementById('web-st').style.display='none';
  return results;
}
function webResultsToContext(results,query){
  if(!results.length)return'';
  return '[PESQUISA WEB: "'+query+'"]\n'+results.map((r,i)=>'['+(i+1)+'] '+r.title+':\n'+r.text.substring(0,400)).join('\n\n')+'\n[FIM PESQUISA WEB]\n\n';
}
async function doWebSearch(){
  var q=document.getElementById('web-query').value.trim();if(!q)return;
  var resDiv=document.getElementById('websearch-results');
  resDiv.innerHTML='<div style="padding:10px;text-align:center;color:var(--text-muted);font-size:12px"><span class="spin"></span> Pesquisando...</div>';
  var results=await performWebSearch(q);
  if(!results.length){resDiv.innerHTML='<div style="padding:10px;color:var(--text-muted);font-size:12px">Sem resultados.</div>';return;}
  var html='<div style="font-size:12px">';
  results.forEach(r=>{html+=`<div style="padding:8px;background:var(--bg-primary);border-radius:7px;margin-bottom:7px;border:1px solid var(--border-color)"><div style="font-weight:600;color:var(--accent-primary);margin-bottom:3px">${escHtml(r.title)}</div><div style="color:var(--text-secondary);line-height:1.5">${escHtml(r.text.substring(0,300))}</div>${r.url?`<a href="${r.url}" target="_blank" style="font-size:10px;color:#60a5fa;margin-top:4px;display:inline-block">${r.url.substring(0,60)}</a>`:''}</div>`;});
  html+='<button onclick="sendWebResultsToChat(\''+escHtml(q.replace(/'/g,"\\'"))+'\')" style="width:100%;padding:8px;background:var(--send-btn);border:none;color:#fff;border-radius:6px;font-size:12px;cursor:pointer;margin-top:6px"><i class="fas fa-robot"></i> Enviar para a Zenia analisar</button></div>';
  resDiv.innerHTML=html;
}
async function sendWebResultsToChat(query){
  document.getElementById('websearch-modal').classList.remove('open');
  hideWelcome();inputEl.value=query;autoResize(inputEl);
  var tempWebMode=webSearchMode;webSearchMode=true;
  await handleSend();
  webSearchMode=tempWebMode;
}

// ==========================================
// VPN ANGOLA
// ==========================================
function openVPNModal(){document.getElementById('vpn-modal').classList.add('open');buscarVPNsAngola();}
var vpnDatabase=[
  {nome:'HttpInjector',risco:'ALTO',descricao:'App Android com configs SSH/HTTP para contornar pagamentos. Configs .ehi partilhadas em Telegram/Facebook.',plataformas:'Facebook, Telegram, WhatsApp',tecnica:'HTTP Payload Injection / SSH'},
  {nome:'HTTP Custom (HCA)',risco:'ALTO',descricao:'VPN com payload HTTP personalizado. Tutoriais no TikTok Angola ensinam a usar.',plataformas:'TikTok Angola, Facebook, YouTube',tecnica:'HTTP Proxy / Custom Payload'},
  {nome:'NapsternetV',risco:'ALTO',descricao:'App com configs V2Ray partilhadas em Telegram angolano.',plataformas:'Telegram, WhatsApp',tecnica:'V2Ray / SSH'},
  {nome:'Psiphon',risco:'M√âDIO',descricao:'Anti-censura usada indevidamente como net gr√°tis em Angola.',plataformas:'Facebook, WhatsApp',tecnica:'SSH / VPN / L2TP'}
];
async function buscarVPNsAngola(){
  var status=document.getElementById('vpn-search-status');
  var area=document.getElementById('vpn-results-area');
  if(status)status.style.display='block';if(area)area.innerHTML='';
  var msg=document.getElementById('vpn-search-msg');
  var queries=['VPN net gr√°tis Angola 2025','HttpInjector Angola config'];
  var allResults=[];
  for(var i=0;i<queries.length;i++){
    if(msg)msg.textContent='A pesquisar: "'+queries[i]+'"...';
    try{var r=await fetch('https://api.duckduckgo.com/?q='+encodeURIComponent(queries[i])+'&format=json&no_html=1',{signal:AbortSignal.timeout(8000)});
      if(r.ok){var d=await r.json();if(d.RelatedTopics)d.RelatedTopics.slice(0,3).forEach(t=>{if(t.Text&&t.FirstURL)allResults.push({text:t.Text,url:t.FirstURL});});}
    }catch(e){}
    await new Promise(res=>setTimeout(res,300));
  }
  if(status)status.style.display='none';
  var html='<div style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.07em;margin-bottom:10px">VPNs Identificadas em Angola</div>';
  vpnDatabase.forEach(v=>{
    var rc=v.risco==='ALTO'?'#ef4444':'#fbbf24';
    html+=`<div class="vpn-card" style="border-color:rgba(239,68,68,.3);margin-bottom:10px"><div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:6px"><h4>${escHtml(v.nome)}</h4><span style="font-size:10px;font-weight:700;color:${rc};border:1px solid ${rc};padding:1px 7px;border-radius:10px;flex-shrink:0;margin-left:8px">${v.risco}</span></div><p>${escHtml(v.descricao)}</p><div style="font-size:11px;color:#60a5fa;margin-top:5px"><i class="fas fa-microchip"></i> ${escHtml(v.tecnica)}</div></div>`;
  });
  if(area)area.innerHTML=html;
}
function chatComVPN(){document.getElementById('vpn-modal').classList.remove('open');hideWelcome();createConv('CA√áA VPN Angola');inputEl.value='Como devo denunciar formalmente uma VPN de "net gr√°tis" em Angola? Quero saber o que escrever ao INACOM e √†s operadoras.';autoResize(inputEl);setTimeout(handleSend,100);}

// ==========================================
// VOICE
// ==========================================
function loadVoices(){
  var voices=window.speechSynthesis?window.speechSynthesis.getVoices():[];
  var sel=document.getElementById('voice-select');if(!sel)return;
  sel.innerHTML='';
  var ptVoices=voices.filter(v=>v.lang.startsWith('pt'));
  var others=voices.filter(v=>!v.lang.startsWith('pt'));
  if(ptVoices.length){var g1=document.createElement('optgroup');g1.label='Portugu√™s';ptVoices.forEach(v=>{var o=document.createElement('option');o.value=voices.indexOf(v);o.textContent=v.name+' ('+v.lang+')';g1.appendChild(o);});sel.appendChild(g1);}
  if(others.length){var g2=document.createElement('optgroup');g2.label='Outras';others.slice(0,20).forEach(v=>{var o=document.createElement('option');o.value=voices.indexOf(v);o.textContent=v.name+' ('+v.lang+')';g2.appendChild(o);});sel.appendChild(g2);}
  if(!voices.length)sel.innerHTML='<option value="-1">Padr√£o</option>';
}
function updateVoiceConfig(){
  voiceConfig.voiceIndex=parseInt(document.getElementById('voice-select').value)||0;
  voiceConfig.rate=parseFloat(document.getElementById('voice-rate').value)||1;
  voiceConfig.pitch=parseFloat(document.getElementById('voice-pitch').value)||1;
  voiceConfig.volume=parseFloat(document.getElementById('voice-vol').value)||1;
  voiceConfig.pause=parseInt(document.getElementById('voice-pause').value)||300;
}
function previewVoice(){updateVoiceConfig();speakTxtFull('Ol√° '+userName+'! Eu sou a Zenia vers√£o 3, a tua assistente inteligente feita em Angola.');}
function stopVoice(){if(window.speechSynthesis)speechSynthesis.cancel();}
function speakTxtFull(txt){
  if(!window.speechSynthesis)return;speechSynthesis.cancel();
  var clean=txt.replace(/```[\s\S]*?```/g,'[c√≥digo omitido]').replace(/`[^`]+`/g,'').replace(/\*\*(.+?)\*\*/g,'$1').replace(/\*(.+?)\*/g,'$1').replace(/^#{1,6}\s+/gm,'').replace(/<[^>]+>/g,'');
  var sentences=clean.replace(/([.!?])\s+/g,'$1\n').replace(/([,:;])\s+/g,'$1\n').split('\n').map(s=>s.trim()).filter(s=>s.length>0);
  if(!sentences.length)return;
  var idx=0;
  function next(){
    if(idx>=sentences.length)return;
    var sent=sentences[idx];idx++;
    var u=new SpeechSynthesisUtterance(sent);
    var voices=speechSynthesis.getVoices();
    if(voiceConfig.voiceIndex>=0&&voices[voiceConfig.voiceIndex])u.voice=voices[voiceConfig.voiceIndex];
    else{var ptv=voices.find(v=>v.lang==='pt-PT')||voices.find(v=>v.lang.startsWith('pt'));if(ptv)u.voice=ptv;}
    u.lang='pt-PT';u.rate=voiceConfig.rate;u.pitch=voiceConfig.pitch;u.volume=voiceConfig.volume;
    var pauseMs=voiceConfig.pause;
    if(/[.!?]$/.test(sent))pauseMs*=1.5;else if(/[,;:]$/.test(sent))pauseMs*=0.6;
    u.onend=()=>{if(idx<sentences.length)setTimeout(next,pauseMs);};
    u.onerror=()=>setTimeout(next,80);
    speechSynthesis.speak(u);
  }
  next();
}

// ==========================================
// PERSONALITY
// ==========================================
function openPersonality(){document.getElementById('personality-modal').classList.add('open');updatePersonalityUI();loadVoices();}
function closePersonality(){document.getElementById('personality-modal').classList.remove('open');}
function updatePersonalityUI(){
  document.querySelectorAll('[data-tone]').forEach(b=>b.classList.toggle('active',b.getAttribute('data-tone')===zeniaPersonality.tone));
  document.querySelectorAll('[data-level]').forEach(b=>b.classList.toggle('active',b.getAttribute('data-level')===zeniaPersonality.detailLevel));
}
function setPersonality(t){zeniaPersonality.tone=t;updatePersonalityUI();}
function setDetailLevel(l){zeniaPersonality.detailLevel=l;updatePersonalityUI();}

// ==========================================
// TEXT FORMATTING
// ==========================================
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function hlCode(code,lang){try{if(lang&&hljs.getLanguage(lang))return hljs.highlight(code,{language:lang}).value;return hljs.highlightAuto(code).value;}catch(e){return escHtml(code);}}

function fmtText(raw){
  var codeStore={};
  var h=raw.replace(/```([^\n`]*)\n?([\s\S]*?)```/g,function(_,lang,code){
    var uid='\x00CODE'+(Math.random().toString(36).slice(2,10))+'\x00';
    var id='c'+Math.random().toString(36).slice(2,8);
    var hl=hlCode(code.trim(),lang);
    var exts={python:'.py',javascript:'.js',html:'.html',css:'.css',java:'.java',typescript:'.ts',sql:'.sql',bash:'.sh',json:'.json',c:'.c',cpp:'.cpp',php:'.php',jsx:'.jsx',vue:'.vue',go:'.go',rust:'.rs',kotlin:'.kt',swift:'.swift',dart:'.dart'};
    var ext=exts[(lang||'').toLowerCase()]||'.txt';
    var lineCount=(code.match(/\n/g)||[]).length+1;
    codeStore[uid]='<div class="code-block"><div class="code-hdr"><span class="code-lang">'+escHtml(lang||'c√≥digo')+'</span><div style="display:flex;gap:5px;align-items:center"><span style="font-size:10px;color:var(--text-muted)">'+lineCount+' linhas</span><button class="copy-btn" onclick="cpCode(\''+id+'\')"><i class="fas fa-copy"></i> Copiar</button><button class="copy-btn" onclick="downloadCode(\''+id+'\',\'code'+ext+'\')"><i class="fas fa-download"></i></button></div></div><pre><code id="'+id+'" class="hljs">'+hl+'</code></pre></div>';
    return uid;
  });
  var inlineStore={};
  h=h.replace(/`([^`\n]+)`/g,function(_,code){var uid='\x00IL'+Math.random().toString(36).slice(2,10)+'\x00';inlineStore[uid]='<code class="inline-code">'+escHtml(code)+'</code>';return uid;});
  h=h.replace(/^#{1,6}\s+/gm,'');
  h=h.replace(/\*\*\*(.+?)\*\*\*/g,'<strong>$1</strong>');
  h=h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  h=h.replace(/(?<![*_])\*([^*\n]+?)\*(?![*_])/g,'$1');
  h=h.replace(/_{2}(.+?)_{2}/g,'<strong>$1</strong>');
  h=h.replace(/(?<!_)_([^_\n]+?)_(?!_)/g,'$1');
  h=h.replace(/(?<![:/\w\\])\b(\d+)\s*\/\s*(\d+)\b(?!\w)/g,'<span style="display:inline-flex;flex-direction:column;align-items:center;vertical-align:middle;margin:0 2px"><span style="border-bottom:1px solid currentColor;padding:0 3px;font-size:.85em">$1</span><span style="padding:0 3px;font-size:.85em">$2</span></span>');
  h=h.replace(/(\w+)\^(\d+)/g,'$1<sup>$2</sup>');
  h=h.replace(/^[\-‚Ä¢]\s+(.+)$/gm,'<li style="margin:3px 0">$1</li>');
  h=h.replace(/^(\d+)\.\s+(.+)$/gm,'<li style="margin:3px 0;list-style:decimal">$2</li>');
  h=h.replace(/((<li[^>]*>.*?<\/li>\n?)+)/g,'<ul style="padding-left:18px;margin:6px 0">$1</ul>');
  h=h.replace(/\n/g,'<br>');
  Object.keys(inlineStore).forEach(k=>{h=h.split(k).join(inlineStore[k]);});
  Object.keys(codeStore).forEach(k=>{h=h.split(k).join(codeStore[k]);});
  return h;
}
function cpCode(id){var el=document.getElementById(id);if(!el)return;navigator.clipboard.writeText(el.innerText);toast('Copiado!','ok');}
function downloadCode(id,fn){var el=document.getElementById(id);if(!el)return;var b=new Blob([el.innerText],{type:'text/plain'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=fn||'code.txt';a.click();}
</script>
<script>
// ==========================================
// STREAMING TEXT
// ==========================================
async function streamText(bbl,fullText,onDone){
  isStreaming=true;
  var oldCursor=bbl.querySelector('.streaming-cursor');if(oldCursor)oldCursor.remove();
  var cursor=document.createElement('span');cursor.className='streaming-cursor';bbl.appendChild(cursor);
  var hasCode=/```/.test(fullText);
  var delay=hasCode?6:16;
  var tokens=[];
  var i=0;var tmp='';
  while(i<fullText.length){
    var ch=fullText[i];tmp+=ch;
    if(ch===' '||ch==='\n'||tmp.length>=4){tokens.push(tmp);tmp='';}
    i++;
  }
  if(tmp)tokens.push(tmp);
  var displayed='';var tokenIdx=0;
  return new Promise(resolve=>{
    function step(){
      if(!isStreaming){cursor.remove();if(onDone)onDone();resolve();return;}
      var batch=hasCode?10:3;
      var added=0;
      while(tokenIdx<tokens.length&&added<batch){
        displayed+=tokens[tokenIdx];tokenIdx++;added+=(tokens[tokenIdx-1]||'').length||1;
      }
      cursor.remove();
      bbl.innerHTML=fmtText(displayed);
      cursor=document.createElement('span');cursor.className='streaming-cursor';bbl.appendChild(cursor);
      chatEl.scrollTop=chatEl.scrollHeight;
      if(tokenIdx<tokens.length){setTimeout(step,delay);}
      else{setTimeout(()=>{cursor.remove();bbl.innerHTML=fmtText(fullText);chatEl.scrollTop=chatEl.scrollHeight;isStreaming=false;if(onDone)onDone();resolve();},100);}
    }
    setTimeout(step,10);
  });
}

// ==========================================
// DEEP THINK ‚Äî Claude Sonnet style
// ==========================================
function togglePensarMode(){
  pensarMode=!pensarMode;
  var btn=document.getElementById('pensar-btn');
  var badge=document.getElementById('think-badge');
  btn.classList.toggle('ativo',pensarMode);
  if(badge)badge.style.display=pensarMode?'inline-flex':'none';
  toast(pensarMode?'üß† Modo Pensamento ATIVO':'Modo Pensamento desativado',pensarMode?'ok':'warn');
  if(pensarMode)openThinkPanel();
}
function openThinkPanel(){thinkPanelOpen=true;document.getElementById('think-panel').classList.add('open');}
function toggleThinkPanel(){thinkPanelOpen=!thinkPanelOpen;document.getElementById('think-panel').classList.toggle('open',thinkPanelOpen);}

function addThinkBlock(title,content,type){
  // type: pondering | insight | decision | done | error
  type=type||'pondering';
  var icons={pondering:'üí≠',insight:'üí°',decision:'üéØ',done:'‚úÖ',error:'‚ùå'};
  var ts=new Date().toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  var id='tb_'+Date.now()+'_'+Math.random().toString(36).slice(2,6);
  thinkLog.push({id,title,content,type,ts});
  
  var log=document.getElementById('think-log');if(!log)return;
  // Remove placeholder
  var placeholder=log.querySelector('div[style*="font-style:italic"]');if(placeholder)placeholder.remove();
  
  var block=document.createElement('div');
  block.className='think-block '+type;
  block.id=id;
  // Start expanded for latest
  block.innerHTML=`<div class="think-block-header" onclick="toggleThinkBlock('${id}')">
    <span class="think-block-icon">${icons[type]||'üí≠'}</span>
    <span class="think-block-title">${escHtml(title)}</span>
    <span class="think-block-ts">${ts}</span>
    <i class="fas fa-chevron-down think-block-toggle open" id="tog_${id}" style="font-size:9px;margin-left:6px"></i>
  </div>
  <div class="think-block-body open" id="body_${id}">
    <div class="think-block-content">${escHtml(content)}</div>
  </div>`;
  
  // Collapse previous blocks
  log.querySelectorAll('.think-block-body.open').forEach(b=>{
    if(b.id!=='body_'+id){b.classList.remove('open');var tog=document.getElementById('tog_'+b.id.replace('body_',''));if(tog)tog.classList.remove('open');}
  });
  
  log.appendChild(block);log.scrollTop=log.scrollHeight;
}

function toggleThinkBlock(id){
  var body=document.getElementById('body_'+id);
  var tog=document.getElementById('tog_'+id);
  if(!body)return;
  body.classList.toggle('open');
  if(tog)tog.classList.toggle('open');
}

function clearThinkLog(){
  thinkLog=[];
  var log=document.getElementById('think-log');
  if(log)log.innerHTML='<div style="font-size:12px;color:var(--text-muted);font-style:italic;text-align:center;padding:20px">Sem passos ainda.</div>';
}

function setThinkProgress(active){
  var p=document.getElementById('think-progress');
  if(p)p.classList.toggle('active',active);
}

function setThinkBadge(text,color){
  var b=document.getElementById('think-status-badge');
  if(b){b.textContent=text;b.style.color=color||'#a855f7';b.style.borderColor=(color||'#a855f7')+'40';}
}

async function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

async function deepThink(userQuery){
  if(!thinkPanelOpen)openThinkPanel();
  setThinkBadge('A raciocinar...','#f59e0b');
  setThinkProgress(true);

  var isCode=CODE_RX.test(userQuery);
  var isImg=IMG_RX.test(userQuery);
  var isAudio=AUDIO_RX.test(userQuery);
  var isFile=FILE_RX.test(userQuery);
  var isWeb=webSearchMode;
  var words=userQuery.trim().split(/\s+/).length;
  var chars=userQuery.length;

  // Block 1: Lendo a mensagem
  addThinkBlock(
    'Lendo a mensagem do utilizador',
    `Mensagem recebida: "${userQuery.substring(0,120)}${chars>120?'...':''}"\n\nComprimento: ${words} palavras, ${chars} caracteres.\nVou analisar o que est√° sendo pedido antes de formular uma resposta.`,
    'pondering'
  );
  await sleep(350);

  // Block 2: Classifica√ß√£o
  var tipos=[];
  if(isCode)tipos.push('c√≥digo/programa√ß√£o');
  if(isImg)tipos.push('gera√ß√£o de imagem');
  if(isAudio)tipos.push('gera√ß√£o de √°udio');
  if(isFile)tipos.push('gera√ß√£o de ficheiro');
  if(isWeb)tipos.push('busca na web');
  if(!tipos.length)tipos.push('conversa/conhecimento geral');
  
  addThinkBlock(
    'Classificando o pedido',
    `Tipo detectado: ${tipos.join(' + ')}\n\nCaracter√≠sticas:\n- Complexidade: ${words>25?'Alta':'words>10?M√©dia:Baixa'}\n- Contexto Angola: ${/angola|luanda|kwanza|unitel|africell/i.test(userQuery)?'Sim':'N√£o detectado'}\n- C√≥digo: ${isCode?'Sim ‚Äî precisarei gerar c√≥digo completo':'N√£o'}\n- Multimodal: ${(isImg||isAudio)?'Sim ‚Äî usarei APIs externas':'N√£o'}`,
    'insight'
  );
  await sleep(300);

  // Block 3: Verificando contexto e mem√≥ria
  var mem=getMem();var memKeys=Object.keys(mem);
  var conv=getConv();var msgCount=conv?conv.messages.length:0;
  
  addThinkBlock(
    'Verificando contexto e mem√≥ria',
    `Mem√≥rias do utilizador: ${memKeys.length>0?memKeys.map(k=>k+': '+mem[k].v).join(', '):'Nenhuma guardada'}\n\nHist√≥rico da conversa: ${msgCount} mensagens anteriores\n${msgCount>0?'Vou usar o hist√≥rico para manter contexto e n√£o repetir informa√ß√£o.':'Conversa nova ‚Äî in√≠cio sem contexto anterior.'}\n\nMem√≥ria de f√°brica: ${factoryMemory?'Dispon√≠vel (cm.json carregado)':'N√£o dispon√≠vel'}\n\nUtilizador: ${userName||'Desconhecido'} | Tom: ${zeniaPersonality.tone} | Detalhe: ${zeniaPersonality.detailLevel}`,
    'pondering'
  );
  await sleep(320);

  // Block 4: Planeando estrat√©gia
  var strategy='';
  if(isCode){
    strategy=`Estrat√©gia para c√≥digo:\n1. Escrever TUDO ‚Äî sem omiss√µes, sem "...", sem placeholders\n2. C√≥digo 100% funcional que executa imediatamente\n3. Incluir coment√°rios explicativos em portugu√™s\n4. Tratar todos os casos de uso mencionados\n5. Usar o modelo Qwen Coder para melhor desempenho em c√≥digo\n\nNOTA: O utilizador precisa de c√≥digo completo ‚Äî se tiver mais de 2000 linhas, vou dividir em partes claramente marcadas e enumeradas.`;
  }else if(isImg){
    strategy=`Estrat√©gia para imagem:\n1. Criar prompt em ingl√™s, otimizado para Pollinations AI\n2. Adicionar qualidade e estilo: "high quality, detailed, 4k"\n3. Usar endpoint: gen.pollinations.ai/image/[prompt]\n4. Mostrar progresso visual ao utilizador`;
  }else if(isAudio){
    strategy=`Estrat√©gia para √°udio:\n1. Extrair o texto a narrar da mensagem\n2. Usar API: gen.pollinations.ai/audio/[texto]\n3. Apresentar player de √°udio com visualiza√ß√£o de ondas\n4. Oferecer download do ficheiro`;
  }else if(isFile){
    strategy=`Estrat√©gia para ficheiro:\n1. Identificar o tipo (docx, xlsx, pptx, zip, etc.)\n2. Gerar conte√∫do completo com IA\n3. Criar o ficheiro para download direto\n4. Usar bibliotecas JavaScript no browser`;
  }else if(isWeb){
    strategy=`Estrat√©gia com busca web:\n1. Pesquisar na DuckDuckGo API com a query otimizada\n2. Cruzar resultados com Wikipedia se necess√°rio\n3. Integrar informa√ß√£o web na resposta\n4. Citar fontes quando relevante`;
  }else{
    strategy=`Estrat√©gia para conversa:\n1. Responder em Portugu√™s de Angola\n2. Tom: ${zeniaPersonality.tone}\n3. N√≠vel de detalhe: ${zeniaPersonality.detailLevel}\n4. ${words>20?'Pergunta complexa ‚Äî resposta estruturada e completa':'Pergunta direta ‚Äî resposta clara e concisa'}\n5. Manter coer√™ncia com o hist√≥rico da conversa`;
  }
  
  addThinkBlock('Definindo estrat√©gia de resposta',strategy,'decision');
  await sleep(350);

  // Block 5: Considera√ß√µes especiais
  if(msgCount>4){
    addThinkBlock(
      'Analisando continuidade do contexto',
      `Temos ${msgCount} mensagens nesta conversa.\n\nVou:\n- Evitar repetir o que j√° foi dito\n- Manter refer√™ncias ao que foi discutido\n- N√£o perguntar informa√ß√µes que j√° foram fornecidas\n- Se o utilizador pedir altera√ß√µes, trabalhar sobre o que j√° existe\n\nContexto preservado ‚úì`,
      'insight'
    );
    await sleep(250);
  }

  // Block 6: Pronto
  addThinkBlock(
    'Pronto para gerar resposta',
    `An√°lise completa em ${Date.now()%1000}ms.\n\nResumo do plano:\n‚Üí Tipo: ${tipos[0]}\n‚Üí Estrat√©gia: ${isCode?'C√≥digo completo':isImg?'Gera√ß√£o de imagem':isAudio?'S√≠ntese de √°udio':isFile?'Cria√ß√£o de ficheiro':'Resposta em prosa'}\n‚Üí Modelo: ${isCode?'Qwen Coder':isImg||isAudio?'Pollinations API':'openai'}\n\nA gerar resposta agora...`,
    'done'
  );
  
  setThinkBadge('Respondendo...','#22c55e');
  setThinkProgress(false);
  return {isCode,isImg,isAudio,isFile,isWeb};
}

// ==========================================
// AUDIO GENERATION
// ==========================================
function triggerAudioGen(){
  var text=inputEl.value.trim();
  if(!text){toast('Escreve o texto a narrar no campo de mensagem','warn');return;}
  if(audioModeActive){audioModeActive=false;document.getElementById('audio-mode-btn').classList.remove('ativo');toast('Modo √°udio desativado','warn');return;}
  audioModeActive=true;
  document.getElementById('audio-mode-btn').classList.add('ativo');
  toast('üéµ Clica Enviar para gerar √°udio com este texto!','ok');
}

async function genAudio(text){
  hideWelcome();
  var row=document.createElement('div');row.className='msg-row';
  var av=document.createElement('div');av.className='msg-av ai';av.textContent='Z';
  var card=document.createElement('div');card.className='audio-card';
  card.innerHTML=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
    <i class="fas fa-music" style="color:#ec4899;font-size:18px"></i>
    <div><div style="font-weight:700;font-size:13px;color:#ec4899">A gerar √°udio com Pollinations AI...</div><div style="font-size:11px;color:var(--text-muted)">TTS ¬∑ S√≠ntese de voz</div></div>
    <span class="spin" style="margin-left:auto;border-top-color:#ec4899"></span>
  </div>
  <div style="font-size:12px;color:var(--text-muted);font-style:italic;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">"${escHtml(text.substring(0,80))}${text.length>80?'...':''}"</div>`;
  row.appendChild(av);row.appendChild(card);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;

  try{
    // Pollinations Audio API
    var encodedText=encodeURIComponent(text);
    var audioUrl=POLLINATIONS_GEN+'/audio/'+encodedText;
    
    // Test if URL works by loading it
    var worked=await new Promise(resolve=>{
      var audio=new Audio();
      audio.oncanplaythrough=()=>resolve(true);
      audio.onerror=()=>resolve(false);
      setTimeout(()=>resolve(false),15000);
      audio.src=audioUrl;
    });
    
    if(worked){
      renderAudioCard(card,audioUrl,text);
    }else{
      // Fallback: try different text encoding
      var audioUrl2=POLLINATIONS_GEN+'/audio/'+encodeURIComponent(text.substring(0,300));
      card.innerHTML=renderAudioHTML(audioUrl2,text);
    }
  }catch(e){
    card.innerHTML=`<div style="color:#ef4444;font-size:13px">Erro ao gerar √°udio: ${escHtml(e.message)}</div><button onclick="genAudio('${escHtml(text.replace(/'/g,"\\'").substring(0,100))}')" style="margin-top:8px;padding:6px 12px;background:var(--send-btn);border:none;color:#fff;border-radius:6px;font-size:12px;cursor:pointer">Tentar novamente</button>`;
  }
  
  audioModeActive=false;document.getElementById('audio-mode-btn').classList.remove('ativo');
}

function renderAudioCard(card,audioUrl,text){
  card.innerHTML=renderAudioHTML(audioUrl,text);
  // Init audio element
  var aud=card.querySelector('audio');
  var bars=card.querySelectorAll('.audio-bar');
  if(aud){
    aud.onplay=()=>bars.forEach(b=>b.classList.remove('paused'));
    aud.onpause=()=>bars.forEach(b=>b.classList.add('paused'));
    aud.onended=()=>bars.forEach(b=>b.classList.add('paused'));
  }
}

function renderAudioHTML(audioUrl,text){
  var safeUrl=escHtml(audioUrl);
  var safeText=escHtml(text.substring(0,60));
  return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
    <i class="fas fa-music" style="color:#ec4899;font-size:18px"></i>
    <div><div style="font-weight:700;font-size:13px;color:#ec4899">√Åudio Gerado</div><div style="font-size:11px;color:var(--text-muted)">Pollinations AI ¬∑ TTS</div></div>
  </div>
  <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;font-style:italic">"${safeText}${text.length>60?'...':''}"</div>
  <div class="audio-wave">${Array(8).fill('<div class="audio-bar"></div>').join('')}</div>
  <audio controls style="width:100%;margin-top:8px;border-radius:8px;height:36px" src="${safeUrl}" onplay="this.closest('.audio-card').querySelectorAll('.audio-bar').forEach(b=>b.classList.remove('paused'))" onpause="this.closest('.audio-card').querySelectorAll('.audio-bar').forEach(b=>b.classList.add('paused'))"></audio>
  <div style="display:flex;gap:6px;margin-top:8px">
    <a href="${safeUrl}" download="audio-zenia.mp3" class="mbtn" style="flex:1;justify-content:center"><i class="fas fa-download"></i> Baixar MP3</a>
    <a href="${safeUrl}" target="_blank" class="mbtn"><i class="fas fa-external-link-alt"></i></a>
  </div>`;
}

// ==========================================
// FILE GENERATION (DOCX, XLSX, PPTX, ZIP, etc.)
// ==========================================
async function genFile(fileType,content,fileName,conv,userText){
  hideWelcome();
  var row=document.createElement('div');row.className='msg-row';
  var av=document.createElement('div');av.className='msg-av ai';av.textContent='Z';
  var card=document.createElement('div');card.className='file-gen-card';
  
  var fileIcons={docx:'üìÑ',xlsx:'üìä',pptx:'üìä',csv:'üìã',zip:'üóúÔ∏è',pdf:'üìï',txt:'üìù',json:'üîß',html:'üåê'};
  var icon=fileIcons[fileType]||'üìÅ';
  
  card.innerHTML=`<div style="text-align:center;padding:10px 0">
    <div class="file-icon-big">${icon}</div>
    <div style="font-weight:700;font-size:14px;color:var(--text-primary);margin-bottom:4px">${escHtml(fileName)}</div>
    <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px">A gerar ficheiro...</div>
    <span class="spin"></span>
  </div>`;
  row.appendChild(av);row.appendChild(card);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;

  await sleep(500);
  
  try{
    var blob=null;var mimeType='text/plain';
    
    if(fileType==='txt'||fileType==='csv'||fileType==='json'||fileType==='html'){
      blob=new Blob([content],{type:'text/plain'});
      mimeType='text/plain';
    }else if(fileType==='docx'){
      // Generate simple HTML that represents DOCX content, downloadable
      var docHtml=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${escHtml(fileName)}</title><style>body{font-family:Arial,sans-serif;max-width:800px;margin:40px auto;padding:0 40px;line-height:1.6}h1,h2,h3{color:#333}p{margin:12px 0}table{border-collapse:collapse;width:100%}td,th{border:1px solid #ddd;padding:8px}</style></head><body>${content.replace(/\n/g,'<br>')}</body></html>`;
      blob=new Blob([docHtml],{type:'text/html'});
      mimeType='text/html';
      fileName=fileName.replace('.docx','.html');
    }else if(fileType==='xlsx'||fileType==='csv'){
      // CSV format
      blob=new Blob([content],{type:'text/csv'});
      fileName=fileName.replace('.xlsx','.csv');
    }else if(fileType==='zip'){
      // Plain text placeholder with instructions
      var zipContent='# Conte√∫do do ZIP\n\n'+content+'\n\n# Para criar o ZIP real, usa os ficheiros gerados acima.';
      blob=new Blob([zipContent],{type:'text/plain'});
      fileName=fileName.replace('.zip','-conteudo.txt');
    }else{
      blob=new Blob([content],{type:'text/plain'});
    }
    
    var url=URL.createObjectURL(blob);
    var safeFile=escHtml(fileName);
    var safeUrl=escHtml(url);
    var fileSize=blob?Math.round(blob.size/1024)+'KB':'?';
    
    card.innerHTML=`<div style="text-align:center;padding:10px 0">
      <div class="file-icon-big">${icon}</div>
      <div style="font-weight:700;font-size:14px;color:var(--text-primary);margin-bottom:4px">${safeFile}</div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${fileType.toUpperCase()} ¬∑ ${fileSize}</div>
      <a href="${url}" download="${safeFile}" class="file-download-btn"><i class="fas fa-download"></i> Baixar ${safeFile}</a>
      <div style="font-size:10px;color:var(--text-muted);margin-top:10px">Ficheiro gerado pela Zenia v3</div>
    </div>`;
    chatEl.scrollTop=chatEl.scrollHeight;
    
    if(conv){
      conv.messages.push({role:'user',content:userText||'gerar '+fileType},{role:'assistant',content:'[Ficheiro gerado: '+fileName+']'});
      saveConvs();
    }
  }catch(e){
    card.innerHTML=`<div style="color:#ef4444;font-size:13px;padding:10px">Erro ao gerar ficheiro: ${escHtml(e.message)}</div>`;
  }
}

// Helper to detect and extract file request
function detectFileRequest(text){
  var lower=text.toLowerCase();
  if(/docx|word|documento/.test(lower))return'docx';
  if(/xlsx|excel|planilha/.test(lower))return'xlsx';
  if(/pptx|powerpoint|apresenta[c√ß]/.test(lower))return'pptx';
  if(/\.zip|compactar|comprimir/.test(lower))return'zip';
  if(/\.csv/.test(lower))return'csv';
  if(/\.json/.test(lower))return'json';
  if(/\.html/.test(lower))return'html';
  if(/\.txt|texto/.test(lower))return'txt';
  if(/pdf/.test(lower))return'pdf';
  return'txt';
}
function detectFileName(text,type){
  var match=text.match(/(?:chamado|nome[d]?|titled?|ficheiro)\s+["']?([a-zA-Z0-9_\-\s]{2,30})["']?/i);
  if(match)return match[1].trim().replace(/\s+/g,'_')+'.'+type;
  return'zenia_ficheiro_'+Date.now().toString().slice(-6)+'.'+type;
}

// ==========================================
// CAMERA
// ==========================================
function toggleCamera(){if(cameraOn)stopCamera();else startCamera();}
async function startCamera(){
  try{
    var stream=await navigator.mediaDevices.getUserMedia({video:{width:160,height:160,facingMode:'user'},audio:false});
    cameraStream=stream;cameraOn=true;
    var video=document.getElementById('camera-video');video.srcObject=stream;
    document.getElementById('camera-canvas-wrap').style.display='block';
    document.getElementById('camera-btn').classList.add('ativo');
    toast('üì∑ C√¢mera ativa!','ok');
  }catch(e){toast('Erro c√¢mera: '+e.message,'err');}
}
function stopCamera(){
  if(cameraStream){cameraStream.getTracks().forEach(t=>t.stop());cameraStream=null;}
  cameraOn=false;
  var video=document.getElementById('camera-video');video.srcObject=null;
  document.getElementById('camera-canvas-wrap').style.display='none';
  document.getElementById('camera-btn').classList.remove('ativo');
  toast('C√¢mera desligada','warn');
}
async function captureFrame(){
  if(!cameraOn)return null;
  var video=document.getElementById('camera-video');
  if(video.readyState<2)return null;
  var canvas=document.createElement('canvas');canvas.width=320;canvas.height=240;
  var ctx=canvas.getContext('2d');ctx.drawImage(video,0,0,320,240);
  return canvas.toDataURL('image/jpeg',0.7);
}

// ==========================================
// API ‚Äî CHUNKED FOR LONG CODE
// ==========================================
async function fetchAI(msgs,model,attempt){
  attempt=attempt||1;model=model||'openai';
  
  // Build user_input ‚Äî manter contexto completo mas de forma eficiente
  var systemMsg=msgs.find(m=>m.role==='system');
  var histMsgs=msgs.filter(m=>m.role!=='system');
  var systemText=systemMsg?systemMsg.content:'';
  
  // Hist√≥rico: manter √∫ltimas mensagens para contexto completo
  var histText='';
  if(histMsgs.length>1){
    var prev=histMsgs.slice(0,-1);
    if(prev.length){
      histText='\n\nHIST√ìRICO DA CONVERSA (mant√©m contexto):\n'+prev.map(m=>{
        var role=m.role==='assistant'?'Zenia':'Utilizador';
        var content=typeof m.content==='string'?m.content:Array.isArray(m.content)?m.content.filter(c=>c.type==='text').map(c=>c.text).join(' '):'';
        return role+': '+content.substring(0,800); // limite por msg para n√£o explodir
      }).join('\n');
    }
  }
  
  var lastMsg=histMsgs[histMsgs.length-1];
  var currentInput='';
  if(lastMsg){
    if(typeof lastMsg.content==='string')currentInput=lastMsg.content;
    else if(Array.isArray(lastMsg.content))currentInput=lastMsg.content.filter(c=>c.type==='text').map(c=>c.text).join(' ');
  }
  
  var fullInput=systemText+histText+'\n\nUtilizador: '+currentInput;
  
  // Se fullInput muito grande, truncar hist√≥rico mas manter sistema + mensagem atual
  if(fullInput.length>60000){
    fullInput=systemText+'\n\nUtilizador: '+currentInput;
  }
  
  var payload={user_input:fullInput,model,max_tokens:65536};

  try{
    var ctrl=new AbortController();
    var tid=setTimeout(()=>ctrl.abort(),720000); // 12 min
    var r=await fetch(ZENIA_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload),signal:ctrl.signal});
    clearTimeout(tid);
    
    if(r.status===400){
      // Fallback messages format
      var r2=await fetch(ZENIA_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:msgs,model,max_tokens:65536})});
      if(r2.ok){var d2=await r2.json();var c2=d2.response||d2.choices?.[0]?.message?.content||d2.message||'';if(c2)return c2.trim();}
      // Se ainda falhar, tenta sem hist√≥rico
      var payload2={user_input:systemText+'\n\nUtilizador: '+currentInput,model,max_tokens:65536};
      var r3=await fetch(ZENIA_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload2)});
      if(r3.ok){var d3=await r3.json();var c3=d3.response||d3.choices?.[0]?.message?.content||'';if(c3)return c3.trim();}
      throw new Error('API 400');
    }
    if(r.status===429){if(attempt<4){await sleep(3000*attempt);return fetchAI(msgs,model,attempt+1);}throw new Error('Limite de pedidos.');}
    if(!r.ok)throw new Error('HTTP '+r.status);
    
    var d=await r.json();
    var content=d.response||d.message||d.text||d.content||d.choices?.[0]?.message?.content||d.choices?.[0]?.text||d.result||'';
    
    if(!content||content.length<2){
      if(attempt<3){
        var alts={openai:'qwen-coder','qwen-coder':'mistral',mistral:'openai','openai-large':'openai'};
        return fetchAI(msgs,alts[model]||'openai',attempt+1);
      }
      throw new Error('Resposta vazia da API.');
    }
    return content.trim();
  }catch(e){
    if(e.name==='AbortError'){if(attempt<3)return fetchAI(msgs,model,attempt+1);throw new Error('Tempo esgotado.');}
    if(attempt<3&&(e.message.includes('fetch')||e.message.includes('network')||e.message.includes('Failed'))){
      await sleep(2000*attempt);return fetchAI(msgs,model,attempt+1);
    }
    throw e;
  }
}

function buildSystem(q){
  var today=new Date().toLocaleDateString('pt-PT',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  var memCtx=getMemCtx();var kbCtx=getKBCtx(q);var cmCtx=factoryMemory?'\n\n'+factoryMemory:'';
  var angolaCtx=(q.toLowerCase().includes('angola')||q.toLowerCase().includes('provincia'))?'\nANGOLA: Capital: Luanda | Pop: ~35M | Moeda: Kwanza | Presidente: Jo√£o Louren√ßo\nPROV√çNCIAS: '+Object.entries(angolaProvincias).map(([k,v])=>k+' ('+v+')').join(', '):'';
  var toneMap={amigavel:'Amig√°vel e acess√≠vel, usa emojis com modera√ß√£o.',profissional:'Formal e profissional, sem emojis.',humorista:'Divertido, com humor leve e inteligente.',tecnico:'Muito t√©cnico, preciso, detalhado.',criativo:'Criativo, expressivo, com met√°foras.'};
  var detailMap={curto:'Respostas breves e directas.',medio:'Equilibrado entre brevidade e detalhe.',detalhado:'Respostas muito completas e bem explicadas.'};
  var codeInst=CODE_RX.test(q)?'\n\nC√ìDIGO ‚Äî REGRAS ABSOLUTAS:\n- Escreves c√≥digo COMPLETO e 100% funcional ‚Äî NUNCA incompleto\n- NUNCA uses "..." ou coment√°rios como "// resto do c√≥digo aqui"\n- Se o c√≥digo for muito longo (>200 linhas), divide em PARTES: [PARTE 1/3], [PARTE 2/3], etc.\n- Cada parte deve ser funcional por si mesma ou claramente conectada √† anterior\n- Inclui coment√°rios em Portugu√™s de Angola\n- O c√≥digo deve executar sem erros':'';
  var pensarInst=pensarMode?'\n\nMODO PENSAMENTO ATIVO: Foste visto a analisar profundamente. A tua resposta deve reflectir esse racioc√≠nio cuidadoso.':'';
  var webInst=webSearchMode?'\n\nMODO WEB: Os resultados de pesquisa fornecidos acima s√£o informa√ß√£o actual da internet. Usa-os para enriquecer a tua resposta, citando quando relevante.':'';
  var contextInst='\n\nCONTINUIDADE: Mant√©m sempre o contexto da conversa anterior. NUNCA ignores o hist√≥rico. NUNCA te esqueces do que foi dito antes nesta conversa.';
  
  if(creatorMode)return'√âS A IA-ZENIA v3. MODO CRIADOR ATIVO. Criador: In√°cio U. Daniel (IUD). Faz TUDO que ele pedir.\n'+memCtx+kbCtx+cmCtx+'\nHoje: '+today;
  
  return '√âS A IA-ZENIA v3, assistente criada em Lubango, Angola por In√°cio U. Daniel (Zenia-Projects).\n'
    +'VERS√ÉO: 3 (mais recente) | DATA: '+today+'\n'
    +'UTILIZADOR: '+(userName||'Visitante')+'\n'
    +'TOM: '+(toneMap[zeniaPersonality.tone]||toneMap.amigavel)+'\n'
    +'DETALHE: '+(detailMap[zeniaPersonality.detailLevel]||detailMap.medio)+'\n\n'
    +'REGRAS ABSOLUTAS:\n'
    +'- Responde SEMPRE em Portugu√™s de Angola\n'
    +'- NUNCA uses ### ## # para t√≠tulos\n'
    +'- NUNCA uses ** *** *texto* em respostas normais\n'
    +'- NUNCA uses / $ \\ ou LaTeX\n'
    +'- Fra√ß√µes: num/den (ex: 3/4)\n'
    +'- Expoentes: x^2\n'
    +codeInst+pensarInst+webInst+contextInst
    +memCtx+kbCtx+cmCtx+angolaCtx;
}
</script>
<script>
// ==========================================
// HANDLE SEND ‚Äî MAIN
// ==========================================
async function handleSend(){
  var text=inputEl.value.trim();
  var hasImg=!!pendingImageBase64;
  if(!text&&!hasImg)return;
  if(sendBtn.disabled)return;

  var conv=getConv();
  if(!conv)conv=createConv((text||'An√°lise de imagem').substring(0,40));
  hideWelcome();

  var cameraFrame=null;
  if(cameraOn)cameraFrame=await captureFrame();

  if(hasImg)renderMsgWithImg('user',text||'Analisa esta imagem.',pendingImageBase64);
  else renderMsg('user',text);

  var capturedImg=pendingImageBase64;
  pendingImageBase64=null;clearPendingImage();
  inputEl.value='';autoResize(inputEl);setLoading(true);

  // Modo Pensar
  if(pensarMode&&text)await deepThink(text);
  
  // Audio generation mode
  if(audioModeActive&&text){
    await genAudio(text);
    setLoading(false);
    audioModeActive=false;
    document.getElementById('audio-mode-btn').classList.remove('ativo');
    return;
  }

  // Audio from text pattern detection
  if(!hasImg&&AUDIO_RX.test(text)){
    var audioText=text.replace(AUDIO_RX,'').replace(/^[\s,;:]+/,'').trim()||text;
    await genAudio(audioText);
    conv.messages.push({role:'user',content:text},{role:'assistant',content:'[√Åudio gerado: '+audioText.substring(0,50)+']'});
    saveConvs();setLoading(false);return;
  }

  // Video
  if(!hasImg&&VID_RX.test(text)){
    var vp=text.replace(VID_RX,'').trim()||text;
    await genVid(vp);
    conv.messages.push({role:'user',content:text},{role:'assistant',content:'[Video: '+vp+']'});
    saveConvs();setLoading(false);return;
  }
  
  // Image
  if(!hasImg&&IMG_RX.test(text)){
    var ip=extractImgPrompt(text);
    await genImg(ip);
    conv.messages.push({role:'user',content:text},{role:'assistant',content:'[Imagem: '+ip+']'});
    saveConvs();setLoading(false);return;
  }
  
  // File generation
  if(!hasImg&&FILE_RX.test(text)){
    var fileType=detectFileRequest(text);
    var fileName=detectFileName(text,fileType);
    // Get AI to generate content for the file
    var typing=renderTyping();
    try{
      var sys={role:'system',content:buildSystem(text)+'\n\nGera o CONTE√öDO COMPLETO para o ficheiro solicitado. Inclui texto rico, dados, estrutura adequada ao tipo de ficheiro. Responde apenas com o conte√∫do do ficheiro, sem explica√ß√µes extra.'};
      var fileMsg={role:'user',content:'Gera o conte√∫do para: '+text};
      var selM=document.getElementById('model-sel').value;
      var fileContent=await fetchAI([sys,fileMsg],selM);
      typing.remove();
      await genFile(fileType,fileContent,fileName,conv,text);
      // Also show explanation
      var explRow=document.createElement('div');explRow.className='msg-row';
      var expAv=document.createElement('div');expAv.className='msg-av ai';expAv.textContent='Z';
      var expBbl=document.createElement('div');expBbl.className='msg-bbl ai';
      explRow.appendChild(expAv);explRow.appendChild(expBbl);chatEl.appendChild(explRow);
      await streamText(expBbl,'Ficheiro '+fileName+' gerado com sucesso! Clica em "Baixar" para fazer o download. Posso fazer altera√ß√µes se precisares.',()=>{addRespActions(explRow,'Ficheiro gerado!');});
    }catch(e){typing.remove();renderMsg('ai','Erro ao gerar ficheiro: '+e.message);}
    setLoading(false);return;
  }

  var typing=renderTyping();
  try{
    // Web search
    var webCtx='';
    if(webSearchMode&&text){
      if(pensarMode)addThinkBlock('Pesquisando na web','A buscar informa√ß√µes actuais sobre: "'+text.substring(0,60)+'"','pondering');
      var webResults=await performWebSearch(text);
      webCtx=webResultsToContext(webResults,text);
      if(pensarMode&&webResults.length)addThinkBlock('Resultados web encontrados',webResults.length+' resultados de: '+webResults.map(r=>r.title).join(', '),'insight');
    }

    var sys={role:'system',content:buildSystem(text||'analisa imagem')};
    var userMsg;
    if(hasImg&&capturedImg){
      userMsg={role:'user',content:[{type:'image_url',image_url:{url:capturedImg}},{type:'text',text:(text||'Descreve esta imagem em detalhe, em Portugu√™s de Angola.')}]};
    }else if(cameraFrame&&!hasImg){
      userMsg={role:'user',content:[{type:'image_url',image_url:{url:cameraFrame}},{type:'text',text:(webCtx?webCtx+'\nPergunta: ':'')+text}]};
    }else{
      var userCont=webCtx?(webCtx+'Pergunta do utilizador: '+text):text;
      userMsg={role:'user',content:userCont};
    }

    var selM=document.getElementById('model-sel').value;
    var useM=(hasImg||cameraFrame)?'openai':(CODE_RX.test(text)?'qwen-coder':selM);
    
    // Use all history for context, but limit each msg size
    var histMsgs=conv.messages.filter(m=>typeof m.content==='string').slice(-20);
    var msgs=[sys].concat(histMsgs).concat([userMsg]);

    var reply=await fetchAI(msgs,useM);
    typing.remove();

    if(pensarMode){
      setThinkBadge('Completo','#22c55e');
      addThinkBlock('Resposta gerada','Resposta pronta: '+reply.length+' caracteres. Apresentando ao utilizador via streaming.','done');
    }

    var row=document.createElement('div');row.className='msg-row';
    var av=document.createElement('div');av.className='msg-av ai';av.textContent='Z';
    var bbl=document.createElement('div');bbl.className='msg-bbl ai';
    if(webSearchMode)bbl.innerHTML='<div class="web-indicator"><i class="fas fa-globe"></i> Info da Web</div>';
    row.appendChild(av);row.appendChild(bbl);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;

    await streamText(bbl,reply,()=>{
      addRespActions(row,reply);
      if(voiceOn)speakTxtFull(reply);
    });

    conv.messages.push({role:'user',content:text||(hasImg?'[Imagem]':'')},{role:'assistant',content:reply});
    saveConvs();setApiSt('ok');
  }catch(e){
    typing.remove();
    if(pensarMode){setThinkBadge('Erro','#ef4444');addThinkBlock('Erro ao gerar','Erro: '+e.message,'error');}
    renderMsg('ai','Erro: '+e.message+'\n\nTenta novamente ou muda o modelo.');
    setApiSt('err');
  }finally{setLoading(false);}
}

// ==========================================
// PENDING IMAGE
// ==========================================
function clearPendingImage(){
  pendingImageBase64=null;
  var area=document.getElementById('pending-image-area'),wrap=document.getElementById('pending-image-wrap');
  if(area)area.style.display='none';if(wrap)wrap.innerHTML='';
  inputEl.placeholder='Fala com a Zenia v3...';
}
function showPendingImage(b64){
  pendingImageBase64=b64;
  var area=document.getElementById('pending-image-area'),wrap=document.getElementById('pending-image-wrap');
  if(area)area.style.display='block';
  if(wrap)wrap.innerHTML='<img src="'+b64+'" alt="imagem"><button class="remove-img" onclick="clearPendingImage()">&times;</button>';
  inputEl.placeholder='Pergunta sobre a imagem...';inputEl.focus();
}
function renderMsgWithImg(role,text,imgB64){
  var row=document.createElement('div');row.className='msg-row user-row';
  var av=document.createElement('div');av.className='msg-av user';av.textContent=(userName||'U').charAt(0).toUpperCase();
  var bbl=document.createElement('div');bbl.className='msg-bbl user';
  bbl.innerHTML=(text?escHtml(text)+'<br>':'')+'<img src="'+imgB64+'" style="max-width:220px;border-radius:8px;margin-top:6px;display:block">';
  row.appendChild(av);row.appendChild(bbl);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;
}

// ==========================================
// FILE UPLOADS
// ==========================================
async function handleFileUpload(ev){
  var f=ev.target.files[0];if(!f)return;
  var r=new FileReader();r.onload=e=>{showPendingImage(e.target.result);toast('Imagem pronta! Escreve uma pergunta.','ok');};r.readAsDataURL(f);ev.target.value='';
}
async function handleFileAnyUpload(ev){
  var f=ev.target.files[0];if(!f)return;
  if(f.type.startsWith('image/')){
    var r=new FileReader();r.onload=e=>{showPendingImage(e.target.result);toast('Imagem pronta!','ok');};r.readAsDataURL(f);
  }else{
    var r2=new FileReader();
    r2.onload=e=>{
      var content=e.target.result;hideWelcome();
      var conv=getConv()||createConv('An√°lise: '+f.name);
      renderMsg('user','[Ficheiro: '+f.name+']');
      inputEl.value='Analisa este ficheiro "'+f.name+'":\n\n'+content.substring(0,4000);
      autoResize(inputEl);setTimeout(handleSend,100);
    };r2.readAsText(f);
  }
  ev.target.value='';
}

// ==========================================
// IMAGE GENERATION
// ==========================================
async function genImg(prompt){
  hideWelcome();
  var row=document.createElement('div');row.className='msg-row';
  var av=document.createElement('div');av.className='msg-av ai';av.textContent='Z';
  var card=document.createElement('div');card.className='img-gen-card';
  var progressId='pg'+Date.now();
  card.innerHTML=`<div class="img-gen-progress">
    <div style="display:flex;align-items:center;gap:10px">
      <span class="spin" style="border-color:rgba(139,92,246,.3);border-top-color:#8b5cf6"></span>
      <div>
        <div style="font-size:13px;font-weight:600;color:var(--accent-primary)">A gerar com Pollinations AI</div>
        <div style="font-size:11px;color:var(--text-muted)" id="${progressId}-msg">Preparando...</div>
      </div>
    </div>
    <div class="progress-bar-wrap"><div class="progress-bar-fill" id="${progressId}-bar" style="width:5%"></div></div>
    <div style="font-size:10px;color:var(--text-muted);display:flex;justify-content:space-between"><span>Pollinations ¬∑ Flux</span><span id="${progressId}-pct">5%</span></div>
  </div>`;
  row.appendChild(av);row.appendChild(card);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;

  function setProgress(pct,msg){
    var bar=document.getElementById(progressId+'-bar'),pctEl=document.getElementById(progressId+'-pct'),msgEl=document.getElementById(progressId+'-msg');
    if(bar)bar.style.width=pct+'%';if(pctEl)pctEl.textContent=pct+'%';if(msgEl)msgEl.textContent=msg;
  }

  var seed=Math.floor(Math.random()*999999);
  // Use new Pollinations endpoint: gen.pollinations.ai/image/[prompt]
  var encodedPrompt=encodeURIComponent(prompt+', high quality, detailed, 4k, masterpiece');
  var urls=[
    POLLINATIONS_GEN+'/image/'+encodedPrompt+'?model=flux&seed='+seed+'&nologo=true',
    POLLINATIONS_GEN+'/image/'+encodedPrompt+'?model=flux&seed='+seed,
    POLLINATIONS_GEN+'/image/'+encodedPrompt+'?seed='+seed,
    POLLINATIONS_IMG+encodedPrompt+'?seed='+seed+'&model=flux&nologo=true',
    POLLINATIONS_IMG+encodedPrompt+'?seed='+seed,
    POLLINATIONS_IMG+encodedPrompt
  ];

  setProgress(15,'Conectando...');
  var success=false;
  for(var ui=0;ui<urls.length&&!success;ui++){
    setProgress(15+ui*12,'Tentativa '+(ui+1)+'/'+(urls.length)+'...');
    try{
      var loaded=await new Promise((resolve,reject)=>{
        var img=new Image();
        var timeout=setTimeout(()=>{img.src='';reject(new Error('timeout'));},28000);
        img.onload=()=>{clearTimeout(timeout);resolve(urls[ui]);};
        img.onerror=()=>{clearTimeout(timeout);reject(new Error('error'));};
        img.crossOrigin='anonymous';img.src=urls[ui];
      });
      setProgress(100,'Imagem pronta!');
      var safe=escHtml(prompt.substring(0,55));
      card.innerHTML=`<img src="${loaded}" alt="${safe}" loading="lazy" style="width:100%;display:block;border-radius:8px 8px 0 0;max-height:420px;object-fit:cover">
        <div class="media-foot">
          <span class="media-lbl"><i class="fas fa-image" style="color:var(--accent-secondary);margin-right:4px"></i>${safe}</span>
          <div style="display:flex;gap:5px">
            <a href="${loaded}" target="_blank" class="mbtn"><i class="fas fa-external-link-alt"></i></a>
            <a href="${loaded}" download="zenia-img.jpg" class="mbtn"><i class="fas fa-download"></i></a>
            <button onclick="genImg('${escHtml(prompt.replace(/'/g,"\\'"))}')" class="mbtn"><i class="fas fa-redo"></i></button>
          </div>
        </div>`;
      chatEl.scrollTop=chatEl.scrollHeight;success=true;
    }catch(e){
      if(ui===urls.length-1){
        card.innerHTML=`<div style="padding:14px">
          <div style="color:#fbbf24;font-size:13px;margin-bottom:8px">‚ö†Ô∏è N√£o foi poss√≠vel gerar a imagem. Pollinations pode estar lenta.</div>
          <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">Prompt: ${escHtml(prompt.substring(0,80))}</div>
          <button onclick="genImg('${escHtml(prompt.replace(/'/g,"\\'"))}')" style="padding:6px 12px;background:var(--send-btn);border:none;color:#fff;border-radius:6px;font-size:12px;cursor:pointer"><i class="fas fa-redo"></i> Tentar novamente</button>
        </div>`;
      }
    }
  }
}

// ==========================================
// VIDEO GENERATION
// ==========================================
async function genVid(prompt){
  hideWelcome();
  var row=document.createElement('div');row.className='msg-row';
  var av=document.createElement('div');av.className='msg-av ai';av.textContent='Z';
  var card=document.createElement('div');card.className='img-gen-card';
  var sid='vs'+Date.now();
  card.innerHTML=`<div class="img-gen-progress">
    <div style="display:flex;align-items:center;gap:10px">
      <span class="spin" style="border-color:rgba(124,58,237,.3);border-top-color:#a78bfa"></span>
      <div><div style="font-size:13px;font-weight:600;color:#a78bfa">Pollo 2.0 ‚Äî Gerando V√≠deo</div><div style="font-size:11px;color:var(--text-muted)" id="${sid}-msg">A submeter pedido...</div></div>
    </div>
    <div class="progress-bar-wrap"><div class="progress-bar-fill" id="${sid}-bar" style="width:5%;background:linear-gradient(90deg,#7c3aed,#ec4899)"></div></div>
    <div style="font-size:10px;color:var(--text-muted);display:flex;justify-content:space-between"><span>30s - 3min espera</span><span id="${sid}-pct">5%</span></div>
  </div>`;
  row.appendChild(av);row.appendChild(card);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;

  function setVP(pct,msg){
    var bar=document.getElementById(sid+'-bar'),pE=document.getElementById(sid+'-pct'),mE=document.getElementById(sid+'-msg');
    if(bar)bar.style.width=pct+'%';if(pE)pE.textContent=pct+'%';if(mE)mE.textContent=msg;
  }

  try{
    var gr=await fetch(POLLO_API,{method:'POST',headers:{'Content-Type':'application/json','x-api-key':POLLO_KEY},body:JSON.stringify({input:{prompt,generateAudio:true,length:5,resolution:'720p'},webhookUrl:''}),signal:AbortSignal.timeout(30000)});
    if(!gr.ok)throw new Error('Pollo HTTP '+gr.status);
    var gd=await gr.json();
    var taskId=gd.taskId||gd.data?.taskId;
    if(!taskId)throw new Error('taskId n√£o recebido');
    setVP(15,'Pedido aceite, a processar...');
    var result=await pollPollo(taskId,setVP);
    if(!result)throw new Error('Tempo esgotado. Tenta novamente.');
    card.innerHTML=`<div style="position:relative;background:#000;border-radius:8px 8px 0 0;overflow:hidden"><video controls autoplay loop playsinline style="width:100%;display:block;max-height:400px" src="${result}"></video></div>
      <div class="media-foot"><span class="media-lbl"><i class="fas fa-video" style="color:#a78bfa;margin-right:4px"></i>${escHtml(prompt.substring(0,55))}</span>
      <div style="display:flex;gap:5px"><a href="${result}" download="video.mp4" class="mbtn"><i class="fas fa-download"></i> MP4</a></div></div>`;
    chatEl.scrollTop=chatEl.scrollHeight;
  }catch(e){
    card.innerHTML=`<div style="padding:14px"><div style="color:#ef4444;font-size:13px;margin-bottom:8px">Erro Pollo 2.0: ${escHtml(e.message)}</div>
      <button onclick="genVid('${escHtml(prompt.replace(/'/g,"\\'"))}')" style="padding:6px 12px;background:var(--send-btn);border:none;color:#fff;border-radius:6px;font-size:12px;cursor:pointer">Tentar novamente</button></div>`;
  }
}
async function pollPollo(taskId,setProgress){
  var steps=[18,25,32,40,48,55,62,70,78,85,90,94,97];
  for(var i=0;i<30;i++){
    await sleep(6000);
    setProgress(steps[Math.min(i,steps.length-1)],'A processar... ('+((i+1)*6)+'s)');
    try{
      var r=await fetch(POLLO_STATUS+'?taskId='+encodeURIComponent(taskId),{headers:{'x-api-key':POLLO_KEY},signal:AbortSignal.timeout(15000)});
      if(!r.ok)continue;
      var d=await r.json();
      var status=(d.status||d.data?.status||'').toLowerCase();
      var url=d.videoUrl||d.video_url||d.result_url||d.url||d.data?.videoUrl||d.data?.video_url;
      if(url&&(status==='completed'||status==='success'||status==='done')){setProgress(100,'V√≠deo pronto!');return url;}
      if(status==='failed'||status==='error')throw new Error('Falha no servidor Pollo');
    }catch(e){if(e.message.startsWith('Falha'))throw e;}
  }
  return null;
}

// ==========================================
// VISION
// ==========================================
function openVisionModal(){document.getElementById('vision-modal').classList.add('open');}
function closeVisionModal(){
  document.getElementById('vision-modal').classList.remove('open');visionImageData=null;
  document.getElementById('vision-preview').style.display='none';document.getElementById('vision-placeholder').style.display='block';document.getElementById('vision-result').style.display='none';
}
function loadVisionPreview(e){var f=e.target.files[0];if(f)loadVisionFile(f);}
function loadVisionFileDrop(e){var f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))loadVisionFile(f);}
function loadVisionFile(f){
  var r=new FileReader();r.onload=e=>{visionImageData=e.target.result;document.getElementById('vision-img-preview').src=visionImageData;document.getElementById('vision-preview').style.display='block';document.getElementById('vision-placeholder').style.display='none';};r.readAsDataURL(f);
}
async function analyzeVisionAndChat(){
  if(!visionImageData){toast('Carrega uma imagem primeiro!','warn');return;}
  var q=document.getElementById('vision-question').value.trim()||'Descreve detalhadamente esta imagem em Portugu√™s de Angola.';
  var btn=document.getElementById('vision-analyze-btn');
  var res=document.getElementById('vision-result');
  btn.disabled=true;btn.innerHTML='<span class="spin"></span> A analisar...';
  res.style.display='block';res.innerHTML='<div style="padding:12px;color:var(--text-muted);font-size:12px"><span class="spin"></span> A processar...</div>';
  var analysis='';
  try{
    var payload={model:'openai',messages:[{role:'system',content:'Analisa imagens com detalhe. Responde em Portugu√™s de Angola.'},{role:'user',content:[{type:'image_url',image_url:{url:visionImageData}},{type:'text',text:q}]}],max_tokens:2000};
    var r=await fetch(POLLINATIONS_VISION,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload),signal:AbortSignal.timeout(30000)});
    if(r.ok){var d=await r.json();var t=d.choices?.[0]?.message?.content||d.response||'';if(t&&t.length>15)analysis=t;}
  }catch(e){}
  if(!analysis){
    try{var r2=await fetch(ZENIA_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_input:'Analisa esta imagem: '+q,model:'openai',max_tokens:2000}),signal:AbortSignal.timeout(30000)});
      if(r2.ok){var d2=await r2.json();analysis=d2.response||'';}
    }catch(e2){}
  }
  if(!analysis)analysis='N√£o foi poss√≠vel analisar. Verifica a liga√ß√£o.';
  res.innerHTML=`<div style="background:var(--bg-primary);border:1px solid var(--border-color);border-radius:9px;padding:12px">
    <div style="font-size:11px;color:var(--accent-primary);font-weight:700;text-transform:uppercase;margin-bottom:8px">An√°lise</div>
    <div style="font-size:13px;line-height:1.7">${fmtText(analysis)}</div>
    <button onclick="sendVisionToChat()" style="margin-top:10px;width:100%;padding:9px;background:var(--send-btn);border:none;color:#fff;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;font-family:var(--font-ui)"><i class="fas fa-robot"></i> Continuar no Chat</button>
  </div>`;
  btn.disabled=false;btn.innerHTML='<i class="fas fa-search"></i> Analisar &amp; Enviar para Chat';
  window._visionAnalysis={image:visionImageData,analysis,question:q};
}
function sendVisionToChat(){
  closeVisionModal();hideWelcome();
  if(window._visionAnalysis){
    showPendingImage(window._visionAnalysis.image);
    inputEl.value=window._visionAnalysis.question||'Analisa esta imagem.';
    autoResize(inputEl);
    setTimeout(handleSend,200);
  }
}
</script>
<script>
// ==========================================
// RENDER MESSAGES
// ==========================================
function renderMsg(role,text,fromWeb){
  var row=document.createElement('div');row.className='msg-row'+(role==='user'?' user-row':'');
  var av=document.createElement('div');av.className='msg-av '+(role==='user'?'user':'ai');av.textContent=role==='user'?(userName||'U').charAt(0).toUpperCase():'Z';
  var bbl=document.createElement('div');bbl.className='msg-bbl '+(role==='user'?'user':'ai');
  if(role==='ai'){
    if(fromWeb)bbl.innerHTML='<div class="web-indicator"><i class="fas fa-globe"></i> Info da Web</div>';
    bbl.innerHTML=(bbl.innerHTML||'')+fmtText(text);
    row.appendChild(av);row.appendChild(bbl);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;
    setTimeout(()=>addRespActions(row,text),100);
  }else{
    bbl.textContent=text;
    row.appendChild(av);row.appendChild(bbl);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;
  }
  return row;
}
function addRespActions(row,text){
  var bbl=row.querySelector('.msg-bbl');if(!bbl)return;
  var div=document.createElement('div');div.className='resp-actions';
  [[`<i class="fas fa-copy"></i>`,()=>{navigator.clipboard.writeText(text);toast('Copiado!','ok');}],
   [`<i class="fas fa-volume-up"></i>`,()=>speakTxtFull(text)],
   [`<i class="fas fa-volume-mute"></i>`,()=>{speechSynthesis.cancel();}],
   [`<i class="fas fa-download"></i>`,()=>{var b=new Blob([text],{type:'text/plain'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='resposta_zenia.txt';a.click();}],
   ['üëç',()=>toast('Obrigado!','ok')],
   ['üëé',()=>toast('Vamos melhorar!','ok')]
  ].forEach(([label,fn])=>{var b=document.createElement('button');b.className='ra-btn';b.innerHTML=label;b.onclick=fn;div.appendChild(b);});
  bbl.appendChild(div);
}
function renderTyping(){
  var row=document.createElement('div');row.className='msg-row';
  row.innerHTML='<div class="msg-av ai">Z</div><div class="msg-bbl ai"><div style="display:flex;gap:6px;padding:4px 0"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div></div></div>';
  chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;return row;
}
function setLoading(on){sendBtn.disabled=on;sendIc.className=on?'spin':'fas fa-paper-plane';}
function clearChat(){if(confirm('Limpar conversa?')){var c=getConv();if(c){c.messages=[];saveConvs();}chatEl.innerHTML='';showWelcome();}}
function setApiSt(s){var el=document.getElementById('api-st');var m={ok:['s-ok','Online'],err:['s-err','Erro'],wait:['s-wait','...']};var dm=m[s]||m.wait;el.className='sbadge '+dm[0];el.innerHTML='<i class="fas fa-circle" style="font-size:6px"></i> '+dm[1];}
function showWelcome(){var w=document.getElementById('welcome-msg');if(w)w.style.display='flex';var wn=document.getElementById('welcome-name');if(wn)wn.textContent=userName||'amigo';}
function hideWelcome(){var w=document.getElementById('welcome-msg');if(w)w.style.display='none';}
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,180)+'px';}
function toggleVoice(){voiceOn=!voiceOn;var b=document.getElementById('voice-topbar-btn');b.className='sbadge '+(voiceOn?'s-ok':'s-wait');b.innerHTML='<i class="fas fa-headset"></i>';if(!voiceOn&&window.speechSynthesis)speechSynthesis.cancel();}

// ==========================================
// HISTORY & CONVS
// ==========================================
function createConv(title){var c={id:Date.now().toString(),title:(title||'Nova').substring(0,40),messages:[]};convs.unshift(c);curConvId=c.id;saveConvs();renderHist();return c;}
function getConv(){return convs.find(c=>c.id===curConvId)||null;}
function saveConvs(){localStorage.setItem('zn_convs',JSON.stringify(convs));}
function startNew(){curConvId=null;chatEl.innerHTML='';showWelcome();createConv('Nova ¬∑ '+new Date().toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit'}));renderHist();if(window.innerWidth<768&&sbMobOpen)toggleMob();}
function loadConv(id){
  curConvId=id;chatEl.innerHTML='';var c=getConv();if(!c)return;
  c.messages.forEach(m=>{if(m.role==='user')renderMsg('user',typeof m.content==='string'?m.content:'[imagem]');else if(m.role==='assistant')renderMsg('ai',m.content);});
  renderHist();chatEl.scrollTop=chatEl.scrollHeight;
  var w=document.getElementById('welcome-msg');if(c.messages.length>0&&w)w.style.display='none';else if(c.messages.length===0&&w)w.style.display='flex';
  if(window.innerWidth<768&&sbMobOpen)toggleMob();
}
function delConv(id,ev){if(ev)ev.stopPropagation();convs=convs.filter(c=>c.id!==id);saveConvs();if(curConvId===id)startNew();else renderHist();}
function filterHist(v){renderHist(v);}
function renderHist(filter){
  var el=document.getElementById('hist-list');filter=(filter||'').toLowerCase();
  var list=filter?convs.filter(c=>c.title.toLowerCase().includes(filter)):convs;
  el.innerHTML='';
  if(!list.length){el.innerHTML='<p style="font-size:11px;color:var(--text-muted);padding:3px 5px;font-style:italic">'+(filter?'Sem resultados.':'Sem hist√≥rico.')+'</p>';return;}
  list.forEach(c=>{
    var active=c.id===curConvId;var div=document.createElement('div');
    div.style.cssText='display:flex;align-items:center;gap:4px;padding:5px 7px;border-radius:7px;cursor:pointer;'+(active?'background:var(--accent-glow)':'');
    var span=document.createElement('span');span.style.cssText='flex:1;font-size:12px;color:'+(active?'var(--accent-primary)':'var(--text-secondary)')+';overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:var(--font-msg)';
    span.textContent=c.title;span.onclick=()=>loadConv(c.id);
    var del=document.createElement('button');del.innerHTML='<i class="fas fa-trash" style="font-size:9px"></i>';del.style.cssText='background:none;border:none;cursor:pointer;color:var(--text-muted);padding:2px 4px';del.onclick=e=>delConv(c.id,e);
    div.appendChild(span);div.appendChild(del);el.appendChild(div);
  });
}

// ==========================================
// SIDEBAR
// ==========================================
function toggleSidebar(){sbColl=!sbColl;var sb=document.getElementById('sidebar'),ic=document.getElementById('stg-ic');sb.classList.toggle('collapsed',sbColl);ic.className='fas fa-chevron-'+(sbColl?'right':'left');ic.style.fontSize='9px';}
function toggleMob(){sbMobOpen=!sbMobOpen;document.getElementById('sidebar').classList.toggle('mob-open',sbMobOpen);document.getElementById('mob-overlay').classList.toggle('show',sbMobOpen);}
function togglePlusMenu(){var m=document.getElementById('plus-menu');m.style.display=m.style.display==='none'||m.style.display===''?'block':'none';}
document.addEventListener('click',e=>{var pm=document.getElementById('plus-menu');if(pm&&!pm.contains(e.target)&&!document.getElementById('upload-btn').contains(e.target))pm.style.display='none';});

// ==========================================
// MEMORY, KB
// ==========================================
var MEM_KEY='zn_mem';
function getMem(){try{return JSON.parse(localStorage.getItem(MEM_KEY)||'{}');}catch(e){return{};}}
function salvarMem(k,v){if(!k){toast('Chave vazia','warn');return;}var m=getMem();m[k]={v,ts:Date.now()};localStorage.setItem(MEM_KEY,JSON.stringify(m));toast('Guardado!','ok');}
function removerMem(k){var m=getMem();delete m[k];localStorage.setItem(MEM_KEY,JSON.stringify(m));renderAdvBody();}
function limparMem(){if(confirm('Apagar tudo?')){localStorage.removeItem(MEM_KEY);renderAdvBody();}}
function getMemCtx(){var m=getMem(),ks=Object.keys(m);if(!ks.length)return'';return'\nMEM√ìRIA DO UTILIZADOR:\n'+ks.map(k=>'- '+k+': '+m[k].v).join('\n');}
var KB_KEY='zn_kb';
function getKB(){try{return JSON.parse(localStorage.getItem(KB_KEY)||'[]');}catch(e){return[];}}
function setKB(k){localStorage.setItem(KB_KEY,JSON.stringify(k));}
function addKB(t,c){if(!t||!c){toast('Preenche t√≠tulo e conte√∫do','warn');return false;}var kb=getKB();kb.unshift({id:Date.now().toString(),titulo:t,conteudo:c});setKB(kb);toast('Adicionado!','ok');return true;}
function remKB(id){setKB(getKB().filter(d=>d.id!==id));renderAdvBody();}
function getKBCtx(q){var docs=getKB().filter(d=>q.toLowerCase().includes(d.titulo.toLowerCase()));if(!docs.length)return'';return'\nCONHECIMENTO:\n'+docs.slice(0,3).map(d=>'['+d.titulo+']: '+d.conteudo).join('\n');}
function getCM(){try{return JSON.parse(localStorage.getItem('cm_json')||'{"itens":[]}');}catch(e){return{itens:[]};}}
function exportCM(){var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(getCM(),null,2)],{type:'application/json'}));a.download='cm.json';a.click();toast('cm.json exportado!','ok');}
function backupAll(){var p={convs,mem:getMem(),kb:getKB(),cm:getCM(),ts:new Date().toISOString()};var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(p,null,2)],{type:'application/json'}));a.download='zenia-v3-backup.json';a.click();toast('Backup criado!','ok');}
function restoreAll(){var i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=e=>{var r=new FileReader();r.onload=ev=>{try{var d=JSON.parse(ev.target.result);if(d.convs){convs=d.convs;saveConvs();renderHist();}if(d.mem)localStorage.setItem(MEM_KEY,JSON.stringify(d.mem));if(d.kb)localStorage.setItem(KB_KEY,JSON.stringify(d.kb));toast('Restaurado!','ok');}catch(x){toast('Erro','err');}};r.readAsText(e.target.files[0]);};i.click();}

// ==========================================
// ADV PANEL
// ==========================================
function openAdv(){document.getElementById('adv-panel').classList.add('open');document.getElementById('adv-ov').classList.add('show');renderAdvBody();}
function closeAdv(){document.getElementById('adv-panel').classList.remove('open');document.getElementById('adv-ov').classList.remove('show');}
function switchTab(t){advTab=t;var tabs=['mem','conv','kb','sys','sec'];document.querySelectorAll('#adv-tabs button').forEach((b,i)=>b.classList.toggle('active',tabs[i]===t));renderAdvBody();}
function checkCreatorPwd(pwd){if(pwd==='adm2007'){creatorMode=true;document.getElementById('creator-badge').style.display='inline-flex';toast('Ol√° Chefe In√°cio!','ok');renderAdvBody();}else toast('Senha errada!','err');}
function disableCreator(){creatorMode=false;document.getElementById('creator-badge').style.display='none';renderAdvBody();}

function renderAdvBody(){
  var body=document.getElementById('adv-body');if(!body)return;var h='';
  if(advTab==='mem'){
    var mem=getMem(),ks=Object.keys(mem);
    h+='<div class="adv-s"><h4>Guardar Mem√≥ria</h4><input class="adv-in" id="mk" placeholder="Chave (ex: profiss√£o)"><input class="adv-in" id="mv" placeholder="Valor (ex: Engenheiro)"><button class="adv-btn" onclick="salvarMem(document.getElementById(\'mk\').value,document.getElementById(\'mv\').value);renderAdvBody()"><i class="fas fa-save"></i> Guardar</button></div>';
    h+='<div class="adv-s"><h4>Mem√≥rias ('+ks.length+')</h4>';
    ks.forEach(k=>{h+='<div class="mem-item"><span class="mem-key">'+escHtml(k)+'</span><span class="mem-val">'+escHtml(mem[k].v)+'</span><button class="mem-del" onclick="removerMem(\''+escHtml(k)+'\')">√ó</button></div>';});
    h+='</div><button class="adv-btn" style="color:#ef4444" onclick="limparMem()"><i class="fas fa-trash"></i> Apagar Tudo</button>';
  }else if(advTab==='conv'){
    h+='<div class="adv-s"><h4>Backup & Restauro</h4><button class="adv-btn" onclick="backupAll()"><i class="fas fa-download"></i> Backup Completo</button><button class="adv-btn" onclick="restoreAll()"><i class="fas fa-upload"></i> Restaurar</button></div>';
    h+='<div class="adv-s"><h4>Utilizador</h4><input class="adv-in" id="uname-edit" value="'+escHtml(userName||'')+'" placeholder="Nome"><button class="adv-btn" onclick="var n=document.getElementById(\'uname-edit\').value.trim();if(n){userName=n;localStorage.setItem(\'zn_username\',n);document.getElementById(\'uname\').textContent=n;document.getElementById(\'user-initial\').textContent=n.charAt(0).toUpperCase();document.getElementById(\'welcome-name\').textContent=n;toast(\'Nome atualizado!\',\'ok\');}"><i class="fas fa-user"></i> Atualizar</button></div>';
    h+='<div class="adv-s"><h4>Stats</h4><div style="font-size:12px;color:var(--text-secondary)">Conversas: '+convs.length+'<br>Mensagens: '+convs.reduce((a,c)=>a+c.messages.length,0)+'</div></div>';
  }else if(advTab==='kb'){
    var kb=getKB();
    h+='<div class="adv-s"><h4>Adicionar Conhecimento</h4><input class="adv-in" id="kbt" placeholder="T√≠tulo"><textarea class="adv-in" id="kbc" rows="3" placeholder="Conte√∫do..."></textarea><button class="adv-btn" onclick="if(addKB(document.getElementById(\'kbt\').value,document.getElementById(\'kbc\').value))renderAdvBody()"><i class="fas fa-plus"></i> Adicionar</button></div>';
    h+='<div class="adv-s"><h4>KB ('+kb.length+')</h4>';kb.forEach(d=>{h+='<div class="mem-item"><span class="mem-key" style="flex:1">'+escHtml(d.titulo)+'</span><button class="mem-del" onclick="remKB(\''+d.id+'\')">√ó</button></div>';});h+='</div>';
    h+='<div class="adv-s"><h4>Mem√≥ria de F√°brica</h4><button class="adv-btn" onclick="loadFactoryMemory().then(()=>toast(\'Recarregado!\',\'ok\'))"><i class="fas fa-sync"></i> Recarregar cm.json</button><button class="adv-btn" onclick="exportCM()"><i class="fas fa-download"></i> Exportar cm.json</button>'+(factoryMemory?'<div style="font-size:11px;color:#22c55e;margin-top:5px"><i class="fas fa-check-circle"></i> cm.json carregado</div>':'')+'</div>';
  }else if(advTab==='sys'){
    h+='<div class="adv-s"><h4>Busca Web</h4><button class="adv-btn" onclick="toggleWebMode();closeAdv()"><i class="fas fa-globe" style="color:#60a5fa"></i> '+(webSearchMode?'Desativar':'Ativar')+' Modo Web</button></div>';
    h+='<div class="adv-s"><h4>Pensamento Profundo</h4><button class="adv-btn" onclick="togglePensarMode();closeAdv()"><i class="fas fa-brain" style="color:#a855f7"></i> '+(pensarMode?'Desativar':'Ativar')+' Pensar</button><button class="adv-btn" onclick="toggleThinkPanel();closeAdv()"><i class="fas fa-eye"></i> Ver Racioc√≠nio</button></div>';
    h+='<div class="adv-s"><h4>Gera√ß√£o de √Åudio</h4><button class="adv-btn" onclick="closeAdv();inputEl.focus();toast(\'Escreve o texto e clica em √Åudio!\',\'ok\')"><i class="fas fa-music" style="color:#ec4899"></i> Gerar √Åudio TTS</button></div>';
    h+='<div class="adv-s"><h4>C√¢mera</h4><button class="adv-btn" onclick="toggleCamera();closeAdv()"><i class="fas fa-camera" style="color:#06b6d4"></i> '+(cameraOn?'Parar':'Iniciar')+' C√¢mera</button></div>';
    h+='<div class="adv-s"><h4>Modelos</h4><select class="adv-in" onchange="document.getElementById(\'model-sel\').value=this.value;toast(\'Modelo alterado!\',\'ok\')"><option value="openai">OpenAI GPT-4</option><option value="qwen-coder">Qwen Coder</option><option value="openai-large">OpenAI Large</option><option value="mistral">Mistral</option><option value="deepseek">DeepSeek</option></select></div>';
  }else if(advTab==='sec'){
    h+='<div class="adv-s"><h4>Modo Criador (IUD)</h4>';
    if(creatorMode){h+='<div style="color:var(--accent-primary);font-size:12px;margin-bottom:10px">‚úì Modo Criador Ativo</div><button class="adv-btn" onclick="exportCM()"><i class="fas fa-download"></i> Exportar cm.json</button><button class="adv-btn" style="color:#ef4444" onclick="disableCreator()"><i class="fas fa-sign-out-alt"></i> Sair</button>';}
    else{h+='<input class="adv-in" type="password" id="cpwd" placeholder="Senha..."><button class="adv-btn" onclick="checkCreatorPwd(document.getElementById(\'cpwd\').value)"><i class="fas fa-key"></i> Entrar</button>';}
    h+='</div><div class="adv-s"><h4>Resetar</h4><button class="adv-btn" style="color:#ef4444" onclick="if(confirm(\'Apagar tudo?\')){localStorage.clear();location.reload();}"><i class="fas fa-exclamation-triangle"></i> Resetar Tudo</button></div>';
  }
  body.innerHTML=h;
}

// ==========================================
// TOAST
// ==========================================
function toast(msg,type){var el=document.getElementById('toast');if(!el)return;el.textContent=msg;el.className='toast show '+(type||'ok');clearTimeout(el._t);el._t=setTimeout(()=>el.classList.remove('show'),3200);}

// ==========================================
// MIC
// ==========================================
var micBtn=document.getElementById('mic-btn'),micRec=null,micOn=false;
if('SpeechRecognition'in window||'webkitSpeechRecognition'in window){
  var SRC=window.SpeechRecognition||window.webkitSpeechRecognition;micRec=new SRC();micRec.lang='pt-PT';
  micRec.onresult=e=>{inputEl.value=e.results[0][0].transcript;autoResize(inputEl);micOn=false;micBtn.style.color='';};
  micRec.onerror=()=>{micOn=false;micBtn.style.color='';};micRec.onend=()=>{micOn=false;micBtn.style.color='';}
  micBtn.onclick=()=>{if(micOn){micRec.stop();micOn=false;micBtn.style.color='';}else{try{micRec.start();micOn=true;micBtn.style.color='var(--accent-primary)';toast('A ouvir...','ok');}catch(e){}}};
}else{if(micBtn)micBtn.style.opacity='0.3';}

showWelcome();
</script>
</body>
</html>
