<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>IA-Zenia v3</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&family=Sora:wght@300;400;600;700;800&family=Orbitron:wght@400;700;900&family=Nunito:wght@400;600;700;800&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;600&family=DM+Sans:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700;800&family=Lexend:wght@300;400;500;600;700&family=Figtree:wght@300;400;500;600;700&display=swap" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
:root {
  --bg-primary:#0b0d11;--bg-secondary:#111318;--bg-tertiary:#151b2d;--bg-input:#151c2e;
  --border-color:#1e2330;--border-accent:#252c3b;--text-primary:#e5e7eb;--text-secondary:#9ca3af;
  --text-muted:#6b7280;--accent-primary:#3b5bdb;--accent-secondary:#7c3aed;--accent-glow:rgba(59,91,219,0.25);
  --msg-ai-bg:transparent;--msg-user-bg:#1d3461;--msg-user-text:#e8f0fe;
  --sidebar-bg:#0f1117;--topbar-bg:#0b0d11;--send-btn:#3b5bdb;--send-btn-hover:#4c6ef5;--user-av:#1e3a5f;
  --font-ui:'Plus Jakarta Sans','Outfit',system-ui,sans-serif;--font-msg:'DM Sans','Plus Jakarta Sans',sans-serif;
  --font-code:'JetBrains Mono',monospace;--radius-main:14px;--shadow-main:0 4px 24px rgba(0,0,0,0.4);
}
[data-theme="cyberpunk"]{--bg-primary:#0a0010;--bg-secondary:#0d0018;--bg-tertiary:#110022;--bg-input:#0f0020;--border-color:#2a0050;--border-accent:#3d0070;--text-primary:#f0e6ff;--text-secondary:#b892ff;--text-muted:#7c52cc;--accent-primary:#bf00ff;--accent-secondary:#00f5ff;--accent-glow:rgba(191,0,255,0.25);--msg-ai-bg:transparent;--msg-user-bg:#1a003a;--msg-user-text:#e8d5ff;--sidebar-bg:#0d0018;--topbar-bg:#080012;--send-btn:#bf00ff;--send-btn-hover:#d333ff;--user-av:#330066;--font-ui:'Orbitron','Space Mono',monospace;--font-msg:'Space Mono',monospace;--radius-main:4px;}
[data-theme="aurora"]{--bg-primary:#020f0a;--bg-secondary:#041a10;--bg-tertiary:#062018;--bg-input:#052818;--border-color:#0d3d20;--border-accent:#155230;--text-primary:#d1fae5;--text-secondary:#6ee7b7;--text-muted:#34d399;--accent-primary:#10b981;--accent-secondary:#06b6d4;--accent-glow:rgba(16,185,129,0.25);--msg-ai-bg:transparent;--msg-user-bg:#063d20;--msg-user-text:#d1fae5;--sidebar-bg:#041a10;--topbar-bg:#020f0a;--send-btn:#10b981;--send-btn-hover:#34d399;--user-av:#064e2a;--font-ui:'Nunito',system-ui,sans-serif;--font-msg:'Nunito',sans-serif;--radius-main:18px;}
[data-theme="solar"]{--bg-primary:#faf8f4;--bg-secondary:#f3f0e8;--bg-tertiary:#ece8dc;--bg-input:#ede9de;--border-color:#d8d0bc;--border-accent:#c5baa8;--text-primary:#2c2416;--text-secondary:#5a4e38;--text-muted:#8a7a60;--accent-primary:#c4862a;--accent-secondary:#d44a00;--accent-glow:rgba(196,134,42,0.15);--msg-ai-bg:transparent;--msg-user-bg:#c4862a;--msg-user-text:#fff8ee;--sidebar-bg:#f3f0e8;--topbar-bg:#faf8f4;--send-btn:#c4862a;--send-btn-hover:#d4922a;--user-av:#7a4a10;--font-ui:'Playfair Display',serif;--font-msg:'DM Sans',sans-serif;--radius-main:10px;}
[data-theme="bloodmoon"]{--bg-primary:#0d0505;--bg-secondary:#140808;--bg-tertiary:#1a0a0a;--bg-input:#180808;--border-color:#3a0f0f;--border-accent:#4d1515;--text-primary:#ffe4e4;--text-secondary:#f87171;--text-muted:#dc2626;--accent-primary:#ef4444;--accent-secondary:#f97316;--accent-glow:rgba(239,68,68,0.25);--msg-ai-bg:transparent;--msg-user-bg:#3a1010;--msg-user-text:#ffe4e4;--sidebar-bg:#140808;--topbar-bg:#0d0505;--send-btn:#ef4444;--send-btn-hover:#f87171;--user-av:#4d1515;--font-ui:'Space Mono',monospace;--font-msg:'Space Mono',monospace;--radius-main:6px;}
[data-theme="ocean"]{--bg-primary:#010d1a;--bg-secondary:#021525;--bg-tertiary:#032030;--bg-input:#03223a;--border-color:#0a3a5a;--border-accent:#0d4e78;--text-primary:#caf0f8;--text-secondary:#90e0ef;--text-muted:#48cae4;--accent-primary:#0096c7;--accent-secondary:#023e8a;--accent-glow:rgba(0,150,199,0.25);--msg-ai-bg:transparent;--msg-user-bg:#023e8a;--msg-user-text:#caf0f8;--sidebar-bg:#021525;--topbar-bg:#010d1a;--send-btn:#0096c7;--send-btn-hover:#00b4d8;--user-av:#03045e;--font-ui:'Outfit',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:16px;}
[data-theme="ember"]{--bg-primary:#0f0800;--bg-secondary:#1a0e00;--bg-tertiary:#261500;--bg-input:#201200;--border-color:#3d2200;--border-accent:#5a3300;--text-primary:#fff3e0;--text-secondary:#ffb347;--text-muted:#e07b00;--accent-primary:#ff6d00;--accent-secondary:#ff9500;--accent-glow:rgba(255,109,0,0.25);--msg-ai-bg:transparent;--msg-user-bg:#5a2e00;--msg-user-text:#fff3e0;--sidebar-bg:#1a0e00;--topbar-bg:#0f0800;--send-btn:#ff6d00;--send-btn-hover:#ff8500;--user-av:#7a3d00;--font-ui:'Sora',sans-serif;--font-msg:'Outfit',sans-serif;--radius-main:12px;}
[data-theme="neon"]{--bg-primary:#050508;--bg-secondary:#09090f;--bg-tertiary:#0d0d16;--bg-input:#0b0b14;--border-color:#1a1a2e;--border-accent:#252540;--text-primary:#f0f0ff;--text-secondary:#a0a0ff;--text-muted:#6060cc;--accent-primary:#4040ff;--accent-secondary:#ff40ff;--accent-glow:rgba(64,64,255,0.3);--msg-ai-bg:transparent;--msg-user-bg:#1a1a4a;--msg-user-text:#e0e0ff;--sidebar-bg:#09090f;--topbar-bg:#050508;--send-btn:#4040ff;--send-btn-hover:#6060ff;--user-av:#1a0030;--font-ui:'Orbitron',monospace;--font-msg:'DM Sans',sans-serif;--radius-main:8px;}
[data-theme="sakura"]{--bg-primary:#fff5f7;--bg-secondary:#ffecf0;--bg-tertiary:#ffe0e8;--bg-input:#ffe8ed;--border-color:#f7c5d0;--border-accent:#f0a0b5;--text-primary:#3d0020;--text-secondary:#8b004a;--text-muted:#c06080;--accent-primary:#e91e8c;--accent-secondary:#ff6b9d;--accent-glow:rgba(233,30,140,0.15);--msg-ai-bg:transparent;--msg-user-bg:#e91e8c;--msg-user-text:#fff5f7;--sidebar-bg:#ffecf0;--topbar-bg:#fff5f7;--send-btn:#e91e8c;--send-btn-hover:#f060a0;--user-av:#8b004a;--font-ui:'Nunito',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:20px;}
[data-theme="slate"]{--bg-primary:#1a1d23;--bg-secondary:#21252d;--bg-tertiary:#272c36;--bg-input:#252b35;--border-color:#32394a;--border-accent:#3d4660;--text-primary:#e2e8f0;--text-secondary:#94a3b8;--text-muted:#64748b;--accent-primary:#38bdf8;--accent-secondary:#818cf8;--accent-glow:rgba(56,189,248,0.2);--msg-ai-bg:transparent;--msg-user-bg:#1e3a5f;--msg-user-text:#e2e8f0;--sidebar-bg:#1c2029;--topbar-bg:#1a1d23;--send-btn:#38bdf8;--send-btn-hover:#7dd3fc;--user-av:#1e3a5f;--font-ui:'Plus Jakarta Sans',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:12px;}
[data-theme="forest"]{--bg-primary:#0a110a;--bg-secondary:#0f180f;--bg-tertiary:#152015;--bg-input:#121a12;--border-color:#203520;--border-accent:#2d4a2d;--text-primary:#d4edda;--text-secondary:#81c784;--text-muted:#4caf50;--accent-primary:#66bb6a;--accent-secondary:#26a69a;--accent-glow:rgba(102,187,106,0.2);--msg-ai-bg:transparent;--msg-user-bg:#1b3a1b;--msg-user-text:#d4edda;--sidebar-bg:#0f180f;--topbar-bg:#0a110a;--send-btn:#66bb6a;--send-btn-hover:#81c784;--user-av:#1b3a1b;--font-ui:'DM Sans',sans-serif;--font-msg:'Outfit',sans-serif;--radius-main:14px;}
[data-theme="violet"]{--bg-primary:#0d0a1a;--bg-secondary:#130f25;--bg-tertiary:#1a1430;--bg-input:#161128;--border-color:#2d2550;--border-accent:#3d3366;--text-primary:#ede8ff;--text-secondary:#b8aaff;--text-muted:#8070cc;--accent-primary:#8b5cf6;--accent-secondary:#ec4899;--accent-glow:rgba(139,92,246,0.25);--msg-ai-bg:transparent;--msg-user-bg:#2d1a5a;--msg-user-text:#ede8ff;--sidebar-bg:#130f25;--topbar-bg:#0d0a1a;--send-btn:#8b5cf6;--send-btn-hover:#a78bfa;--user-av:#2d1a5a;--font-ui:'Outfit',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:16px;}
[data-theme="mint"]{--bg-primary:#f0faf8;--bg-secondary:#e5f7f2;--bg-tertiary:#d5f0ea;--bg-input:#daf0eb;--border-color:#b0ddd6;--border-accent:#80c4b9;--text-primary:#0d2b26;--text-secondary:#1a6b5f;--text-muted:#35a08f;--accent-primary:#0d9488;--accent-secondary:#0891b2;--accent-glow:rgba(13,148,136,0.15);--msg-ai-bg:transparent;--msg-user-bg:#0d9488;--msg-user-text:#f0faf8;--sidebar-bg:#e5f7f2;--topbar-bg:#f0faf8;--send-btn:#0d9488;--send-btn-hover:#14b8a6;--user-av:#0d4d47;--font-ui:'Nunito',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:18px;}
/* NOVOS TEMAS */
[data-theme="midnight"]{--bg-primary:#080c14;--bg-secondary:#0d1221;--bg-tertiary:#121830;--bg-input:#0f1528;--border-color:#1c2440;--border-accent:#263060;--text-primary:#dce8ff;--text-secondary:#8aa8e0;--text-muted:#4a6090;--accent-primary:#4d80e4;--accent-secondary:#b06af0;--accent-glow:rgba(77,128,228,0.25);--msg-ai-bg:transparent;--msg-user-bg:#1a2c5a;--msg-user-text:#dce8ff;--sidebar-bg:#0d1221;--topbar-bg:#080c14;--send-btn:#4d80e4;--send-btn-hover:#6a99f5;--user-av:#1a2c5a;--font-ui:'Lexend',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:16px;}
[data-theme="sand"]{--bg-primary:#faf6f0;--bg-secondary:#f5efe4;--bg-tertiary:#ede4d4;--bg-input:#f0e8d8;--border-color:#d8ccb8;--border-accent:#c0b098;--text-primary:#2a1f0e;--text-secondary:#5c4a28;--text-muted:#8a7050;--accent-primary:#8b5e2a;--accent-secondary:#c4784a;--accent-glow:rgba(139,94,42,0.15);--msg-ai-bg:transparent;--msg-user-bg:#8b5e2a;--msg-user-text:#faf6f0;--sidebar-bg:#f5efe4;--topbar-bg:#faf6f0;--send-btn:#8b5e2a;--send-btn-hover:#a0703a;--user-av:#5c3a18;--font-ui:'Figtree',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:12px;}
[data-theme="zinc"]{--bg-primary:#18181b;--bg-secondary:#1f1f23;--bg-tertiary:#26262c;--bg-input:#232329;--border-color:#36363f;--border-accent:#46464f;--text-primary:#fafafa;--text-secondary:#a1a1aa;--text-muted:#71717a;--accent-primary:#e4e4e7;--accent-secondary:#d4d4d8;--accent-glow:rgba(228,228,231,0.1);--msg-ai-bg:transparent;--msg-user-bg:#3f3f46;--msg-user-text:#fafafa;--sidebar-bg:#18181b;--topbar-bg:#18181b;--send-btn:#52525b;--send-btn-hover:#71717a;--user-av:#3f3f46;--font-ui:'DM Sans',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:10px;}
[data-theme="rose"]{--bg-primary:#0f050a;--bg-secondary:#1a0810;--bg-tertiary:#240c18;--bg-input:#1e0a14;--border-color:#3d1028;--border-accent:#561638;--text-primary:#ffd6e8;--text-secondary:#ff85b0;--text-muted:#cc4478;--accent-primary:#ff3377;--accent-secondary:#ff8c42;--accent-glow:rgba(255,51,119,0.25);--msg-ai-bg:transparent;--msg-user-bg:#3d1030;--msg-user-text:#ffd6e8;--sidebar-bg:#1a0810;--topbar-bg:#0f050a;--send-btn:#ff3377;--send-btn-hover:#ff5590;--user-av:#4d1040;--font-ui:'Sora',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:18px;}
[data-theme="arctic"]{--bg-primary:#f4f8fc;--bg-secondary:#e8f2f9;--bg-tertiary:#dceef8;--bg-input:#e2f0f8;--border-color:#b8d8f0;--border-accent:#90c0e8;--text-primary:#0a1e30;--text-secondary:#1a4a70;--text-muted:#3a7aaa;--accent-primary:#0057b8;--accent-secondary:#00a8cc;--accent-glow:rgba(0,87,184,0.15);--msg-ai-bg:transparent;--msg-user-bg:#0057b8;--msg-user-text:#f4f8fc;--sidebar-bg:#e8f2f9;--topbar-bg:#f4f8fc;--send-btn:#0057b8;--send-btn-hover:#0070e0;--user-av:#003d80;--font-ui:'Lexend',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:14px;}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:var(--bg-primary);color:var(--text-primary);font-family:var(--font-ui);font-size:14px;transition:background .4s,color .4s}
#app{display:flex;height:100vh;width:100%;overflow:hidden;position:relative}
#sidebar{width:260px;min-width:260px;background:var(--sidebar-bg);border-right:1px solid var(--border-color);display:flex;flex-direction:column;height:100vh;transition:all .3s;overflow:hidden;z-index:100;position:relative;flex-shrink:0}
#sidebar.collapsed{width:0;min-width:0;border:none}
#sidebar-inner{width:260px;min-width:260px;display:flex;flex-direction:column;height:100%}
#sidebar-scroll{flex:1;overflow-y:auto}
#sidebar-scroll::-webkit-scrollbar{width:3px}
#sidebar-scroll::-webkit-scrollbar-thumb{background:var(--border-accent);border-radius:4px}
.sb-section{border-bottom:1px solid var(--border-color)}
.sb-section-hdr{width:100%;display:flex;align-items:center;justify-content:space-between;padding:7px 13px;background:transparent;border:none;cursor:pointer;color:var(--text-muted);font-family:var(--font-ui);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;transition:background .15s}
.sb-section-hdr:hover{background:var(--bg-secondary);color:var(--text-primary)}
.sb-section-body{overflow:hidden;transition:max-height .28s ease,opacity .2s;max-height:500px;opacity:1;padding:3px 0 6px}
.sb-section-body.collapsed{max-height:0 !important;opacity:0;padding:0;pointer-events:none}
.sb-chev{transition:transform .25s}
.sb-chev.rotated{transform:rotate(-90deg)}
.sb-item{width:100%;display:flex;align-items:center;gap:7px;padding:5px 13px;background:transparent;border:none;cursor:pointer;color:var(--text-secondary);font-size:12px;text-align:left;font-family:var(--font-ui);transition:background .15s,color .15s;text-decoration:none}
.sb-item:hover{background:var(--bg-secondary);color:var(--text-primary)}
#sidebar-toggle{position:absolute;top:50%;right:-17px;transform:translateY(-50%);background:var(--bg-secondary);border:1px solid var(--border-color);width:17px;height:44px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:101;border-radius:0 7px 7px 0;color:var(--text-muted);transition:background .2s;flex-shrink:0}
#sidebar-toggle:hover{background:var(--border-accent);color:var(--text-primary)}
#mob-toggle{display:none;position:fixed;top:10px;left:10px;z-index:300;background:var(--bg-secondary);border:1px solid var(--border-color);width:36px;height:36px;border-radius:9px;align-items:center;justify-content:center;cursor:pointer;color:var(--text-secondary)}
#mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:190}
#main{flex:1;display:flex;flex-direction:column;min-width:0;height:100vh;overflow:hidden}
#topbar{height:50px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;padding:0 14px;gap:8px;flex-shrink:0;background:var(--topbar-bg)}
.tbLeft{display:flex;align-items:center;gap:7px;flex-wrap:nowrap;min-width:0;overflow:hidden}
.tbRight{display:flex;align-items:center;gap:7px;flex-shrink:0}
#chat-window{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:4px}
#chat-window::-webkit-scrollbar{width:4px}
#chat-window::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:4px}
#input-area{border-top:1px solid var(--border-color);padding:9px 12px;background:var(--topbar-bg);flex-shrink:0}
#input-wrap{max-width:780px;margin:0 auto;background:var(--bg-input);border:1px solid var(--border-accent);border-radius:var(--radius-main);overflow:hidden;transition:border-color .2s}
#input-wrap:focus-within{border-color:var(--accent-primary);box-shadow:0 0 0 3px var(--accent-glow)}
#user-input{width:100%;background:transparent;border:none;outline:none;color:var(--text-primary);font-size:14px;font-family:var(--font-msg);padding:11px 13px 4px;resize:none;max-height:120px;line-height:1.6}
#user-input::placeholder{color:var(--text-muted)}
#input-bottom{display:flex;align-items:center;padding:4px 7px 7px;gap:5px}
#input-bottom-left{display:flex;align-items:center;gap:3px;flex:1}
.ia-btn{background:transparent;border:none;cursor:pointer;color:var(--text-muted);padding:5px 7px;border-radius:7px;font-size:13px;transition:all .2s;display:flex;align-items:center;gap:4px}
.ia-btn:hover{background:var(--border-accent);color:var(--text-primary)}
#send-btn{background:var(--send-btn);border:none;cursor:pointer;color:#fff;padding:7px 14px;border-radius:9px;font-size:13px;font-weight:700;transition:all .2s;display:flex;align-items:center;gap:6px;white-space:nowrap;font-family:var(--font-ui)}
#send-btn:hover{background:var(--send-btn-hover);transform:scale(1.03)}
#send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
.msg-row{display:flex;gap:10px;max-width:780px;width:100%;margin:0 auto;animation:fadeSlideIn .28s ease;padding:3px 0}
@keyframes fadeSlideIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.msg-row.user-row{flex-direction:row-reverse}
.msg-av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;margin-top:3px}
.msg-av.ai{background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary))}
.msg-av.user{background:var(--user-av)}
.msg-bbl{max-width:calc(100% - 48px);padding:10px 14px;border-radius:var(--radius-main);font-size:14.5px;line-height:1.7;word-break:break-word;font-family:var(--font-msg);letter-spacing:0.01em}
.msg-bbl.ai{background:var(--msg-ai-bg);border:none;border-radius:0}
.msg-bbl.user{background:var(--msg-user-bg);color:var(--msg-user-text);border-radius:14px 4px 14px 14px;padding:10px 14px}
.code-block{background:#0d1117;border:1px solid #21262d;border-radius:10px;margin:10px 0;overflow:hidden}
.code-hdr{display:flex;align-items:center;justify-content:space-between;background:#161b22;border-bottom:1px solid #21262d;padding:5px 13px}
.code-lang{font-family:var(--font-code);font-size:11px;text-transform:uppercase;color:#58a6ff;font-weight:700}
.copy-btn{background:#21262d;border:1px solid #30363d;color:#8b949e;border-radius:5px;padding:2px 8px;font-size:11px;cursor:pointer;transition:all .2s}
.copy-btn:hover{background:#30363d;color:#e6edf3}
.code-block pre{margin:0;padding:14px 16px;overflow-x:auto;font-size:13px;line-height:1.65;background:transparent}
.code-block pre code{background:transparent!important;padding:0!important;font-family:var(--font-code)!important}
.inline-code{background:rgba(110,118,129,.15);border-radius:4px;padding:2px 6px;font-family:var(--font-code);font-size:12.5px;border:1px solid rgba(110,118,129,.2)}
.math-block{background:rgba(255,255,255,0.04);border-left:3px solid var(--accent-primary);padding:12px 16px;margin:10px 0;border-radius:0 8px 8px 0;overflow-x:auto;font-size:15px;line-height:2}
.frac-display{display:inline-flex;flex-direction:column;align-items:center;vertical-align:middle;margin:0 3px;font-family:var(--font-msg)}
.frac-num{border-bottom:1.5px solid currentColor;padding:0 3px;text-align:center;font-size:0.9em}
.frac-den{padding:0 3px;text-align:center;font-size:0.9em}
.media-card{background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:11px;overflow:hidden;margin:6px 0;max-width:100%}
.media-card img{width:100%;display:block;max-height:380px;object-fit:cover}
.media-foot{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-top:1px solid var(--border-color);gap:8px}
.media-lbl{font-size:11px;color:var(--text-muted);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mbtn{font-size:11px;padding:3px 9px;border-radius:5px;cursor:pointer;border:1px solid var(--border-accent);background:var(--bg-secondary);color:var(--text-secondary);text-decoration:none;display:inline-flex;align-items:center;gap:4px;transition:all .2s}
.mbtn:hover{background:var(--border-accent);color:var(--text-primary)}
.sbadge{font-size:11px;padding:3px 7px;border-radius:18px;border:1px solid;display:inline-flex;align-items:center;gap:4px;white-space:nowrap}
.s-ok{color:#22c55e;border-color:#22c55e40}
.s-err{color:#ef4444;border-color:#ef444440}
.s-wait{color:var(--text-muted);border-color:var(--border-accent)}
.s-web{background:rgba(59,130,246,.1);border-color:rgba(59,130,246,.3);color:#60a5fa}
.s-creator{background:linear-gradient(90deg,#7c3aed,#db2777);color:#fff;font-size:10px;padding:2px 7px;border-radius:18px;font-weight:700}
#welcome-msg{display:none;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;gap:12px;padding:20px}
.z-logo{font-size:56px;font-weight:900;color:var(--accent-primary);font-family:var(--font-ui);line-height:1;text-shadow:0 0 40px var(--accent-glow);animation:logoPulse 3s ease-in-out infinite}
@keyframes logoPulse{0%,100%{text-shadow:0 0 40px var(--accent-glow)}50%{text-shadow:0 0 80px var(--accent-glow),0 0 120px var(--accent-glow)}}
.tdot{width:7px;height:7px;background:var(--accent-primary);border-radius:50%;animation:tdot 1.2s infinite}
.tdot:nth-child(2){animation-delay:.2s}
.tdot:nth-child(3){animation-delay:.4s}
@keyframes tdot{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}
.spin{width:13px;height:13px;border:2px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}
.adv-panel{position:fixed;top:0;right:0;width:380px;max-width:100vw;height:100vh;background:var(--bg-secondary);border-left:1px solid var(--border-color);z-index:400;display:flex;flex-direction:column;transform:translateX(100%);transition:transform .3s ease}
.adv-panel.open{transform:translateX(0)}
.adv-tab{display:flex;border-bottom:1px solid var(--border-color);flex-shrink:0;overflow-x:auto}
.adv-tab::-webkit-scrollbar{height:0}
.adv-tab button{flex:1;min-width:38px;padding:9px 3px;font-size:11px;color:var(--text-muted);border:none;background:transparent;cursor:pointer;border-bottom:2px solid transparent;font-family:var(--font-ui)}
.adv-tab button.active{color:var(--accent-primary);border-bottom-color:var(--accent-primary);background:var(--accent-glow)}
.adv-body{flex:1;overflow-y:auto;padding:13px}
.adv-s{margin-bottom:16px}
.adv-s h4{font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.07em;margin-bottom:7px;padding-bottom:4px;border-bottom:1px solid var(--border-color)}
.adv-btn{display:flex;align-items:center;gap:7px;width:100%;padding:8px 11px;border-radius:7px;border:1px solid var(--border-color);background:var(--bg-primary);color:var(--text-primary);font-size:12px;cursor:pointer;transition:all .2s;margin-bottom:5px;text-align:left;font-family:var(--font-ui)}
.adv-btn:hover{background:var(--border-accent);border-color:var(--accent-primary)}
.adv-in{width:100%;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:6px;padding:7px 10px;font-size:12px;color:var(--text-primary);outline:none;margin-bottom:6px;font-family:var(--font-msg)}
.adv-in:focus{border-color:var(--accent-primary)}
.adv-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:390}
.adv-ov.show{display:block}
.toast{position:fixed;bottom:18px;right:18px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;padding:9px 15px;font-size:13px;color:var(--text-primary);z-index:9999;opacity:0;transform:translateY(10px);transition:all .3s;pointer-events:none;max-width:300px;font-family:var(--font-ui)}
.toast.show{opacity:1;transform:translateY(0)}
.toast.ok{border-color:#22c55e60;color:#22c55e}
.toast.err{border-color:#ef444460;color:#ef4444}
.toast.warn{border-color:#fbbf2460;color:#fbbf24}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:500;overflow-y:auto;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal-box{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:16px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,0.8);width:100%;max-width:540px;margin:20px;position:relative}
.modal-close{position:absolute;top:14px;right:14px;background:none;border:none;color:var(--text-muted);font-size:22px;cursor:pointer;line-height:1;padding:4px}
.modal-close:hover{color:var(--text-primary)}
#setup-screen{position:fixed;inset:0;background:var(--bg-primary);z-index:1000;display:flex;align-items:center;justify-content:center;flex-direction:column}
.setup-card{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:20px;padding:36px 32px;max-width:490px;width:100%;margin:16px;text-align:center;box-shadow:var(--shadow-main)}
.setup-logo{font-size:64px;font-weight:900;color:var(--accent-primary);font-family:var(--font-ui);margin-bottom:8px;animation:logoPulse 3s ease-in-out infinite}
.setup-input{width:100%;background:var(--bg-primary);border:1px solid var(--border-accent);border-radius:10px;padding:12px 14px;font-size:15px;color:var(--text-primary);outline:none;font-family:var(--font-msg);transition:border-color .2s,box-shadow .2s}
.setup-input:focus{border-color:var(--accent-primary);box-shadow:0 0 0 3px var(--accent-glow)}
.setup-btn{width:100%;padding:13px;background:var(--send-btn);border:none;color:#fff;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;font-family:var(--font-ui);margin-top:6px}
.setup-btn:hover{background:var(--send-btn-hover);transform:translateY(-1px)}
.theme-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:7px;margin:10px 0 16px}
.theme-dot{width:100%;aspect-ratio:1;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all .2s;position:relative;overflow:hidden}
.theme-dot.active{border-color:#fff;transform:scale(1.1);box-shadow:0 0 12px rgba(255,255,255,.3)}
.theme-dot-inner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:14px}
.theme-name{font-size:8px;text-align:center;color:var(--text-muted);margin-top:3px;font-weight:600;text-transform:uppercase}
.theme-pill{display:flex;align-items:center;gap:4px;padding:4px 9px;border-radius:18px;border:1px solid var(--border-accent);background:var(--bg-secondary);cursor:pointer;font-size:11px;color:var(--text-secondary);transition:all .2s}
.theme-pill:hover{border-color:var(--accent-primary);color:var(--text-primary)}
.resp-actions{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap}
.ra-btn{padding:4px 9px;font-size:11px;background:transparent;border:1px solid var(--border-accent);color:var(--text-muted);border-radius:5px;cursor:pointer;transition:all .2s;font-family:var(--font-ui)}
.ra-btn:hover{background:var(--border-accent);color:var(--text-primary)}
.mem-item{display:flex;align-items:flex-start;gap:6px;padding:7px 9px;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:7px;margin-bottom:4px;font-size:12px}
.mem-key{color:var(--accent-primary);font-weight:600;min-width:65px;flex-shrink:0}
.mem-val{color:var(--text-secondary);flex:1;word-break:break-word;max-height:38px;overflow:hidden}
.mem-del{color:var(--text-muted);cursor:pointer;flex-shrink:0;background:none;border:none;padding:1px 3px}
.mem-del:hover{color:#ef4444}
#plus-menu{display:none;position:absolute;bottom:calc(100% + 8px);left:0;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:11px;padding:6px 0;min-width:210px;z-index:100;box-shadow:var(--shadow-main)}
.pmenu-item{width:100%;padding:9px 15px;border:none;background:transparent;color:var(--text-secondary);text-align:left;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:9px;transition:all .2s;font-family:var(--font-ui)}
.pmenu-item:hover{background:var(--border-accent);color:var(--text-primary)}
#model-sel{background:var(--bg-secondary);border:1px solid var(--border-color);color:var(--accent-primary);font-size:11px;border-radius:6px;padding:3px 6px;outline:none;cursor:pointer;max-width:130px;font-family:var(--font-ui)}
.pers-btn{padding:8px 12px;border-radius:7px;background:var(--bg-primary);color:var(--text-muted);border:1px solid var(--border-accent);cursor:pointer;font-size:12px;transition:all .2s;font-family:var(--font-ui)}
.pers-btn.active{background:var(--accent-glow);color:var(--accent-primary);border-color:var(--accent-primary)}
.web-indicator{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:14px;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);color:#60a5fa;font-size:11px;margin-bottom:8px}
.voice-slider{width:100%;accent-color:var(--accent-primary);margin:4px 0}
.voice-preview-btn{padding:6px 12px;background:var(--accent-glow);border:1px solid var(--accent-primary);color:var(--accent-primary);border-radius:7px;font-size:12px;cursor:pointer;font-family:var(--font-ui);transition:all .2s}
.voice-preview-btn:hover{background:var(--accent-primary);color:#fff}
.download-zenia-btn{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:18px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));color:#fff;font-size:12px;font-weight:700;text-decoration:none;transition:all .2s;border:none;cursor:pointer;white-space:nowrap}
.download-zenia-btn:hover{opacity:.85;transform:scale(1.03)}
/* Image upload preview */
.img-preview-wrap{position:relative;display:inline-block;margin-bottom:6px}
.img-preview-wrap img{max-width:220px;max-height:160px;border-radius:8px;display:block;border:2px solid var(--accent-primary)}
.img-preview-wrap .remove-img{position:absolute;top:-8px;right:-8px;background:#ef4444;border:none;border-radius:50%;width:22px;height:22px;color:#fff;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.vision-result{background:rgba(255,255,255,0.03);border:1px solid var(--border-color);border-radius:10px;padding:13px;margin:8px 0}
/* Audio player */
.audio-player-card{background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:11px;overflow:hidden;margin:6px 0}
.audio-waveform{height:60px;background:linear-gradient(135deg,var(--bg-secondary),var(--bg-tertiary));display:flex;align-items:center;justify-content:center;gap:3px;padding:0 16px}
.wave-bar{width:3px;border-radius:2px;background:var(--accent-primary);animation:waveAnim 1.2s ease-in-out infinite;opacity:0.6}
.wave-bar:nth-child(2n){animation-delay:.2s;height:60%}
.wave-bar:nth-child(3n){animation-delay:.4s;height:40%}
.wave-bar:nth-child(4n){animation-delay:.1s;height:80%}
.wave-bar:nth-child(5n){animation-delay:.3s;height:50%}
@keyframes waveAnim{0%,100%{transform:scaleY(1)}50%{transform:scaleY(1.6)}}
.audio-player-card.playing .wave-bar{opacity:1}
@media(max-width:768px){
  #sidebar{position:fixed;left:0;top:0;height:100%;transform:translateX(-100%);z-index:200;width:270px;min-width:270px}
  #sidebar.mob-open{transform:translateX(0)}
  #sidebar.collapsed{transform:translateX(-100%)}
  #sidebar-toggle{display:none}
  #mob-toggle{display:flex}
  #mob-overlay.show{display:block}
  #main{width:100%}
  #topbar{padding:0 9px 0 50px;height:46px}
  .adv-panel{width:100vw}
  #input-area{padding:7px 8px}
  .theme-grid{grid-template-columns:repeat(6,1fr)}
  .download-zenia-btn span{display:none}
}
</style>
</head>
<body data-theme="dark">

<!-- SETUP SCREEN -->
<div id="setup-screen" style="display:none">
  <div class="setup-card">
    <div class="setup-logo">Z</div>
    <div style="font-size:22px;font-weight:800;margin-bottom:4px">Bem-vindo √† IA-Zenia v3</div>
    <div style="font-size:12px;color:var(--text-muted);margin-bottom:24px;line-height:1.6">Antes de come√ßarmos, deixa-me conhecer-te<br>e escolher como preferes que eu apare√ßa.</div>
    <div style="margin-bottom:20px;text-align:left">
      <label style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:6px">Como te chamas?</label>
      <input class="setup-input" id="setup-name" type="text" placeholder="Escreve o teu nome..." maxlength="30" autofocus onkeydown="if(event.key==='Enter')completeSetup()">
      <div style="font-size:11px;color:var(--text-muted);margin-top:5px">A Zenia vai chamar-te por este nome nas conversas.</div>
    </div>
    <div style="margin-bottom:20px;text-align:left">
      <label style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:8px">Escolhe o teu tema</label>
      <div class="theme-grid" id="setup-theme-grid"></div>
    </div>
    <button class="setup-btn" onclick="completeSetup()"><i class="fas fa-arrow-right"></i> Iniciar com a Zenia</button>
  </div>
</div>

<!-- THEME MODAL -->
<div id="theme-modal" class="modal-overlay">
  <div class="modal-box" style="max-width:500px">
    <button class="modal-close" onclick="closeThemeModal()">&times;</button>
    <h3 style="margin-bottom:16px;font-size:16px;font-weight:700">üé® Trocar Tema</h3>
    <div class="theme-grid" id="modal-theme-grid" style="grid-template-columns:repeat(6,1fr)"></div>
    <div style="font-size:11px;color:var(--text-muted);margin-top:4px">O tema √© guardado automaticamente. Total: 18 temas dispon√≠veis.</div>
  </div>
</div>

<!-- PERSONALITY / VOICE MODAL -->
<div id="personality-modal" class="modal-overlay">
  <div class="modal-box" style="max-width:580px">
    <button class="modal-close" onclick="closePersonality()">&times;</button>
    <h3 style="margin-bottom:16px;font-size:16px;font-weight:700">Personalidade &amp; Voz Natural da Z√©nia</h3>
    
    <div style="margin-bottom:16px">
      <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px">Tom de Conversa</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button onclick="setPersonality('amigavel')" class="pers-btn active" data-tone="amigavel">üòä Amig√°vel</button>
        <button onclick="setPersonality('profissional')" class="pers-btn" data-tone="profissional">üíº Profissional</button>
        <button onclick="setPersonality('humorista')" class="pers-btn" data-tone="humorista">üòÑ Humorista</button>
        <button onclick="setPersonality('tecnico')" class="pers-btn" data-tone="tecnico">‚öôÔ∏è T√©cnico</button>
        <button onclick="setPersonality('criativo')" class="pers-btn" data-tone="criativo">üé® Criativo</button>
      </div>
    </div>

    <div style="margin-bottom:16px">
      <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px">N√≠vel de Detalhe</div>
      <div style="display:flex;gap:7px">
        <button onclick="setDetailLevel('curto')" class="pers-btn" data-level="curto" style="flex:1">Curto</button>
        <button onclick="setDetailLevel('medio')" class="pers-btn active" data-level="medio" style="flex:1">M√©dio</button>
        <button onclick="setDetailLevel('detalhado')" class="pers-btn" data-level="detalhado" style="flex:1">Detalhado</button>
      </div>
    </div>

    <!-- VOZ NATURAL AVAN√áADA -->
    <div style="border-top:1px solid var(--border-color);padding-top:16px;margin-bottom:16px">
      <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:12px">üîä Configura√ß√£o de Voz Natural</div>
      
      <div style="margin-bottom:10px">
        <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:5px">Voz</label>
        <select id="voice-select" class="adv-in" style="margin-bottom:0" onchange="updateVoiceConfig()">
          <option value="">Carregando vozes...</option>
        </select>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div>
          <label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:4px">Velocidade: <strong id="voice-rate-val">1.0</strong>x</label>
          <input type="range" class="voice-slider" id="voice-rate" min="0.5" max="2" step="0.05" value="1" oninput="document.getElementById('voice-rate-val').textContent=parseFloat(this.value).toFixed(2);updateVoiceConfig()">
          <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-muted)"><span>Lento</span><span>R√°pido</span></div>
        </div>
        <div>
          <label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:4px">Tom: <strong id="voice-pitch-val">1.0</strong></label>
          <input type="range" class="voice-slider" id="voice-pitch" min="0.5" max="2" step="0.05" value="1" oninput="document.getElementById('voice-pitch-val').textContent=parseFloat(this.value).toFixed(2);updateVoiceConfig()">
          <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-muted)"><span>Grave</span><span>Agudo</span></div>
        </div>
        <div>
          <label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:4px">Volume: <strong id="voice-vol-val">1.0</strong></label>
          <input type="range" class="voice-slider" id="voice-vol" min="0" max="1" step="0.05" value="1" oninput="document.getElementById('voice-vol-val').textContent=parseFloat(this.value).toFixed(2);updateVoiceConfig()">
        </div>
        <div>
          <label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:4px">Pausa entre frases (ms): <strong id="voice-pause-val">300</strong></label>
          <input type="range" class="voice-slider" id="voice-pause" min="0" max="1200" step="50" value="300" oninput="document.getElementById('voice-pause-val').textContent=this.value;updateVoiceConfig()">
        </div>
      </div>

      <!-- Presets de naturalidade -->
      <div style="margin-bottom:12px">
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">Presets de Naturalidade</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button onclick="applyVoicePreset('natural')" class="mbtn" style="font-size:11px">üó£Ô∏è Natural</button>
          <button onclick="applyVoicePreset('calma')" class="mbtn" style="font-size:11px">üòå Calma</button>
          <button onclick="applyVoicePreset('energica')" class="mbtn" style="font-size:11px">‚ö° En√©rgica</button>
          <button onclick="applyVoicePreset('narrativa')" class="mbtn" style="font-size:11px">üìñ Narrativa</button>
          <button onclick="applyVoicePreset('crianca')" class="mbtn" style="font-size:11px">üë∂ Suave</button>
        </div>
      </div>

      <!-- Op√ß√µes avan√ßadas de naturalidade -->
      <div style="background:var(--bg-primary);border:1px solid var(--border-color);border-radius:8px;padding:10px;margin-bottom:10px">
        <div style="font-size:11px;font-weight:700;color:var(--text-secondary);margin-bottom:8px">Op√ß√µes de Naturalidade</div>
        <label style="display:flex;align-items:center;gap:7px;cursor:pointer;margin-bottom:6px;font-size:12px;color:var(--text-secondary)">
          <input type="checkbox" id="voice-chunked" checked onchange="updateVoiceConfig()" style="accent-color:var(--accent-primary)">
          Pausas naturais entre frases
        </label>
        <label style="display:flex;align-items:center;gap:7px;cursor:pointer;margin-bottom:6px;font-size:12px;color:var(--text-secondary)">
          <input type="checkbox" id="voice-variation" onchange="updateVoiceConfig()" style="accent-color:var(--accent-primary)">
          Varia√ß√£o de entoa√ß√£o ligeira
        </label>
        <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:12px;color:var(--text-secondary)">
          <input type="checkbox" id="voice-skip-code" checked onchange="updateVoiceConfig()" style="accent-color:var(--accent-primary)">
          Ignorar blocos de c√≥digo na leitura
        </label>
      </div>

      <div style="display:flex;gap:8px">
        <button class="voice-preview-btn" onclick="previewVoice()" style="flex:1"><i class="fas fa-play"></i> Testar Voz</button>
        <button class="voice-preview-btn" onclick="stopVoice()" style="flex:1;background:rgba(239,68,68,.1);border-color:#ef4444;color:#ef4444"><i class="fas fa-stop"></i> Parar</button>
      </div>
    </div>

    <div style="background:var(--bg-primary);border:1px solid var(--border-color);border-radius:8px;padding:10px;font-size:12px;margin-bottom:14px">
      Tom: <span id="current-tone" style="color:var(--accent-primary);font-weight:600">Amig√°vel</span> &nbsp;|&nbsp;
      Detalhe: <span id="current-detail" style="color:var(--accent-primary);font-weight:600">M√©dio</span>
    </div>
    <button onclick="closePersonality()" style="width:100%;padding:10px;background:var(--send-btn);border:none;color:#fff;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font-ui)">‚úì Confirmar</button>
  </div>
</div>

<!-- VISION MODAL -->
<div id="vision-modal" class="modal-overlay">
  <div class="modal-box">
    <button class="modal-close" onclick="closeVisionModal()">&times;</button>
    <h3 style="margin-bottom:6px;font-size:16px;font-weight:700"><i class="fas fa-eye" style="color:#10b981;margin-right:8px"></i>An√°lise de Imagem com IA</h3>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Carrega uma imagem e a Zenia analisa-a detalhadamente.</p>
    <div id="vision-drop-zone" style="border:2px dashed var(--border-accent);border-radius:10px;padding:28px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:14px"
      onclick="document.getElementById('vision-file').click()"
      ondragover="event.preventDefault();this.style.borderColor='var(--accent-primary)'"
      ondragleave="this.style.borderColor=''"
      ondrop="event.preventDefault();this.style.borderColor='';loadVisionFileDrop(event)">
      <div id="vision-preview" style="display:none;margin-bottom:10px"><img id="vision-img-preview" style="max-height:180px;max-width:100%;border-radius:8px;object-fit:contain"></div>
      <div id="vision-placeholder">
        <i class="fas fa-cloud-upload-alt" style="font-size:32px;color:var(--accent-primary);margin-bottom:8px;display:block"></i>
        <div style="font-size:13px;font-weight:600">Arrasta ou clica para carregar</div>
        <div style="font-size:11px;color:var(--text-muted);margin-top:4px">JPG, PNG, WebP, GIF</div>
      </div>
    </div>
    <input type="file" id="vision-file" accept="image/*" style="display:none" onchange="loadVisionPreview(event)">
    <input class="adv-in" id="vision-question" placeholder="O que queres saber sobre a imagem? (opcional)">
    <button onclick="analyzeVision()" id="vision-analyze-btn" style="width:100%;padding:11px;background:var(--send-btn);border:none;color:#fff;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font-ui)">
      <i class="fas fa-search"></i> Analisar com IA
    </button>
    <div id="vision-result" style="display:none;margin-top:14px"></div>
  </div>
</div>

<!-- WEB SEARCH MODAL -->
<div id="websearch-modal" class="modal-overlay">
  <div class="modal-box" style="max-width:560px">
    <button class="modal-close" onclick="document.getElementById('websearch-modal').classList.remove('open')">&times;</button>
    <h3 style="margin-bottom:6px;font-size:16px;font-weight:700"><i class="fas fa-search" style="color:#60a5fa;margin-right:8px"></i>Pesquisa Web Avan√ßada</h3>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:14px">Pesquisa e navega em p√°ginas web com IA.</p>
    <div style="margin-bottom:10px">
      <select id="search-engine" class="adv-in" style="margin-bottom:8px">
        <option value="duckduckgo">DuckDuckGo (Gr√°tis)</option>
        <option value="bing">Bing Search</option>
        <option value="google">Google (via SerpAPI)</option>
      </select>
      <div style="display:flex;gap:6px">
        <input class="adv-in" id="web-query" placeholder="O que queres pesquisar?" style="flex:1;margin-bottom:0">
        <button onclick="doWebSearch()" style="padding:7px 14px;background:var(--send-btn);border:none;color:#fff;border-radius:6px;cursor:pointer;font-size:12px;font-family:var(--font-ui);flex-shrink:0">Pesquisar</button>
      </div>
    </div>
    <div style="margin-bottom:10px">
      <label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:4px">Navegar para URL:</label>
      <div style="display:flex;gap:6px">
        <input class="adv-in" id="web-url" placeholder="https://..." style="flex:1;margin-bottom:0">
        <button onclick="doFetchURL()" style="padding:7px 14px;background:var(--border-accent);border:1px solid var(--border-color);color:var(--text-primary);border-radius:6px;cursor:pointer;font-size:12px;font-family:var(--font-ui);flex-shrink:0">Ir</button>
      </div>
    </div>
    <div id="websearch-results" style="max-height:280px;overflow-y:auto"></div>
  </div>
</div>

<!-- ARTIFACTS MODAL -->
<div id="artifacts-modal" class="modal-overlay">
  <div class="modal-box" style="max-width:760px;height:90vh;display:flex;flex-direction:column;padding:0">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;flex-shrink:0">
      <h3 style="font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px"><i class="fas fa-magic" style="color:#8b5cf6"></i> Artefatos</h3>
      <div style="display:flex;gap:7px;align-items:center">
        <button onclick="createNewArtifact()" style="padding:5px 12px;background:var(--send-btn);border:none;color:#fff;border-radius:7px;font-size:12px;cursor:pointer;font-family:var(--font-ui)"><i class="fas fa-plus"></i> Novo</button>
        <button class="modal-close" style="position:static" onclick="document.getElementById('artifacts-modal').classList.remove('open')">&times;</button>
      </div>
    </div>
    <div style="display:flex;flex:1;overflow:hidden">
      <div id="artifacts-list" style="width:200px;flex-shrink:0;border-right:1px solid var(--border-color);overflow-y:auto;padding:8px"></div>
      <div style="flex:1;display:flex;flex-direction:column;overflow:hidden">
        <div id="artifact-editor-area" style="flex:1;display:flex;flex-direction:column;overflow:hidden">
          <div style="padding:10px 14px;border-bottom:1px solid var(--border-color);display:flex;gap:8px;align-items:center;flex-shrink:0">
            <input id="artifact-title" placeholder="Nome do artefato..." style="flex:1;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:6px;padding:5px 9px;font-size:12px;color:var(--text-primary);outline:none;font-family:var(--font-msg)">
            <select id="artifact-type" style="background:var(--bg-primary);border:1px solid var(--border-color);border-radius:6px;padding:5px 9px;font-size:12px;color:var(--text-primary);outline:none">
              <option value="html">HTML</option><option value="markdown">Markdown</option>
              <option value="code">C√≥digo</option><option value="text">Texto</option>
            </select>
            <button onclick="saveArtifact()" style="padding:5px 11px;background:var(--send-btn);border:none;color:#fff;border-radius:6px;font-size:12px;cursor:pointer"><i class="fas fa-save"></i></button>
            <button onclick="runArtifact()" style="padding:5px 11px;background:#22c55e;border:none;color:#fff;border-radius:6px;font-size:12px;cursor:pointer"><i class="fas fa-play"></i></button>
          </div>
          <textarea id="artifact-editor" style="flex:1;background:var(--bg-primary);border:none;outline:none;color:var(--text-primary);font-family:var(--font-code);font-size:13px;padding:14px;resize:none;line-height:1.6" placeholder="Escreve ou pede √† Zenia para gerar c√≥digo aqui..." spellcheck="false"></textarea>
        </div>
        <div id="artifact-preview" style="flex:1;display:none;overflow:hidden;border-top:1px solid var(--border-color)">
          <div style="padding:6px 10px;background:var(--bg-secondary);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border-color)">
            <span style="font-size:11px;color:var(--text-muted)">Pr√©-visualiza√ß√£o</span>
            <button onclick="closeArtifactPreview()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:16px">&times;</button>
          </div>
          <iframe id="artifact-iframe" style="width:100%;height:calc(100% - 35px);border:none;background:#fff"></iframe>
        </div>
      </div>
    </div>
    <div style="padding:8px 14px;border-top:1px solid var(--border-color);display:flex;gap:7px;flex-shrink:0">
      <input id="artifact-ai-prompt" placeholder="Pede √† Zenia para gerar/melhorar este artefato..." style="flex:1;background:var(--bg-input);border:1px solid var(--border-accent);border-radius:7px;padding:7px 11px;font-size:12px;color:var(--text-primary);outline:none;font-family:var(--font-msg)">
      <button onclick="aiGenerateArtifact()" style="padding:7px 14px;background:var(--send-btn);border:none;color:#fff;border-radius:7px;font-size:12px;cursor:pointer;font-family:var(--font-ui);white-space:nowrap"><span class="spin" id="artifact-spin" style="display:none"></span> <i class="fas fa-wand-magic-sparkles"></i> Gerar</button>
    </div>
  </div>
</div>

<!-- CODE STUDIO MODAL -->
<div id="codestudio-modal" class="modal-overlay">
  <div class="modal-box" style="max-width:800px;height:90vh;display:flex;flex-direction:column;padding:0">
    <div style="padding:14px 18px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;flex-shrink:0">
      <h3 style="font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px"><i class="fas fa-code" style="color:#60a5fa"></i> Zenia Code Studio</h3>
      <div style="display:flex;gap:6px;align-items:center">
        <select id="cs-lang" style="background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;padding:4px 8px;font-size:11px;color:var(--text-primary);outline:none">
          <option>python</option><option>javascript</option><option>html</option><option>css</option>
          <option>java</option><option>c</option><option>cpp</option><option>sql</option><option>bash</option><option>php</option>
        </select>
        <button onclick="csRun()" style="padding:5px 11px;background:#22c55e;border:none;color:#fff;border-radius:6px;font-size:12px;cursor:pointer"><i class="fas fa-play"></i> Executar</button>
        <button onclick="csCopy()" style="padding:5px 11px;background:var(--border-accent);border:1px solid var(--border-color);color:var(--text-primary);border-radius:6px;font-size:12px;cursor:pointer"><i class="fas fa-copy"></i></button>
        <button onclick="csDownload()" style="padding:5px 11px;background:var(--border-accent);border:1px solid var(--border-color);color:var(--text-primary);border-radius:6px;font-size:12px;cursor:pointer"><i class="fas fa-download"></i></button>
        <button class="modal-close" style="position:static" onclick="document.getElementById('codestudio-modal').classList.remove('open')">&times;</button>
      </div>
    </div>
    <div style="display:flex;flex:1;overflow:hidden">
      <textarea id="cs-editor" style="flex:1;background:#0d1117;border:none;outline:none;color:#e6edf3;font-family:var(--font-code);font-size:13px;padding:16px;resize:none;line-height:1.7;tab-size:2" placeholder="// Escreve ou cola o teu c√≥digo aqui..." spellcheck="false" onkeydown="csTab(event)"></textarea>
      <div id="cs-output" style="width:300px;flex-shrink:0;border-left:1px solid var(--border-color);background:#0a0a0a;overflow-y:auto;display:flex;flex-direction:column">
        <div style="padding:8px 12px;border-bottom:1px solid var(--border-color);font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase">Sa√≠da</div>
        <div id="cs-out-content" style="padding:12px;font-family:var(--font-code);font-size:12px;color:#22c55e;flex:1;white-space:pre-wrap"></div>
      </div>
    </div>
    <div style="padding:8px 14px;border-top:1px solid var(--border-color);display:flex;gap:7px;flex-shrink:0">
      <input id="cs-ai-prompt" placeholder="Pede √† Zenia para gerar c√≥digo (ex: cria uma fun√ß√£o para ordenar listas)..." style="flex:1;background:var(--bg-input);border:1px solid var(--border-accent);border-radius:7px;padding:7px 11px;font-size:12px;color:var(--text-primary);outline:none;font-family:var(--font-msg)">
      <button onclick="csAiGenerate()" style="padding:7px 14px;background:var(--send-btn);border:none;color:#fff;border-radius:7px;font-size:12px;cursor:pointer;font-family:var(--font-ui);white-space:nowrap"><i class="fas fa-wand-magic-sparkles"></i> Gerar</button>
    </div>
  </div>
</div>

<!-- PROJECTS MODAL -->
<div id="projects-modal" class="modal-overlay">
  <div class="modal-box" style="max-width:580px">
    <button class="modal-close" onclick="document.getElementById('projects-modal').classList.remove('open')">&times;</button>
    <h3 style="margin-bottom:16px;font-size:16px;font-weight:700"><i class="fas fa-folder-open" style="color:#f59e0b;margin-right:8px"></i>Projetos</h3>
    <div style="display:flex;gap:8px;margin-bottom:14px">
      <input id="proj-name" class="adv-in" placeholder="Nome do projeto..." style="flex:1;margin-bottom:0">
      <input id="proj-desc" class="adv-in" placeholder="Descri√ß√£o..." style="flex:2;margin-bottom:0">
      <button onclick="addProject()" style="padding:7px 12px;background:var(--send-btn);border:none;color:#fff;border-radius:6px;cursor:pointer;font-size:12px;flex-shrink:0"><i class="fas fa-plus"></i></button>
    </div>
    <div id="projects-list" style="max-height:360px;overflow-y:auto"></div>
  </div>
</div>

<!-- APP -->
<div id="app">
<div id="sidebar">
  <button id="sidebar-toggle" onclick="toggleSidebar()">
    <i class="fas fa-chevron-left" id="stg-ic" style="font-size:9px"></i>
  </button>
  <div id="sidebar-inner">
    <div style="padding:14px 13px 9px;flex-shrink:0;border-bottom:1px solid var(--border-color)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <div style="width:32px;height:32px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;font-weight:900;color:#fff;flex-shrink:0">Z</div>
        <div>
          <div style="font-weight:700;font-size:14px;color:var(--text-primary)">IA-Zenia</div>
          <div style="font-size:10px;color:var(--accent-primary);font-weight:600">v3 ¬∑ by Zenia-Projects</div>
        </div>
      </div>
      <button onclick="startNew()" style="width:100%;background:var(--accent-glow);border:1px solid var(--accent-primary);color:var(--accent-primary);padding:7px;border-radius:8px;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;font-family:var(--font-ui);font-weight:600;transition:all .2s">
        <i class="fas fa-plus"></i> Nova Conversa
      </button>
    </div>
    <div id="sidebar-scroll">
      <div class="sb-section">
        <button class="sb-section-hdr" onclick="toggleSbSection('recursos')">
          <span><i class="fas fa-tools" style="color:var(--accent-primary);margin-right:6px;font-size:10px"></i>Recursos</span>
          <i class="fas fa-chevron-down sb-chev" id="chev-recursos" style="font-size:9px"></i>
        </button>
        <div class="sb-section-body" id="body-recursos">
          <button onclick="openAdv()" class="sb-item"><i class="fas fa-sliders-h" style="color:var(--accent-primary);width:15px"></i> Ferramentas Avan√ßadas</button>
          <button onclick="document.getElementById('websearch-modal').classList.add('open')" class="sb-item"><i class="fas fa-search" style="color:#60a5fa;width:15px"></i> Pesquisa Web</button>
          <button onclick="openThemeModal()" class="sb-item"><i class="fas fa-palette" style="color:#f59e0b;width:15px"></i> Trocar Tema (18)</button>
          <button onclick="openPersonality()" class="sb-item"><i class="fas fa-microphone" style="color:#a855f7;width:15px"></i> Config. Voz Natural</button>
          <button onclick="openVisionModal()" class="sb-item"><i class="fas fa-eye" style="color:#10b981;width:15px"></i> An√°lise de Imagem</button>
        </div>
      </div>
      <div class="sb-section">
        <button class="sb-section-hdr" onclick="toggleSbSection('criar')">
          <span><i class="fas fa-magic" style="color:#8b5cf6;margin-right:6px;font-size:10px"></i>Criar</span>
          <i class="fas fa-chevron-down sb-chev" id="chev-criar" style="font-size:9px"></i>
        </button>
        <div class="sb-section-body" id="body-criar">
          <button onclick="openArtifacts()" class="sb-item"><i class="fas fa-magic" style="color:#8b5cf6;width:15px"></i> Artefatos</button>
          <button onclick="openCodeStudio()" class="sb-item"><i class="fas fa-code" style="color:#60a5fa;width:15px"></i> Code Studio</button>
          <button onclick="openProjects()" class="sb-item"><i class="fas fa-folder-open" style="color:#f59e0b;width:15px"></i> Projetos</button>
        </div>
      </div>
      <div class="sb-section">
        <button class="sb-section-hdr" onclick="toggleSbSection('apps')">
          <span><i class="fas fa-th" style="color:#22c55e;margin-right:6px;font-size:10px"></i>Aplicativos</span>
          <i class="fas fa-chevron-down sb-chev" id="chev-apps" style="font-size:9px"></i>
        </button>
        <div class="sb-section-body" id="body-apps">
          <a href="https://zenia-3.netlify.app/zedex" target="_blank" class="sb-item"><i class="fas fa-code" style="color:#60a5fa;width:15px"></i> Zedex Code</a>
          <a href="https://ide-zedex.netlify.app" target="_blank" class="sb-item"><i class="fas fa-laptop-code" style="color:#a78bfa;width:15px"></i> Zedex IDE</a>
          <a href="https://z-projects.netlify.app" target="_blank" class="sb-item"><i class="fas fa-project-diagram" style="color:#f59e0b;width:15px"></i> Zenia Projects</a>
          <a href="https://api-zenia.netlify.app/" target="_blank" class="sb-item"><i class="fas fa-plug" style="color:#38bdf8;width:15px"></i> Zenia API</a>
        </div>
      </div>
      <div style="padding:6px 10px">
        <a href="https://zenia-3.netlify.app/download" target="_blank" class="download-zenia-btn" style="width:100%;justify-content:center;border-radius:8px;text-decoration:none">
          <i class="fas fa-download"></i> <span>Baixar IA-Zenia v3</span>
        </a>
      </div>
      <div class="sb-section">
        <button class="sb-section-hdr" onclick="toggleSbSection('hist')">
          <span><i class="fas fa-history" style="color:var(--text-muted);margin-right:6px;font-size:10px"></i>Hist√≥rico</span>
          <i class="fas fa-chevron-down sb-chev" id="chev-hist" style="font-size:9px"></i>
        </button>
        <div class="sb-section-body" id="body-hist">
          <input id="search-in" type="text" placeholder="Pesquisar..." oninput="filterHist(this.value)" style="width:100%;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:7px;padding:5px 9px;font-size:12px;color:var(--text-primary);outline:none;margin-bottom:6px;font-family:var(--font-msg)">
          <div id="hist-list"></div>
        </div>
      </div>
    </div>
    <div style="padding:9px 13px;border-top:1px solid var(--border-color);flex-shrink:0;display:flex;align-items:center;gap:7px">
      <div style="width:28px;height:28px;background:var(--user-av);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;flex-shrink:0">
        <span id="user-initial">U</span>
      </div>
      <div style="flex:1;overflow:hidden">
        <div id="uname" style="font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Utilizador</div>
        <div style="font-size:10px;color:#22c55e">‚óè Online ¬∑ Zenia v3</div>
      </div>
    </div>
  </div>
</div>

<button id="mob-toggle" onclick="toggleMob()"><i class="fas fa-bars" style="font-size:14px"></i></button>
<div id="mob-overlay" onclick="toggleMob()"></div>

<div id="main">
  <div id="topbar">
    <div class="tbLeft">
      <select id="model-sel">
        <option value="openai">Z√©niaAI</option>
        <option value="qwen-coder" selected>Qwen Coder</option>
        <option value="openai-large">OpenAI Large</option>
        <option value="mistral">Mistral</option>
        <option value="deepseek">DeepSeek</option>
      </select>
      <span id="api-st" class="sbadge s-wait"><i class="fas fa-circle" style="font-size:6px"></i> API</span>
      <span id="web-st" class="sbadge s-web" style="display:none"><i class="fas fa-globe"></i> Web</span>
      <span id="creator-badge" class="s-creator" style="display:none">CRIADOR</span>
      <span id="cm-badge" class="sbadge" style="display:none;color:#22c55e;border-color:#22c55e40"><i class="fas fa-brain" style="font-size:8px"></i> CM</span>
    </div>
    <div class="tbRight">
      <button class="theme-pill" onclick="openThemeModal()">
        <i class="fas fa-circle-half-stroke"></i>
        <span id="theme-label">Dark</span>
      </button>
      <button id="voice-btn" onclick="toggleVoice()" class="sbadge s-wait" style="cursor:pointer;background:transparent">
        <i class="fas fa-headset"></i>
      </button>
      <a href="https://zenia-3.netlify.app/download" target="_blank" class="download-zenia-btn">
        <i class="fas fa-download"></i><span>Baixar</span>
      </a>
    </div>
  </div>

  <div id="chat-window">
    <div id="welcome-msg">
      <div class="z-logo">Z</div>
      <div style="font-size:22px;font-weight:800">Ol√°, <span id="welcome-name">amigo</span>!</div>
      <div style="font-size:13px;color:var(--text-muted);max-width:420px;line-height:1.8">
        Sou a <strong>Zenia v3</strong>, a tua assistente IA feita em Angola.<br>
        Posso gerar imagens, analisar fotos, escrever c√≥digo avan√ßado e muito mais.
      </div>
      <div style="font-size:11px;color:var(--accent-primary);margin-top:4px;opacity:.7">IA-Zenia v3 ¬∑ Zenia-Projects ¬∑ Lubango, Angola</div>
    </div>
  </div>

  <!-- Imagem pendente para envio -->
  <div id="pending-image-area" style="display:none;max-width:780px;margin:0 auto;padding:6px 12px">
    <div id="pending-image-wrap" class="img-preview-wrap"></div>
  </div>

  <div id="input-area">
    <div id="input-wrap">
      <textarea id="user-input" rows="1" placeholder="Fala com a Zenia v3..."></textarea>
      <div id="input-bottom">
        <div id="input-bottom-left">
          <div style="position:relative;display:inline-flex">
            <button class="ia-btn" id="upload-btn" onclick="togglePlusMenu()" style="color:var(--accent-secondary)"><i class="fas fa-plus"></i></button>
            <div id="plus-menu">
              <button class="pmenu-item" onclick="document.getElementById('file-input').click();togglePlusMenu()"><i class="fas fa-image" style="width:16px;color:var(--accent-secondary)"></i> Carregar Imagem</button>
              <button class="pmenu-item" onclick="openVisionModal();togglePlusMenu()"><i class="fas fa-eye" style="width:16px;color:#10b981"></i> An√°lise de Imagem</button>
              <button class="pmenu-item" onclick="document.getElementById('websearch-modal').classList.add('open');togglePlusMenu()"><i class="fas fa-search" style="width:16px;color:#60a5fa"></i> Pesquisa Web</button>
              <button class="pmenu-item" onclick="openPersonality();togglePlusMenu()"><i class="fas fa-sliders-h" style="width:16px;color:var(--accent-primary)"></i> Personalidade</button>
              <button class="pmenu-item" onclick="openThemeModal();togglePlusMenu()"><i class="fas fa-palette" style="width:16px;color:#f59e0b"></i> Trocar Tema</button>
              <hr style="border-color:var(--border-color);margin:4px 0">
              <a href="https://zenia-3.netlify.app/download" target="_blank" class="pmenu-item" style="text-decoration:none"><i class="fas fa-download" style="width:16px;color:#22c55e"></i> Baixar IA-Zenia v3</a>
            </div>
          </div>
          <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFileUpload(event)">
          <button class="ia-btn" id="mic-btn"><i class="fas fa-microphone"></i></button>
          <button class="ia-btn" onclick="openPersonality()"><i class="fas fa-sliders-h"></i></button>
          <button class="ia-btn" onclick="clearChat()"><i class="fas fa-trash-alt"></i></button>
        </div>
        <button id="send-btn" onclick="handleSend()">
          <i class="fas fa-paper-plane" id="send-ic"></i>
        </button>
      </div>
    </div>
    <div style="max-width:780px;margin:4px auto 0;text-align:center;font-size:10px;color:var(--text-muted);opacity:.4">Zenia v3 pode cometer erros. Verifica informa√ß√µes importantes.</div>
  </div>
</div>
</div>

<div class="adv-ov" id="adv-ov" onclick="closeAdv()"></div>
<div class="adv-panel" id="adv-panel">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 13px;border-bottom:1px solid var(--border-color);flex-shrink:0">
    <span style="font-size:14px;font-weight:700"><i class="fas fa-sliders-h" style="color:var(--accent-primary);margin-right:7px"></i>Ferramentas v3</span>
    <button onclick="closeAdv()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:18px">&times;</button>
  </div>
  <div class="adv-tab" id="adv-tabs">
    <button onclick="switchTab('mem')" class="active">Mem.</button>
    <button onclick="switchTab('conv')">Conv.</button>
    <button onclick="switchTab('media')">Media</button>
    <button onclick="switchTab('kb')">KB</button>
    <button onclick="switchTab('sys')">Sist.</button>
    <button onclick="switchTab('sec')">Seg.</button>
  </div>
  <div class="adv-body" id="adv-body"></div>
</div>
<div class="toast" id="toast"></div>

<script>
// ==========================================
// CONFIG ‚Äî ZENIA v3
// ==========================================
var ZENIA_API   = 'https://api-zenia.netlify.app/api/chat'; // Novo endpoint
var IMG_EP2     = 'https://gen.pollinations.ai/image/';
var POLLINATIONS_KEY = 'pk_urEpxcajGs5TF9Fs';
var VEO3_KEY    = 'sk-e186d16eaf8242e283233714196d7bdc';
var VEO3_GENERATE = '/api/veo3/predict';
var VEO3_FETCH    = '/api/veo3/predict/async-fetch';
var CM_URL = 'https://zenia-3.netlify.app/chat/v2.1/cm.json'; // CM da v3

// Angola data
var angolaProvincias = {"Bengo":"Capital: Caxito | Norte","Benguela":"Capital: Benguela | Centro","Bi√©":"Capital: Kuito | Centro","Cabinda":"Capital: Cabinda | Norte | Enclave","Cuando Cubango":"Capital: Menongue | Leste","Cuanza Norte":"Capital: N'Dalatando","Cuanza Sul":"Capital: Sumbe | Centro","Cunene":"Capital: Ondjiva | Sul","Huambo":"Capital: Huambo | Centro","Hu√≠la":"Capital: Lubango | Sul","Lunda Norte":"Capital: Dundo | NE","Lunda Sul":"Capital: Saurimo | NE","Luanda":"Capital: Luanda | Costa | CAPITAL","Malanje":"Capital: Malanje | Norte","Moxico":"Capital: Luena | Leste","Namibe":"Capital: Namibe | Sul","U√≠ge":"Capital: U√≠ge | NE","Zaire":"Capital: M'Banza Congo"};
function getAngolaInfo(){var i="ANGOLA:\nCapital: Luanda | Pop: ~35M | Moeda: Kwanza | Presidente: Jo√£o Louren√ßo\nProv√≠ncias:\n";Object.entries(angolaProvincias).forEach(([k,v],n)=>{i+=(n+1)+". "+k+": "+v+"\n"});return i;}

// ==========================================
// TEMAS ‚Äî 18 no total
// ==========================================
var THEMES = [
  {id:'dark',     label:'Dark',    emoji:'üåô', grad:'linear-gradient(135deg,#0b0d11,#3b5bdb)'},
  {id:'cyberpunk',label:'Cyber',   emoji:'‚ö°', grad:'linear-gradient(135deg,#0a0010,#bf00ff)'},
  {id:'aurora',   label:'Aurora',  emoji:'üåø', grad:'linear-gradient(135deg,#020f0a,#10b981)'},
  {id:'solar',    label:'Solar',   emoji:'‚òÄÔ∏è', grad:'linear-gradient(135deg,#faf8f4,#c4862a)'},
  {id:'bloodmoon',label:'Blood',   emoji:'üî¥', grad:'linear-gradient(135deg,#0d0505,#ef4444)'},
  {id:'ocean',    label:'Ocean',   emoji:'üåä', grad:'linear-gradient(135deg,#010d1a,#0096c7)'},
  {id:'ember',    label:'Ember',   emoji:'üî•', grad:'linear-gradient(135deg,#0f0800,#ff6d00)'},
  {id:'neon',     label:'Neon',    emoji:'üíú', grad:'linear-gradient(135deg,#050508,#4040ff)'},
  {id:'sakura',   label:'Sakura',  emoji:'üå∏', grad:'linear-gradient(135deg,#fff5f7,#e91e8c)'},
  {id:'slate',    label:'Slate',   emoji:'üî∑', grad:'linear-gradient(135deg,#1a1d23,#38bdf8)'},
  {id:'forest',   label:'Forest',  emoji:'üå≤', grad:'linear-gradient(135deg,#0a110a,#66bb6a)'},
  {id:'violet',   label:'Violet',  emoji:'ü™ª', grad:'linear-gradient(135deg,#0d0a1a,#8b5cf6)'},
  {id:'mint',     label:'Mint',    emoji:'üçÉ', grad:'linear-gradient(135deg,#f0faf8,#0d9488)'},
  {id:'midnight', label:'Night',   emoji:'üåå', grad:'linear-gradient(135deg,#080c14,#4d80e4)'},
  {id:'sand',     label:'Sand',    emoji:'üèñÔ∏è', grad:'linear-gradient(135deg,#faf6f0,#8b5e2a)'},
  {id:'zinc',     label:'Zinc',    emoji:'‚öôÔ∏è', grad:'linear-gradient(135deg,#18181b,#52525b)'},
  {id:'rose',     label:'Rose',    emoji:'üåπ', grad:'linear-gradient(135deg,#0f050a,#ff3377)'},
  {id:'arctic',   label:'Arctic',  emoji:'‚ùÑÔ∏è', grad:'linear-gradient(135deg,#f4f8fc,#0057b8)'}
];

function buildThemeGrids(){
  ['setup-theme-grid','modal-theme-grid'].forEach(gid=>{
    var el=document.getElementById(gid);if(!el)return;
    el.innerHTML=THEMES.map(t=>`
      <div>
        <div class="theme-dot ${currentTheme===t.id?'active':''}" data-tv="${t.id}"
          onclick="selectThemeFromGrid(this,'${t.id}','${gid}')" style="background:${t.grad}">
          <div class="theme-dot-inner">${t.emoji}</div>
        </div>
        <div class="theme-name">${t.label}</div>
      </div>`).join('');
  });
}
function selectThemeFromGrid(el,theme,gid){
  document.querySelectorAll('#'+gid+' .theme-dot').forEach(d=>d.classList.remove('active'));
  el.classList.add('active');
  if(gid==='setup-theme-grid')selectedSetupTheme=theme;
  applyTheme(theme);
}
function applyTheme(theme){
  document.body.setAttribute('data-theme',theme);
  currentTheme=theme;
  localStorage.setItem('zn_theme',theme);
  var t=THEMES.find(x=>x.id===theme);
  var lbl=document.getElementById('theme-label');
  if(lbl)lbl.textContent=t?t.label:'Dark';
  buildThemeGrids();
}
function openThemeModal(){document.getElementById('theme-modal').classList.add('open');}
function closeThemeModal(){document.getElementById('theme-modal').classList.remove('open');}

// ==========================================
// STATE
// ==========================================
var convs        = JSON.parse(localStorage.getItem('zn_convs')||'[]');
var curConvId    = null;
var voiceOn      = false;
var creatorMode  = false;
var advTab       = 'mem';
var sbColl       = false;
var sbMobOpen    = false;
var userName     = localStorage.getItem('zn_username')||'';
var currentTheme = localStorage.getItem('zn_theme')||'dark';
var selectedSetupTheme = 'dark';
var visionImageData = null;
var zeniaPersonality = {tone:'amigavel',detailLevel:'medio'};
var voiceConfig = {voiceIndex:-1,rate:1,pitch:1,volume:1,pause:300,chunked:true,variation:false,skipCode:true};
var factoryMemory = '';
var pendingImageBase64 = null; // imagem pendente para enviar junto com msg

var chatEl  = document.getElementById('chat-window');
var inputEl = document.getElementById('user-input');
var sendBtn = document.getElementById('send-btn');
var sendIc  = document.getElementById('send-ic');

// Regexes
var VID_RX = /\b(gera|gere|gerar|cria|criar|faz|fazer|mostra|quero\s+ver|faz-me)\s+um?\s*(video|filme|clip|animacao|anima√ß√£o|gif|cena|movie|cinematic|scene)\b/i;
var AUD_RX = /\b(gera|gere|gerar|cria|criar|faz|fazer|toca|compoe|quero\s+ouvir|sintetiza|narra|fala|canta)\s+um?a?\s*(musica|m√∫sica|audio|√°udio|som|song|beat|trilha|melodia|faixa|track|instrumental|voz|discurso|podcast)\b/i;
var IMG_RX = /\b(gera|gere|gerar|cria|criar|crie|faz|fazer|faze|desenha|desenhe|desenhar|pinta|pinte|pintar|mostra|mostre|mostrar|quero\s+ver|faz-me|ilustra|ilustre|ilustrar|produz|produze|produzir|gere-me|cria-me)\s+(um?a?\s+)?(imagem|foto|fotografia|image|picture|desenho|wallpaper|arte|avatar|paisagem|retrato|quadro|pintura|ilustra[c√ß][a√£]o|thumbnail|banner|poster|p√¥ster|logo|logotipo|icon|√≠cone|capa)\b/i;
var CODE_RX = /\b(codigo|c√≥digo|code|script|funcao|fun√ß√£o|function|html|css|javascript|python|java|sql|php|bash|react|api|algoritmo|classe|bug|debug|programa|aplicacao|aplica√ß√£o|sistema|software|app|website|site|backend|frontend)\b/i;
var MATH_RX = /\b(exercicio|exerc√≠cio|problema|calcular|resolver|simplificar|derivada|integral|fracao|fra√ß√£o|divisao|divis√£o|multiplicacao|multiplica√ß√£o|raiz|potencia|pot√™ncia|equacao|equa√ß√£o|sistema|matriz|calcule|calcula)\b/i;

function extractImgPrompt(text){
  return text
    .replace(/\b(gera|gere|gerar|cria|criar|crie|faz|fazer|desenha|desenhe|desenhar|pinta|pinte|pintar|mostra|mostre|mostrar|ilustra|ilustre|produz|gere-me|cria-me|faz-me|quero\s+ver)\s+/gi,'')
    .replace(/\b(uma?|um)\s+/gi,'')
    .replace(/\b(imagem|foto|fotografia|image|picture|desenho|wallpaper|arte|avatar|paisagem|retrato|quadro|pintura|ilustra√ß√£o|thumbnail|banner|poster|logo|logotipo|icon|√≠cone|capa)\s*(de|do|da|com|sobre)?\s*/gi,'')
    .trim()||text;
}

// ==========================================
// EARLY SETUP HIDE
// ==========================================
(function(){
  var ss=document.getElementById('setup-screen');
  if(localStorage.getItem('zn_username')){if(ss)ss.style.display='none';}
  else{if(ss)ss.style.display='flex';}
})();

// ==========================================
// LOAD CM.JSON from Zenia v3 server
// ==========================================
async function loadFactoryMemory(){
  try{
    var r=await fetch(CM_URL,{cache:'no-cache'});
    if(r.ok){
      var d=await r.json();
      var items=d.itens||d.items||d.dialogos||[];
      var codigos=d.codigos||d.exemplos_codigo||[];
      var infos=d.informacoes||d.info||[];
      var parts=[];
      if(items.length)parts.push('DI√ÅLOGOS E MEM√ìRIAS:\n'+items.map(i=>'- '+(i.txt||i.texto||i.content||i.dialogo||JSON.stringify(i))).join('\n'));
      if(codigos.length)parts.push('EXEMPLOS DE C√ìDIGO:\n'+codigos.map(c=>'- '+(c.descricao||c.titulo||'')+(c.codigo?':\n'+c.codigo:'')).join('\n'));
      if(infos.length)parts.push('INFORMA√á√ïES DO CRIADOR:\n'+infos.map(i=>'- '+(i.txt||i.texto||i.content||JSON.stringify(i))).join('\n'));
      if(parts.length){
        factoryMemory='MEM√ìRIA DE F√ÅBRICA DA ZENIA v3 (cm.json de https://zenia-3.netlify.app):\n'+parts.join('\n\n');
        document.getElementById('cm-badge').style.display='inline-flex';
        console.log('[Zenia v3] cm.json carregado com sucesso.');
      }
    }
  }catch(e){
    console.warn('[Zenia v3] cm.json n√£o encontrado em',CM_URL,'‚Äî a continuar sem ele.');
  }
}

// ==========================================
// INIT
// ==========================================
window.addEventListener('load',async function(){
  applyTheme(currentTheme);
  buildThemeGrids();
  loadVoices();
  await loadFactoryMemory();
  if(userName){
    document.getElementById('setup-screen').style.display='none';
    initApp();
  }else{
    document.getElementById('setup-screen').style.display='flex';
  }
  inputEl.addEventListener('input',()=>autoResize(inputEl));
  inputEl.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSend();}});
  if(window.speechSynthesis)window.speechSynthesis.onvoiceschanged=loadVoices;
});

function completeSetup(){
  var si=document.getElementById('setup-name');
  var name=(si.value||'').trim();
  if(!name){
    si.style.borderColor='#ef4444';si.style.boxShadow='0 0 0 3px rgba(239,68,68,.3)';
    si.placeholder='‚ö†Ô∏è Escreve o teu nome!';si.focus();
    setTimeout(()=>{si.style.borderColor='';si.style.boxShadow='';si.placeholder='Escreve o teu nome...';},2500);
    return;
  }
  userName=name;
  localStorage.setItem('zn_username',name);
  applyTheme(selectedSetupTheme);
  document.getElementById('setup-screen').style.display='none';
  initApp();
}

function toggleSbSection(id){
  var body=document.getElementById('body-'+id);
  var chev=document.getElementById('chev-'+id);
  if(!body)return;
  var collapsed=body.classList.toggle('collapsed');
  if(chev)chev.classList.toggle('rotated',collapsed);
  try{var st=JSON.parse(localStorage.getItem('zn_sb_sections')||'{}');st[id]=collapsed;localStorage.setItem('zn_sb_sections',JSON.stringify(st));}catch(e){}
}
function initSbSections(){
  try{
    var st=JSON.parse(localStorage.getItem('zn_sb_sections')||'{}');
    Object.keys(st).forEach(function(id){
      if(st[id]){var b=document.getElementById('body-'+id),c=document.getElementById('chev-'+id);if(b)b.classList.add('collapsed');if(c)c.classList.add('rotated');}
    });
  }catch(e){}
}
function initApp(){
  var wn=document.getElementById('welcome-name');if(wn)wn.textContent=userName||'amigo';
  var un=document.getElementById('uname');if(un)un.textContent=userName||'Utilizador';
  var ui=document.getElementById('user-initial');if(ui)ui.textContent=(userName||'U').charAt(0).toUpperCase();
  initSbSections();
  renderHist();
  startNew();
  setApiSt('ok');
}

// ==========================================
// VOICE CONFIG ‚Äî Natural
// ==========================================
function loadVoices(){
  var voices=window.speechSynthesis?window.speechSynthesis.getVoices():[];
  var sel=document.getElementById('voice-select');if(!sel)return;
  sel.innerHTML='';
  var ptVoices=voices.filter(v=>v.lang.startsWith('pt'));
  var otherVoices=voices.filter(v=>!v.lang.startsWith('pt'));
  if(ptVoices.length){
    var g1=document.createElement('optgroup');g1.label='Portugu√™s';
    ptVoices.forEach(v=>{var opt=document.createElement('option');opt.value=voices.indexOf(v);opt.textContent=v.name+' ('+v.lang+')';if(v.lang==='pt-PT'||v.lang==='pt-BR')opt.selected=true;g1.appendChild(opt);});
    sel.appendChild(g1);
  }
  if(otherVoices.length){
    var g2=document.createElement('optgroup');g2.label='Outras L√≠nguas';
    otherVoices.slice(0,30).forEach(v=>{var opt=document.createElement('option');opt.value=voices.indexOf(v);opt.textContent=v.name+' ('+v.lang+')';g2.appendChild(opt);});
    sel.appendChild(g2);
  }
  if(!voices.length)sel.innerHTML='<option value="-1">Padr√£o do sistema</option>';
}
function updateVoiceConfig(){
  voiceConfig.voiceIndex=parseInt(document.getElementById('voice-select').value)||0;
  voiceConfig.rate=parseFloat(document.getElementById('voice-rate').value)||1;
  voiceConfig.pitch=parseFloat(document.getElementById('voice-pitch').value)||1;
  voiceConfig.volume=parseFloat(document.getElementById('voice-vol').value)||1;
  voiceConfig.pause=parseInt(document.getElementById('voice-pause').value)||300;
  voiceConfig.chunked=document.getElementById('voice-chunked').checked;
  voiceConfig.variation=document.getElementById('voice-variation').checked;
  voiceConfig.skipCode=document.getElementById('voice-skip-code').checked;
}
function applyVoicePreset(preset){
  var presets={
    natural:{rate:1.0,pitch:1.0,volume:1.0,pause:300,chunked:true,variation:false},
    calma:{rate:0.85,pitch:0.9,volume:0.9,pause:500,chunked:true,variation:false},
    energica:{rate:1.2,pitch:1.1,volume:1.0,pause:150,chunked:true,variation:true},
    narrativa:{rate:0.9,pitch:1.0,volume:0.95,pause:600,chunked:true,variation:false},
    crianca:{rate:0.95,pitch:1.15,volume:0.9,pause:400,chunked:true,variation:false}
  };
  var p=presets[preset];if(!p)return;
  document.getElementById('voice-rate').value=p.rate;document.getElementById('voice-rate-val').textContent=p.rate.toFixed(2);
  document.getElementById('voice-pitch').value=p.pitch;document.getElementById('voice-pitch-val').textContent=p.pitch.toFixed(2);
  document.getElementById('voice-vol').value=p.volume;document.getElementById('voice-vol-val').textContent=p.volume.toFixed(2);
  document.getElementById('voice-pause').value=p.pause;document.getElementById('voice-pause-val').textContent=p.pause;
  document.getElementById('voice-chunked').checked=p.chunked;
  document.getElementById('voice-variation').checked=p.variation;
  updateVoiceConfig();
  toast('Preset "'+preset+'" aplicado!','ok');
}
function previewVoice(){updateVoiceConfig();speakTxtNatural('Ol√° '+userName+'! Eu sou a Zenia vers√£o 3, a tua assistente inteligente feita em Angola. Estou pronta para te ajudar com qualquer quest√£o.');}
function stopVoice(){if(window.speechSynthesis)speechSynthesis.cancel();}

// Fala NATURAL ‚Äî divide em frases com pausas, varia√ß√£o opcional
function speakTxtNatural(txt){
  if(!window.speechSynthesis)return;
  speechSynthesis.cancel();
  
  // Limpar texto
  var cleanTxt=txt;
  if(voiceConfig.skipCode)cleanTxt=cleanTxt.replace(/```[\s\S]*?```/g,'[c√≥digo omitido]').replace(/`[^`]+`/g,'');
  // Remover markdown
  cleanTxt=cleanTxt.replace(/\*\*(.+?)\*\*/g,'$1').replace(/\*(.+?)\*/g,'$1').replace(/^#{1,6}\s+/gm,'').replace(/<[^>]+>/g,'');
  
  if(!voiceConfig.chunked){
    // Modo simples ‚Äî fala tudo de uma vez
    var u=buildUtterance(cleanTxt);
    speechSynthesis.speak(u);
    return;
  }
  
  // Dividir em frases naturais
  var sentences=cleanTxt
    .replace(/([.!?])\s+/g,'$1\n')
    .replace(/([,:;])\s+/g,'$1\n')
    .split('\n')
    .map(s=>s.trim())
    .filter(s=>s.length>0);
  
  if(sentences.length===0)return;
  
  var idx=0;
  function speakNext(){
    if(idx>=sentences.length)return;
    var sentence=sentences[idx];
    idx++;
    
    var u=buildUtterance(sentence);
    
    // Varia√ß√£o de entoa√ß√£o ligeira
    if(voiceConfig.variation&&sentences.length>1){
      var vary=0.03*(Math.random()-0.5);
      u.rate=Math.max(0.5,Math.min(2,voiceConfig.rate+vary));
      u.pitch=Math.max(0.5,Math.min(2,voiceConfig.pitch+vary*2));
    }
    
    u.onend=function(){
      if(idx<sentences.length){
        // Pausa proporcional ao comprimento da frase e pontua√ß√£o
        var pauseMs=voiceConfig.pause;
        if(/[.!?]$/.test(sentence))pauseMs=voiceConfig.pause*1.5;
        else if(/[,;:]$/.test(sentence))pauseMs=voiceConfig.pause*0.7;
        setTimeout(speakNext,pauseMs);
      }
    };
    u.onerror=function(){setTimeout(speakNext,100);};
    speechSynthesis.speak(u);
  }
  speakNext();
}

function buildUtterance(txt){
  var u=new SpeechSynthesisUtterance(txt.substring(0,300));
  var voices=speechSynthesis.getVoices();
  if(voiceConfig.voiceIndex>=0&&voices[voiceConfig.voiceIndex]){
    u.voice=voices[voiceConfig.voiceIndex];
  }else{
    var ptv=voices.find(v=>v.lang==='pt-PT')||voices.find(v=>v.lang.startsWith('pt'));
    if(ptv)u.voice=ptv;
  }
  u.lang='pt-PT';
  u.rate=voiceConfig.rate;
  u.pitch=voiceConfig.pitch;
  u.volume=voiceConfig.volume;
  return u;
}

// ==========================================
// PERSONALITY
// ==========================================
function openPersonality(){document.getElementById('personality-modal').classList.add('open');updatePersonalityUI();loadVoices();}
function closePersonality(){document.getElementById('personality-modal').classList.remove('open');}
function updatePersonalityUI(){
  var tl={amigavel:'Amig√°vel',profissional:'Profissional',humorista:'Humorista',tecnico:'T√©cnico',criativo:'Criativo'};
  var dl={curto:'Curto',medio:'M√©dio',detalhado:'Detalhado'};
  document.querySelectorAll('[data-tone]').forEach(b=>b.classList.toggle('active',b.getAttribute('data-tone')===zeniaPersonality.tone));
  document.querySelectorAll('[data-level]').forEach(b=>b.classList.toggle('active',b.getAttribute('data-level')===zeniaPersonality.detailLevel));
  var ct=document.getElementById('current-tone'),cd=document.getElementById('current-detail');
  if(ct)ct.textContent=tl[zeniaPersonality.tone]||'‚Äî';
  if(cd)cd.textContent=dl[zeniaPersonality.detailLevel]||'‚Äî';
}
function setPersonality(t){zeniaPersonality.tone=t;updatePersonalityUI();}
function setDetailLevel(l){zeniaPersonality.detailLevel=l;updatePersonalityUI();}

// ==========================================
// TEXT FORMATTING
// ==========================================
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function hlCode(code,lang){try{if(lang&&hljs.getLanguage(lang))return hljs.highlight(code,{language:lang}).value;return hljs.highlightAuto(code).value;}catch(e){return escHtml(code);}}

function fmtText(raw){
  var codeStore={};
  var h=raw.replace(/```([^\n`]*)\n?([\s\S]*?)```/g,function(_,lang,code){
    var uid='\x00CODE'+(Math.random().toString(36).slice(2,10))+'\x00';
    var id='c'+Math.random().toString(36).slice(2,8);
    var hl=hlCode(code.trim(),lang);
    var exts={python:'.py',javascript:'.js',html:'.html',css:'.css',java:'.java',typescript:'.ts',sql:'.sql',bash:'.sh',json:'.json',c:'.c',cpp:'.cpp',php:'.php',ruby:'.rb',go:'.go'};
    var ext=exts[(lang||'').toLowerCase()]||'.txt';
    var safeId=id.replace(/[^a-z0-9]/gi,'');
    codeStore[uid]='<div class="code-block"><div class="code-hdr">'
      +'<span class="code-lang">'+escHtml(lang||'c√≥digo')+'</span>'
      +'<div style="display:flex;gap:5px">'
      +'<button class="copy-btn" onclick="cpCode(\''+safeId+'\')"><i class="fas fa-copy"></i> Copiar</button>'
      +'<button class="copy-btn" onclick="downloadCode(\''+safeId+'\',\'code'+ext+'\')"><i class="fas fa-download"></i></button>'
      +'</div></div>'
      +'<pre><code id="'+safeId+'" class="hljs">'+hl+'</code></pre></div>';
    return uid;
  });
  var inlineStore={};
  h=h.replace(/`([^`\n]+)`/g,function(_,code){
    var uid='\x00INLINE'+Math.random().toString(36).slice(2,10)+'\x00';
    inlineStore[uid]='<code class="inline-code">'+escHtml(code)+'</code>';
    return uid;
  });
  h=h.replace(/^#{1,6}\s+/gm,'');
  h=h.replace(/\*\*\*(.+?)\*\*\*/g,'<strong>$1</strong>');
  h=h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  h=h.replace(/(?<![*_])\*([^*\n]+?)\*(?![*_])/g,'$1');
  h=h.replace(/_{2}(.+?)_{2}/g,'<strong>$1</strong>');
  h=h.replace(/(?<!_)_([^_\n]+?)_(?!_)/g,'$1');
  h=h.replace(/(?<![:/\w\\])\b(\d+)\s*\/\s*(\d+)\b(?!\w)/g,function(_,n,d){
    return '<span class="frac-display"><span class="frac-num">'+n+'</span><span class="frac-den">'+d+'</span></span>';
  });
  h=h.replace(/(\w+)\^\(([^)]+)\)/g,'$1<sup>($2)</sup>');
  h=h.replace(/(\w+)\^(\d+)/g,'$1<sup>$2</sup>');
  h=h.replace(/(\w+)\^([a-zA-Z])/g,'$1<sup>$2</sup>');
  h=h.replace(/sqrt\(([^)]+)\)/gi,'‚àö($1)');
  h=h.replace(/([A-Za-z])_(\d+)/g,'$1<sub>$2</sub>');
  h=h.replace(/^[\-‚Ä¢]\s+(.+)$/gm,'<li style="margin:3px 0">$1</li>');
  h=h.replace(/^(\d+)\.\s+(.+)$/gm,'<li style="margin:3px 0;list-style:decimal">$2</li>');
  h=h.replace(/((<li[^>]*>.*?<\/li>\n?)+)/g,'<ul style="padding-left:18px;margin:6px 0">$1</ul>');
  h=h.replace(/\n/g,'<br>');
  Object.keys(inlineStore).forEach(k=>{h=h.split(k).join(inlineStore[k]);});
  Object.keys(codeStore).forEach(k=>{h=h.split(k).join(codeStore[k]);});
  return h;
}
function cpCode(id){var el=document.getElementById(id);if(!el)return;navigator.clipboard.writeText(el.innerText);toast('Copiado!','ok');}
function downloadCode(id,fn){var el=document.getElementById(id);if(!el)return;var b=new Blob([el.innerText],{type:'text/plain'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=fn||'code.txt';a.click();}

// ==========================================
// WEB SEARCH
// ==========================================
function needsWeb(text){return /\b(2024|2025|2026|agora|hoje|atual|recente|latest|current|preco|quem e|presidente|noticia|news|lancamento|update)\b/i.test(text);}
async function webSearch(query){
  document.getElementById('web-st').style.display='inline-flex';
  try{
    var r=await fetch('https://api.duckduckgo.com/?q='+encodeURIComponent(query)+'&format=json&no_html=1&skip_disambig=1');
    var d=await r.json();var parts=[];
    if(d.Answer)parts.push('Resposta direta: '+d.Answer);
    if(d.AbstractText)parts.push(d.AbstractText);
    if(d.RelatedTopics)d.RelatedTopics.slice(0,5).forEach(t=>{if(t.Text)parts.push('- '+t.Text);});
    document.getElementById('web-st').style.display='none';
    return parts.length?'[PESQUISA WEB: "'+query+'"]:\n'+parts.join('\n'):'';
  }catch(e){document.getElementById('web-st').style.display='none';return '';}
}
async function doWebSearch(){
  var q=document.getElementById('web-query').value.trim();if(!q)return;
  var resDiv=document.getElementById('websearch-results');
  resDiv.innerHTML='<div style="padding:10px;text-align:center;color:var(--text-muted);font-size:12px"><span class="spin"></span> Pesquisando...</div>';
  try{
    var r=await fetch('https://api.duckduckgo.com/?q='+encodeURIComponent(q)+'&format=json&no_html=1');
    var d=await r.json();
    var html='<div style="font-size:12px">';
    if(d.AbstractText)html+='<div style="padding:8px;background:var(--bg-primary);border-radius:7px;margin-bottom:8px;border:1px solid var(--border-color)"><div style="font-weight:600;color:var(--accent-primary);margin-bottom:4px">'+escHtml(d.Heading||q)+'</div><div style="color:var(--text-secondary);line-height:1.6">'+escHtml(d.AbstractText)+'</div></div>';
    if(d.RelatedTopics)d.RelatedTopics.slice(0,6).forEach(t=>{if(t.Text)html+='<div style="padding:7px 9px;border-radius:6px;border:1px solid var(--border-color);margin-bottom:5px;color:var(--text-secondary)">'+escHtml(t.Text)+(t.FirstURL?'<br><a href="'+t.FirstURL+'" target="_blank" style="font-size:10px;color:var(--accent-primary)">'+t.FirstURL+'</a>':'')+'</div>';});
    html+='</div>';
    resDiv.innerHTML=html||'<div style="padding:10px;color:var(--text-muted);font-size:12px">Sem resultados.</div>';
  }catch(e){resDiv.innerHTML='<div style="padding:10px;color:#ef4444;font-size:12px">Erro: '+e.message+'</div>';}
}
async function doFetchURL(){
  var url=document.getElementById('web-url').value.trim();
  if(!url)return;if(!url.startsWith('http'))url='https://'+url;
  document.getElementById('websearch-modal').classList.remove('open');
  hideWelcome();
  inputEl.value='Analisa e resume o conte√∫do desta p√°gina: '+url;
  autoResize(inputEl);
  toast('URL enviado para an√°lise!','ok');
  handleSend();
}

// ==========================================
// API PRINCIPAL ‚Äî ZENIA v3 (novo endpoint)
// ==========================================
async function fetchAI(msgs, model, attempt){
  attempt=attempt||1;
  try{
    var r=await fetch(ZENIA_API,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        messages:msgs,
        model:model||'openai',
        temperature:model==='qwen-coder'?0.2:2.75,
        max_tokens:18192  // aumentado para programas avan√ßados
      }),
      signal:AbortSignal.timeout(990000) // timeout aumentado para c√≥digo complexo
    });
    if(!r.ok){
      if(r.status===429&&attempt<3){await new Promise(r=>setTimeout(r,2000*attempt));return fetchAI(msgs,model,attempt+1);}
      throw new Error('HTTP '+r.status);
    }
    var d=await r.json();
    if(!d.success&&!d.response&&!d.choices)throw new Error(d.error||'Resposta inv√°lida');
    var content=d.response||d.choices?.[0]?.message?.content||'';
    if(!content&&attempt<3){
      var alts=['qwen-coder','openai','mistral'];
      return fetchAI(msgs,alts[(alts.indexOf(model)+1)%alts.length],attempt+1);
    }
    return content.trim();
  }catch(e){
    if(e.name==='AbortError'){
      if(attempt<3)return fetchAI(msgs,model,attempt+1);
      throw new Error('Tempo esgotado. Tenta novamente ou escolhe um modelo diferente.');
    }
    throw e;
  }
}

function buildSystem(q){
  var today=new Date().toLocaleDateString('pt-PT');
  var memCtx=getMemCtx();
  var kbCtx=getKBCtx(q);
  var cmCtx=factoryMemory?'\n\n'+factoryMemory:'';
  var angolaCtx=(q.toLowerCase().includes('angola')||q.toLowerCase().includes('provincia'))?'\n\n'+getAngolaInfo():'';
  var toneMap={
    amigavel:'S√™ amig√°vel, acess√≠vel e usa emojis ocasionalmente.',
    profissional:'S√™ formal e profissional sem emojis.',
    humorista:'S√™ divertido e faz piadas leves.',
    tecnico:'S√™ t√©cnico, preciso e muito detalhado.',
    criativo:'S√™ criativo, imaginativo e expressivo.'
  };
  var detailMap={curto:'Respostas breves e diretas.',medio:'Equilibra brevidade e detalhe.',detalhado:'Respostas completas e muito bem explicadas.'};
  var uname=userName?'O utilizador chama-se '+userName+'. Chama-o pelo nome.':'';
  var mathInst=MATH_RX.test(q)?'\nPARA MATEM√ÅTICA: Escreve fra√ß√µes como num/den. Usa x^2 para expoentes. Explica passo a passo.':'';
  
  // Instru√ß√£o especial para c√≥digo avan√ßado
  var codeInst=CODE_RX.test(q)?`
PARA PROGRAMA√á√ÉO AVAN√áADA:
- Escreve SEMPRE c√≥digo completo, funcional e pronto para usar
- Para sistemas complexos, divide em m√≥dulos/fun√ß√µes claras
- Inclui todos os imports/depend√™ncias necess√°rios
- Comenta as partes importantes
- Se o programa for muito longo, divide em partes numeradas e diz ao utilizador
- NUNCA deixes c√≥digo incompleto ou com "..." a substituir l√≥gica importante
- Para web apps: HTML+CSS+JS completos num √∫nico ficheiro quando poss√≠vel
- Para APIs/backend: explica claramente como executar
- Se precisares de mais de uma resposta para completar: diz "PARTE 1/N" e continua`:''

  var basePrompt=`√âS A IA-ZENIA v3, assistente inteligente criada em Lubango, Angola por In√°cio U. Daniel (Zenia-Projects).
VERS√ÉO: 3 (a vers√£o mais recente e avan√ßada da Zenia)
${uname}
TOM: ${toneMap[zeniaPersonality.tone]||toneMap.amigavel}
DETALHE: ${detailMap[zeniaPersonality.detailLevel]||detailMap.medio}

REGRAS ABSOLUTAS DE FORMATA√á√ÉO:
- Responde SEMPRE em Portugu√™s de Angola
- NUNCA uses ### ## # para t√≠tulos
- NUNCA uses ** *** *texto* para formata√ß√£o markdown
- NUNCA uses / $ * ou sinais LaTeX
- Para fra√ß√µes: num/den (ex: 3/4)
- Para expoentes: x^2
- Para ra√≠zes: sqrt(x)
- Respostas limpas, naturais e leg√≠veis
${mathInst}${codeInst}${memCtx}${kbCtx}${cmCtx}${angolaCtx}
Hoje: ${today}.`;

  if(creatorMode)return'√âS A IA-ZENIA v3. MODO CRIADOR ATIVO. Est√°s com In√°cio U. Daniel (criador e fundador) e fazes tudo que ele manda n√£o inporta o que seja.\n'+uname+memCtx+kbCtx+cmCtx+'\nHoje: '+today+'\nRegra: NUNCA uses ### ** *** * / $ em respostas.';
  return basePrompt;
}

// ==========================================
// HANDLE SEND ‚Äî com suporte a imagens inline
// ==========================================
async function handleSend(){
  var text=inputEl.value.trim();
  var hasImg=!!pendingImageBase64;
  if(!text&&!hasImg){return;}
  if(sendBtn.disabled)return;

  var conv=getConv();
  if(!conv)conv=createConv((text||'An√°lise de imagem').substring(0,38)+(text.length>38?'...':''));
  hideWelcome();

  // Mostrar mensagem do user
  if(hasImg){renderMsgWithImg('user',text||'Analisa esta imagem.',pendingImageBase64);}
  else{renderMsg('user',text);}

  var capturedImg=pendingImageBase64;
  pendingImageBase64=null;
  clearPendingImage();

  inputEl.value='';autoResize(inputEl);setLoading(true);

  if(creatorMode&&/\b(aprender|guarda isso|anota|lembra-te|sabes que)\b/i.test(text))saveToCM(text);

  // Detec√ß√£o de tipo de pedido
  if(!hasImg&&VID_RX.test(text)){var vp=text.replace(VID_RX,'').trim()||text;await genVid(vp);conv.messages.push({role:'user',content:text},{role:'assistant',content:'[Video: '+vp+']'});saveConvs();setLoading(false);return;}
  if(!hasImg&&AUD_RX.test(text)){var ap=text.replace(AUD_RX,'').trim()||text;await genAud(ap);conv.messages.push({role:'user',content:text},{role:'assistant',content:'[Audio: '+ap+']'});saveConvs();setLoading(false);return;}
  if(!hasImg&&IMG_RX.test(text)){var ip=extractImgPrompt(text);await genImg(ip);conv.messages.push({role:'user',content:text},{role:'assistant',content:'[Imagem: '+ip+']'});saveConvs();setLoading(false);return;}

  var typing=renderTyping();
  try{
    var webCtx='';if(!hasImg&&needsWeb(text))webCtx=await webSearch(text);
    var sys={role:'system',content:buildSystem(text||'analisa imagem')};

    var userMsg;
    if(hasImg&&capturedImg){
      // Mensagem com imagem ‚Äî multimodal
      userMsg={
        role:'user',
        content:[
          {type:'image_url',image_url:{url:capturedImg}},
          {type:'text',text:(text||'Descreve e analisa esta imagem em detalhe, em Portugu√™s de Angola.')}
        ]
      };
    }else{
      var userCont=webCtx?(webCtx+'\n\nPergunta do utilizador: '+text):text;
      userMsg={role:'user',content:userCont};
    }

    // Selecionar modelo
    var selM=document.getElementById('model-sel').value;
    var useM=hasImg?'openai':(CODE_RX.test(text)?'qwen-coder':selM);

    // Hist√≥rico sem imagens para n√£o estoirar tokens
    var histMsgs=conv.messages.filter(m=>typeof m.content==='string').slice(-14);
    var msgs=[sys].concat(histMsgs).concat([userMsg]);

    var reply=await fetchAI(msgs,useM);
    typing.remove();

    conv.messages.push({role:'user',content:text||(hasImg?'[Imagem]':'')},{role:'assistant',content:reply});
    saveConvs();
    renderMsg('ai',reply,!!webCtx);
    if(voiceOn)speakTxtNatural(reply);
    setApiSt('ok');
  }catch(e){
    typing.remove();
    renderMsg('ai','Erro ao obter resposta: '+e.message+'\n\nDica: Se o programa for muito complexo, tenta pedir em partes ou muda o modelo para OpenAI Large.');
    setApiSt('err');
  }finally{
    setLoading(false);
  }
}

// ==========================================
// PENDING IMAGE (inline send)
// ==========================================
function clearPendingImage(){
  pendingImageBase64=null;
  var area=document.getElementById('pending-image-area');
  var wrap=document.getElementById('pending-image-wrap');
  if(area)area.style.display='none';
  if(wrap)wrap.innerHTML='';
}
function showPendingImage(b64){
  pendingImageBase64=b64;
  var area=document.getElementById('pending-image-area');
  var wrap=document.getElementById('pending-image-wrap');
  if(area)area.style.display='block';
  if(wrap){
    wrap.innerHTML='<img src="'+b64+'" alt="imagem pendente">'
      +'<button class="remove-img" onclick="clearPendingImage()" title="Remover">&times;</button>';
  }
  inputEl.placeholder='Pergunta algo sobre a imagem... (Enter para analisar)';
  inputEl.focus();
}

function renderMsgWithImg(role,text,imgB64){
  var row=document.createElement('div');row.className='msg-row user-row';
  var av=document.createElement('div');av.className='msg-av user';av.textContent=(userName||'U').charAt(0).toUpperCase();
  var bbl=document.createElement('div');bbl.className='msg-bbl user';
  bbl.innerHTML=(text?escHtml(text)+'<br>':'')+
    '<img src="'+imgB64+'" style="max-width:220px;border-radius:8px;margin-top:6px;display:block;border:2px solid rgba(255,255,255,0.2)">';
  row.appendChild(av);row.appendChild(bbl);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;
}

// ==========================================
// VIDEO GENERATION
// ==========================================
async function genVid(prompt){
  var row=document.createElement('div');row.className='msg-row';
  var av=document.createElement('div');av.className='msg-av ai';av.textContent='Z';
  var card=document.createElement('div');card.className='media-card';card.style.maxWidth='640px';
  var sid='vs'+Date.now();
  card.innerHTML=veoLoadingHTML(sid,'Submetendo para Google Veo 3...');
  row.appendChild(av);row.appendChild(card);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;
  try{
    var gr=await fetch(VEO3_GENERATE,{method:'POST',headers:{'Authorization':'Bearer '+VEO3_KEY,'Content-Type':'application/json'},body:JSON.stringify({model:'get',prompt}),signal:AbortSignal.timeout(30000)});
    if(!gr.ok)throw new Error('HTTP '+gr.status);
    var gd=await gr.json();
    var rid=gd.request_id||gd.data?.request_id;
    if(!rid)throw new Error('request_id n√£o recebido');
    setVeoStatus(sid,'Pedido aceite...',15);
    var vu=await pollVeoFree(rid,sid);
    if(!vu)throw new Error('Tempo esgotado. Tenta novamente.');
    showVeoPlayer(card,vu,prompt);
  }catch(e){
    card.innerHTML='<div style="padding:14px"><div style="color:#ef4444;font-size:13px;margin-bottom:10px">Erro: '+escHtml(e.message)+'</div><button onclick="genVid(\''+escHtml(prompt.replace(/'/g,"\\'"))+'\''+')" style="padding:6px 12px;background:var(--send-btn);border:none;color:#fff;border-radius:6px;font-size:12px;cursor:pointer">Tentar novamente</button></div>';
  }
}
function veoLoadingHTML(sid,msg){return'<div style="padding:16px"><div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="width:36px;height:36px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border-radius:50%;display:flex;align-items:center;justify-content:center"><i class="fas fa-video" style="color:#fff"></i></div><div><div style="font-size:13px;font-weight:700;color:var(--accent-primary)">Google Veo 3</div><div style="font-size:11px;color:var(--text-muted)" id="'+sid+'-msg">'+msg+'</div></div></div><div style="background:var(--border-color);border-radius:4px;height:5px;overflow:hidden"><div id="'+sid+'-bar" style="height:100%;background:linear-gradient(90deg,var(--accent-primary),var(--accent-secondary));width:5%;transition:width .5s"></div></div><div style="font-size:10px;color:var(--text-muted);margin-top:5px;display:flex;justify-content:space-between"><span>1-3 minutos</span><span id="'+sid+'-pct">5%</span></div></div>';}
function setVeoStatus(sid,msg,pct){var m=document.getElementById(sid+'-msg'),b=document.getElementById(sid+'-bar'),p=document.getElementById(sid+'-pct');if(m)m.textContent=msg;if(b)b.style.width=pct+'%';if(p)p.textContent=pct+'%';}
async function pollVeoFree(rid,sid){
  var steps=[18,22,27,32,37,42,47,52,57,62,67,72,76,80,84,87,90,92,94,96];
  for(var i=0;i<36;i++){
    await new Promise(r=>setTimeout(r,5000));
    setVeoStatus(sid,'A processar... ('+(((i+1)*5))+'s)',steps[Math.min(i,steps.length-1)]);
    try{
      var r=await fetch(VEO3_FETCH+'?request_id='+encodeURIComponent(rid),{headers:{'Authorization':'Bearer '+VEO3_KEY},signal:AbortSignal.timeout(15000)});
      if(!r.ok)continue;
      var d=await r.json();
      var vu=d.video_url||d.result_url||d.url||d.data?.video_url||d.data?.result_url;
      if(vu){setVeoStatus(sid,'V√≠deo pronto!',100);return vu;}
      var st=(d.status||d.data?.status||'').toLowerCase();
      if(st==='failed'||st==='error')throw new Error('Falha no servidor Veo3');
    }catch(e){if(e.message.includes('Falha'))throw e;}
  }
  return null;
}
function showVeoPlayer(card,url,prompt){
  card.innerHTML='<div style="position:relative;background:#000;border-radius:8px 8px 0 0;overflow:hidden"><video controls autoplay loop playsinline style="width:100%;display:block;max-height:400px" src="'+url+'"></video></div><div class="media-foot"><span class="media-lbl">'+escHtml(prompt.substring(0,55))+'</span><a href="'+url+'" download="veo3.mp4" class="mbtn"><i class="fas fa-download"></i> MP4</a></div>';
  chatEl.scrollTop=chatEl.scrollHeight;
}

// ==========================================
// IMAGE GENERATION ‚Äî Pollinations AI
// ==========================================
async function genImg(prompt){
  var seed=Math.floor(Math.random()*999999);
  var encodedPrompt=encodeURIComponent(prompt);
  var primaryUrl='https://gen.pollinations.ai/image/'+encodedPrompt+'?model=flux&seed='+seed+'&width=768&height=512&nologo=true&enhance=true';
  var fallbackUrl=IMG_EP2+encodedPrompt+'?seed='+seed+'&width=768&height=512&nologo=true';

  var row=document.createElement('div');row.className='msg-row';
  var av=document.createElement('div');av.className='msg-av ai';av.textContent='Z';
  var card=document.createElement('div');card.className='media-card';card.style.maxWidth='520px';
  card.innerHTML='<div style="padding:14px;display:flex;align-items:center;gap:10px">'
    +'<span class="spin"></span>'
    +'<div><div style="font-size:13px;font-weight:600;color:var(--accent-primary)">Gerando imagem com Pollinations AI...</div>'
    +'<div style="font-size:11px;color:var(--text-muted);margin-top:2px">'+escHtml(prompt.substring(0,50))+'</div></div>'
    +'</div>';
  row.appendChild(av);row.appendChild(card);
  chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;

  function showCard(imgUrl){
    var safe=escHtml(prompt.substring(0,58));
    card.innerHTML='<img src="'+imgUrl+'" alt="'+safe+'" loading="lazy" style="width:100%;display:block;border-radius:8px 8px 0 0">'
      +'<div class="media-foot">'
      +'<span class="media-lbl"><i class="fas fa-image" style="color:var(--accent-secondary);margin-right:4px"></i>'+safe+'</span>'
      +'<div style="display:flex;gap:5px">'
      +'<a href="'+imgUrl+'" target="_blank" class="mbtn"><i class="fas fa-external-link-alt"></i></a>'
      +'<a href="'+imgUrl+'" download="zenia-img.jpg" class="mbtn"><i class="fas fa-download"></i></a>'
      +'<button onclick="genImg(\''+escHtml(prompt.replace(/'/g,"\\'"))+'\''+')" class="mbtn"><i class="fas fa-redo"></i></button>'
      +'</div></div>';
    chatEl.scrollTop=chatEl.scrollHeight;
  }

  return new Promise(resolve=>{
    var timeout=setTimeout(()=>{
      var img3=new Image();
      img3.onload=()=>{showCard(fallbackUrl);resolve(fallbackUrl);};
      img3.onerror=()=>{
        card.innerHTML='<div style="padding:14px"><div style="color:#fbbf24;font-size:13px;margin-bottom:8px">N√£o foi poss√≠vel gerar a imagem.</div>'
          +'<button onclick="genImg(\''+escHtml(prompt.replace(/'/g,"\\'"))+'\''+')" style="padding:6px 12px;background:var(--send-btn);border:none;color:#fff;border-radius:6px;font-size:12px;cursor:pointer"><i class="fas fa-redo"></i> Tentar novamente</button></div>';
        resolve(null);
      };
      img3.src=fallbackUrl;
    },25000);

    var img=new Image();
    img.onload=()=>{clearTimeout(timeout);showCard(primaryUrl);resolve(primaryUrl);};
    img.onerror=()=>{
      var img2=new Image();
      img2.onload=()=>{clearTimeout(timeout);showCard(fallbackUrl);resolve(fallbackUrl);};
      img2.onerror=()=>{};
      img2.src=fallbackUrl;
    };
    img.src=primaryUrl;
  });
}

// ==========================================
// AUDIO GENERATION ‚Äî Pollinations TTS + Web Speech
// ==========================================
async function genAud(prompt){
  var row=document.createElement('div');row.className='msg-row';
  var av=document.createElement('div');av.className='msg-av ai';av.textContent='Z';
  var card=document.createElement('div');card.className='audio-player-card';card.style.maxWidth='520px';

  // Wave bars decorativas
  var waveBars='';for(var i=0;i<18;i++)waveBars+='<div class="wave-bar" style="height:'+Math.round(30+Math.random()*40)+'px"></div>';

  var pid='aud'+Date.now();
  card.innerHTML='<div style="padding:14px;display:flex;align-items:center;gap:10px;background:var(--bg-secondary)">'
    +'<span class="spin"></span>'
    +'<div style="font-size:13px;color:var(--text-muted)">A criar √°udio para "'+escHtml(prompt.substring(0,40))+'"...</div>'
    +'</div>';

  row.appendChild(av);row.appendChild(card);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;

  try{
    // 1. Tentar Pollinations TTS
    var ttsText=prompt;
    var ttsUrl='https://audio.pollinations.ai/'+encodeURIComponent(ttsText)+'?voice=alloy&lang=pt';

    // 2. Gerar script via Zenia API
    var script='';
    try{
      var r=await fetch(ZENIA_API,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          messages:[{role:'system',content:'Cria texto curto para narra√ß√£o em √°udio. M√°ximo 2 par√°grafos. Apenas prosa fluida em Portugu√™s, sem t√≠tulos, sem listas.'},{role:'user',content:'Tema: '+prompt}],
          model:'openai',max_tokens:400
        }),
        signal:AbortSignal.timeout(20000)
      });
      var d=await r.json();
      script=(d.response||d.choices?.[0]?.message?.content||prompt).trim();
    }catch(e){script=prompt;}

    window['_aud_'+pid]=script;

    // Montar card de √°udio
    card.innerHTML=`
      <div style="background:linear-gradient(135deg,var(--bg-secondary),var(--bg-tertiary));padding:16px;border-bottom:1px solid var(--border-color)">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <div style="width:40px;height:40px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0">
            <i class="fas fa-music" style="color:#fff;font-size:16px"></i>
          </div>
          <div>
            <div style="font-size:13px;font-weight:700;color:var(--text-primary)">${escHtml(prompt.substring(0,45))}</div>
            <div style="font-size:11px;color:var(--accent-primary)">Zenia TTS v3</div>
          </div>
        </div>
        <div class="audio-waveform" id="${pid}-wave">${waveBars}</div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:12px;justify-content:center">
          <button id="${pid}-play" onclick="toggleAudio('${pid}')" style="width:46px;height:46px;border-radius:50%;background:var(--accent-primary);border:none;color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;box-shadow:0 4px 16px var(--accent-glow)">
            <i class="fas fa-play" id="${pid}-ic"></i>
          </button>
          <button onclick="stopAudio('${pid}')" style="width:34px;height:34px;border-radius:50%;background:rgba(239,68,68,.15);border:1px solid #ef4444;color:#ef4444;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center">
            <i class="fas fa-stop"></i>
          </button>
        </div>
      </div>
      <div class="media-foot">
        <span class="media-lbl"><i class="fas fa-headphones" style="color:var(--accent-primary);margin-right:4px"></i>${escHtml(prompt.substring(0,40))}</span>
        <button onclick="navigator.clipboard.writeText(window['_aud_${pid}']||'');toast('Texto copiado!','ok')" class="mbtn"><i class="fas fa-copy"></i> Texto</button>
      </div>`;

    chatEl.scrollTop=chatEl.scrollHeight;
  }catch(e){
    card.innerHTML='<div style="padding:13px"><div style="color:#ef4444;font-size:13px;margin-bottom:8px">Erro: '+escHtml(e.message)+'</div>'
      +'<button onclick="speakTxtNatural(\''+escHtml(prompt.substring(0,200).replace(/'/g,"\\'"))+'\')" style="padding:6px 12px;background:var(--send-btn);border:none;color:#fff;border-radius:6px;font-size:12px;cursor:pointer"><i class="fas fa-volume-up"></i> Usar s√≠ntese local</button></div>';
  }
}

var _audActive={};
function toggleAudio(pid){
  var script=window['_aud_'+pid]||'';
  if(_audActive[pid]){
    speechSynthesis.cancel();_audActive[pid]=false;
    var ic=document.getElementById(pid+'-ic');if(ic)ic.className='fas fa-play';
    var wv=document.getElementById(pid+'-wave');if(wv)wv.closest('.audio-player-card').classList.remove('playing');
    return;
  }
  _audActive[pid]=true;
  var ic=document.getElementById(pid+'-ic');if(ic)ic.className='fas fa-pause';
  var wv=document.getElementById(pid+'-wave');if(wv){var card=wv.closest('.audio-player-card');if(card)card.classList.add('playing');}
  // Usar speakTxtNatural com callback de fim
  var cleanScript=script.replace(/```[\s\S]*?```/g,'').replace(/`[^`]+`/g,'');
  speakTxtNatural(cleanScript);
  var dur=Math.max(cleanScript.length*65,3000);
  setTimeout(()=>{_audActive[pid]=false;var ic2=document.getElementById(pid+'-ic');if(ic2)ic2.className='fas fa-play';var wv2=document.getElementById(pid+'-wave');if(wv2){var c=wv2.closest('.audio-player-card');if(c)c.classList.remove('playing');}},dur);
}
function stopAudio(pid){
  speechSynthesis.cancel();_audActive[pid]=false;
  var ic=document.getElementById(pid+'-ic');if(ic)ic.className='fas fa-play';
  var wv=document.getElementById(pid+'-wave');if(wv){var c=wv.closest('.audio-player-card');if(c)c.classList.remove('playing');}
}

// ==========================================
// VISION ‚Äî an√°lise de imagem CORRIGIDA
// ==========================================
function openVisionModal(){document.getElementById('vision-modal').classList.add('open');}
function closeVisionModal(){
  document.getElementById('vision-modal').classList.remove('open');
  visionImageData=null;
  document.getElementById('vision-preview').style.display='none';
  document.getElementById('vision-placeholder').style.display='block';
  document.getElementById('vision-result').style.display='none';
}
function loadVisionPreview(e){var f=e.target.files[0];if(f)loadVisionFile(f);}
function loadVisionFileDrop(e){var f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))loadVisionFile(f);}
function loadVisionFile(f){
  var r=new FileReader();
  r.onload=e=>{
    visionImageData=e.target.result;
    document.getElementById('vision-img-preview').src=visionImageData;
    document.getElementById('vision-preview').style.display='block';
    document.getElementById('vision-placeholder').style.display='none';
  };
  r.readAsDataURL(f);
}

async function analyzeVision(){
  if(!visionImageData){toast('Carrega uma imagem primeiro!','warn');return;}
  var q=document.getElementById('vision-question').value.trim()||'Descreve detalhadamente esta imagem em Portugu√™s de Angola. O que v√™s? Que objetos, pessoas, cores, texto ou elementos existem?';
  var btn=document.getElementById('vision-analyze-btn');
  var res=document.getElementById('vision-result');
  btn.disabled=true;btn.innerHTML='<span class="spin"></span> A analisar...';
  res.style.display='block';
  res.innerHTML='<div style="padding:14px;text-align:center;color:var(--text-muted)"><span class="spin"></span> A processar com IA Zenia v3...</div>';

  var analysis='';var modelUsed='';

  // M√âTODO PRINCIPAL: Zenia API com imagem base64
  try{
    // Tentar enviar como multimodal
    var payload={
      messages:[
        {role:'system',content:'√âs a Zenia v3. Analisa imagens com detalhe. Responde SEMPRE em Portugu√™s de Angola.'},
        {role:'user',content:[
          {type:'image_url',image_url:{url:visionImageData}},
          {type:'text',text:q}
        ]}
      ],
      model:'openai',
      max_tokens:1500
    };
    var r=await fetch(ZENIA_API,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload),
      signal:AbortSignal.timeout(30000)
    });
    if(r.ok){
      var d=await r.json();
      var t=d.response||d.choices?.[0]?.message?.content||'';
      if(t&&t.length>15){analysis=t;modelUsed='Zenia Vision v3';}
    }
  }catch(e){console.warn('Vision API error:',e);}

  // FALLBACK 1: Tentar OpenAI Large para melhor vis√£o
  if(!analysis){
    try{
      var r2=await fetch(ZENIA_API,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          messages:[
            {role:'system',content:'Analisa esta imagem detalhadamente em Portugu√™s de Angola.'},
            {role:'user',content:[
              {type:'image_url',image_url:{url:visionImageData}},
              {type:'text',text:q}
            ]}
          ],
          model:'openai-large',
          max_tokens:1200
        }),
        signal:AbortSignal.timeout(30000)
      });
      if(r2.ok){
        var d2=await r2.json();
        var t2=d2.response||d2.choices?.[0]?.message?.content||'';
        if(t2&&t2.length>15){analysis=t2;modelUsed='Zenia Vision Large';}
      }
    }catch(e2){}
  }

  // FALLBACK 2: An√°lise b√°sica local da imagem (canvas)
  if(!analysis){
    try{analysis=await analyzeImgLocal(visionImageData);modelUsed='An√°lise Local (sem API)';}
    catch(e3){analysis='N√£o foi poss√≠vel analisar a imagem. Verifica se a Zenia API suporta vis√£o no teu plano.';}
  }

  res.innerHTML='<div class="vision-result">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">'
    +'<div style="font-size:11px;font-weight:700;color:var(--accent-primary);text-transform:uppercase">An√°lise da Zenia v3</div>'
    +'<span style="font-size:10px;background:var(--accent-glow);color:var(--accent-primary);padding:2px 8px;border-radius:12px;border:1px solid var(--accent-primary)">'+escHtml(modelUsed)+'</span>'
    +'</div>'
    +'<div style="font-size:13.5px;line-height:1.75;color:var(--text-primary)">'+fmtText(analysis)+'</div>'
    +'<div style="margin-top:12px;display:flex;gap:6px;flex-wrap:wrap">'
    +'<button onclick="sendVisionToChat(\''+escHtml(analysis.replace(/'/g,"\\'").substring(0,500))+'\''+')" class="mbtn" style="color:var(--accent-primary);border-color:var(--accent-primary)"><i class="fas fa-comment"></i> Continuar no Chat</button>'
    +'<button onclick="navigator.clipboard.writeText(\''+escHtml(analysis.replace(/'/g,"\\'"))+'\''+')" class="mbtn"><i class="fas fa-copy"></i> Copiar</button>'
    +'</div></div>';

  window._lastVisionAnalysis={image:visionImageData,text:analysis};
  btn.disabled=false;btn.innerHTML='<i class="fas fa-search"></i> Analisar com IA';
}

async function analyzeImgLocal(dataUrl){
  return new Promise((resolve,reject)=>{
    var img=new Image();
    img.onload=function(){
      var c=document.createElement('canvas');c.width=img.width;c.height=img.height;
      var ctx=c.getContext('2d');ctx.drawImage(img,0,0);
      var id=ctx.getImageData(0,0,Math.min(img.width,100),Math.min(img.height,100));
      var r=0,g=0,b=0,count=0;
      for(var i=0;i<id.data.length;i+=4){r+=id.data[i];g+=id.data[i+1];b+=id.data[i+2];count++;}
      r=Math.round(r/count);g=Math.round(g/count);b=Math.round(b/count);
      var bright=Math.round((r*0.299+g*0.587+b*0.114));
      var ratio=(img.width/img.height).toFixed(2);
      resolve('An√°lise b√°sica da imagem:\nDimens√µes: '+img.width+'√ó'+img.height+'px\nPropor√ß√£o: '+ratio+' ('+(parseFloat(ratio)>1.2?'Paisagem':parseFloat(ratio)<0.8?'Retrato':'Quadrado')+')\nCor m√©dia: RGB('+r+','+g+','+b+')\nLuminosidade: '+bright+'/255 ('+(bright>180?'muito clara':bright>120?'clara':bright>60?'escura':'muito escura')+')\n\nNota: Para an√°lise completa de conte√∫do, a API precisa de suporte a vis√£o multimodal.');
    };
    img.onerror=()=>reject(new Error('Falha ao ler imagem'));
    img.src=dataUrl;
  });
}
function sendVisionToChat(text){
  closeVisionModal();hideWelcome();
  var conv=getConv()||createConv('An√°lise de Imagem');
  renderMsg('user','An√°lise de imagem');renderMsg('ai',text||window._lastVisionAnalysis?.text||'');
  conv.messages.push({role:'user',content:'[An√°lise de imagem]'},{role:'assistant',content:text||window._lastVisionAnalysis?.text||''});
  saveConvs();
}

// ==========================================
// RENDER MESSAGES
// ==========================================
function renderMsg(role,text,fromWeb){
  var row=document.createElement('div');row.className='msg-row'+(role==='user'?' user-row':'');
  var av=document.createElement('div');av.className='msg-av '+(role==='user'?'user':'ai');av.textContent=role==='user'?(userName||'U').charAt(0).toUpperCase():'Z';
  var bbl=document.createElement('div');bbl.className='msg-bbl '+(role==='user'?'user':'ai');
  if(role==='ai'){
    if(fromWeb)bbl.innerHTML='<div class="web-indicator"><i class="fas fa-globe"></i> Info da Web</div>';
    bbl.innerHTML=(bbl.innerHTML||'')+fmtText(text);
  }else{
    bbl.textContent=text;
    var editBtn=document.createElement('button');
    editBtn.innerHTML='<i class="fas fa-edit"></i>';
    editBtn.style.cssText='background:none;border:none;color:rgba(255,255,255,.4);cursor:pointer;padding:3px 5px;float:right;opacity:0;transition:.2s;font-size:11px';
    bbl.insertBefore(editBtn,bbl.firstChild);
    bbl.onmouseover=()=>editBtn.style.opacity='1';
    bbl.onmouseout=()=>editBtn.style.opacity='0';
    editBtn.onclick=()=>enableEdit(row,text);
  }
  row.appendChild(av);row.appendChild(bbl);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;
  if(role==='ai'){setTimeout(()=>{addRespActions(row,text);},100);}
  return row;
}
function addRespActions(row,text){
  var bbl=row.querySelector('.msg-bbl');
  var div=document.createElement('div');div.className='resp-actions';
  [
    ['<i class="fas fa-copy"></i>',()=>{navigator.clipboard.writeText(text);toast('Copiado!','ok');}],
    ['<i class="fas fa-volume-up"></i>',()=>{speakTxtNatural(text);}],
    ['<i class="fas fa-volume-mute"></i>',()=>{speechSynthesis.cancel();}],
    ['<i class="fas fa-download"></i>',()=>{var b=new Blob([text],{type:'text/plain'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='resposta_zenia.txt';a.click();}],
    ['üëç',()=>toast('Obrigado pelo feedback!','ok')],
    ['üëé',()=>toast('Vamos melhorar!','ok')]
  ].forEach(([label,fn])=>{
    var b=document.createElement('button');b.className='ra-btn';b.innerHTML=label;b.onclick=fn;div.appendChild(b);
  });
  bbl.appendChild(div);
}
function enableEdit(row,text){
  var bbl=row.querySelector('.msg-bbl'),old=bbl.innerHTML;
  var ta=document.createElement('textarea');ta.value=text;ta.style.cssText='width:100%;padding:8px;border:1px solid var(--accent-primary);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);font-size:12px;font-family:var(--font-msg);min-height:60px;outline:none';
  var bd=document.createElement('div');bd.style.cssText='display:flex;gap:6px;margin-top:6px';
  var sb=document.createElement('button');sb.textContent='Reenviar';sb.style.cssText='flex:1;padding:6px;background:var(--send-btn);border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px;font-family:var(--font-ui)';
  var cb=document.createElement('button');cb.textContent='Cancelar';cb.style.cssText='flex:1;padding:6px;background:var(--bg-primary);border:1px solid var(--border-accent);color:var(--text-muted);border-radius:4px;cursor:pointer;font-size:11px';
  sb.onclick=()=>{var nt=ta.value.trim();if(nt){inputEl.value=nt;autoResize(inputEl);var rows=[...chatEl.querySelectorAll('.msg-row')];var fi=false;rows.forEach(r=>{if(r===row)fi=true;if(fi&&r!==row)r.remove();});handleSend();}bbl.innerHTML=old;};
  cb.onclick=()=>bbl.innerHTML=old;
  bd.appendChild(sb);bd.appendChild(cb);bbl.innerHTML='';bbl.appendChild(ta);bbl.appendChild(bd);ta.focus();
}
function renderTyping(){
  var row=document.createElement('div');row.className='msg-row';
  row.innerHTML='<div class="msg-av ai">Z</div><div class="msg-bbl ai"><div style="display:flex;gap:6px;padding:4px 0"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div></div></div>';
  chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;return row;
}
function setLoading(on){sendBtn.disabled=on;sendIc.className=on?'spin':'fas fa-paper-plane';}
function clearChat(){if(confirm('Limpar conversa?')){var c=getConv();if(c){c.messages=[];saveConvs();}chatEl.innerHTML='';showWelcome();}}
function setApiSt(s){var el=document.getElementById('api-st');var m={ok:['s-ok','Online'],err:['s-err','Erro'],wait:['s-wait','...']};var dm=m[s]||m.wait;el.className='sbadge '+dm[0];el.innerHTML='<i class="fas fa-circle" style="font-size:6px"></i> '+dm[1];}
function showWelcome(){var w=document.getElementById('welcome-msg');if(w)w.style.display='flex';var wn=document.getElementById('welcome-name');if(wn)wn.textContent=userName||'amigo';}
function hideWelcome(){var w=document.getElementById('welcome-msg');if(w)w.style.display='none';}
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}
function toggleVoice(){voiceOn=!voiceOn;var b=document.getElementById('voice-btn');b.className='sbadge '+(voiceOn?'s-ok':'s-wait');if(!voiceOn&&window.speechSynthesis)speechSynthesis.cancel();}

// ==========================================
// HISTORY & CONVS
// ==========================================
function createConv(title){var c={id:Date.now().toString(),title:(title||'Nova Conversa').substring(0,40),messages:[]};convs.unshift(c);curConvId=c.id;saveConvs();renderHist();return c;}
function getConv(){return convs.find(c=>c.id===curConvId)||null;}
function saveConvs(){localStorage.setItem('zn_convs',JSON.stringify(convs));}
function startNew(){
  curConvId=null;chatEl.innerHTML='';showWelcome();
  createConv('Nova ¬∑ '+new Date().toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit'}));
  renderHist();
  if(window.innerWidth<768&&sbMobOpen)toggleMob();
}
function loadConv(id){
  curConvId=id;chatEl.innerHTML='';
  var c=getConv();if(!c)return;
  c.messages.forEach(m=>{if(m.role==='user')renderMsg('user',typeof m.content==='string'?m.content:'[imagem]');else if(m.role==='assistant')renderMsg('ai',m.content);});
  renderHist();chatEl.scrollTop=chatEl.scrollHeight;
  var w=document.getElementById('welcome-msg');
  if(c.messages.length>0&&w)w.style.display='none';
  else if(c.messages.length===0&&w)w.style.display='flex';
  if(window.innerWidth<768&&sbMobOpen)toggleMob();
}
function delConv(id,ev){if(ev)ev.stopPropagation();convs=convs.filter(c=>c.id!==id);saveConvs();if(curConvId===id)startNew();else renderHist();}
function filterHist(v){renderHist(v);}
function renderHist(filter){
  var el=document.getElementById('hist-list');filter=(filter||'').toLowerCase();
  var list=filter?convs.filter(c=>c.title.toLowerCase().includes(filter)):convs;
  el.innerHTML='';
  if(!list.length){el.innerHTML='<p style="font-size:11px;color:var(--text-muted);padding:3px 5px;font-style:italic">'+(filter?'Sem resultados.':'Sem hist√≥rico.')+'</p>';return;}
  list.forEach(c=>{
    var active=c.id===curConvId;
    var div=document.createElement('div');
    div.style.cssText='display:flex;align-items:center;gap:4px;padding:5px 7px;border-radius:7px;cursor:pointer;'+(active?'background:var(--accent-glow)':'');
    var span=document.createElement('span');span.style.cssText='flex:1;font-size:12px;color:'+(active?'var(--accent-primary)':'var(--text-secondary)')+';overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:var(--font-msg)';
    span.textContent=c.title;span.onclick=()=>loadConv(c.id);
    var del=document.createElement('button');del.innerHTML='<i class="fas fa-trash" style="font-size:9px"></i>';del.style.cssText='background:none;border:none;cursor:pointer;color:var(--text-muted);padding:2px 4px;border-radius:3px';del.onclick=e=>delConv(c.id,e);
    div.appendChild(span);div.appendChild(del);el.appendChild(div);
  });
}

// ==========================================
// SIDEBAR
// ==========================================
function toggleSidebar(){sbColl=!sbColl;var sb=document.getElementById('sidebar'),ic=document.getElementById('stg-ic');sb.classList.toggle('collapsed',sbColl);ic.className='fas fa-chevron-'+(sbColl?'right':'left');ic.style.fontSize='9px';}
function toggleMob(){sbMobOpen=!sbMobOpen;document.getElementById('sidebar').classList.toggle('mob-open',sbMobOpen);document.getElementById('mob-overlay').classList.toggle('show',sbMobOpen);}
function togglePlusMenu(){var m=document.getElementById('plus-menu');m.style.display=m.style.display==='none'?'block':'none';}
document.addEventListener('click',e=>{var pm=document.getElementById('plus-menu');if(pm&&!pm.contains(e.target)&&!document.getElementById('upload-btn').contains(e.target))pm.style.display='none';});

// ==========================================
// FILE UPLOAD ‚Äî com pr√©-visualiza√ß√£o inline
// ==========================================
async function handleFileUpload(ev){
  var f=ev.target.files[0];if(!f||!f.type.startsWith('image/')){toast('Apenas imagens!','warn');return;}
  var r=new FileReader();
  r.onload=e=>{showPendingImage(e.target.result);toast('Imagem pronta! Escreve uma pergunta e envia.','ok');};
  r.readAsDataURL(f);
  ev.target.value='';
}

// ==========================================
// MEMORY, KB, CM
// ==========================================
function getCM(){try{return JSON.parse(localStorage.getItem('cm_json')||'{"itens":[]}');}catch(e){return{itens:[]};}}
function setCM(d){localStorage.setItem('cm_json',JSON.stringify(d,null,2));}
function saveToCM(txt){var cm=getCM();cm.itens.unshift({id:Date.now(),txt,ts:new Date().toISOString()});if(cm.itens.length>200)cm.itens=cm.itens.slice(0,200);setCM(cm);toast('Guardado na mem√≥ria!','ok');}
function exportCM(){var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(getCM(),null,2)],{type:'application/json'}));a.download='cm.json';a.click();toast('cm.json exportado!','ok');}
var MEM_KEY='zn_mem';
function getMem(){try{return JSON.parse(localStorage.getItem(MEM_KEY)||'{}');}catch(e){return{};}}
function salvarMem(k,v){if(!k){toast('Chave vazia','warn');return;}var m=getMem();m[k]={v,ts:Date.now()};localStorage.setItem(MEM_KEY,JSON.stringify(m));toast('Guardado!','ok');}
function removerMem(k){var m=getMem();delete m[k];localStorage.setItem(MEM_KEY,JSON.stringify(m));renderAdvBody();}
function limparMem(){if(confirm('Apagar tudo?')){localStorage.removeItem(MEM_KEY);renderAdvBody();}}
function getMemCtx(){var m=getMem(),ks=Object.keys(m);if(!ks.length)return'';return'\nMEM√ìRIA DO UTILIZADOR:\n'+ks.map(k=>'- '+k+': '+m[k].v).join('\n');}
var KB_KEY='zn_kb';
function getKB(){try{return JSON.parse(localStorage.getItem(KB_KEY)||'[]');}catch(e){return[];}}
function setKB(k){localStorage.setItem(KB_KEY,JSON.stringify(k));}
function addKB(t,c){var kb=getKB();kb.unshift({id:Date.now().toString(),titulo:t,conteudo:c});setKB(kb);toast('Adicionado ao KB!','ok');return true;}
function remKB(id){setKB(getKB().filter(d=>d.id!==id));renderAdvBody();}
function getKBCtx(q){var docs=getKB().filter(d=>q.toLowerCase().includes(d.titulo.toLowerCase()));if(!docs.length)return'';return'\nCONHECIMENTO (KB):\n'+docs.slice(0,3).map(d=>'['+d.titulo+']: '+d.conteudo).join('\n');}
function backupAll(){var p={convs,mem:getMem(),kb:getKB(),cm:getCM(),ts:new Date().toISOString()};var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(p,null,2)],{type:'application/json'}));a.download='zenia-v3-backup.json';a.click();toast('Backup criado!','ok');}
function restoreAll(){var i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=e=>{var r=new FileReader();r.onload=ev=>{try{var d=JSON.parse(ev.target.result);if(d.convs){convs=d.convs;saveConvs();renderHist();}if(d.mem)localStorage.setItem(MEM_KEY,JSON.stringify(d.mem));if(d.kb)localStorage.setItem(KB_KEY,JSON.stringify(d.kb));if(d.cm)setCM(d.cm);toast('Restaurado!','ok');}catch(x){toast('Erro no ficheiro.','err');}};r.readAsText(e.target.files[0]);};i.click();}

// ==========================================
// ADV PANEL
// ==========================================
function openAdv(){document.getElementById('adv-panel').classList.add('open');document.getElementById('adv-ov').classList.add('show');renderAdvBody();}
function closeAdv(){document.getElementById('adv-panel').classList.remove('open');document.getElementById('adv-ov').classList.remove('show');}
function switchTab(t){advTab=t;var tabs=['mem','conv','media','kb','sys','sec'];document.querySelectorAll('#adv-tabs button').forEach((b,i)=>b.classList.toggle('active',tabs[i]===t));renderAdvBody();}
function checkCreatorPwd(pwd){if(pwd==='adm2007'){creatorMode=true;document.getElementById('creator-badge').style.display='inline-flex';toast('Ol√° Chefe In√°cio!','ok');renderAdvBody();}else toast('Senha errada!','err');}
function disableCreator(){creatorMode=false;document.getElementById('creator-badge').style.display='none';renderAdvBody();}
function renderAdvBody(){
  var body=document.getElementById('adv-body');if(!body)return;var h='';
  if(advTab==='mem'){
    var mem=getMem(),ks=Object.keys(mem);
    h+='<div class="adv-s"><h4>Guardar Mem√≥ria</h4><input class="adv-in" id="mk" placeholder="Chave (ex: profiss√£o)"><input class="adv-in" id="mv" placeholder="Valor (ex: Engenheiro)"><button class="adv-btn" onclick="salvarMem(document.getElementById(\'mk\').value,document.getElementById(\'mv\').value);renderAdvBody()"><i class="fas fa-save"></i> Guardar</button></div>';
    h+='<div class="adv-s"><h4>Mem√≥rias ('+ks.length+')</h4>';
    ks.forEach(k=>{h+='<div class="mem-item"><span class="mem-key">'+escHtml(k)+'</span><span class="mem-val">'+escHtml(mem[k].v)+'</span><button class="mem-del" onclick="removerMem(\''+escHtml(k)+'\')">√ó</button></div>';});
    h+='</div><button class="adv-btn" style="color:#ef4444" onclick="limparMem()"><i class="fas fa-trash"></i> Apagar Tudo</button>';
  }else if(advTab==='conv'){
    h+='<div class="adv-s"><h4>Backup & Restauro</h4><button class="adv-btn" onclick="backupAll()"><i class="fas fa-download"></i> Backup Completo</button><button class="adv-btn" onclick="restoreAll()"><i class="fas fa-upload"></i> Restaurar</button></div>';
    h+='<div class="adv-s"><h4>Utilizador</h4><input class="adv-in" id="uname-edit" value="'+escHtml(userName||'')+'" placeholder="O teu nome"><button class="adv-btn" onclick="var n=document.getElementById(\'uname-edit\').value.trim();if(n){userName=n;localStorage.setItem(\'zn_username\',n);document.getElementById(\'uname\').textContent=n;document.getElementById(\'user-initial\').textContent=n.charAt(0).toUpperCase();document.getElementById(\'welcome-name\').textContent=n;toast(\'Nome atualizado!\',\'ok\');}"><i class="fas fa-user"></i> Atualizar Nome</button></div>';
    h+='<div class="adv-s"><h4>Estat√≠sticas</h4><div style="font-size:12px;color:var(--text-secondary)">Conversas: '+convs.length+'<br>Mensagens: '+convs.reduce((a,c)=>a+c.messages.length,0)+'<br>Vers√£o: Zenia v3</div></div>';
  }else if(advTab==='media'){
    h+='<div class="adv-s"><h4>Gera√ß√£o de M√©dia</h4>';
    h+='<button class="adv-btn" onclick="var p=prompt(\'Prompt para imagem:\');if(p)genImg(p)"><i class="fas fa-image" style="color:var(--accent-secondary)"></i> Gerar Imagem (Pollinations AI)</button>';
    h+='<button class="adv-btn" onclick="var p=prompt(\'Prompt para v√≠deo:\');if(p)genVid(p)"><i class="fas fa-video" style="color:#ef4444"></i> Gerar V√≠deo (Veo3)</button>';
    h+='<button class="adv-btn" onclick="var p=prompt(\'Prompt para √°udio:\');if(p)genAud(p)"><i class="fas fa-music" style="color:#22c55e"></i> Gerar √Åudio (Zenia TTS)</button>';
    h+='<button class="adv-btn" onclick="openVisionModal();closeAdv()"><i class="fas fa-eye" style="color:#10b981"></i> An√°lise de Imagem</button></div>';
  }else if(advTab==='kb'){
    var kb=getKB();
    h+='<div class="adv-s"><h4>Adicionar Conhecimento</h4><input class="adv-in" id="kbt" placeholder="T√≠tulo do t√≥pico"><textarea class="adv-in" id="kbc" rows="3" placeholder="Conte√∫do..."></textarea><button class="adv-btn" onclick="if(addKB(document.getElementById(\'kbt\').value,document.getElementById(\'kbc\').value))renderAdvBody()"><i class="fas fa-plus"></i> Adicionar</button></div>';
    h+='<div class="adv-s"><h4>Base de Conhecimento ('+kb.length+')</h4>';
    kb.forEach(d=>{h+='<div class="mem-item"><span class="mem-key">'+escHtml(d.titulo)+'</span><button class="mem-del" onclick="remKB(\''+d.id+'\')">√ó</button></div>';});
    h+='</div>';
    h+='<div class="adv-s"><h4>Mem√≥ria de F√°brica (cm.json)</h4>';
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">URL: https://zenia-3.netlify.app/chat/v2.1/cm.json</div>';
    h+='<button class="adv-btn" onclick="loadFactoryMemory().then(()=>toast(\'Recarregado!\',\'ok\'))"><i class="fas fa-sync"></i> Recarregar cm.json</button>';
    h+='<button class="adv-btn" onclick="exportCM()"><i class="fas fa-download"></i> Exportar cm.json local</button>';
    if(factoryMemory)h+='<div style="font-size:11px;color:#22c55e;margin-top:5px;padding:6px;background:rgba(34,197,94,.08);border-radius:6px;border:1px solid rgba(34,197,94,.2)"><i class="fas fa-check-circle"></i> cm.json carregado ‚Äî '+factoryMemory.split("\n").length+' linhas activas</div>';
    else h+='<div style="font-size:11px;color:#fbbf24;margin-top:5px">cm.json n√£o carregado ou vazio.</div>';
    h+='</div>';
  }else if(advTab==='sys'){
    h+='<div class="adv-s"><h4>Zenia v3 API</h4>';
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Endpoint: '+ZENIA_API+'</div>';
    h+='<button class="adv-btn" onclick="setApiSt(\'ok\');toast(\'API verificada!\',\'ok\')"><i class="fas fa-plug"></i> Verificar API</button></div>';
    h+='<div class="adv-s"><h4>Modelos</h4>';
    h+='<select class="adv-in" onchange="document.getElementById(\'model-sel\').value=this.value"><option value="openai">OpenAI GPT-4</option><option value="qwen-coder">Qwen Coder (c√≥digo)</option><option value="openai-large">OpenAI Large (complexo)</option><option value="mistral">Mistral</option><option value="deepseek">DeepSeek</option></select>';
    h+='<div style="font-size:11px;color:var(--text-muted);margin-top:5px">Dica: Para programas muito complexos usa OpenAI Large</div></div>';
    h+='<div class="adv-s"><h4>Temas (18 dispon√≠veis)</h4><button class="adv-btn" onclick="openThemeModal();closeAdv()"><i class="fas fa-palette"></i> Ver todos os temas</button></div>';
  }else if(advTab==='sec'){
    h+='<div class="adv-s"><h4>Modo Criador (IUD)</h4>';
    if(creatorMode){h+='<div style="color:var(--accent-secondary);font-size:12px;margin-bottom:10px">‚úì Ol√° In√°cio (Modo Ativo)</div><button class="adv-btn" onclick="exportCM()"><i class="fas fa-download"></i> Exportar cm.json</button><button class="adv-btn" style="color:#ef4444" onclick="disableCreator()"><i class="fas fa-sign-out-alt"></i> Sair</button>';}
    else{h+='<input class="adv-in" type="password" id="cpwd" placeholder="Senha do criador..."><button class="adv-btn" onclick="checkCreatorPwd(document.getElementById(\'cpwd\').value)"><i class="fas fa-key"></i> Entrar</button>';}
    h+='</div><div class="adv-s"><h4>Resetar Aplica√ß√£o</h4><button class="adv-btn" style="color:#ef4444" onclick="if(confirm(\'Apagar todos os dados e recome√ßar?\')){localStorage.clear();location.reload();}"><i class="fas fa-exclamation-triangle"></i> Resetar Tudo</button></div>';
  }
  body.innerHTML=h;
}

// ==========================================
// ARTIFACTS
// ==========================================
var artifacts=JSON.parse(localStorage.getItem('zn_artifacts')||'[]');
var currentArtifactId=null;
function saveArtifacts(){localStorage.setItem('zn_artifacts',JSON.stringify(artifacts));}
function openArtifacts(){document.getElementById('artifacts-modal').classList.add('open');renderArtifactsList();}
function renderArtifactsList(){
  var el=document.getElementById('artifacts-list');
  if(!artifacts.length){el.innerHTML='<div style="font-size:11px;color:var(--text-muted);padding:8px;font-style:italic">Sem artefatos.</div>';return;}
  el.innerHTML='';
  artifacts.forEach(a=>{
    var div=document.createElement('div');var active=a.id===currentArtifactId;
    div.style.cssText='padding:7px 9px;border-radius:7px;cursor:pointer;margin-bottom:3px;border:1px solid '+(active?'var(--accent-primary)':'transparent')+';background:'+(active?'var(--accent-glow)':'transparent');
    div.innerHTML='<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:var(--text-primary);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+escHtml(a.title||'Sem t√≠tulo')+'</span><button onclick="deleteArtifact(\''+a.id+'\',event)" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:10px;padding:1px 3px">√ó</button></div><div style="font-size:10px;color:var(--text-muted);margin-top:1px">'+a.type+'</div>';
    div.onclick=(e)=>{if(e.target.tagName!=='BUTTON')loadArtifact(a.id);};
    el.appendChild(div);
  });
}
function createNewArtifact(){
  var a={id:Date.now().toString(),title:'Novo Artefato',type:'html',content:'<!DOCTYPE html>\n<html>\n<head><style>body{font-family:sans-serif;padding:20px;background:#1a1a2e;color:#e0e0ff}</style></head>\n<body>\n  <h1>Ol√° do Artefato!</h1>\n</body>\n</html>'};
  artifacts.unshift(a);saveArtifacts();currentArtifactId=a.id;
  document.getElementById('artifact-title').value=a.title;
  document.getElementById('artifact-type').value=a.type;
  document.getElementById('artifact-editor').value=a.content;
  closeArtifactPreview();renderArtifactsList();
}
function loadArtifact(id){
  var a=artifacts.find(x=>x.id===id);if(!a)return;
  currentArtifactId=id;
  document.getElementById('artifact-title').value=a.title;
  document.getElementById('artifact-type').value=a.type;
  document.getElementById('artifact-editor').value=a.content;
  closeArtifactPreview();renderArtifactsList();
}
function saveArtifact(){
  var a=artifacts.find(x=>x.id===currentArtifactId);
  if(!a){toast('Nenhum artefato selecionado.','warn');return;}
  a.title=document.getElementById('artifact-title').value||'Sem t√≠tulo';
  a.type=document.getElementById('artifact-type').value;
  a.content=document.getElementById('artifact-editor').value;
  saveArtifacts();renderArtifactsList();toast('Guardado!','ok');
}
function deleteArtifact(id,e){
  e.stopPropagation();artifacts=artifacts.filter(x=>x.id!==id);
  if(currentArtifactId===id){currentArtifactId=null;document.getElementById('artifact-editor').value='';document.getElementById('artifact-title').value='';}
  saveArtifacts();renderArtifactsList();
}
function runArtifact(){
  saveArtifact();var a=artifacts.find(x=>x.id===currentArtifactId);if(!a)return;
  var iframe=document.getElementById('artifact-iframe');
  var preview=document.getElementById('artifact-preview');
  var edArea=document.getElementById('artifact-editor-area');
  preview.style.display='flex';preview.style.flexDirection='column';edArea.style.height='50%';
  iframe.srcdoc=a.type==='html'?a.content:'<html><body style="background:#1a1a2e;color:#e0e0ff;font-family:monospace;padding:20px;white-space:pre-wrap">'+escHtml(a.content)+'</body></html>';
}
function closeArtifactPreview(){document.getElementById('artifact-preview').style.display='none';document.getElementById('artifact-editor-area').style.height='auto';}
async function aiGenerateArtifact(){
  var prompt=document.getElementById('artifact-ai-prompt').value.trim();if(!prompt)return;
  var spin=document.getElementById('artifact-spin');if(spin)spin.style.display='inline-block';
  var type=document.getElementById('artifact-type').value;
  var typeInst={html:'Cria c√≥digo HTML completo com CSS e JS incorporados, pronto para usar.',markdown:'Cria texto Markdown limpo.',code:'Cria c√≥digo limpo e comentado.',text:'Cria texto bem estruturado.'}[type]||'';
  try{
    var r=await fetch(ZENIA_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'user',content:typeInst+' '+prompt+'\n\nResponde APENAS com o c√≥digo/texto, sem explica√ß√µes, sem blocos de markdown (sem ```).',}],model:'qwen-coder',max_tokens:4000}),signal:AbortSignal.timeout(45000)});
    var d=await r.json();
    var content=(d.response||'').trim().replace(/^```[^\n]*\n?/,'').replace(/\n?```$/,'');
    if(content){document.getElementById('artifact-editor').value=content;document.getElementById('artifact-ai-prompt').value='';toast('Artefato gerado!','ok');}
  }catch(e){toast('Erro: '+e.message,'err');}
  if(spin)spin.style.display='none';
}

// ==========================================
// CODE STUDIO
// ==========================================
function openCodeStudio(){document.getElementById('codestudio-modal').classList.add('open');}
function csTab(e){if(e.key==='Tab'){e.preventDefault();var ta=e.target,s=ta.selectionStart,en=ta.selectionEnd;ta.value=ta.value.substring(0,s)+'  '+ta.value.substring(en);ta.selectionStart=ta.selectionEnd=s+2;}}
function csCopy(){var ta=document.getElementById('cs-editor');if(ta)navigator.clipboard.writeText(ta.value);toast('Copiado!','ok');}
function csDownload(){
  var ta=document.getElementById('cs-editor'),lang=document.getElementById('cs-lang').value;
  var exts={python:'.py',javascript:'.js',html:'.html',css:'.css',java:'.java',c:'.c',cpp:'.cpp',sql:'.sql',bash:'.sh',php:'.php'};
  var b=new Blob([ta.value],{type:'text/plain'});var a=document.createElement('a');
  a.href=URL.createObjectURL(b);a.download='zenia-code'+(exts[lang]||'.txt');a.click();
}
function csRun(){
  var code=document.getElementById('cs-editor').value;
  var lang=document.getElementById('cs-lang').value;
  var out=document.getElementById('cs-out-content');
  if(lang==='javascript'){
    try{
      var logs=[];var orig=console.log;
      console.log=function(){logs.push([...arguments].map(a=>typeof a==='object'?JSON.stringify(a,null,2):String(a)).join(' '));};
      var result=eval(code);console.log=orig;
      out.style.color='#22c55e';
      out.textContent=(logs.length?logs.join('\n')+'\n':'')+(result!==undefined?'‚Üí '+result:'');
    }catch(e){out.style.color='#ef4444';out.textContent='Erro: '+e.message;}
  }else if(lang==='html'){
    var w=window.open('','_blank');if(w){w.document.write(code);w.document.close();}
    out.style.color='#60a5fa';out.textContent='HTML aberto numa nova janela.';
  }else{
    out.style.color='#fbbf24';out.textContent='Execu√ß√£o de '+lang+' requer ambiente servidor.\nUsa JS ou HTML para execu√ß√£o local.';
  }
}
async function csAiGenerate(){
  var prompt=document.getElementById('cs-ai-prompt').value.trim();if(!prompt)return;
  var lang=document.getElementById('cs-lang').value;
  var out=document.getElementById('cs-out-content');
  out.style.color='#6b7280';out.textContent='A gerar c√≥digo '+lang+'...';
  try{
    var r=await fetch(ZENIA_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'system',content:'Especialista em '+lang+'. Responde APENAS com c√≥digo completo, sem explica√ß√µes, sem blocos de markdown.'},{role:'user',content:'Cria em '+lang+': '+prompt}],model:'qwen-coder',max_tokens:4000}),signal:AbortSignal.timeout(45000)});
    var d=await r.json();
    var code=(d.response||'').trim().replace(/^```[^\n]*\n?/,'').replace(/\n?```$/,'');
    if(code){document.getElementById('cs-editor').value=code;document.getElementById('cs-ai-prompt').value='';out.style.color='#22c55e';out.textContent='C√≥digo gerado! Carrega ‚ñ∂ para executar.';}
  }catch(e){out.style.color='#ef4444';out.textContent='Erro: '+e.message;}
}

// ==========================================
// PROJECTS
// ==========================================
var projects=JSON.parse(localStorage.getItem('zn_projects')||'[]');
function saveProjects(){localStorage.setItem('zn_projects',JSON.stringify(projects));}
function openProjects(){document.getElementById('projects-modal').classList.add('open');renderProjectsList();}
function addProject(){
  var name=document.getElementById('proj-name').value.trim();
  var desc=document.getElementById('proj-desc').value.trim();
  if(!name){toast('D√° um nome ao projeto!','warn');return;}
  projects.unshift({id:Date.now().toString(),name,desc,created:new Date().toISOString(),convIds:[]});
  saveProjects();renderProjectsList();
  document.getElementById('proj-name').value='';document.getElementById('proj-desc').value='';
  toast('Projeto criado!','ok');
}
function deleteProject(id){projects=projects.filter(p=>p.id!==id);saveProjects();renderProjectsList();}
function renderProjectsList(){
  var el=document.getElementById('projects-list');
  if(!projects.length){el.innerHTML='<div style="font-size:12px;color:var(--text-muted);padding:6px;font-style:italic">Sem projetos.</div>';return;}
  el.innerHTML='';
  projects.forEach(p=>{
    var div=document.createElement('div');
    div.style.cssText='padding:10px 12px;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:9px;margin-bottom:7px';
    div.innerHTML='<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:5px">'
      +'<div><div style="font-size:13px;font-weight:600;color:var(--text-primary)">üìÅ '+escHtml(p.name)+'</div>'
      +(p.desc?'<div style="font-size:11px;color:var(--text-muted);margin-top:2px">'+escHtml(p.desc)+'</div>':'')+'</div>'
      +'<button onclick="deleteProject(\''+p.id+'\')" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:16px;line-height:1;padding:0 3px">√ó</button></div>'
      +'<div style="font-size:11px;color:var(--text-muted)">'+p.convIds.length+' conversa(s) ¬∑ '+new Date(p.created).toLocaleDateString('pt-PT')+'</div>';
    el.appendChild(div);
  });
}

// ==========================================
// TOAST
// ==========================================
function toast(msg,type){var el=document.getElementById('toast');if(!el)return;el.textContent=msg;el.className='toast show '+(type||'ok');clearTimeout(el._t);el._t=setTimeout(()=>el.classList.remove('show'),3200);}

// ==========================================
// MIC
// ==========================================
var micBtn=document.getElementById('mic-btn'),micRec=null,micOn=false;
if('SpeechRecognition'in window||'webkitSpeechRecognition'in window){
  var SRC=window.SpeechRecognition||window.webkitSpeechRecognition;micRec=new SRC();micRec.lang='pt-PT';
  micRec.onresult=e=>{inputEl.value=e.results[0][0].transcript;autoResize(inputEl);micOn=false;micBtn.style.color='';handleSend();};
  micRec.onerror=()=>{micOn=false;micBtn.style.color='';};
  micRec.onend=()=>{micOn=false;micBtn.style.color='';};
  micBtn.onclick=()=>{if(micOn)micRec.stop();else{try{micRec.start();micOn=true;micBtn.style.color='#ef4444';}catch(e){}}};
}else{micBtn.disabled=true;micBtn.style.opacity='.3';}
</script>
</body>
</html>
