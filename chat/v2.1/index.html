<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>IA-Zenia</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&family=Sora:wght@300;400;600;700;800&family=Orbitron:wght@400;700;900&family=Nunito:wght@400;600;700;800&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;600&family=DM+Sans:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
:root {
  --bg-primary:#0b0d11;--bg-secondary:#111318;--bg-tertiary:#151b2d;--bg-input:#151c2e;
  --border-color:#1e2330;--border-accent:#252c3b;--text-primary:#e5e7eb;--text-secondary:#9ca3af;
  --text-muted:#6b7280;--accent-primary:#3b5bdb;--accent-secondary:#7c3aed;--accent-glow:rgba(59,91,219,0.25);
  --msg-ai-bg:transparent;--msg-user-bg:#1d3461;--msg-user-text:#e8f0fe;
  --sidebar-bg:#0f1117;--topbar-bg:#0b0d11;--send-btn:#3b5bdb;--send-btn-hover:#4c6ef5;--user-av:#1e3a5f;
  --font-ui:'Plus Jakarta Sans','Outfit',system-ui,sans-serif;--font-msg:'DM Sans','Plus Jakarta Sans',sans-serif;
  --font-code:'JetBrains Mono',monospace;--radius-main:14px;--shadow-main:0 4px 24px rgba(0,0,0,0.4);
}
[data-theme="cyberpunk"]{--bg-primary:#0a0010;--bg-secondary:#0d0018;--bg-tertiary:#110022;--bg-input:#0f0020;--border-color:#2a0050;--border-accent:#3d0070;--text-primary:#f0e6ff;--text-secondary:#b892ff;--text-muted:#7c52cc;--accent-primary:#bf00ff;--accent-secondary:#00f5ff;--accent-glow:rgba(191,0,255,0.25);--msg-ai-bg:transparent;--msg-user-bg:#1a003a;--msg-user-text:#e8d5ff;--sidebar-bg:#0d0018;--topbar-bg:#080012;--send-btn:#bf00ff;--send-btn-hover:#d333ff;--user-av:#330066;--font-ui:'Orbitron','Space Mono',monospace;--font-msg:'Space Mono',monospace;--radius-main:4px;}
[data-theme="aurora"]{--bg-primary:#020f0a;--bg-secondary:#041a10;--bg-tertiary:#062018;--bg-input:#052818;--border-color:#0d3d20;--border-accent:#155230;--text-primary:#d1fae5;--text-secondary:#6ee7b7;--text-muted:#34d399;--accent-primary:#10b981;--accent-secondary:#06b6d4;--accent-glow:rgba(16,185,129,0.25);--msg-ai-bg:transparent;--msg-user-bg:#063d20;--msg-user-text:#d1fae5;--sidebar-bg:#041a10;--topbar-bg:#020f0a;--send-btn:#10b981;--send-btn-hover:#34d399;--user-av:#064e2a;--font-ui:'Nunito',system-ui,sans-serif;--font-msg:'Nunito',sans-serif;--radius-main:18px;}
[data-theme="solar"]{--bg-primary:#faf8f4;--bg-secondary:#f3f0e8;--bg-tertiary:#ece8dc;--bg-input:#ede9de;--border-color:#d8d0bc;--border-accent:#c5baa8;--text-primary:#2c2416;--text-secondary:#5a4e38;--text-muted:#8a7a60;--accent-primary:#c4862a;--accent-secondary:#d44a00;--accent-glow:rgba(196,134,42,0.15);--msg-ai-bg:transparent;--msg-user-bg:#c4862a;--msg-user-text:#fff8ee;--sidebar-bg:#f3f0e8;--topbar-bg:#faf8f4;--send-btn:#c4862a;--send-btn-hover:#d4922a;--user-av:#7a4a10;--font-ui:'Playfair Display',serif;--font-msg:'DM Sans',sans-serif;--radius-main:10px;}
[data-theme="bloodmoon"]{--bg-primary:#0d0505;--bg-secondary:#140808;--bg-tertiary:#1a0a0a;--bg-input:#180808;--border-color:#3a0f0f;--border-accent:#4d1515;--text-primary:#ffe4e4;--text-secondary:#f87171;--text-muted:#dc2626;--accent-primary:#ef4444;--accent-secondary:#f97316;--accent-glow:rgba(239,68,68,0.25);--msg-ai-bg:transparent;--msg-user-bg:#3a1010;--msg-user-text:#ffe4e4;--sidebar-bg:#140808;--topbar-bg:#0d0505;--send-btn:#ef4444;--send-btn-hover:#f87171;--user-av:#4d1515;--font-ui:'Space Mono',monospace;--font-msg:'Space Mono',monospace;--radius-main:6px;}
[data-theme="ocean"]{--bg-primary:#010d1a;--bg-secondary:#021525;--bg-tertiary:#032030;--bg-input:#03223a;--border-color:#0a3a5a;--border-accent:#0d4e78;--text-primary:#caf0f8;--text-secondary:#90e0ef;--text-muted:#48cae4;--accent-primary:#0096c7;--accent-secondary:#023e8a;--accent-glow:rgba(0,150,199,0.25);--msg-ai-bg:transparent;--msg-user-bg:#023e8a;--msg-user-text:#caf0f8;--sidebar-bg:#021525;--topbar-bg:#010d1a;--send-btn:#0096c7;--send-btn-hover:#00b4d8;--user-av:#03045e;--font-ui:'Outfit',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:16px;}
[data-theme="ember"]{--bg-primary:#0f0800;--bg-secondary:#1a0e00;--bg-tertiary:#261500;--bg-input:#201200;--border-color:#3d2200;--border-accent:#5a3300;--text-primary:#fff3e0;--text-secondary:#ffb347;--text-muted:#e07b00;--accent-primary:#ff6d00;--accent-secondary:#ff9500;--accent-glow:rgba(255,109,0,0.25);--msg-ai-bg:transparent;--msg-user-bg:#5a2e00;--msg-user-text:#fff3e0;--sidebar-bg:#1a0e00;--topbar-bg:#0f0800;--send-btn:#ff6d00;--send-btn-hover:#ff8500;--user-av:#7a3d00;--font-ui:'Sora',sans-serif;--font-msg:'Outfit',sans-serif;--radius-main:12px;}
[data-theme="neon"]{--bg-primary:#050508;--bg-secondary:#09090f;--bg-tertiary:#0d0d16;--bg-input:#0b0b14;--border-color:#1a1a2e;--border-accent:#252540;--text-primary:#f0f0ff;--text-secondary:#a0a0ff;--text-muted:#6060cc;--accent-primary:#4040ff;--accent-secondary:#ff40ff;--accent-glow:rgba(64,64,255,0.3);--msg-ai-bg:transparent;--msg-user-bg:#1a1a4a;--msg-user-text:#e0e0ff;--sidebar-bg:#09090f;--topbar-bg:#050508;--send-btn:#4040ff;--send-btn-hover:#6060ff;--user-av:#1a0030;--font-ui:'Orbitron',monospace;--font-msg:'DM Sans',sans-serif;--radius-main:8px;}
[data-theme="sakura"]{--bg-primary:#fff5f7;--bg-secondary:#ffecf0;--bg-tertiary:#ffe0e8;--bg-input:#ffe8ed;--border-color:#f7c5d0;--border-accent:#f0a0b5;--text-primary:#3d0020;--text-secondary:#8b004a;--text-muted:#c06080;--accent-primary:#e91e8c;--accent-secondary:#ff6b9d;--accent-glow:rgba(233,30,140,0.15);--msg-ai-bg:transparent;--msg-user-bg:#e91e8c;--msg-user-text:#fff5f7;--sidebar-bg:#ffecf0;--topbar-bg:#fff5f7;--send-btn:#e91e8c;--send-btn-hover:#f060a0;--user-av:#8b004a;--font-ui:'Nunito',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:20px;}
[data-theme="slate"]{--bg-primary:#1a1d23;--bg-secondary:#21252d;--bg-tertiary:#272c36;--bg-input:#252b35;--border-color:#32394a;--border-accent:#3d4660;--text-primary:#e2e8f0;--text-secondary:#94a3b8;--text-muted:#64748b;--accent-primary:#38bdf8;--accent-secondary:#818cf8;--accent-glow:rgba(56,189,248,0.2);--msg-ai-bg:transparent;--msg-user-bg:#1e3a5f;--msg-user-text:#e2e8f0;--sidebar-bg:#1c2029;--topbar-bg:#1a1d23;--send-btn:#38bdf8;--send-btn-hover:#7dd3fc;--user-av:#1e3a5f;--font-ui:'Plus Jakarta Sans',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:12px;}
[data-theme="forest"]{--bg-primary:#0a110a;--bg-secondary:#0f180f;--bg-tertiary:#152015;--bg-input:#121a12;--border-color:#203520;--border-accent:#2d4a2d;--text-primary:#d4edda;--text-secondary:#81c784;--text-muted:#4caf50;--accent-primary:#66bb6a;--accent-secondary:#26a69a;--accent-glow:rgba(102,187,106,0.2);--msg-ai-bg:transparent;--msg-user-bg:#1b3a1b;--msg-user-text:#d4edda;--sidebar-bg:#0f180f;--topbar-bg:#0a110a;--send-btn:#66bb6a;--send-btn-hover:#81c784;--user-av:#1b3a1b;--font-ui:'DM Sans',sans-serif;--font-msg:'Outfit',sans-serif;--radius-main:14px;}
[data-theme="violet"]{--bg-primary:#0d0a1a;--bg-secondary:#130f25;--bg-tertiary:#1a1430;--bg-input:#161128;--border-color:#2d2550;--border-accent:#3d3366;--text-primary:#ede8ff;--text-secondary:#b8aaff;--text-muted:#8070cc;--accent-primary:#8b5cf6;--accent-secondary:#ec4899;--accent-glow:rgba(139,92,246,0.25);--msg-ai-bg:transparent;--msg-user-bg:#2d1a5a;--msg-user-text:#ede8ff;--sidebar-bg:#130f25;--topbar-bg:#0d0a1a;--send-btn:#8b5cf6;--send-btn-hover:#a78bfa;--user-av:#2d1a5a;--font-ui:'Outfit',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:16px;}
[data-theme="mint"]{--bg-primary:#f0faf8;--bg-secondary:#e5f7f2;--bg-tertiary:#d5f0ea;--bg-input:#daf0eb;--border-color:#b0ddd6;--border-accent:#80c4b9;--text-primary:#0d2b26;--text-secondary:#1a6b5f;--text-muted:#35a08f;--accent-primary:#0d9488;--accent-secondary:#0891b2;--accent-glow:rgba(13,148,136,0.15);--msg-ai-bg:transparent;--msg-user-bg:#0d9488;--msg-user-text:#f0faf8;--sidebar-bg:#e5f7f2;--topbar-bg:#f0faf8;--send-btn:#0d9488;--send-btn-hover:#14b8a6;--user-av:#0d4d47;--font-ui:'Nunito',sans-serif;--font-msg:'DM Sans',sans-serif;--radius-main:18px;}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:var(--bg-primary);color:var(--text-primary);font-family:var(--font-ui);font-size:14px;transition:background .4s,color .4s}
#app{display:flex;height:100vh;width:100%;overflow:hidden;position:relative}
#sidebar{width:260px;min-width:260px;background:var(--sidebar-bg);border-right:1px solid var(--border-color);display:flex;flex-direction:column;height:100vh;transition:all .3s;overflow:hidden;z-index:100;position:relative;flex-shrink:0}
#sidebar.collapsed{width:0;min-width:0;border:none}
#sidebar-inner{width:260px;min-width:260px;display:flex;flex-direction:column;height:100%}
#sidebar-scroll{flex:1;overflow-y:auto}
#sidebar-scroll::-webkit-scrollbar{width:3px}
#sidebar-scroll::-webkit-scrollbar-thumb{background:var(--border-accent);border-radius:4px}
#sidebar-toggle{position:absolute;top:50%;right:-17px;transform:translateY(-50%);background:var(--bg-secondary);border:1px solid var(--border-color);width:17px;height:44px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:101;border-radius:0 7px 7px 0;color:var(--text-muted);transition:background .2s;flex-shrink:0}
#sidebar-toggle:hover{background:var(--border-accent);color:var(--text-primary)}
#mob-toggle{display:none;position:fixed;top:10px;left:10px;z-index:300;background:var(--bg-secondary);border:1px solid var(--border-color);width:36px;height:36px;border-radius:9px;align-items:center;justify-content:center;cursor:pointer;color:var(--text-secondary)}
#mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:190}
#main{flex:1;display:flex;flex-direction:column;min-width:0;height:100vh;overflow:hidden}
#topbar{height:50px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;padding:0 14px;gap:8px;flex-shrink:0;background:var(--topbar-bg)}
.tbLeft{display:flex;align-items:center;gap:7px;flex-wrap:nowrap;min-width:0;overflow:hidden}
.tbRight{display:flex;align-items:center;gap:7px;flex-shrink:0}
#chat-window{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:4px}
#chat-window::-webkit-scrollbar{width:4px}
#chat-window::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:4px}
#input-area{border-top:1px solid var(--border-color);padding:9px 12px;background:var(--topbar-bg);flex-shrink:0}
#input-wrap{max-width:780px;margin:0 auto;background:var(--bg-input);border:1px solid var(--border-accent);border-radius:var(--radius-main);overflow:hidden;transition:border-color .2s}
#input-wrap:focus-within{border-color:var(--accent-primary);box-shadow:0 0 0 3px var(--accent-glow)}
#user-input{width:100%;background:transparent;border:none;outline:none;color:var(--text-primary);font-size:14px;font-family:var(--font-msg);padding:11px 13px 4px;resize:none;max-height:120px;line-height:1.6}
#user-input::placeholder{color:var(--text-muted)}
#input-bottom{display:flex;align-items:center;padding:4px 7px 7px;gap:5px}
#input-bottom-left{display:flex;align-items:center;gap:3px;flex:1}
.ia-btn{background:transparent;border:none;cursor:pointer;color:var(--text-muted);padding:5px 7px;border-radius:7px;font-size:13px;transition:all .2s;display:flex;align-items:center;gap:4px}
.ia-btn:hover{background:var(--border-accent);color:var(--text-primary)}
#send-btn{background:var(--send-btn);border:none;cursor:pointer;color:#fff;padding:7px 14px;border-radius:9px;font-size:13px;font-weight:700;transition:all .2s;display:flex;align-items:center;gap:6px;white-space:nowrap;font-family:var(--font-ui)}
#send-btn:hover{background:var(--send-btn-hover);transform:scale(1.03)}
#send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}

/* Messages */
.msg-row{display:flex;gap:10px;max-width:780px;width:100%;margin:0 auto;animation:fadeSlideIn .28s ease;padding:3px 0}
@keyframes fadeSlideIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.msg-row.user-row{flex-direction:row-reverse}
.msg-av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;margin-top:3px}
.msg-av.ai{background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary))}
.msg-av.user{background:var(--user-av)}
.msg-bbl{max-width:calc(100% - 48px);padding:10px 14px;border-radius:var(--radius-main);font-size:14.5px;line-height:1.7;word-break:break-word;font-family:var(--font-msg);letter-spacing:0.01em}
.msg-bbl.ai{background:var(--msg-ai-bg);border:none;border-radius:0}
.msg-bbl.user{background:var(--msg-user-bg);color:var(--msg-user-text);border-radius:14px 4px 14px 14px;padding:10px 14px}

/* Code */
.code-block{background:#0d1117;border:1px solid #21262d;border-radius:10px;margin:10px 0;overflow:hidden}
.code-hdr{display:flex;align-items:center;justify-content:space-between;background:#161b22;border-bottom:1px solid #21262d;padding:5px 13px}
.code-lang{font-family:var(--font-code);font-size:11px;text-transform:uppercase;color:#58a6ff;font-weight:700}
.copy-btn{background:#21262d;border:1px solid #30363d;color:#8b949e;border-radius:5px;padding:2px 8px;font-size:11px;cursor:pointer;transition:all .2s}
.copy-btn:hover{background:#30363d;color:#e6edf3}
.code-block pre{margin:0;padding:14px 16px;overflow-x:auto;font-size:13px;line-height:1.65;background:transparent}
.code-block pre code{background:transparent!important;padding:0!important;font-family:var(--font-code)!important}
.inline-code{background:rgba(110,118,129,.15);border-radius:4px;padding:2px 6px;font-family:var(--font-code);font-size:12.5px;border:1px solid rgba(110,118,129,.2)}

/* Math */
.math-block{background:rgba(255,255,255,0.04);border-left:3px solid var(--accent-primary);padding:12px 16px;margin:10px 0;border-radius:0 8px 8px 0;overflow-x:auto;font-size:15px;line-height:2}
.math-inline{background:rgba(255,255,255,0.04);border-radius:4px;padding:1px 6px;font-size:14px}
.frac-display{display:inline-flex;flex-direction:column;align-items:center;vertical-align:middle;margin:0 3px;font-family:var(--font-msg)}
.frac-num{border-bottom:1.5px solid currentColor;padding:0 3px;text-align:center;font-size:0.9em}
.frac-den{padding:0 3px;text-align:center;font-size:0.9em}

/* Media */
.media-card{background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:11px;overflow:hidden;margin:6px 0;max-width:100%}
.media-card img{width:100%;display:block;max-height:380px;object-fit:cover}
.media-foot{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-top:1px solid var(--border-color);gap:8px}
.media-lbl{font-size:11px;color:var(--text-muted);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mbtn{font-size:11px;padding:3px 9px;border-radius:5px;cursor:pointer;border:1px solid var(--border-accent);background:var(--bg-secondary);color:var(--text-secondary);text-decoration:none;display:inline-flex;align-items:center;gap:4px;transition:all .2s}
.mbtn:hover{background:var(--border-accent);color:var(--text-primary)}
.sbadge{font-size:11px;padding:3px 7px;border-radius:18px;border:1px solid;display:inline-flex;align-items:center;gap:4px;white-space:nowrap}
.s-ok{color:#22c55e;border-color:#22c55e40}
.s-err{color:#ef4444;border-color:#ef444440}
.s-wait{color:var(--text-muted);border-color:var(--border-accent)}
.s-web{background:rgba(59,130,246,.1);border-color:rgba(59,130,246,.3);color:#60a5fa}
.s-creator{background:linear-gradient(90deg,#7c3aed,#db2777);color:#fff;font-size:10px;padding:2px 7px;border-radius:18px;font-weight:700}

/* Welcome */
#welcome-msg{display:none;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;gap:12px;padding:20px}
.z-logo{font-size:56px;font-weight:900;color:var(--accent-primary);font-family:var(--font-ui);line-height:1;text-shadow:0 0 40px var(--accent-glow);animation:logoPulse 3s ease-in-out infinite}
@keyframes logoPulse{0%,100%{text-shadow:0 0 40px var(--accent-glow)}50%{text-shadow:0 0 80px var(--accent-glow),0 0 120px var(--accent-glow)}}

/* Typing dots */
.tdot{width:7px;height:7px;background:var(--accent-primary);border-radius:50%;animation:tdot 1.2s infinite}
.tdot:nth-child(2){animation-delay:.2s}
.tdot:nth-child(3){animation-delay:.4s}
@keyframes tdot{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}
.spin{width:13px;height:13px;border:2px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}

/* ADV Panel */
.adv-panel{position:fixed;top:0;right:0;width:380px;max-width:100vw;height:100vh;background:var(--bg-secondary);border-left:1px solid var(--border-color);z-index:400;display:flex;flex-direction:column;transform:translateX(100%);transition:transform .3s ease}
.adv-panel.open{transform:translateX(0)}
.adv-tab{display:flex;border-bottom:1px solid var(--border-color);flex-shrink:0;overflow-x:auto}
.adv-tab::-webkit-scrollbar{height:0}
.adv-tab button{flex:1;min-width:38px;padding:9px 3px;font-size:11px;color:var(--text-muted);border:none;background:transparent;cursor:pointer;border-bottom:2px solid transparent;font-family:var(--font-ui)}
.adv-tab button.active{color:var(--accent-primary);border-bottom-color:var(--accent-primary);background:var(--accent-glow)}
.adv-body{flex:1;overflow-y:auto;padding:13px}
.adv-s{margin-bottom:16px}
.adv-s h4{font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.07em;margin-bottom:7px;padding-bottom:4px;border-bottom:1px solid var(--border-color)}
.adv-btn{display:flex;align-items:center;gap:7px;width:100%;padding:8px 11px;border-radius:7px;border:1px solid var(--border-color);background:var(--bg-primary);color:var(--text-primary);font-size:12px;cursor:pointer;transition:all .2s;margin-bottom:5px;text-align:left;font-family:var(--font-ui)}
.adv-btn:hover{background:var(--border-accent);border-color:var(--accent-primary)}
.adv-in{width:100%;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:6px;padding:7px 10px;font-size:12px;color:var(--text-primary);outline:none;margin-bottom:6px;font-family:var(--font-msg)}
.adv-in:focus{border-color:var(--accent-primary)}
.adv-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:390}
.adv-ov.show{display:block}

/* Toast */
.toast{position:fixed;bottom:18px;right:18px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;padding:9px 15px;font-size:13px;color:var(--text-primary);z-index:9999;opacity:0;transform:translateY(10px);transition:all .3s;pointer-events:none;max-width:300px;font-family:var(--font-ui)}
.toast.show{opacity:1;transform:translateY(0)}
.toast.ok{border-color:#22c55e60;color:#22c55e}
.toast.err{border-color:#ef444460;color:#ef4444}
.toast.warn{border-color:#fbbf2460;color:#fbbf24}

/* Modals */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:500;overflow-y:auto;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal-box{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:16px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,0.8);width:100%;max-width:540px;margin:20px;position:relative}
.modal-close{position:absolute;top:14px;right:14px;background:none;border:none;color:var(--text-muted);font-size:22px;cursor:pointer;line-height:1;padding:4px}
.modal-close:hover{color:var(--text-primary)}

/* Setup screen */
#setup-screen{position:fixed;inset:0;background:var(--bg-primary);z-index:1000;display:flex;align-items:center;justify-content:center;flex-direction:column}
.setup-card{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:20px;padding:36px 32px;max-width:490px;width:100%;margin:16px;text-align:center;box-shadow:var(--shadow-main)}
.setup-logo{font-size:64px;font-weight:900;color:var(--accent-primary);font-family:var(--font-ui);margin-bottom:8px;animation:logoPulse 3s ease-in-out infinite}
.setup-input{width:100%;background:var(--bg-primary);border:1px solid var(--border-accent);border-radius:10px;padding:12px 14px;font-size:15px;color:var(--text-primary);outline:none;font-family:var(--font-msg);transition:border-color .2s,box-shadow .2s}
.setup-input:focus{border-color:var(--accent-primary);box-shadow:0 0 0 3px var(--accent-glow)}
.setup-btn{width:100%;padding:13px;background:var(--send-btn);border:none;color:#fff;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;font-family:var(--font-ui);margin-top:6px}
.setup-btn:hover{background:var(--send-btn-hover);transform:translateY(-1px)}

/* Theme grid */
.theme-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:7px;margin:10px 0 16px}
.theme-dot{width:100%;aspect-ratio:1;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all .2s;position:relative;overflow:hidden}
.theme-dot.active{border-color:#fff;transform:scale(1.1);box-shadow:0 0 12px rgba(255,255,255,.3)}
.theme-dot-inner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:14px}
.theme-name{font-size:8px;text-align:center;color:var(--text-muted);margin-top:3px;font-weight:600;text-transform:uppercase}
.theme-pill{display:flex;align-items:center;gap:4px;padding:4px 9px;border-radius:18px;border:1px solid var(--border-accent);background:var(--bg-secondary);cursor:pointer;font-size:11px;color:var(--text-secondary);transition:all .2s}
.theme-pill:hover{border-color:var(--accent-primary);color:var(--text-primary)}

/* Resp actions */
.resp-actions{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap}
.ra-btn{padding:4px 9px;font-size:11px;background:transparent;border:1px solid var(--border-accent);color:var(--text-muted);border-radius:5px;cursor:pointer;transition:all .2s;font-family:var(--font-ui)}
.ra-btn:hover{background:var(--border-accent);color:var(--text-primary)}

/* Mem items */
.mem-item{display:flex;align-items:flex-start;gap:6px;padding:7px 9px;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:7px;margin-bottom:4px;font-size:12px}
.mem-key{color:var(--accent-primary);font-weight:600;min-width:65px;flex-shrink:0}
.mem-val{color:var(--text-secondary);flex:1;word-break:break-word;max-height:38px;overflow:hidden}
.mem-del{color:var(--text-muted);cursor:pointer;flex-shrink:0;background:none;border:none;padding:1px 3px}
.mem-del:hover{color:#ef4444}

/* Plus menu */
#plus-menu{display:none;position:absolute;bottom:calc(100% + 8px);left:0;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:11px;padding:6px 0;min-width:210px;z-index:100;box-shadow:var(--shadow-main)}
.pmenu-item{width:100%;padding:9px 15px;border:none;background:transparent;color:var(--text-secondary);text-align:left;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:9px;transition:all .2s;font-family:var(--font-ui)}
.pmenu-item:hover{background:var(--border-accent);color:var(--text-primary)}
#model-sel{background:var(--bg-secondary);border:1px solid var(--border-color);color:var(--accent-primary);font-size:11px;border-radius:6px;padding:3px 6px;outline:none;cursor:pointer;max-width:130px;font-family:var(--font-ui)}

/* Personality */
.pers-btn{padding:8px 12px;border-radius:7px;background:var(--bg-primary);color:var(--text-muted);border:1px solid var(--border-accent);cursor:pointer;font-size:12px;transition:all .2s;font-family:var(--font-ui)}
.pers-btn.active{background:var(--accent-glow);color:var(--accent-primary);border-color:var(--accent-primary)}

/* Web search indicator */
.web-indicator{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:14px;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);color:#60a5fa;font-size:11px;margin-bottom:8px}

/* Voice config */
.voice-slider{width:100%;accent-color:var(--accent-primary);margin:4px 0}
.voice-preview-btn{padding:6px 12px;background:var(--accent-glow);border:1px solid var(--accent-primary);color:var(--accent-primary);border-radius:7px;font-size:12px;cursor:pointer;font-family:var(--font-ui);transition:all .2s}
.voice-preview-btn:hover{background:var(--accent-primary);color:#fff}

/* Download btn */
.download-zenia-btn{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:18px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));color:#fff;font-size:12px;font-weight:700;text-decoration:none;transition:all .2s;border:none;cursor:pointer;white-space:nowrap}
.download-zenia-btn:hover{opacity:.85;transform:scale(1.03)}

#camera-canvas{display:none;position:fixed;top:60px;right:14px;width:60px;height:60px;border:2px solid var(--accent-primary);border-radius:50%;z-index:500;background:#000;cursor:pointer;object-fit:cover}

/* Vision modal */
.vision-result{background:rgba(255,255,255,0.03);border:1px solid var(--border-color);border-radius:10px;padding:13px;margin:8px 0}

@media(max-width:768px){
  #sidebar{position:fixed;left:0;top:0;height:100%;transform:translateX(-100%);z-index:200;width:270px;min-width:270px}
  #sidebar.mob-open{transform:translateX(0)}
  #sidebar.collapsed{transform:translateX(-100%)}
  #sidebar-toggle{display:none}
  #mob-toggle{display:flex}
  #mob-overlay.show{display:block}
  #main{width:100%}
  #topbar{padding:0 9px 0 50px;height:46px}
  .adv-panel{width:100vw}
  #input-area{padding:7px 8px}
  .theme-grid{grid-template-columns:repeat(6,1fr)}
  .download-zenia-btn span{display:none}
}
</style>
</head>
<body data-theme="dark">

<!-- SETUP SCREEN -->
<div id="setup-screen" style="display:none">
  <div class="setup-card">
    <div class="setup-logo">Z</div>
    <div style="font-size:22px;font-weight:800;margin-bottom:4px">Bem-vindo √† IA-Zenia</div>
    <div style="font-size:12px;color:var(--text-muted);margin-bottom:24px;line-height:1.6">Antes de come√ßarmos, deixa-me conhecer-te<br>e escolher como preferes que eu apare√ßa.</div>
    <div style="margin-bottom:20px;text-align:left">
      <label style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:6px">Como te chamas?</label>
      <input class="setup-input" id="setup-name" type="text" placeholder="Escreve o teu nome..." maxlength="30" autofocus onkeydown="if(event.key==='Enter')completeSetup()">
      <div style="font-size:11px;color:var(--text-muted);margin-top:5px">A Zenia vai chamar-te por este nome nas conversas.</div>
    </div>
    <div style="margin-bottom:20px;text-align:left">
      <label style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:8px">Escolhe o teu tema</label>
      <div class="theme-grid" id="setup-theme-grid"></div>
    </div>
    <button class="setup-btn" onclick="completeSetup()"><i class="fas fa-arrow-right"></i> Iniciar com a Zenia</button>
  </div>
</div>

<!-- THEME MODAL -->
<div id="theme-modal" class="modal-overlay">
  <div class="modal-box" style="max-width:460px">
    <button class="modal-close" onclick="closeThemeModal()">&times;</button>
    <h3 style="margin-bottom:16px;font-size:16px;font-weight:700">üé® Trocar Tema</h3>
    <div class="theme-grid" id="modal-theme-grid"></div>
    <div style="font-size:11px;color:var(--text-muted);margin-top:4px">O tema √© guardado automaticamente.</div>
  </div>
</div>

<!-- PERSONALITY MODAL -->
<div id="personality-modal" class="modal-overlay">
  <div class="modal-box">
    <button class="modal-close" onclick="closePersonality()">&times;</button>
    <h3 style="margin-bottom:16px;font-size:16px;font-weight:700">Personalidade &amp; Voz da Z√©nia</h3>
    <div style="margin-bottom:16px">
      <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px">Tom de Conversa</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button onclick="setPersonality('amigavel')" class="pers-btn active" data-tone="amigavel">üòä Amig√°vel</button>
        <button onclick="setPersonality('profissional')" class="pers-btn" data-tone="profissional">üíº Profissional</button>
        <button onclick="setPersonality('humorista')" class="pers-btn" data-tone="humorista">üòÑ Humorista</button>
        <button onclick="setPersonality('tecnico')" class="pers-btn" data-tone="tecnico">‚öôÔ∏è T√©cnico</button>
        <button onclick="setPersonality('criativo')" class="pers-btn" data-tone="criativo">üé® Criativo</button>
      </div>
    </div>
    <div style="margin-bottom:16px">
      <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px">N√≠vel de Detalhe</div>
      <div style="display:flex;gap:7px">
        <button onclick="setDetailLevel('curto')" class="pers-btn" data-level="curto" style="flex:1">Curto</button>
        <button onclick="setDetailLevel('medio')" class="pers-btn active" data-level="medio" style="flex:1">M√©dio</button>
        <button onclick="setDetailLevel('detalhado')" class="pers-btn" data-level="detalhado" style="flex:1">Detalhado</button>
      </div>
    </div>
    <div style="margin-bottom:16px;border-top:1px solid var(--border-color);padding-top:14px">
      <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:10px">üîä Configura√ß√£o de Voz</div>
      <div style="margin-bottom:10px">
        <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:5px">Voz</label>
        <select id="voice-select" class="adv-in" style="margin-bottom:0" onchange="updateVoiceConfig()">
          <option value="">Carregando vozes...</option>
        </select>
      </div>
      <div style="margin-bottom:10px">
        <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:5px">Velocidade: <span id="voice-rate-val">1.0</span>x</label>
        <input type="range" class="voice-slider" id="voice-rate" min="0.5" max="2" step="0.1" value="1" oninput="document.getElementById('voice-rate-val').textContent=parseFloat(this.value).toFixed(1);updateVoiceConfig()">
      </div>
      <div style="margin-bottom:10px">
        <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:5px">Tom: <span id="voice-pitch-val">1.0</span></label>
        <input type="range" class="voice-slider" id="voice-pitch" min="0.5" max="2" step="0.1" value="1" oninput="document.getElementById('voice-pitch-val').textContent=parseFloat(this.value).toFixed(1);updateVoiceConfig()">
      </div>
      <div style="margin-bottom:10px">
        <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:5px">Volume: <span id="voice-vol-val">1.0</span></label>
        <input type="range" class="voice-slider" id="voice-vol" min="0" max="1" step="0.1" value="1" oninput="document.getElementById('voice-vol-val').textContent=parseFloat(this.value).toFixed(1);updateVoiceConfig()">
      </div>
      <button class="voice-preview-btn" onclick="previewVoice()"><i class="fas fa-play"></i> Testar Voz</button>
    </div>
    <div style="background:var(--bg-primary);border:1px solid var(--border-color);border-radius:8px;padding:10px;font-size:12px;margin-bottom:14px">
      Tom: <span id="current-tone" style="color:var(--accent-primary);font-weight:600">Amig√°vel</span> &nbsp;|&nbsp;
      Detalhe: <span id="current-detail" style="color:var(--accent-primary);font-weight:600">M√©dio</span>
    </div>
    <button onclick="closePersonality()" style="width:100%;padding:10px;background:var(--send-btn);border:none;color:#fff;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font-ui)">‚úì Confirmar</button>
  </div>
</div>

<!-- VISION MODAL -->
<div id="vision-modal" class="modal-overlay">
  <div class="modal-box">
    <button class="modal-close" onclick="closeVisionModal()">&times;</button>
    <h3 style="margin-bottom:6px;font-size:16px;font-weight:700"><i class="fas fa-eye" style="color:#10b981;margin-right:8px"></i>Vis√£o Computacional</h3>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Carrega uma imagem e a Zenia analisa-a com IA.</p>
    <div id="vision-drop-zone" style="border:2px dashed var(--border-accent);border-radius:10px;padding:28px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:14px" onclick="document.getElementById('vision-file').click()">
      <div id="vision-preview" style="display:none;margin-bottom:10px"><img id="vision-img-preview" style="max-height:180px;max-width:100%;border-radius:8px;object-fit:contain"></div>
      <div id="vision-placeholder">
        <i class="fas fa-cloud-upload-alt" style="font-size:32px;color:var(--accent-primary);margin-bottom:8px;display:block"></i>
        <div style="font-size:13px;font-weight:600">Arrasta ou clica para carregar</div>
        <div style="font-size:11px;color:var(--text-muted);margin-top:4px">JPG, PNG, WebP</div>
      </div>
    </div>
    <input type="file" id="vision-file" accept="image/*" style="display:none" onchange="loadVisionPreview(event)">
    <input class="adv-in" id="vision-question" placeholder="O que queres saber sobre a imagem? (opcional)">
    <button onclick="analyzeVision()" id="vision-analyze-btn" style="width:100%;padding:11px;background:var(--send-btn);border:none;color:#fff;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font-ui)">
      <i class="fas fa-search"></i> Analisar com IA
    </button>
    <div id="vision-result" style="display:none;margin-top:14px"></div>
  </div>
</div>

<!-- WEB SEARCH MODAL -->
<div id="websearch-modal" class="modal-overlay">
  <div class="modal-box" style="max-width:560px">
    <button class="modal-close" onclick="document.getElementById('websearch-modal').classList.remove('open')">&times;</button>
    <h3 style="margin-bottom:6px;font-size:16px;font-weight:700"><i class="fas fa-search" style="color:#60a5fa;margin-right:8px"></i>Pesquisa Web Avan√ßada</h3>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:14px">Pesquisa e navega em p√°ginas web com IA.</p>
    <div style="margin-bottom:10px">
      <select id="search-engine" class="adv-in" style="margin-bottom:8px">
        <option value="duckduckgo">DuckDuckGo (Gr√°tis)</option>
        <option value="bing">Bing Search</option>
        <option value="google">Google (via SerpAPI)</option>
        <option value="yandex">Yandex Search</option>
      </select>
      <div style="display:flex;gap:6px">
        <input class="adv-in" id="web-query" placeholder="O que queres pesquisar?" style="flex:1;margin-bottom:0">
        <button onclick="doWebSearch()" style="padding:7px 14px;background:var(--send-btn);border:none;color:#fff;border-radius:6px;cursor:pointer;font-size:12px;font-family:var(--font-ui);flex-shrink:0">Pesquisar</button>
      </div>
    </div>
    <div style="margin-bottom:10px">
      <label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:4px">Navegar para URL:</label>
      <div style="display:flex;gap:6px">
        <input class="adv-in" id="web-url" placeholder="https://..." style="flex:1;margin-bottom:0">
        <button onclick="doFetchURL()" style="padding:7px 14px;background:var(--border-accent);border:1px solid var(--border-color);color:var(--text-primary);border-radius:6px;cursor:pointer;font-size:12px;font-family:var(--font-ui);flex-shrink:0">Ir</button>
      </div>
    </div>
    <div id="websearch-results" style="max-height:280px;overflow-y:auto"></div>
  </div>
</div>

<!-- APP -->
<div id="app">

<!-- SIDEBAR -->
<div id="sidebar">
  <button id="sidebar-toggle" onclick="toggleSidebar()">
    <i class="fas fa-chevron-left" id="stg-ic" style="font-size:9px"></i>
  </button>
  <div id="sidebar-inner">
    <div style="padding:14px 13px 9px;flex-shrink:0;border-bottom:1px solid var(--border-color)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <div style="width:32px;height:32px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;font-weight:900;color:#fff;flex-shrink:0">Z</div>
        <div><div style="font-weight:700;font-size:14px;color:var(--text-primary)">IA-Zenia</div><div style="font-size:10px;color:var(--text-muted)">by Zenia-Projects</div></div>
      </div>
      <button onclick="startNew()" style="width:100%;background:var(--accent-glow);border:1px solid var(--accent-primary);color:var(--accent-primary);padding:7px;border-radius:8px;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;font-family:var(--font-ui);font-weight:600;transition:all .2s">
        <i class="fas fa-plus"></i> Nova Conversa
      </button>
    </div>
    <div id="sidebar-scroll">
      <div style="padding:9px 10px 3px">
        <p style="font-size:10px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px;padding:0 3px">Recursos</p>
        <button onclick="openAdv()" style="width:100%;display:flex;align-items:center;gap:7px;padding:6px 9px;border-radius:7px;background:transparent;border:none;cursor:pointer;color:var(--text-secondary);font-size:12px;text-align:left;font-family:var(--font-ui)"><i class="fas fa-sliders-h" style="color:var(--accent-primary);width:15px"></i> Ferramentas Avan√ßadas</button>
        <button onclick="document.getElementById('websearch-modal').classList.add('open')" style="width:100%;display:flex;align-items:center;gap:7px;padding:6px 9px;border-radius:7px;background:transparent;border:none;cursor:pointer;color:var(--text-secondary);font-size:12px;text-align:left;font-family:var(--font-ui)"><i class="fas fa-search" style="color:#60a5fa;width:15px"></i> Pesquisa Web</button>
        <button onclick="openGallery()" style="width:100%;display:flex;align-items:center;gap:7px;padding:6px 9px;border-radius:7px;background:transparent;border:none;cursor:pointer;color:var(--text-secondary);font-size:12px;text-align:left;font-family:var(--font-ui)"><i class="fas fa-images" style="color:#db2777;width:15px"></i> Galeria</button>
        <button onclick="openThemeModal()" style="width:100%;display:flex;align-items:center;gap:7px;padding:6px 9px;border-radius:7px;background:transparent;border:none;cursor:pointer;color:var(--text-secondary);font-size:12px;text-align:left;font-family:var(--font-ui)"><i class="fas fa-palette" style="color:#f59e0b;width:15px"></i> Trocar Tema</button>
        <button onclick="openPersonality()" style="width:100%;display:flex;align-items:center;gap:7px;padding:6px 9px;border-radius:7px;background:transparent;border:none;cursor:pointer;color:var(--text-secondary);font-size:12px;text-align:left;font-family:var(--font-ui)"><i class="fas fa-microphone" style="color:#a855f7;width:15px"></i> Config. Voz</button>
      </div>
      <div style="padding:9px 10px 3px">
        <p style="font-size:10px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px;padding:0 3px">Aplicativos</p>
        <a href="https://antonia-ia.netlify.app" target="_blank" style="width:100%;display:flex;align-items:center;gap:7px;padding:6px 9px;border-radius:7px;text-decoration:none;color:var(--text-secondary);font-size:12px"><i class="fas fa-comment-dots" style="color:#10b981;width:15px"></i> Antonia IA</a>
        <a href="https://ia-zenia.netlify.app/zedex" target="_blank" style="width:100%;display:flex;align-items:center;gap:7px;padding:6px 9px;border-radius:7px;text-decoration:none;color:var(--text-secondary);font-size:12px"><i class="fas fa-code" style="color:#60a5fa;width:15px"></i> Zedex Code</a>
        <a href="https://zenia-projects.netlify.app" target="_blank" style="width:100%;display:flex;align-items:center;gap:7px;padding:6px 9px;border-radius:7px;text-decoration:none;color:var(--text-secondary);font-size:12px"><i class="fas fa-project-diagram" style="color:#f59e0b;width:15px"></i> Zenia Projects</a>
      </div>
      <div style="padding:6px 10px">
        <a href="https://ia-zenia.netlify.app/download" target="_blank" class="download-zenia-btn" style="width:100%;justify-content:center;border-radius:8px;text-decoration:none">
          <i class="fas fa-download"></i> <span>Baixar IA-Zenia</span>
        </a>
      </div>
      <div style="padding:4px 10px">
        <p style="font-size:10px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px;padding:0 3px">Hist√≥rico</p>
        <input id="search-in" type="text" placeholder="Pesquisar..." oninput="filterHist(this.value)" style="width:100%;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:7px;padding:5px 9px;font-size:12px;color:var(--text-primary);outline:none;margin-bottom:6px;font-family:var(--font-msg)">
        <div id="hist-list"></div>
      </div>
    </div>
    <div style="padding:9px 13px;border-top:1px solid var(--border-color);flex-shrink:0;display:flex;align-items:center;gap:7px">
      <div style="width:28px;height:28px;background:var(--user-av);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;flex-shrink:0">
        <span id="user-initial">U</span>
      </div>
      <div style="flex:1;overflow:hidden">
        <div id="uname" style="font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Utilizador</div>
        <div style="font-size:10px;color:#22c55e">‚óè Online</div>
      </div>
    </div>
  </div>
</div>

<button id="mob-toggle" onclick="toggleMob()"><i class="fas fa-bars" style="font-size:14px"></i></button>
<div id="mob-overlay" onclick="toggleMob()"></div>

<!-- MAIN -->
<div id="main">
  <div id="topbar">
    <div class="tbLeft">
      <select id="model-sel">
        <option value="openai">OpenAI</option>
        <option value="qwen-coder" selected>Qwen Coder</option>
        <option value="openai-large">OpenAI Large</option>
        <option value="mistral">Mistral</option>
        <option value="deepseek">DeepSeek</option>
      </select>
      <span id="api-st" class="sbadge s-wait"><i class="fas fa-circle" style="font-size:6px"></i> API</span>
      <span id="web-st" class="sbadge s-web" style="display:none"><i class="fas fa-globe"></i> Web</span>
      <span id="creator-badge" class="s-creator" style="display:none">CRIADOR</span>
    </div>
    <div class="tbRight">
      <button class="theme-pill" onclick="openThemeModal()">
        <i class="fas fa-circle-half-stroke"></i>
        <span id="theme-label">Dark</span>
      </button>
      <button id="voice-btn" onclick="toggleVoice()" class="sbadge s-wait" style="cursor:pointer;background:transparent">
        <i class="fas fa-headset"></i>
      </button>
      <a href="https://ia-zenia.netlify.app/download" target="_blank" class="download-zenia-btn">
        <i class="fas fa-download"></i><span>Baixar</span>
      </a>
    </div>
  </div>

  <div id="chat-window">
    <div id="welcome-msg">
      <div class="z-logo">Z</div>
      <div style="font-size:22px;font-weight:800">Ol√°, <span id="welcome-name">amigo</span>!</div>
      <div style="font-size:13px;color:var(--text-muted);max-width:400px;line-height:1.8">
        Sou a Zenia, a tua assistente IA feita em Angola.<br>
        Posso gerar imagens, v√≠deos, analisar fotos e muito mais.
      </div>
    </div>
  </div>

  <div id="input-area">
    <div id="input-wrap">
      <textarea id="user-input" rows="1" placeholder="Fala com a Zenia..."></textarea>
      <div id="input-bottom">
        <div id="input-bottom-left">
          <div style="position:relative;display:inline-flex">
            <button class="ia-btn" id="upload-btn" onclick="togglePlusMenu()" style="color:var(--accent-secondary)"><i class="fas fa-plus"></i></button>
            <div id="plus-menu">
              <button class="pmenu-item" onclick="document.getElementById('file-input').click();togglePlusMenu()"><i class="fas fa-image" style="width:16px;color:var(--accent-secondary)"></i> Carregar Imagem</button>
              <button class="pmenu-item" onclick="toggleCamera();togglePlusMenu()"><i class="fas fa-video" style="width:16px;color:#ef4444"></i> C√¢mera ao Vivo</button>
              <button class="pmenu-item" onclick="openVisionModal();togglePlusMenu()"><i class="fas fa-eye" style="width:16px;color:#10b981"></i> Vis√£o Computacional</button>
              <button class="pmenu-item" onclick="document.getElementById('websearch-modal').classList.add('open');togglePlusMenu()"><i class="fas fa-search" style="width:16px;color:#60a5fa"></i> Pesquisa Web</button>
              <button class="pmenu-item" onclick="openPersonality();togglePlusMenu()"><i class="fas fa-sliders-h" style="width:16px;color:var(--accent-primary)"></i> Personalidade</button>
              <button class="pmenu-item" onclick="openThemeModal();togglePlusMenu()"><i class="fas fa-palette" style="width:16px;color:#f59e0b"></i> Trocar Tema</button>
              <hr style="border-color:var(--border-color);margin:4px 0">
              <a href="https://ia-zenia.netlify.app/download" target="_blank" class="pmenu-item" style="text-decoration:none"><i class="fas fa-download" style="width:16px;color:#22c55e"></i> Baixar IA-Zenia</a>
            </div>
          </div>
          <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFileUpload(event)">
          <button class="ia-btn" id="mic-btn"><i class="fas fa-microphone"></i></button>
          <button class="ia-btn" onclick="openPersonality()"><i class="fas fa-sliders-h"></i></button>
          <button class="ia-btn" onclick="clearChat()"><i class="fas fa-trash-alt"></i></button>
        </div>
        <button id="send-btn" onclick="handleSend()">
          <i class="fas fa-paper-plane" id="send-ic"></i>
        </button>
      </div>
    </div>
    <div style="max-width:780px;margin:4px auto 0;text-align:center;font-size:10px;color:var(--text-muted);opacity:.4">Zenia pode cometer erros. Verifica informa√ß√µes importantes.</div>
  </div>
</div>
</div>

<canvas id="camera-canvas" onclick="toggleCamera()"></canvas>
<div class="adv-ov" id="adv-ov" onclick="closeAdv()"></div>
<div class="adv-panel" id="adv-panel">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 13px;border-bottom:1px solid var(--border-color);flex-shrink:0">
    <span style="font-size:14px;font-weight:700"><i class="fas fa-sliders-h" style="color:var(--accent-primary);margin-right:7px"></i>Ferramentas</span>
    <button onclick="closeAdv()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:18px">&times;</button>
  </div>
  <div class="adv-tab" id="adv-tabs">
    <button onclick="switchTab('mem')" class="active">Mem.</button>
    <button onclick="switchTab('conv')">Conv.</button>
    <button onclick="switchTab('media')">Media</button>
    <button onclick="switchTab('gal')">Gal.</button>
    <button onclick="switchTab('kb')">KB</button>
    <button onclick="switchTab('sys')">Sist.</button>
    <button onclick="switchTab('sec')">Seg.</button>
  </div>
  <div class="adv-body" id="adv-body"></div>
</div>
<div class="toast" id="toast"></div>

<script>
// ==========================================
// CONFIG & ENDPOINTS
// ==========================================
var ZENIA_API   = 'https://zenia-api.netlify.app/api/chat';
var IMG_EP      = 'https://gen.pollinations.ai/image/';
var IMG_EP2     = 'https://image.pollinations.ai/prompt/';
var VEO3_KEY    = 'sk-e186d16eaf8242e283233714196d7bdc';
var VEO3_GENERATE = '/api/veo3/predict';
var VEO3_FETCH    = '/api/veo3/predict/async-fetch';

// cm.json URL (f√°brica) ‚Äî mem√≥ria de f√°brica
var CM_FACTORY_URL = './cm.json';

// Angola data
var angolaProvincias = {"Bengo":"Capital: Caxito | Norte","Benguela":"Capital: Benguela | Centro","Bi√©":"Capital: Kuito | Centro","Cabinda":"Capital: Cabinda | Norte | Enclave","Cuando Cubango":"Capital: Menongue | Leste","Cuanza Norte":"Capital: N'Dalatando","Cuanza Sul":"Capital: Sumbe | Centro","Cunene":"Capital: Ondjiva | Sul","Huambo":"Capital: Huambo | Centro","Hu√≠la":"Capital: Lubango | Sul","Lunda Norte":"Capital: Dundo | NE","Lunda Sul":"Capital: Saurimo | NE","Luanda":"Capital: Luanda | Costa | CAPITAL","Malanje":"Capital: Malanje | Norte","Moxico":"Capital: Luena | Leste","Namibe":"Capital: Namibe | Sul","U√≠ge":"Capital: U√≠ge | NE","Zaire":"Capital: M'Banza Congo"};
function getAngolaInfo(){var i="ANGOLA:\nCapital: Luanda | Pop: ~35M | Moeda: Kwanza | Presidente: Jo√£o Louren√ßo\nProv√≠ncias:\n";Object.entries(angolaProvincias).forEach(([k,v],n)=>{i+=(n+1)+". "+k+": "+v+"\n";});return i;}

// ==========================================
// TEMAS (13 no total)
// ==========================================
var THEMES = [
  {id:'dark',   label:'Dark',    emoji:'üåô', grad:'linear-gradient(135deg,#0b0d11,#3b5bdb)'},
  {id:'cyberpunk',label:'Cyber', emoji:'‚ö°', grad:'linear-gradient(135deg,#0a0010,#bf00ff)'},
  {id:'aurora', label:'Aurora',  emoji:'üåø', grad:'linear-gradient(135deg,#020f0a,#10b981)'},
  {id:'solar',  label:'Solar',   emoji:'‚òÄÔ∏è', grad:'linear-gradient(135deg,#faf8f4,#c4862a)'},
  {id:'bloodmoon',label:'Blood', emoji:'üî¥', grad:'linear-gradient(135deg,#0d0505,#ef4444)'},
  {id:'ocean',  label:'Ocean',   emoji:'üåä', grad:'linear-gradient(135deg,#010d1a,#0096c7)'},
  {id:'ember',  label:'Ember',   emoji:'üî•', grad:'linear-gradient(135deg,#0f0800,#ff6d00)'},
  {id:'neon',   label:'Neon',    emoji:'üíú', grad:'linear-gradient(135deg,#050508,#4040ff)'},
  {id:'sakura', label:'Sakura',  emoji:'üå∏', grad:'linear-gradient(135deg,#fff5f7,#e91e8c)'},
  {id:'slate',  label:'Slate',   emoji:'üî∑', grad:'linear-gradient(135deg,#1a1d23,#38bdf8)'},
  {id:'forest', label:'Forest',  emoji:'üå≤', grad:'linear-gradient(135deg,#0a110a,#66bb6a)'},
  {id:'violet', label:'Violet',  emoji:'ü™ª', grad:'linear-gradient(135deg,#0d0a1a,#8b5cf6)'},
  {id:'mint',   label:'Mint',    emoji:'üçÉ', grad:'linear-gradient(135deg,#f0faf8,#0d9488)'}
];

function buildThemeGrids() {
  ['setup-theme-grid','modal-theme-grid'].forEach(id=>{
    var el=document.getElementById(id);if(!el)return;
    el.innerHTML=THEMES.map(t=>`
      <div>
        <div class="theme-dot ${currentTheme===t.id?'active':''}" data-theme-val="${t.id}"
          onclick="selectThemeFromGrid(this,'${t.id}','${id}')" style="background:${t.grad}">
          <div class="theme-dot-inner">${t.emoji}</div>
        </div>
        <div class="theme-name">${t.label}</div>
      </div>`).join('');
  });
}
function selectThemeFromGrid(el,theme,gridId){
  document.querySelectorAll('#'+gridId+' .theme-dot').forEach(d=>d.classList.remove('active'));
  el.classList.add('active');
  if(gridId==='setup-theme-grid') selectedSetupTheme=theme;
  applyTheme(theme);
}
function applyTheme(theme){
  document.body.setAttribute('data-theme',theme);
  currentTheme=theme;
  localStorage.setItem('zn_theme',theme);
  var t=THEMES.find(x=>x.id===theme);
  var lbl=document.getElementById('theme-label');
  if(lbl)lbl.textContent=t?t.label:'Dark';
  buildThemeGrids();
}
function openThemeModal(){document.getElementById('theme-modal').classList.add('open');}
function closeThemeModal(){document.getElementById('theme-modal').classList.remove('open');}

// ==========================================
// STATE
// ==========================================
var convs        = JSON.parse(localStorage.getItem('zn_convs')||'[]');
var curConvId    = null;
var voiceOn      = false;
var creatorMode  = false;
var advTab       = 'mem';
var sbColl       = false;
var sbMobOpen    = false;
var userName     = localStorage.getItem('zn_username')||'';
var currentTheme = localStorage.getItem('zn_theme')||'dark';
var selectedSetupTheme = 'dark';
var visionImageData = null;
var cameraActive = false;
var cameraStream = null;
var zeniaPersonality = {tone:'amigavel',detailLevel:'medio'};
var voiceConfig = {voiceIndex:-1,rate:1,pitch:1,volume:1};
var factoryMemory = '';

var chatEl  = document.getElementById('chat-window');
var inputEl = document.getElementById('user-input');
var sendBtn = document.getElementById('send-btn');
var sendIc  = document.getElementById('send-ic');

// Regex detectores
var VID_RX  = /\b(gera|cria|faz|mostra|quero\s+ver|faz-me)\s+um?\s*(video|filme|clip|animacao|gif|cena|movie|cinematic|scene)\b/i;
var AUD_RX  = /\b(gera|cria|faz|toca|compoe|quero\s+ouvir|sintetiza|narra|fala|canta)\s+um?a?\s*(musica|audio|som|song|beat|trilha|melodia|faixa|track|instrumental|voz|discurso|podcast)\b/i;
var IMG_RX  = /\b(gera|cria|faz|desenha|pinta|mostra|quero\s+ver|faz-me|ilustra)\s+um?a?\s*(imagem|foto|image|picture|desenho|wallpaper|arte|avatar|paisagem|retrato|fotografia|quadro|pintura|ilustracao)\b/i;
var CODE_RX = /\b(codigo|code|script|funcao|function|html|css|javascript|python|java|sql|php|bash|react|api|algoritmo|classe|bug|debug)\b/i;
var MATH_RX = /\b(exercicio|problema|calcular|resolver|simplificar|derivada|integral|fracao|divisao|multiplicacao|raiz|potencia|equacao|sistema|matriz|calcule|calcula)\b/i;

// ==========================================
// FACTORY MEMORY (cm.json auto-load)
// ==========================================
async function loadFactoryMemory() {
  try {
    var r = await fetch(CM_FACTORY_URL);
    if (r.ok) {
      var d = await r.json();
      var items = d.itens || d.items || [];
      if (items.length) {
        factoryMemory = 'MEM√ìRIA DE F√ÅBRICA (cm.json):\n' +
          items.map(i => '- ' + (i.txt || i.texto || i.content || JSON.stringify(i))).join('\n');
      }
    }
  } catch(e) {
    // cm.json n√£o encontrado ‚Äî silencioso
  }
}

// ==========================================
// EARLY SETUP HIDE
// ==========================================
(function(){
  var ss = document.getElementById('setup-screen');
  if (localStorage.getItem('zn_username')) {
    if (ss) ss.style.display = 'none';
  } else {
    if (ss) ss.style.display = 'flex';
  }
})();

// ==========================================
// INIT
// ==========================================
window.addEventListener('load', async function() {
  applyTheme(currentTheme);
  buildThemeGrids();
  loadVoices();
  await loadFactoryMemory();
  if (userName) {
    document.getElementById('setup-screen').style.display = 'none';
    initApp();
  } else {
    document.getElementById('setup-screen').style.display = 'flex';
  }
  inputEl.addEventListener('input', ()=>autoResize(inputEl));
  inputEl.addEventListener('keydown', e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSend();}});
  if (window.speechSynthesis) {
    window.speechSynthesis.onvoiceschanged = loadVoices;
  }
});

function completeSetup() {
  var si = document.getElementById('setup-name');
  var name = (si.value||'').trim();
  if (!name) {
    si.style.borderColor='#ef4444';si.style.boxShadow='0 0 0 3px rgba(239,68,68,.3)';
    si.placeholder='‚ö†Ô∏è Escreve o teu nome!';si.focus();
    setTimeout(()=>{si.style.borderColor='';si.style.boxShadow='';si.placeholder='Escreve o teu nome...';},2500);
    return;
  }
  userName = name;
  localStorage.setItem('zn_username', name);
  applyTheme(selectedSetupTheme);
  document.getElementById('setup-screen').style.display = 'none';
  initApp();
}

function initApp() {
  var wn=document.getElementById('welcome-name');if(wn)wn.textContent=userName||'amigo';
  var un=document.getElementById('uname');if(un)un.textContent=userName||'Utilizador';
  var ui=document.getElementById('user-initial');if(ui)ui.textContent=(userName||'U').charAt(0).toUpperCase();
  renderHist();
  // Sempre come√ßa com conversa nova
  startNew();
  setInterval(()=>setApiSt('ok'),60000);
  setApiSt('ok');
}

// ==========================================
// VOICE CONFIG
// ==========================================
function loadVoices() {
  var voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
  var sel = document.getElementById('voice-select');
  if (!sel) return;
  sel.innerHTML = '';
  var ptVoices = voices.filter(v=>v.lang.startsWith('pt'));
  var otherVoices = voices.filter(v=>!v.lang.startsWith('pt'));
  if (ptVoices.length) {
    var grp1 = document.createElement('optgroup');grp1.label='Portugu√™s';
    ptVoices.forEach((v,i)=>{
      var opt=document.createElement('option');opt.value=voices.indexOf(v);
      opt.textContent=v.name+' ('+v.lang+')';
      if(v.lang==='pt-PT'||v.lang==='pt-BR')opt.selected=true;
      grp1.appendChild(opt);
    });
    sel.appendChild(grp1);
  }
  if (otherVoices.length) {
    var grp2=document.createElement('optgroup');grp2.label='Outras';
    otherVoices.slice(0,20).forEach(v=>{
      var opt=document.createElement('option');opt.value=voices.indexOf(v);
      opt.textContent=v.name+' ('+v.lang+')';
      grp2.appendChild(opt);
    });
    sel.appendChild(grp2);
  }
  if (!voices.length) sel.innerHTML='<option value="-1">Padr√£o do sistema</option>';
}
function updateVoiceConfig() {
  voiceConfig.voiceIndex = parseInt(document.getElementById('voice-select').value)||0;
  voiceConfig.rate = parseFloat(document.getElementById('voice-rate').value)||1;
  voiceConfig.pitch = parseFloat(document.getElementById('voice-pitch').value)||1;
  voiceConfig.volume = parseFloat(document.getElementById('voice-vol').value)||1;
}
function previewVoice() {
  updateVoiceConfig();
  speakTxt('Ol√° '+userName+'! Eu sou a Zenia, a tua assistente inteligente feita em Angola.');
}
function speakTxt(txt) {
  if (!window.speechSynthesis) return;
  speechSynthesis.cancel();
  var u = new SpeechSynthesisUtterance(txt.substring(0,500));
  var voices = speechSynthesis.getVoices();
  if (voiceConfig.voiceIndex >= 0 && voices[voiceConfig.voiceIndex]) {
    u.voice = voices[voiceConfig.voiceIndex];
  } else {
    var ptv = voices.find(v=>v.lang==='pt-PT')||voices.find(v=>v.lang.startsWith('pt'));
    if (ptv) u.voice = ptv;
  }
  u.lang = 'pt-PT';
  u.rate = voiceConfig.rate;
  u.pitch = voiceConfig.pitch;
  u.volume = voiceConfig.volume;
  speechSynthesis.speak(u);
}

// ==========================================
// PERSONALITY
// ==========================================
function openPersonality(){document.getElementById('personality-modal').classList.add('open');updatePersonalityUI();loadVoices();}
function closePersonality(){document.getElementById('personality-modal').classList.remove('open');}
function updatePersonalityUI(){
  var tl={'amigavel':'Amig√°vel','profissional':'Profissional','humorista':'Humorista','tecnico':'T√©cnico','criativo':'Criativo'};
  var dl={'curto':'Curto','medio':'M√©dio','detalhado':'Detalhado'};
  document.querySelectorAll('[data-tone]').forEach(b=>b.classList.toggle('active',b.getAttribute('data-tone')===zeniaPersonality.tone));
  document.querySelectorAll('[data-level]').forEach(b=>b.classList.toggle('active',b.getAttribute('data-level')===zeniaPersonality.detailLevel));
  var ct=document.getElementById('current-tone'),cd=document.getElementById('current-detail');
  if(ct)ct.textContent=tl[zeniaPersonality.tone]||'‚Äî';
  if(cd)cd.textContent=dl[zeniaPersonality.detailLevel]||'‚Äî';
}
function setPersonality(t){zeniaPersonality.tone=t;updatePersonalityUI();}
function setDetailLevel(l){zeniaPersonality.detailLevel=l;updatePersonalityUI();}

// ==========================================
// TEXT FORMATTING ‚Äî LIMPO SEM ### ** * / $
// ==========================================
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

function hlCode(code,lang){try{if(lang&&hljs.getLanguage(lang))return hljs.highlight(code,{language:lang}).value;return hljs.highlightAuto(code).value;}catch(e){return escHtml(code);}}

// Converte fra√ß√£o a/b para HTML elegante
function renderFrac(num,den){return '<span class="frac-display"><span class="frac-num">'+escHtml(num)+'</span><span class="frac-den">'+escHtml(den)+'</span></span>';}

// Remove todos os caracteres de markdown indesejados
function cleanMarkdown(text){
  // Remove ### ## # no in√≠cio de linhas (headings)
  text = text.replace(/^#{1,6}\s+/gm,'');
  // Remove **texto** -> texto (bold markdown)
  text = text.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  // Remove *texto* e _texto_ (italic)
  text = text.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g,'<em>$1</em>');
  text = text.replace(/_(.+?)_/g,'<em>$1</em>');
  // Remove *** e ***
  text = text.replace(/\*{3}(.+?)\*{3}/g,'<strong><em>$1</em></strong>');
  return text;
}

// Formato fra√ß√µes cient√≠ficas: num/den ‚Üí bela exibi√ß√£o
function formatScientificFractions(text){
  // Detecta padr√µes como: 3/4, 22/7, a/b dentro de contexto matem√°tico
  return text.replace(/\b(\d+)\s*\/\s*(\d+)\b/g, (match, n, d) => renderFrac(n, d));
}

// Formata expoentes: x^n -> <sup>n</sup>
function formatExponents(text){
  return text.replace(/(\w+)\^(\d+)/g,'$1<sup>$2</sup>');
}

// Formata ra√≠zes sqrt(x) ‚Üí ‚àöx
function formatSqrt(text){
  return text.replace(/sqrt\(([^)]+)\)/gi,'‚àö($1)');
}

function fmtText(raw){
  // 1. Extrair e processar blocos de c√≥digo primeiro
  var codeBlocks = [];
  var h = raw.replace(/```([^\n`]*)\n?([\s\S]*?)```/g, (_, lang, code) => {
    var id='c'+Math.random().toString(36).slice(2,7);
    var hl=hlCode(code.trim(),lang);
    var exts={'python':'.py','javascript':'.js','html':'.html','css':'.css','java':'.java','typescript':'.ts','sql':'.sql','bash':'.sh','json':'.json'};
    var ext=exts[(lang||'').toLowerCase()]||'.txt';
    var block='<div class="code-block"><div class="code-hdr"><span class="code-lang">'+(lang||'c√≥digo')+'</span>'
      +'<div style="display:flex;gap:5px"><button class="copy-btn" onclick="cpCode(\''+id+'\')"><i class="fas fa-copy"></i> Copiar</button>'
      +'<button class="copy-btn" onclick="downloadCode(\''+id+'\',\'code'+ext+'\')"><i class="fas fa-download"></i></button></div></div>'
      +'<pre><code id="'+id+'" class="hljs">'+hl+'</code></pre></div>';
    var ph='__CODE'+codeBlocks.length+'__';
    codeBlocks.push(block);
    return ph;
  });

  // 2. Inline code
  h = h.replace(/`([^`\n]+)`/g,'<code class="inline-code">$1</code>');

  // 3. Limpar markdown indesejado
  h = cleanMarkdown(h);

  // 4. Fra√ß√µes matem√°ticas
  h = formatScientificFractions(h);
  h = formatExponents(h);
  h = formatSqrt(h);

  // 5. Listas
  h = h.replace(/^[\-\*]\s+(.+)$/gm,'<li>$1</li>');
  h = h.replace(/(<li>.*<\/li>)/gs, '<ul style="padding-left:20px;margin:6px 0">$1</ul>');

  // 6. Newlines
  h = h.replace(/\n/g,'<br>');

  // 7. Restaurar blocos de c√≥digo
  codeBlocks.forEach((block,i)=>{
    h = h.replace('__CODE'+i+'__', block);
  });

  return h;
}

function cpCode(id){var el=document.getElementById(id);if(!el)return;navigator.clipboard.writeText(el.innerText);toast('Copiado!','ok');}
function downloadCode(id,fn){var el=document.getElementById(id);if(!el)return;var b=new Blob([el.innerText],{type:'text/plain'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=fn||'code.txt';a.click();}

// ==========================================
// WEB SEARCH AVAN√áADA
// ==========================================
function needsWeb(text){return /\b(2024|2025|2026|agora|hoje|atual|recente|latest|current|preco|quem e|presidente|noticia|news|lancamento|update)\b/i.test(text);}

async function webSearch(query) {
  document.getElementById('web-st').style.display='inline-flex';
  try {
    var r=await fetch('https://api.duckduckgo.com/?q='+encodeURIComponent(query)+'&format=json&no_html=1&skip_disambig=1');
    var d=await r.json();var parts=[];
    if(d.Answer)parts.push('Resposta direta: '+d.Answer);
    if(d.AbstractText)parts.push(d.AbstractText);
    if(d.RelatedTopics)d.RelatedTopics.slice(0,5).forEach(t=>{if(t.Text)parts.push('- '+t.Text);});
    document.getElementById('web-st').style.display='none';
    return parts.length?'[PESQUISA WEB: "'+query+'"]:\n'+parts.join('\n'):'';
  }catch(e){document.getElementById('web-st').style.display='none';return '';}
}

async function doWebSearch() {
  var q = document.getElementById('web-query').value.trim();
  if (!q) return;
  var engine = document.getElementById('search-engine').value;
  var resDiv = document.getElementById('websearch-results');
  resDiv.innerHTML = '<div style="padding:10px;text-align:center;color:var(--text-muted);font-size:12px"><span class="spin"></span> Pesquisando...</div>';
  try {
    var results = '';
    if (engine === 'duckduckgo') {
      var r = await fetch('https://api.duckduckgo.com/?q='+encodeURIComponent(q)+'&format=json&no_html=1');
      var d = await r.json();
      var html = '<div style="font-size:12px">';
      if(d.AbstractText) html+='<div style="padding:8px;background:var(--bg-primary);border-radius:7px;margin-bottom:8px;border:1px solid var(--border-color)"><div style="font-weight:600;color:var(--accent-primary);margin-bottom:4px">'+escHtml(d.Heading||q)+'</div><div style="color:var(--text-secondary);line-height:1.6">'+escHtml(d.AbstractText)+'</div></div>';
      if(d.RelatedTopics) d.RelatedTopics.slice(0,6).forEach(t=>{if(t.Text)html+='<div style="padding:7px 9px;border-radius:6px;border:1px solid var(--border-color);margin-bottom:5px;color:var(--text-secondary)">'+escHtml(t.Text)+(t.FirstURL?'<br><a href="'+t.FirstURL+'" target="_blank" style="font-size:10px;color:var(--accent-primary)">'+t.FirstURL+'</a>':'')+'</div>';});
      html += '</div>';
      resDiv.innerHTML = html || '<div style="padding:10px;color:var(--text-muted);font-size:12px">Sem resultados.</div>';
    } else {
      resDiv.innerHTML = '<div style="padding:10px;font-size:12px;color:var(--text-muted)">Para usar '+engine+', configura a API key nas ferramentas avan√ßadas (Seg.) e a Zenia utilizar√° nos chats automaticamente.</div>';
    }
  } catch(e) {
    resDiv.innerHTML = '<div style="padding:10px;color:#ef4444;font-size:12px">Erro: '+e.message+'</div>';
  }
}

async function doFetchURL() {
  var url = document.getElementById('web-url').value.trim();
  if (!url) return;
  if (!url.startsWith('http')) url = 'https://' + url;
  var resDiv = document.getElementById('websearch-results');
  resDiv.innerHTML = '<div style="padding:10px;text-align:center;color:var(--text-muted);font-size:12px"><span class="spin"></span> A carregar p√°gina...</div>';
  try {
    // Usar proxy (CORS) ‚Äî envia para a Zenia analisar
    var conv = getConv(); if(!conv) conv = createConv('An√°lise de URL');
    document.getElementById('websearch-modal').classList.remove('open');
    hideWelcome();
    inputEl.value = 'Analisa e resume o conte√∫do desta p√°gina: ' + url;
    autoResize(inputEl);
    toast('URL enviado para an√°lise!','ok');
    handleSend();
  } catch(e) {
    resDiv.innerHTML = '<div style="padding:10px;color:#ef4444;font-size:12px">Erro: '+e.message+'</div>';
  }
}

// ==========================================
// API PRINCIPAL ‚Äî ZENIA API
// ==========================================
async function fetchAI(msgs, model, attempt) {
  attempt = attempt||1;
  try {
    var r = await fetch(ZENIA_API, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        messages: msgs,
        model: model||'openai',
        temperature: model==='qwen-coder'?0.3:0.75,
        max_tokens: 4096
      }),
      signal: AbortSignal.timeout(30000)
    });
    if (!r.ok) {
      if (r.status===429&&attempt<3){await new Promise(r=>setTimeout(r,2000*attempt));return fetchAI(msgs,model,attempt+1);}
      throw new Error('HTTP '+r.status);
    }
    var d = await r.json();
    if (!d.success && !d.response && !d.choices) throw new Error(d.error||'Resposta inv√°lida');
    var content = d.response || d.choices?.[0]?.message?.content || '';
    if (!content && attempt<3){
      var alts=['qwen-coder','openai','mistral'];
      return fetchAI(msgs,alts[(alts.indexOf(model)+1)%alts.length],attempt+1);
    }
    return content.trim();
  } catch(e) {
    if (e.name==='AbortError') {
      if (attempt<3) return fetchAI(msgs,model,attempt+1);
      throw new Error('Tempo esgotado.');
    }
    throw e;
  }
}

function buildSystem(q) {
  var today = new Date().toLocaleDateString('pt-PT');
  var memCtx = getMemCtx();
  var kbCtx = getKBCtx(q);
  var cmCtx = factoryMemory ? '\n\n'+factoryMemory : '';
  var angolaCtx = (q.toLowerCase().includes('angola')||q.toLowerCase().includes('provincia')) ? '\n\n'+getAngolaInfo() : '';
  var toneMap={
    amigavel:'S√™ amig√°vel, acess√≠vel e usa emojis ocasionalmente.',
    profissional:'S√™ formal e profissional sem emojis.',
    humorista:'S√™ divertido e faz piadas leves.',
    tecnico:'S√™ t√©cnico, preciso e detalhado.',
    criativo:'S√™ criativo, imaginativo e expressivo.'
  };
  var detailMap={curto:'Respostas breves e diretas.',medio:'Equilibra brevidade e detalhe.',detalhado:'Respostas completas e bem explicadas.'};
  var uname = userName ? 'O utilizador chama-se '+userName+'. Chama-o pelo nome.' : '';
  var mathInst = MATH_RX.test(q) ? '\nPARA MATEM√ÅTICA: Escreve fra√ß√µes como num/den (ser√£o renderizadas bonitas). Usa nota√ß√£o clara sem $ nem \\frac. Usa expoentes como x^2. Explica passo a passo.' : '';

  var basePrompt = `√âS A IA-ZENIA, assistente inteligente criada em Lubango, Angola por In√°cio U. Daniel (Zenia-Projects).
${uname}
TOM: ${toneMap[zeniaPersonality.tone]||toneMap.amigavel}
DETALHE: ${detailMap[zeniaPersonality.detailLevel]||detailMap.medio}

REGRAS ABSOLUTAS DE FORMATA√á√ÉO:
- Responde SEMPRE em Portugu√™s de Angola
- NUNCA uses ### ## # para t√≠tulos ‚Äî usa apenas texto normal ou MAI√öSCULAS para destaques
- NUNCA uses ** *** *texto* para formata√ß√£o markdown ‚Äî se quiseres destacar, usa MAI√öSCULAS ou sublinhado com contexto
- NUNCA uses / $ * ou sinais LaTeX nas respostas
- Para fra√ß√µes matem√°ticas escreve sempre como num/den (ex: 3/4, 22/7)
- Para expoentes usa x^2 (ex: x^2, 10^3)
- Para ra√≠zes usa sqrt(x)
- Para somas/integrais descreve por extenso
- As respostas devem ser limpas, naturais e leg√≠veis como prosa normal
${mathInst}${memCtx}${kbCtx}${cmCtx}${angolaCtx}
Hoje: ${today}.`;

  if (creatorMode) return '√âS A IA-ZENIA. MODO CRIADOR ATIVO. Est√°s com In√°cio U. Daniel (criador e fundador).\n'+uname+memCtx+kbCtx+cmCtx+'\nHoje: '+today+'\nRegra: NUNCA uses ### ** *** * / $ em respostas.';
  return basePrompt;
}

// ==========================================
// HANDLE SEND
// ==========================================
async function handleSend() {
  var text = inputEl.value.trim();
  if (!text || sendBtn.disabled) return;
  var conv = getConv();
  if (!conv) conv = createConv(text.substring(0,38)+(text.length>38?'...':''));
  hideWelcome();
  renderMsg('user', text);
  inputEl.value='';autoResize(inputEl);setLoading(true);

  if (creatorMode && /\b(aprender|guarda isso|anota|lembra-te|sabes que)\b/i.test(text)) saveToCM(text);

  if (VID_RX.test(text)){var vp=text.replace(VID_RX,'').trim()||text;await genVid(vp);conv.messages.push({role:'user',content:text},{role:'assistant',content:'[Video: '+vp+']'});saveConvs();setLoading(false);return;}
  if (AUD_RX.test(text)){var ap=text.replace(AUD_RX,'').trim()||text;await genAud(ap);conv.messages.push({role:'user',content:text},{role:'assistant',content:'[Audio: '+ap+']'});saveConvs();setLoading(false);return;}
  if (IMG_RX.test(text)){var ip=text.replace(IMG_RX,'').trim()||text;await genImg(ip);conv.messages.push({role:'user',content:text},{role:'assistant',content:'[Imagem: '+ip+']'});saveConvs();setLoading(false);return;}

  var typing = renderTyping();
  try {
    var webCtx='';if(needsWeb(text))webCtx=await webSearch(text);
    var sys = {role:'system',content:buildSystem(text)};
    var userCont = webCtx?(webCtx+'\n\nPergunta do utilizador: '+text):text;
    var selM = document.getElementById('model-sel').value;
    var useM = CODE_RX.test(text)?'qwen-coder':selM;
    var msgs = [sys].concat(conv.messages.slice(-14)).concat([{role:'user',content:userCont}]);
    var reply = await fetchAI(msgs, useM);
    typing.remove();
    conv.messages.push({role:'user',content:text},{role:'assistant',content:reply});
    saveConvs();
    renderMsg('ai', reply, !!webCtx);
    if (voiceOn) speakTxt(reply.replace(/```[\s\S]*?```/g,''));
    setApiSt('ok');
  } catch(e) {
    typing.remove();
    renderMsg('ai','Erro ao obter resposta: '+e.message);
    setApiSt('err');
  } finally {
    setLoading(false);
  }
}

// ==========================================
// VIDEO GENERATION
// ==========================================
async function genVid(prompt){
  var row=document.createElement('div');row.className='msg-row';
  var av=document.createElement('div');av.className='msg-av ai';av.textContent='Z';
  var card=document.createElement('div');card.className='media-card';card.style.maxWidth='640px';
  var sid='vs'+Date.now();
  card.innerHTML=veoLoadingHTML(sid,'Submetendo para Google Veo 3...');
  row.appendChild(av);row.appendChild(card);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;
  try {
    var gr=await fetch(VEO3_GENERATE,{method:'POST',headers:{'Authorization':'Bearer '+VEO3_KEY,'Content-Type':'application/json'},body:JSON.stringify({model:'get',prompt}),signal:AbortSignal.timeout(30000)});
    if(!gr.ok)throw new Error('HTTP '+gr.status);
    var gd=await gr.json();
    var rid=gd.request_id||gd.data?.request_id;
    if(!rid)throw new Error('request_id n√£o recebido');
    setVeoStatus(sid,'Pedido aceite ‚Äî aguardando processamento...',15);
    var vu=await pollVeoFree(rid,sid);
    if(!vu)throw new Error('Tempo esgotado. Tenta novamente.');
    showVeoPlayer(card,vu,prompt);
  }catch(e){
    card.innerHTML='<div style="padding:14px"><div style="color:#ef4444;font-size:13px;margin-bottom:10px">Erro: '+escHtml(e.message)+'</div><button onclick="genVid(\''+escHtml(prompt.replace(/'/g,"\\'"))+'\''+')" style="padding:6px 12px;background:var(--send-btn);border:none;color:#fff;border-radius:6px;font-size:12px;cursor:pointer">Tentar novamente</button></div>';
  }
}
function veoLoadingHTML(sid,msg){return'<div style="padding:16px"><div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="width:36px;height:36px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border-radius:50%;display:flex;align-items:center;justify-content:center"><i class="fas fa-video" style="color:#fff"></i></div><div><div style="font-size:13px;font-weight:700;color:var(--accent-primary)">Google Veo 3</div><div style="font-size:11px;color:var(--text-muted)" id="'+sid+'-msg">'+msg+'</div></div></div><div style="background:var(--border-color);border-radius:4px;height:5px;overflow:hidden"><div id="'+sid+'-bar" style="height:100%;background:linear-gradient(90deg,var(--accent-primary),var(--accent-secondary));width:5%;transition:width .5s"></div></div><div style="font-size:10px;color:var(--text-muted);margin-top:5px;display:flex;justify-content:space-between"><span>1-3 minutos</span><span id="'+sid+'-pct">5%</span></div></div>';}
function setVeoStatus(sid,msg,pct){var m=document.getElementById(sid+'-msg'),b=document.getElementById(sid+'-bar'),p=document.getElementById(sid+'-pct');if(m)m.textContent=msg;if(b)b.style.width=pct+'%';if(p)p.textContent=pct+'%';}
async function pollVeoFree(rid,sid){
  var steps=[18,22,27,32,37,42,47,52,57,62,67,72,76,80,84,87,90,92,94,96];
  for(var i=0;i<36;i++){
    await new Promise(r=>setTimeout(r,5000));
    setVeoStatus(sid,'A processar... ('+(((i+1)*5))+'s)',steps[Math.min(i,steps.length-1)]);
    try{
      var r=await fetch(VEO3_FETCH+'?request_id='+encodeURIComponent(rid),{headers:{'Authorization':'Bearer '+VEO3_KEY},signal:AbortSignal.timeout(15000)});
      if(!r.ok)continue;
      var d=await r.json();
      var vu=d.video_url||d.result_url||d.url||d.data?.video_url||d.data?.result_url;
      if(vu){setVeoStatus(sid,'V√≠deo pronto!',100);return vu;}
      var st=(d.status||d.data?.status||'').toLowerCase();
      if(st==='failed'||st==='error')throw new Error('Falha no servidor Veo3');
    }catch(e){if(e.message.includes('Falha'))throw e;}
  }
  return null;
}
function showVeoPlayer(card,url,prompt){
  card.innerHTML='<div style="position:relative;background:#000;border-radius:8px 8px 0 0;overflow:hidden"><video controls autoplay loop playsinline style="width:100%;display:block;max-height:400px" src="'+url+'"></video><div style="position:absolute;top:10px;left:10px;background:rgba(0,0,0,.85);color:#fff;font-size:10px;padding:4px 10px;border-radius:18px;font-weight:700">Veo 3 Free</div></div><div class="media-foot"><span class="media-lbl">'+escHtml(prompt.substring(0,55))+'</span><a href="'+url+'" download="veo3.mp4" class="mbtn"><i class="fas fa-download"></i> MP4</a></div>';
  chatEl.scrollTop=chatEl.scrollHeight;
}

// ==========================================
// IMAGE GENERATION
// ==========================================
async function genImg(prompt){
  var ep=encodeURIComponent(prompt),seed=Math.floor(Math.random()*999999);
  var u1=IMG_EP+ep+'?model=flux&seed='+seed+'&width=768&height=512&nologo=true&enhance=true';
  var u2=IMG_EP2+ep+'?seed='+seed+'&width=768&height=512&nologo=true';
  var row=document.createElement('div');row.className='msg-row';
  var av=document.createElement('div');av.className='msg-av ai';av.textContent='Z';
  var card=document.createElement('div');card.className='media-card';card.style.maxWidth='500px';
  card.innerHTML='<div style="padding:13px;display:flex;align-items:center;gap:9px;color:var(--text-muted);font-size:13px"><span class="spin"></span> A gerar imagem...</div>';
  row.appendChild(av);row.appendChild(card);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;
  function showCard(url){card.innerHTML='<img src="'+url+'" alt="" loading="lazy"><div class="media-foot"><span class="media-lbl">'+escHtml(prompt.substring(0,55))+'</span><div style="display:flex;gap:5px"><a href="'+url+'" target="_blank" class="mbtn"><i class="fas fa-external-link-alt"></i></a><a href="'+url+'" download="zenia.jpg" class="mbtn"><i class="fas fa-download"></i></a></div></div>';chatEl.scrollTop=chatEl.scrollHeight;}
  return new Promise(res=>{
    var t=setTimeout(()=>{card.innerHTML='<div style="padding:13px;color:#fbbf24;font-size:13px">Demorou demasiado.</div>';res(null);},35000);
    var i1=new Image();i1.onload=()=>{clearTimeout(t);showCard(u1);res(u1);};
    i1.onerror=()=>{var i2=new Image();i2.onload=()=>{clearTimeout(t);showCard(u2);res(u2);};i2.onerror=()=>{clearTimeout(t);card.innerHTML='<div style="padding:13px;color:#fbbf24">Falha ao gerar.</div>';res(null);};i2.src=u2;};
    i1.src=u1;
  });
}

// ==========================================
// AUDIO GENERATION
// ==========================================
async function genAud(prompt){
  var row=document.createElement('div');row.className='msg-row';
  var av=document.createElement('div');av.className='msg-av ai';av.textContent='Z';
  var card=document.createElement('div');card.className='media-card';card.style.maxWidth='480px';
  card.innerHTML='<div style="padding:13px;display:flex;align-items:center;gap:9px;color:var(--text-muted);font-size:13px"><span class="spin"></span> A criar √°udio...</div>';
  row.appendChild(av);row.appendChild(card);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;
  var waveUrl=IMG_EP2+encodeURIComponent('music equalizer neon audio waves')+'?width=580&height=100&nologo=true&seed='+Date.now();
  var ttsUrl='https://api.unspeech.com/tts?text='+encodeURIComponent(prompt.substring(0,200))+'&voice=pt-PT-RaquelNeural';
  setTimeout(()=>{
    card.innerHTML='<div style="background:linear-gradient(90deg,#1a3a52,#2d5a8c);border-radius:9px;padding:12px"><img src="'+waveUrl+'" style="width:100%;height:55px;object-fit:cover;border-radius:6px;margin-bottom:8px"><audio controls style="width:100%;height:34px"><source src="'+ttsUrl+'" type="audio/mpeg"></audio><div style="font-size:11px;color:#22c55e;margin-top:5px">'+escHtml(prompt.substring(0,55))+'</div></div>';
    chatEl.scrollTop=chatEl.scrollHeight;
  },800);
}

// ==========================================
// CAMERA
// ==========================================
async function toggleCamera(){
  if(!cameraActive){
    try{
      cameraStream=await navigator.mediaDevices.getUserMedia({video:{width:60,height:60}});
      var canvas=document.getElementById('camera-canvas');canvas.style.display='block';
      var ctx=canvas.getContext('2d'),vid=document.createElement('video');
      vid.srcObject=cameraStream;vid.play();cameraActive=true;
      toast('C√¢mera ligada!','ok');
      (function loop(){if(!cameraActive)return;ctx.drawImage(vid,0,0,60,60);requestAnimationFrame(loop);})();
    }catch(e){toast('Erro c√¢mera: '+e.message,'err');}
  }else{
    cameraActive=false;if(cameraStream)cameraStream.getTracks().forEach(t=>t.stop());
    document.getElementById('camera-canvas').style.display='none';
    toast('C√¢mera desligada.','ok');
  }
}

// ==========================================
// VISION
// ==========================================
function openVisionModal(){document.getElementById('vision-modal').classList.add('open');}
function closeVisionModal(){
  document.getElementById('vision-modal').classList.remove('open');
  visionImageData=null;
  document.getElementById('vision-preview').style.display='none';
  document.getElementById('vision-placeholder').style.display='block';
  document.getElementById('vision-result').style.display='none';
}
function loadVisionPreview(e){var f=e.target.files[0];if(f)loadVisionFile(f);}
function loadVisionFile(f){
  var r=new FileReader();
  r.onload=e=>{visionImageData=e.target.result;document.getElementById('vision-img-preview').src=visionImageData;document.getElementById('vision-preview').style.display='block';document.getElementById('vision-placeholder').style.display='none';};
  r.readAsDataURL(f);
}
async function analyzeVision(){
  if(!visionImageData){toast('Carrega uma imagem!','warn');return;}
  var q=document.getElementById('vision-question').value.trim()||'Descreve detalhadamente esta imagem em portugu√™s.';
  var btn=document.getElementById('vision-analyze-btn'),res=document.getElementById('vision-result');
  btn.disabled=true;btn.innerHTML='<span class="spin"></span> Analisando...';
  res.style.display='block';res.innerHTML='<div style="padding:14px;text-align:center;color:var(--text-muted)"><span class="spin"></span> A processar...</div>';
  var analysis='',modelUsed='';
  try{
    var r=await fetch(ZENIA_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'user',content:[{type:'image_url',image_url:{url:visionImageData}},{type:'text',text:'Responde em Portugu√™s de Angola. '+q}]}],model:'openai',max_tokens:1024}),signal:AbortSignal.timeout(25000)});
    if(r.ok){var d=await r.json();var t=d.response||d.choices?.[0]?.message?.content;if(t&&t.length>20){analysis=t;modelUsed='Zenia Vision';}}
  }catch(e){}
  if(!analysis){analysis='N√£o foi poss√≠vel analisar a imagem via API. Tenta carregar novamente.';modelUsed='Fallback';}
  res.innerHTML='<div class="vision-result"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-size:11px;font-weight:700;color:var(--accent-primary)">AN√ÅLISE DA ZENIA</div><span style="font-size:10px;color:var(--text-muted)">'+modelUsed+'</span></div><div style="font-size:13px;line-height:1.7;color:var(--text-primary)">'+escHtml(analysis)+'</div><div style="margin-top:10px;display:flex;gap:6px"><button onclick="sendVisionToChat()" class="mbtn" style="color:var(--accent-primary)">Continuar no Chat</button><button onclick="navigator.clipboard.writeText(\''+escHtml(analysis.replace(/'/g,"\\'").replace(/\n/g,' '))+'\');toast(\'Copiado!\',\'ok\')" class="mbtn">Copiar</button></div></div>';
  window._lastVisionAnalysis={image:visionImageData,text:analysis};
  btn.disabled=false;btn.innerHTML='<i class="fas fa-search"></i> Analisar com IA';
}
function sendVisionToChat(){
  if(!window._lastVisionAnalysis)return;
  closeVisionModal();hideWelcome();
  var conv=getConv()||createConv('An√°lise de Imagem');
  renderMsg('user','[Imagem enviada para an√°lise]');renderMsg('ai',window._lastVisionAnalysis.text);
  conv.messages.push({role:'user',content:'[An√°lise de imagem]'},{role:'assistant',content:window._lastVisionAnalysis.text});
  saveConvs();
}

// ==========================================
// RENDER MESSAGES
// ==========================================
function renderMsg(role, text, fromWeb){
  var row=document.createElement('div');row.className='msg-row'+(role==='user'?' user-row':'');
  var av=document.createElement('div');av.className='msg-av '+(role==='user'?'user':'ai');av.textContent=role==='user'?(userName||'U').charAt(0).toUpperCase():'Z';
  var bbl=document.createElement('div');bbl.className='msg-bbl '+(role==='user'?'user':'ai');
  if (role==='ai') {
    if(fromWeb)bbl.innerHTML='<div class="web-indicator"><i class="fas fa-globe"></i> Info da Web</div>';
    bbl.innerHTML+=(bbl.innerHTML||'')+fmtText(text);
  } else {
    bbl.textContent=text;
    var editBtn=document.createElement('button');
    editBtn.innerHTML='<i class="fas fa-edit"></i>';
    editBtn.style.cssText='background:none;border:none;color:var(--text-muted);cursor:pointer;padding:3px 5px;float:right;opacity:0;transition:.2s;font-size:11px';
    bbl.insertBefore(editBtn,bbl.firstChild);
    bbl.onmouseover=()=>editBtn.style.opacity='1';bbl.onmouseout=()=>editBtn.style.opacity='0';
    editBtn.onclick=()=>enableEdit(row,text);
  }
  row.appendChild(av);row.appendChild(bbl);chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;
  if(role==='ai'){
    setTimeout(()=>{
      addRespActions(row,text);
      if(window.MathJax)MathJax.typesetPromise([bbl]).catch(()=>{});
    },100);
  }
  return row;
}

function addRespActions(row,text){
  var bbl=row.querySelector('.msg-bbl');
  var div=document.createElement('div');div.className='resp-actions';
  [
    ['<i class="fas fa-copy"></i>',()=>{navigator.clipboard.writeText(text);toast('Copiado!','ok');}],
    ['<i class="fas fa-volume-up"></i>',()=>{speakTxt(text);}],
    ['<i class="fas fa-download"></i>',()=>{var b=new Blob([text],{type:'text/plain'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='resposta_zenia.txt';a.click();}],
    ['üëç',()=>toast('Obrigado!','ok')],
    ['üëé',()=>toast('Vamos melhorar!','ok')]
  ].forEach(([label,fn])=>{
    var b=document.createElement('button');b.className='ra-btn';b.innerHTML=label;b.onclick=fn;div.appendChild(b);
  });
  bbl.appendChild(div);
}

function enableEdit(row,text){
  var bbl=row.querySelector('.msg-bbl'),old=bbl.innerHTML;
  var ta=document.createElement('textarea');ta.value=text;ta.style.cssText='width:100%;padding:8px;border:1px solid var(--accent-primary);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);font-size:12px;font-family:var(--font-msg);min-height:60px;outline:none';
  var bd=document.createElement('div');bd.style.cssText='display:flex;gap:6px;margin-top:6px';
  var sb=document.createElement('button');sb.textContent='Reenviar';sb.style.cssText='flex:1;padding:6px;background:var(--send-btn);border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px;font-family:var(--font-ui)';
  var cb=document.createElement('button');cb.textContent='Cancelar';cb.style.cssText='flex:1;padding:6px;background:var(--bg-primary);border:1px solid var(--border-accent);color:var(--text-muted);border-radius:4px;cursor:pointer;font-size:11px';
  sb.onclick=()=>{var nt=ta.value.trim();if(nt){inputEl.value=nt;autoResize(inputEl);var rows=[...chatEl.querySelectorAll('.msg-row')];var fi=false;rows.forEach(r=>{if(r===row)fi=true;if(fi&&r!==row)r.remove();});handleSend();}bbl.innerHTML=old;};
  cb.onclick=()=>bbl.innerHTML=old;
  bd.appendChild(sb);bd.appendChild(cb);bbl.innerHTML='';bbl.appendChild(ta);bbl.appendChild(bd);ta.focus();
}

function renderTyping(){
  var row=document.createElement('div');row.className='msg-row';
  row.innerHTML='<div class="msg-av ai">Z</div><div class="msg-bbl ai"><div style="display:flex;gap:6px;padding:4px 0"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div></div></div>';
  chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;return row;
}

function setLoading(on){sendBtn.disabled=on;sendIc.className=on?'spin':'fas fa-paper-plane';}
function clearChat(){if(confirm('Limpar conversa?')){var c=getConv();if(c){c.messages=[];saveConvs();}chatEl.innerHTML='';showWelcome();}}
function setApiSt(s){var el=document.getElementById('api-st');var m={ok:['s-ok','Online'],err:['s-err','Erro'],wait:['s-wait','...']};var d=m[s]||m.wait;el.className='sbadge '+d[0];el.innerHTML='<i class="fas fa-circle" style="font-size:6px"></i> '+d[1];}
function showWelcome(){var w=document.getElementById('welcome-msg');if(w)w.style.display='flex';var wn=document.getElementById('welcome-name');if(wn)wn.textContent=userName||'amigo';}
function hideWelcome(){var w=document.getElementById('welcome-msg');if(w)w.style.display='none';}
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}
function toggleVoice(){voiceOn=!voiceOn;var b=document.getElementById('voice-btn');b.className='sbadge '+(voiceOn?'s-ok':'s-wait');if(!voiceOn&&window.speechSynthesis)speechSynthesis.cancel();}

// ==========================================
// HISTORY & CONVS
// ==========================================
function createConv(title){var c={id:Date.now().toString(),title:(title||'Nova Conversa').substring(0,40),messages:[]};convs.unshift(c);curConvId=c.id;saveConvs();renderHist();return c;}
function getConv(){return convs.find(c=>c.id===curConvId)||null;}
function saveConvs(){localStorage.setItem('zn_convs',JSON.stringify(convs));}
function startNew(){
  curConvId=null;
  chatEl.innerHTML='';
  showWelcome();
  // Cria automaticamente nova conversa
  var c=createConv('Nova Conversa '+new Date().toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit'}));
  renderHist();
  if(window.innerWidth<768&&sbMobOpen)toggleMob();
}
function loadConv(id){
  curConvId=id;chatEl.innerHTML='';
  var c=getConv();if(!c)return;
  c.messages.forEach(m=>{if(m.role==='user')renderMsg('user',m.content);else if(m.role==='assistant')renderMsg('ai',m.content);});
  renderHist();chatEl.scrollTop=chatEl.scrollHeight;
  if(window.innerWidth<768&&sbMobOpen)toggleMob();
  var w=document.getElementById('welcome-msg');
  if(c.messages.length>0&&w)w.style.display='none';
  else if(c.messages.length===0&&w)w.style.display='flex';
}
function delConv(id,ev){if(ev)ev.stopPropagation();convs=convs.filter(c=>c.id!==id);saveConvs();if(curConvId===id)startNew();else renderHist();}
function filterHist(v){renderHist(v);}
function renderHist(filter){
  var el=document.getElementById('hist-list');filter=(filter||'').toLowerCase();
  var list=filter?convs.filter(c=>c.title.toLowerCase().includes(filter)):convs;
  el.innerHTML='';
  if(!list.length){el.innerHTML='<p style="font-size:11px;color:var(--text-muted);padding:3px 5px;font-style:italic">'+(filter?'Sem resultados.':'Sem hist√≥rico.')+'</p>';return;}
  list.forEach(c=>{
    var active=c.id===curConvId;
    var div=document.createElement('div');
    div.style.cssText='display:flex;align-items:center;gap:4px;padding:5px 7px;border-radius:7px;cursor:pointer;'+(active?'background:var(--accent-glow)':'');
    var span=document.createElement('span');span.style.cssText='flex:1;font-size:12px;color:'+(active?'var(--accent-primary)':'var(--text-secondary)')+';overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:var(--font-msg)';
    span.textContent=c.title;span.onclick=()=>loadConv(c.id);
    var del=document.createElement('button');del.innerHTML='<i class="fas fa-trash" style="font-size:9px"></i>';del.style.cssText='background:none;border:none;cursor:pointer;color:var(--text-muted);padding:2px 4px;border-radius:3px';del.onclick=e=>delConv(c.id,e);
    div.appendChild(span);div.appendChild(del);el.appendChild(div);
  });
}

// ==========================================
// SIDEBAR
// ==========================================
function toggleSidebar(){sbColl=!sbColl;var sb=document.getElementById('sidebar'),ic=document.getElementById('stg-ic');sb.classList.toggle('collapsed',sbColl);ic.className='fas fa-chevron-'+(sbColl?'right':'left');ic.style.fontSize='9px';}
function toggleMob(){sbMobOpen=!sbMobOpen;document.getElementById('sidebar').classList.toggle('mob-open',sbMobOpen);document.getElementById('mob-overlay').classList.toggle('show',sbMobOpen);}
function togglePlusMenu(){var m=document.getElementById('plus-menu');m.style.display=m.style.display==='none'?'block':'none';}
document.addEventListener('click',e=>{var pm=document.getElementById('plus-menu');if(pm&&!pm.contains(e.target)&&!document.getElementById('upload-btn').contains(e.target))pm.style.display='none';});

// ==========================================
// FILE UPLOAD
// ==========================================
async function handleFileUpload(ev){
  var f=ev.target.files[0];if(!f||!f.type.startsWith('image/')){toast('Apenas imagens!','warn');return;}
  hideWelcome();
  var r=new FileReader();
  r.onload=e=>{
    var b64=e.target.result;
    var row=document.createElement('div');row.className='msg-row user-row';
    row.innerHTML='<div class="msg-av user">'+(userName||'U').charAt(0).toUpperCase()+'</div><div class="msg-bbl user" style="padding:0;border:none"><img src="'+b64+'" style="max-width:260px;border-radius:8px;display:block"></div>';
    chatEl.appendChild(row);chatEl.scrollTop=chatEl.scrollHeight;
    inputEl.value='Analisa esta imagem em detalhe, descreve o que v√™s.';autoResize(inputEl);
    toast('Imagem carregada!','ok');
  };
  r.readAsDataURL(f);ev.target.value='';
}

// ==========================================
// MEMORY, KB, CM
// ==========================================
function getCM(){try{return JSON.parse(localStorage.getItem('cm_json')||'{"itens":[]}');}catch(e){return{itens:[]};}}
function setCM(d){localStorage.setItem('cm_json',JSON.stringify(d,null,2));}
function saveToCM(txt){var cm=getCM();cm.itens.unshift({id:Date.now(),txt,ts:new Date().toISOString()});if(cm.itens.length>200)cm.itens=cm.itens.slice(0,200);setCM(cm);toast('Guardado!','ok');}
function exportCM(){var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(getCM(),null,2)],{type:'application/json'}));a.download='cm.json';a.click();toast('cm.json exportado!','ok');}
var MEM_KEY='zn_mem';
function getMem(){try{return JSON.parse(localStorage.getItem(MEM_KEY)||'{}');}catch(e){return{};}}
function salvarMem(k,v){if(!k){toast('Chave vazia','warn');return;}var m=getMem();m[k]={v,ts:Date.now()};localStorage.setItem(MEM_KEY,JSON.stringify(m));toast('Guardado!','ok');}
function removerMem(k){var m=getMem();delete m[k];localStorage.setItem(MEM_KEY,JSON.stringify(m));renderAdvBody();}
function limparMem(){if(confirm('Apagar tudo?')){localStorage.removeItem(MEM_KEY);renderAdvBody();}}
function getMemCtx(){var m=getMem(),ks=Object.keys(m);if(!ks.length)return'';return'\nMEM√ìRIA DO UTILIZADOR:\n'+ks.map(k=>'- '+k+': '+m[k].v).join('\n');}
var KB_KEY='zn_kb';
function getKB(){try{return JSON.parse(localStorage.getItem(KB_KEY)||'[]');}catch(e){return[];}}
function setKB(k){localStorage.setItem(KB_KEY,JSON.stringify(k));}
function addKB(t,c){var kb=getKB();kb.unshift({id:Date.now().toString(),titulo:t,conteudo:c});setKB(kb);toast('Adicionado ao KB!','ok');return true;}
function remKB(id){setKB(getKB().filter(d=>d.id!==id));renderAdvBody();}
function getKBCtx(q){var docs=getKB().filter(d=>q.toLowerCase().includes(d.titulo.toLowerCase()));if(!docs.length)return'';return'\nCONHECIMENTO (KB):\n'+docs.slice(0,3).map(d=>'['+d.titulo+']: '+d.conteudo).join('\n');}
function backupAll(){var p={convs,mem:getMem(),kb:getKB(),cm:getCM(),ts:new Date().toISOString()};var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(p,null,2)],{type:'application/json'}));a.download='zenia-backup.json';a.click();toast('Backup criado!','ok');}
function restoreAll(){var i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=e=>{var r=new FileReader();r.onload=ev=>{try{var d=JSON.parse(ev.target.result);if(d.convs){convs=d.convs;saveConvs();renderHist();}if(d.mem)localStorage.setItem(MEM_KEY,JSON.stringify(d.mem));if(d.kb)localStorage.setItem(KB_KEY,JSON.stringify(d.kb));if(d.cm)setCM(d.cm);toast('Restaurado!','ok');}catch(x){toast('Erro no ficheiro.','err');}};r.readAsText(e.target.files[0]);};i.click();}
function importCM(){var i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=e=>{var r=new FileReader();r.onload=ev=>{try{var d=JSON.parse(ev.target.result);if(d.itens){setCM(d);factoryMemory='MEM√ìRIA DE F√ÅBRICA (cm.json):\n'+d.itens.map(x=>'- '+(x.txt||x.texto||'')).join('\n');toast('cm.json importado!','ok');}else toast('Formato inv√°lido.','err');}catch(x){toast('Erro.','err');}};r.readAsText(e.target.files[0]);};i.click();}

// ==========================================
// ADV PANEL
// ==========================================
function openGallery(){openAdv();switchTab('gal');}
function openAdv(){document.getElementById('adv-panel').classList.add('open');document.getElementById('adv-ov').classList.add('show');renderAdvBody();}
function closeAdv(){document.getElementById('adv-panel').classList.remove('open');document.getElementById('adv-ov').classList.remove('show');}
function switchTab(t){advTab=t;var tabs=['mem','conv','media','gal','kb','sys','sec'];document.querySelectorAll('#adv-tabs button').forEach((b,i)=>b.classList.toggle('active',tabs[i]===t));renderAdvBody();}
function checkCreatorPwd(pwd){if(pwd==='adm2007'){creatorMode=true;document.getElementById('creator-badge').style.display='inline-flex';toast('Ol√° Chefe In√°cio!','ok');renderAdvBody();}else toast('Senha errada!','err');}
function disableCreator(){creatorMode=false;document.getElementById('creator-badge').style.display='none';renderAdvBody();}

function renderAdvBody(){
  var body=document.getElementById('adv-body');if(!body)return;var h='';
  if(advTab==='mem'){
    var mem=getMem(),ks=Object.keys(mem);
    h+='<div class="adv-s"><h4>Guardar Mem√≥ria</h4><input class="adv-in" id="mk" placeholder="Chave (ex: profiss√£o)"><input class="adv-in" id="mv" placeholder="Valor (ex: Engenheiro)"><button class="adv-btn" onclick="salvarMem(document.getElementById(\'mk\').value,document.getElementById(\'mv\').value);renderAdvBody()"><i class="fas fa-save"></i> Guardar</button></div>';
    h+='<div class="adv-s"><h4>Mem√≥rias ('+ks.length+')</h4>';
    ks.forEach(k=>{h+='<div class="mem-item"><span class="mem-key">'+escHtml(k)+'</span><span class="mem-val">'+escHtml(mem[k].v)+'</span><button class="mem-del" onclick="removerMem(\''+escHtml(k)+'\')">√ó</button></div>';});
    h+='</div><button class="adv-btn" style="color:#ef4444" onclick="limparMem()"><i class="fas fa-trash"></i> Apagar Tudo</button>';
  }else if(advTab==='conv'){
    h+='<div class="adv-s"><h4>Backup & Restauro</h4><button class="adv-btn" onclick="backupAll()"><i class="fas fa-download"></i> Backup Completo</button><button class="adv-btn" onclick="restoreAll()"><i class="fas fa-upload"></i> Restaurar</button></div>';
    h+='<div class="adv-s"><h4>Utilizador</h4><input class="adv-in" id="uname-edit" value="'+escHtml(userName||'')+'" placeholder="O teu nome"><button class="adv-btn" onclick="var n=document.getElementById(\'uname-edit\').value.trim();if(n){userName=n;localStorage.setItem(\'zn_username\',n);document.getElementById(\'uname\').textContent=n;document.getElementById(\'user-initial\').textContent=n.charAt(0).toUpperCase();document.getElementById(\'welcome-name\').textContent=n;toast(\'Nome atualizado!\',\'ok\');}"><i class="fas fa-user"></i> Atualizar Nome</button></div>';
    h+='<div class="adv-s"><h4>Estat√≠sticas</h4><div style="font-size:12px;color:var(--text-secondary)">Total de conversas: '+convs.length+'<br>Total de mensagens: '+convs.reduce((a,c)=>a+c.messages.length,0)+'</div></div>';
  }else if(advTab==='media'){
    h+='<div class="adv-s"><h4>Gera√ß√£o de M√©dia</h4>';
    h+='<button class="adv-btn" onclick="var p=prompt(\'Prompt para imagem:\');if(p)genImg(p)"><i class="fas fa-image" style="color:var(--accent-secondary)"></i> Gerar Imagem</button>';
    h+='<button class="adv-btn" onclick="var p=prompt(\'Prompt para v√≠deo:\');if(p)genVid(p)"><i class="fas fa-video" style="color:#ef4444"></i> Gerar V√≠deo (Veo3)</button>';
    h+='<button class="adv-btn" onclick="var p=prompt(\'Prompt para √°udio:\');if(p)genAud(p)"><i class="fas fa-music" style="color:#22c55e"></i> Gerar √Åudio</button>';
    h+='<button class="adv-btn" onclick="openVisionModal();closeAdv()"><i class="fas fa-eye" style="color:#10b981"></i> An√°lise de Imagem</button></div>';
  }else if(advTab==='gal'){
    h+='<div class="adv-s"><h4>Galeria de Imagens</h4>';
    var found=false;
    convs.forEach(c=>c.messages.forEach(m=>{if(m.content.includes('[Imagem:')){found=true;var p=m.content.match(/\[Imagem:\s*(.*?)\]/);if(p)h+='<div class="media-card" style="margin-bottom:7px;padding:8px"><div style="font-size:11px;color:var(--text-muted);margin-bottom:5px">'+escHtml(p[1])+'</div><button class="mbtn" onclick="genImg(\''+escHtml(p[1].replace(/'/g,"\\'"))+'\')"><i class="fas fa-redo"></i> Regerar</button></div>';}}));
    if(!found)h+='<p style="color:var(--text-muted);font-size:12px;padding:4px">Sem imagens no hist√≥rico.</p>';
    h+='</div>';
  }else if(advTab==='kb'){
    var kb=getKB();
    h+='<div class="adv-s"><h4>Adicionar Conhecimento</h4><input class="adv-in" id="kbt" placeholder="T√≠tulo do t√≥pico"><textarea class="adv-in" id="kbc" rows="3" placeholder="Conte√∫do..."></textarea><button class="adv-btn" onclick="if(addKB(document.getElementById(\'kbt\').value,document.getElementById(\'kbc\').value))renderAdvBody()"><i class="fas fa-plus"></i> Adicionar</button></div>';
    h+='<div class="adv-s"><h4>Base de Conhecimento ('+kb.length+')</h4>';
    kb.forEach(d=>{h+='<div class="mem-item"><span class="mem-key">'+escHtml(d.titulo)+'</span><button class="mem-del" onclick="remKB(\''+d.id+'\')">√ó</button></div>';});
    h+='</div>';
    h+='<div class="adv-s"><h4>Mem√≥ria de F√°brica (cm.json)</h4>';
    h+='<button class="adv-btn" onclick="importCM()"><i class="fas fa-upload"></i> Importar cm.json</button>';
    h+='<button class="adv-btn" onclick="exportCM()"><i class="fas fa-download"></i> Exportar cm.json</button>';
    if(factoryMemory)h+='<div style="font-size:11px;color:#22c55e;margin-top:5px"><i class="fas fa-check-circle"></i> cm.json carregado ('+factoryMemory.split("\n").length+' entradas)</div>';
    h+='</div>';
  }else if(advTab==='sys'){
    h+='<div class="adv-s"><h4>Pesquisa Web</h4>';
    h+='<button class="adv-btn" onclick="document.getElementById(\'websearch-modal\').classList.add(\'open\');closeAdv()"><i class="fas fa-search" style="color:#60a5fa"></i> Abrir Pesquisa Web</button>';
    h+='<div style="font-size:11px;color:var(--text-muted);margin-top:5px">APIs dispon√≠veis: DuckDuckGo (ativo), Bing, Google/SerpAPI, Yandex</div></div>';
    h+='<div class="adv-s"><h4>Voz & Personalidade</h4>';
    h+='<button class="adv-btn" onclick="openPersonality();closeAdv()"><i class="fas fa-microphone" style="color:#a855f7"></i> Configurar Voz & Tom</button></div>';
    h+='<div class="adv-s"><h4>Modelos de IA</h4>';
    h+='<select class="adv-in" onchange="document.getElementById(\'model-sel\').value=this.value"><option value="openai">OpenAI GPT-4</option><option value="qwen-coder">Qwen Coder</option><option value="openai-large">OpenAI Large</option><option value="mistral">Mistral</option><option value="deepseek">DeepSeek</option></select></div>';
  }else if(advTab==='sec'){
    h+='<div class="adv-s"><h4>Modo Criador (IUD)</h4>';
    if(creatorMode){h+='<div style="color:var(--accent-secondary);font-size:12px;margin-bottom:10px">Ol√° In√°cio (Modo Ativo)</div><button class="adv-btn" onclick="exportCM()"><i class="fas fa-download"></i> Exportar cm.json</button><button class="adv-btn" style="color:#ef4444" onclick="disableCreator()"><i class="fas fa-sign-out-alt"></i> Sair do Modo Criador</button>';}
    else{h+='<input class="adv-in" type="password" id="cpwd" placeholder="Senha do criador..."><button class="adv-btn" onclick="checkCreatorPwd(document.getElementById(\'cpwd\').value)"><i class="fas fa-key"></i> Entrar</button>';}
    h+='</div><div class="adv-s"><h4>Resetar Aplica√ß√£o</h4><button class="adv-btn" style="color:#ef4444" onclick="if(confirm(\'Apagar todos os dados e recome√ßar?\')){localStorage.clear();location.reload();}"><i class="fas fa-exclamation-triangle"></i> Resetar Tudo</button></div>';
  }
  body.innerHTML=h;
}

// ==========================================
// TOAST
// ==========================================
function toast(msg,type){var el=document.getElementById('toast');if(!el)return;el.textContent=msg;el.className='toast show '+(type||'ok');clearTimeout(el._t);el._t=setTimeout(()=>el.classList.remove('show'),3200);}

// ==========================================
// MIC
// ==========================================
var micBtn=document.getElementById('mic-btn'),micRec=null,micOn=false;
if('SpeechRecognition'in window||'webkitSpeechRecognition'in window){
  var SRC=window.SpeechRecognition||window.webkitSpeechRecognition;micRec=new SRC();micRec.lang='pt-PT';
  micRec.onresult=e=>{inputEl.value=e.results[0][0].transcript;autoResize(inputEl);micOn=false;micBtn.style.color='';handleSend();};
  micRec.onerror=()=>{micOn=false;micBtn.style.color='';};
  micRec.onend=()=>{micOn=false;micBtn.style.color='';};
  micBtn.onclick=()=>{if(micOn)micRec.stop();else{try{micRec.start();micOn=true;micBtn.style.color='#ef4444';}catch(e){}}};
}else{micBtn.disabled=true;micBtn.style.opacity='.3';}
</script>
</body>
</html>
