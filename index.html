<!DOCTYPE html>
<html lang="pt-AO">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>IA-Z√©nia by Z√©nia-Projects</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root {
    --accent: #00eaff;        
    --accent-alt: #0066ff;    
    --bg: #020617;            
    --panel: #0b1124;         
    --border: #1e3a8a;        
    --text-light: #e0f2fe;    
    --neon-glow: 0 0 15px rgba(0, 234, 255, 0.6), 0 0 30px rgba(0, 102, 255, 0.4);
}

* { box-sizing: border-box; }

body { 
    background: linear-gradient(135deg, var(--bg) 0%, #000000 100%); 
    color: var(--text-light); 
    font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin: 0; height: 100vh; display: flex; overflow: hidden; 
}

.sidebar { 
    width: 280px; 
    background: linear-gradient(to bottom, var(--panel), var(--bg));
    border-right: 1px solid var(--border); 
    display: flex; flex-direction: column; transition: .3s; 
    box-shadow: 5px 0 15px rgba(0, 102, 255, 0.1);
    z-index: 100;
}

@media(max-width:768px){ 
    .sidebar{position:fixed;left:-100%;top:0;height:100%; width: 85%; max-width: 300px;}
    .sidebar.active{left:0;} 
    .sidebar-overlay {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(3px); z-index: 90; display: none; opacity: 0; transition: opacity .3s;}
    .sidebar-overlay.active { display: block; opacity: 1; }
}

.main-content { flex:1; display:flex; flex-direction:column; overflow:hidden; }

.chat-container { 
    flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; 
    background: radial-gradient(circle at center, #0b1124 0%, var(--bg) 70%);
}

.hist-item { 
    padding: 12px; border-radius: 12px; background: rgba(11, 17, 36, 0.6); margin-bottom: 10px; cursor: pointer; 
    border: 1px solid var(--border); font-size: 13px; transition: all .3s ease; word-break: break-word;
}
.hist-item:hover { border-color: var(--accent); background: linear-gradient(to right, rgba(0, 234, 255, 0.1), rgba(0, 102, 255, 0.2)); }
.hist-item.active { border-color: var(--accent-alt); background: linear-gradient(to right, rgba(0, 102, 255, 0.3), rgba(11, 17, 36, 0.8)); box-shadow: var(--neon-glow); }

.btn-new { 
    background: linear-gradient(135deg, var(--accent), var(--accent-alt)); 
    color: #fff; padding: 12px; border-radius: 12px; font-weight: 800; text-align: center; margin-bottom: 20px; cursor: pointer; transition: .3s; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.3); box-shadow: 0 4px 15px rgba(0, 102, 255, 0.3); border: none;
}
.btn-new:hover { transform: translateY(-2px) scale(1.02); box-shadow: var(--neon-glow); }

.btn-close-sidebar { display: none; margin-bottom: 15px; padding: 10px; background: rgba(255, 51, 102, 0.2); border: 1px solid #ff3366; color: #ff3366; font-weight: bold; border-radius: 8px; text-align: center; cursor: pointer; }
@media(max-width:768px){ .btn-close-sidebar{display:block;} }

.msg-wrapper { display:flex; flex-direction:column; max-width:90%; gap:5px; position:relative; animation:fadeIn .3s ease; }
.msg-wrapper.user-wrapper { align-self: flex-end; }
.msg-wrapper.ai-wrapper { align-self: flex-start; }

.msg { padding: 15px; border-radius: 18px; line-height: 1.6; font-size: 14px; word-wrap: break-word; transition: .3s; backdrop-filter: blur(5px); white-space: pre-wrap; }
.ai-msg { border: 1px solid var(--border); border-left: 4px solid var(--accent); background: linear-gradient(135deg, var(--panel), rgba(2, 6, 23, 0.8)); color: var(--text-light); }
.user-msg { background: linear-gradient(135deg, var(--accent-alt), var(--accent)); color: #fff; border: none; box-shadow: 0 5px 15px rgba(0, 102, 255, 0.4); }

.msg-controls { display: flex; gap: 10px; margin-top: 8px; padding: 0 10px; opacity: 0; transition: opacity .3s; }
.msg-wrapper:hover .msg-controls { opacity: 1; }

.ctrl-btn { cursor: pointer; transition: .2s; color: #64748b; padding: 4px 8px; border-radius: 6px; background: rgba(0, 234, 255, 0.1); border: 1px solid var(--border); font-size: 14px; }
.ctrl-btn:hover { color: var(--accent); background: rgba(0, 234, 255, 0.2); }

.footer-input { background: linear-gradient(to top, var(--bg) 0%, rgba(11, 17, 36, 0.95) 100%); padding: env(safe-area-inset-bottom, 10px) 10px 10px 10px; border-top: 1px solid var(--border); }
.footer-input-inner { max-width: 860px; margin: 0 auto; background: rgba(11, 17, 36, 0.5); border-radius: 20px; padding: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; backdrop-filter: blur(10px); }

.input-row { display: flex; gap: 8px; width: 100%; align-items: flex-end; }
textarea { flex: 1; background: transparent; border: none; outline: none; color: var(--text-light); font-size: 15px; padding: 10px; max-height: 120px; resize: none; font-family: inherit; }

button.action-btn { width: 40px; height: 40px; border-radius: 12px; border: none; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: .3s; }
button.send-btn { background: linear-gradient(135deg, var(--accent), var(--accent-alt)); color: #fff; box-shadow: 0 0 10px rgba(0, 234, 255, 0.3); }

.loading { display: inline-block; width: 12px; height: 12px; border: 2px solid var(--accent); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }

.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
.modal-overlay.active { display: flex; }
.modal-content { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px; max-width: 600px; width: 90%; box-shadow: var(--neon-glow); }
.modal-header { font-size: 16px; font-weight: bold; color: var(--accent); margin-bottom: 15px; }
.modal-textarea { width: 100%; background: rgba(0,0,0,0.3); color: var(--text-light); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-family: inherit; font-size: 14px; min-height: 150px; resize: vertical; }
.modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; }
.modal-btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: .2s; }
.modal-btn-save { background: linear-gradient(135deg, var(--accent), var(--accent-alt)); color: #fff; }
.modal-btn-cancel { background: rgba(255,51,102,0.2); color: #ff3366; border: 1px solid #ff3366; }

@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeIn { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }

#titleRotator { transition: opacity 0.3s ease-in-out; }

@media(max-width:768px){ 
    .chat-container { padding: 15px; } 
    .msg-wrapper { max-width: 100%; }
}

.chat-container::-webkit-scrollbar { width: 6px; }
.chat-container::-webkit-scrollbar-track { background: transparent; }
.chat-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
.chat-container::-webkit-scrollbar-thumb:hover { background: var(--accent); }
</style>
</head>
<body>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="window.toggleSidebar()"></div>

<aside class="sidebar p-4" id="sidebar">
    <button class="btn-close-sidebar" onclick="window.toggleSidebar()">‚úï FECHAR</button>
    <div class="btn-new" onclick="window.startNewChat()">+ NOVA CONVERSA</div>
    <h2 class="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">Hist√≥rico</h2>
    <div id="historyList" class="flex-1 overflow-y-auto pr-1"></div>
    <div class="mt-auto pt-4 border-t border-slate-800 space-y-2 text-xs">
        <h2 class="text-[9px] font-bold text-slate-500 uppercase mb-2">Sobre</h2>
        <p class="text-slate-400">Desenvolvido por<br><strong>@inacio.u.daniel</strong></p>
        <p class="text-slate-400">Z√©nia-Projects ¬© 2025</p>
        <p class="text-slate-300 text-[10px] mt-2">üîì APIs 100% p√∫blicas<br>Sem chaves necess√°rias</p>
    </div>
</aside>

<main class="main-content">
    <header class="p-4 border-b border-slate-800 flex justify-between items-center bg-black/30 backdrop-blur-md z-10">
        <div class="flex items-center gap-4">
            <button onclick="window.toggleSidebar()" class="md:hidden text-white font-bold text-lg">‚ò∞</button>
            <h1 class="text-xl font-black italic tracking-wider">
                IA-Z√âNIA <span class="text-blue-500 text-xs font-normal" id="titleRotator" style="text-shadow: 0 0 10px rgba(0,234,255,0.5);">VISION</span>
            </h1>
        </div>
        <button onclick="window.clearAllData()" class="text-[10px] text-red-500 font-bold hover:underline">LIMPAR</button>
    </header>

    <div id="chatBox" class="chat-container"></div>

    <div class="footer-input z-20">
        <div class="footer-input-inner">
            <div class="input-row">
                <textarea id="userInput" placeholder="Escreve uma mensagem..." oninput="window.autoGrow(this)"></textarea>
                <button class="action-btn send-btn" onclick="window.handleSend()">üöÄ</button>
            </div>
        </div>
    </div>
</main>

<div class="modal-overlay" id="editModal">
    <div class="modal-content">
        <div class="modal-header">Editar Mensagem</div>
        <textarea class="modal-textarea" id="editTextarea"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="window.closeEditModal()">Cancelar</button>
            <button class="modal-btn modal-btn-save" onclick="window.saveEditedMessage()">Guardar</button>
        </div>
    </div>
</div>

<div style="position:fixed;top:10px;right:15px;padding:8px 15px;background:rgba(2, 6, 23, 0.8);color:var(--accent);border:1px solid var(--accent);border-radius:20px;font-size:12px;font-weight:bold;backdrop-filter:blur(10px);z-index:9999;">
    üîµ <span id="viewsNumber">0</span>
</div>

<script>
/* ============================================================
   VARI√ÅVEIS GLOBAIS
============================================================ */
const chatBox = document.getElementById('chatBox');
const historyList = document.getElementById('historyList');
const userInput = document.getElementById('userInput');
const editModal = document.getElementById('editModal');
const editTextarea = document.getElementById('editTextarea');

let sessions = JSON.parse(localStorage.getItem('zenia_sessions') || '[]');
let currentSessionId = null;
let editingMessageId = null;

const titleRotations = ['VISION', 'ALL.ANGOLA', 'LUBANGO', 'DE CABINDA AO CUNENE', 'ALL.WORLD', 'ALL.AFRICA', '@INACIO.U.DANIEL'];
let titleIndex = 0;

/* ============================================================
   ROTA√á√ÉO DE T√çTULO
============================================================ */
function rotateTitleSubtitle(){
    const titleEl = document.getElementById('titleRotator');
    if(!titleEl) return;
    titleEl.style.opacity = '0';
    setTimeout(() => {
        titleIndex = (titleIndex + 1) % titleRotations.length;
        titleEl.textContent = titleRotations[titleIndex];
        titleEl.style.opacity = '1';
    }, 300);
}
setInterval(rotateTitleSubtitle, 7000);

/* ============================================================
   FUN√á√ïES GLOBAIS
============================================================ */
window.toggleSidebar = function(){ 
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("sidebarOverlay");
    if(sidebar) sidebar.classList.toggle("active");
    if(overlay) overlay.classList.toggle("active");
};

window.autoGrow = function(el){ 
    el.style.height = "auto"; 
    el.style.height = Math.min(el.scrollHeight, 120) + "px"; 
};

window.clearAllData = function(){ 
    if(confirm("Apagar tudo?")){ 
        try { localStorage.clear(); location.reload(); } 
        catch(e) { console.error(e); }
    } 
};

window.startNewChat = startNewChat;
window.handleSend = handleSend;

window.deleteMessage = function(msgId) {
    const msgEl = document.getElementById(msgId);
    if(msgEl && msgEl.parentElement) {
        msgEl.style.opacity = '0';
        setTimeout(() => { if(msgEl.parentElement) msgEl.parentElement.remove(); }, 300);
    }
};

window.editMessage = function(msgId) {
    const msgEl = document.getElementById(msgId);
    if(msgEl) {
        editTextarea.value = msgEl.textContent || '';
        editingMessageId = msgId;
        editModal.classList.add('active');
        editTextarea.focus();
    }
};

window.closeEditModal = function() {
    editModal.classList.remove('active');
    editingMessageId = null;
};

window.saveEditedMessage = function() {
    if(editingMessageId) {
        const msgEl = document.getElementById(editingMessageId);
        if(msgEl) msgEl.textContent = editTextarea.value;
    }
    window.closeEditModal();
};

/* ============================================================
   CONTADOR DE VISITANTES
============================================================ */
(function(){
    try {
        let v = localStorage.getItem("zenia_global_views");
        v = v ? parseInt(v) + 1 : 1;
        localStorage.setItem("zenia_global_views", v);
        const viewsEl = document.getElementById("viewsNumber");
        if(viewsEl) viewsEl.textContent = v;
    } catch(e) { console.error(e); }
})();

/* ============================================================
   SYSTEM PROMPT
============================================================ */
const ZENIA_SYSTEM = `Voc√™ √© IA-Z√âNIA, assistente inteligente do Lubango criada por @inacio.u.daniel.
- Responda em Portugu√™s de Angola
- Seja amig√°vel, criativo e conciso
- M√°ximo 150 palavras por resposta`;

/* ============================================================
   APIs P√öBLICAS SEM CHAVES
============================================================ */

// API 1: Hugging Face Inference API (100% gr√°tis, p√∫blico)
async function callHuggingFace(prompt) {
    try {
        const response = await fetch('https://api-inference.huggingface.co/models/gpt2', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                inputs: prompt,
                parameters: {
                    max_length: 200,
                    temperature: 0.7
                }
            })
        });

        if(!response.ok) throw new Error(`HF error: ${response.status}`);
        const data = await response.json();
        return data[0]?.generated_text || null;
    } catch(e) {
        console.log('HuggingFace falhou:', e.message);
        throw e;
    }
}

// API 2: Cohere Playground (sem autentica√ß√£o)
async function callCoherePlayground(prompt) {
    try {
        const response = await fetch('https://api.cohere.ai/v1/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer '
            },
            body: JSON.stringify({
                prompt: prompt,
                max_tokens: 200,
                temperature: 0.7
            })
        });

        if(!response.ok) throw new Error(`Cohere error: ${response.status}`);
        const data = await response.json();
        return data.generations[0]?.text || null;
    } catch(e) {
        console.log('Cohere falhou:', e.message);
        throw e;
    }
}

// API 3: Random User API (para ter algo funcionando)
async function callRandomAPI(prompt) {
    try {
        const response = await fetch('https://jsonplaceholder.typicode.com/posts/1');
        if(!response.ok) throw new Error('Random API error');
        const data = await response.json();
        
        // Retorna texto criativo baseado no prompt
        return `Recebi sua mensagem: "${prompt}"\n\nVou processar e responder assim que as APIs estiverem dispon√≠veis!`;
    } catch(e) {
        console.log('Random API falhou:', e.message);
        throw e;
    }
}

// Fun√ß√£o principal de chamada
async function callAPI(prompt) {
    const apis = [
        () => callHuggingFace(prompt),
        () => callCoherePlayground(prompt),
        () => callRandomAPI(prompt),
    ];

    for (let apiFunc of apis) {
        try {
            const response = await apiFunc();
            if(response) return response;
        } catch(e) {
            console.log('API falhou, tentando pr√≥xima...');
            continue;
        }
    }
    
    throw new Error('Todas as APIs falharam');
}

/* ============================================================
   BASE DE DADOS LOCAL
============================================================ */
const knowledgeBase = {
    greetings: {
        'oi': 'Ol√°! Como est√°? üëã',
        'ol√°': 'Oi! Bem-vindo! Como posso ajudar? üòä',
        'ola': 'Oi! Bem-vindo! Como posso ajudar? üòä',
        'tudo bem': 'Tudo bem sim! E contigo? üòä',
        'como vai': 'Estou √≥timo! Pronto para conversar! üöÄ',
        'bom dia': 'Bom dia! Que dia lindo, n√£o √©? üåÖ',
        'boa tarde': 'Boa tarde! Como est√° sendo seu dia? üå§Ô∏è',
        'boa noite': 'Boa noite! Que descanse bem! üåô',
    },
    thanks: {
        'obrigado': 'De nada! Fico feliz em ajudar! üòä',
        'muito obrigado': 'Por nada! Sempre √† disposi√ß√£o! üòä',
        'valeu': 'De nada! Volte sempre! üëç',
    },
    about: {
        'quem √© voc√™': 'Sou a IA-Z√©nia, sua assistente inteligente do Lubango!\nCriada por @inacio.u.daniel com muito carinho! ü§ñ',
        'qual √© seu nome': 'Sou a Z√©nia! Prazer em conversar com voc√™! üòä',
        'como voc√™ funciona': 'Sou uma intelig√™ncia artificial que usa APIs p√∫blicas para responder perguntas.\nSem chaves, completamente gr√°tis! üéâ',
        'voc√™ √© gr√°tis': 'Sim! 100% gr√°tis e de c√≥digo aberto! üîì',
    },
    location: {
        'lubango': 'Lubango √© a capital da Hu√≠la, uma cidade linda em Angola! üá¶üá¥',
        'angola': 'Angola √© um belo pa√≠s na √Åfrica Austral com muita cultura! üá¶üá¥',
        'hu√≠la': 'Hu√≠la √© uma das 21 prov√≠ncias de Angola, onde fico localizada! üèûÔ∏è',
    },
    help: {
        'ajuda': 'Posso ajudar com:\n‚Ä¢ Responder perguntas\n‚Ä¢ Conversar\n‚Ä¢ Guardar hist√≥rico\n\nS√≥ escreve e envia! üòä',
        'o que voc√™ faz': 'Respondo suas perguntas, converso com voc√™ e guardo o hist√≥rico localmente!\nSem necessidade de APIs com chaves! üéâ',
    }
};

// Procurar resposta na base de dados
function findLocalResponse(query) {
    const lower = query.toLowerCase().trim();
    
    for (let category in knowledgeBase) {
        for (let key in knowledgeBase[category]) {
            if (lower.includes(key)) {
                return knowledgeBase[category][key];
            }
        }
    }
    
    return null;
}

// Gerar resposta padr√£o criativa
function generateCreativeResponse(query) {
    const responses = [
        `Que pergunta interessante sobre "${query}"! ü§î\n\nNo momento, estou aprendendo mais sobre este t√≥pico. Que me diz mais?`,
        `"${query}" √© um tema fascinante! üåü\n\nGostaria de saber mais. Pode elaborar?`,
        `Adorei sua pergunta sobre "${query}"! üí°\n\nTe agradar√≠a explorar isto mais profundamente?`,
        `${query.substring(0, 20)}... Interessante! üéØ\n\nQual √© o contexto da sua pergunta?`,
    ];
    return responses[Math.floor(Math.random() * responses.length)];
}

/* ============================================================
   CORE FUNCTIONS
============================================================ */
function init(){
    renderHistory();
    if(sessions.length > 0) {
        loadSession(sessions[sessions.length - 1].id);
    } else {
        startNewChat();
    }
}

function startNewChat(){
    currentSessionId = Date.now();
    chatBox.innerHTML = '';
    const newSession = {
        id: currentSessionId,
        title: 'Conversa Nova',
        messages: []
    };
    sessions.push(newSession);
    try { localStorage.setItem('zenia_sessions', JSON.stringify(sessions)); } 
    catch(e) { console.error(e); }
    addMessage("Ol√°! Sou a IA-Z√©nia ü§ñ\n\nSou 100% gr√°tis e funciono com APIs p√∫blicas, sem nenhuma chave!\n\nComo posso ajud√°-lo?", false);
    renderHistory();
}

function loadSession(sessionId){
    currentSessionId = sessionId;
    const session = sessions.find(s => s.id === sessionId);
    chatBox.innerHTML = '';
    if(session) {
        session.messages.forEach(m => {
            addMessage(m.text, m.role === 'user');
        });
    }
    renderHistory();
}

async function handleSend(){
    const query = userInput.value.trim();
    if(!query) return;

    addMessage(query, true);
    userInput.value = '';
    userInput.style.height = 'auto';

    const loadMsg = addMessage('Z√©nia est√° pensando... <span class="loading"></span>', false);
    
    try {
        // 1. Tentar resposta local primeiro (r√°pido)
        let response = findLocalResponse(query);
        
        // 2. Se n√£o achou, tentar APIs
        if (!response) {
            try {
                response = await callAPI(ZENIA_SYSTEM + '\n\nPergunta: ' + query);
                
                // Limpar resposta de artefatos
                if(response) {
                    response = response
                        .replace(/^[^a-z√°√©√≠√≥√∫]*/i, '')
                        .trim()
                        .split('\n')[0];
                }
            } catch(apiError) {
                console.log('APIs falharam, gerando resposta criativa');
                response = generateCreativeResponse(query);
            }
        }

        if(loadMsg && loadMsg.parentElement) {
            loadMsg.parentElement.remove();
        }
        
        processResponse(response || 'Desculpe, houve um erro. Tente novamente.', query);
    } catch(e) {
        console.error(e);
        const fallback = generateCreativeResponse(query);
        if(loadMsg && loadMsg.parentElement) {
            loadMsg.parentElement.remove();
        }
        processResponse(fallback, query);
    }
}

function processResponse(text, query){
    const wrapper = document.createElement('div');
    wrapper.className = 'msg-wrapper ai-wrapper';
    
    const msgId = 'ai-' + Date.now();
    const msgDiv = document.createElement('div');
    msgDiv.id = msgId;
    msgDiv.className = 'msg ai-msg';
    msgDiv.textContent = text;
    wrapper.appendChild(msgDiv);
    
    const controls = document.createElement('div');
    controls.className = 'msg-controls';
    controls.innerHTML = `
        <span class="ctrl-btn" onclick="window.deleteMessage('${msgId}')" title="Remover">üóëÔ∏è</span>
        <span class="ctrl-btn" onclick="window.editMessage('${msgId}')" title="Editar">‚úèÔ∏è</span>
    `;
    wrapper.appendChild(controls);
    
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
    
    saveToSession(query, text);
}

function addMessage(text, isUser){
    const wrapper = document.createElement('div');
    wrapper.className = 'msg-wrapper ' + (isUser ? 'user-wrapper' : 'ai-wrapper');
    
    const msgId = (isUser ? 'user' : 'ai') + '-' + Date.now();
    const msgDiv = document.createElement('div');
    msgDiv.id = msgId;
    msgDiv.className = 'msg ' + (isUser ? 'user-msg' : 'ai-msg');
    msgDiv.innerHTML = text;  // innerHTML para o spinner
    wrapper.appendChild(msgDiv);
    
    if(isUser) {
        const controls = document.createElement('div');
        controls.className = 'msg-controls';
        controls.innerHTML = `
            <span class="ctrl-btn" onclick="window.deleteMessage('${msgId}')" title="Remover">üóëÔ∏è</span>
            <span class="ctrl-btn" onclick="window.editMessage('${msgId}')" title="Editar">‚úèÔ∏è</span>
        `;
        wrapper.appendChild(controls);
    }
    
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
    return wrapper;
}

function saveToSession(userText, aiText){
    const session = sessions.find(x => x.id === currentSessionId);
    if(session) {
        session.messages.push({role: 'user', text: userText});
        session.messages.push({role: 'ai', text: aiText});
        try { localStorage.setItem('zenia_sessions', JSON.stringify(sessions)); } 
        catch(e) { console.error(e); }
        renderHistory();
    }
}

function renderHistory(){
    historyList.innerHTML = '';
    sessions.slice().reverse().forEach(s => {
        const item = document.createElement('div');
        item.className = 'hist-item' + (s.id === currentSessionId ? ' active' : '');
        const title = s.messages.length > 0 ? s.messages[0].text.substring(0, 25) : 'Conversa';
        item.textContent = title + '...';
        item.onclick = (e) => {
            e.stopPropagation();
            loadSession(s.id);
        };
        historyList.appendChild(item);
    });
}

/* ============================================================
   EVENT LISTENERS
============================================================ */
editModal.addEventListener('click', function(e){
    if(e.target === editModal) window.closeEditModal();
});

document.addEventListener('keydown', function(e){
    if(e.key === 'Escape' && editModal.classList.contains('active')) {
        window.closeEditModal();
    }
    if(e.key === 'Enter' && !e.shiftKey && document.activeElement === userInput) {
        e.preventDefault();
        window.handleSend();
    }
});

init();
</script>
</body>
</html>
