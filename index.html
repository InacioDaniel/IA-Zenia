<script type="module">
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.16.0';
    env.allowLocalModels = false;
    env.useBrowserCache = true;

    let visionPipeline = null;
    let sessions = JSON.parse(localStorage.getItem('zenia_sessions') || '[]');
    let currentSessionId = null;

    // --- CONFIGURAÇÃO DE APIS PÚBLICAS (SEM CHAVE) ---
    const API_ENDPOINTS = [
        (p) => `https://text.pollinations.ai/${encodeURIComponent(p)}?model=mistral`,
        (p) => `https://api.pawan.krd/cosmosrp-v1/chat/completions`, // Alternativa Pública
        (p) => `https://hercai.onrender.com/v3/hercai?question=${encodeURIComponent(p)}` // Backup Grátis
    ];

    window.onload = () => {
        if (sessions.length === 0) startNewChat();
        else loadSession(sessions[sessions.length - 1].id);
        renderHistory();
    };

    window.toggleSidebar = () => {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('sidebarOverlay').classList.toggle('hidden');
    };

    window.startNewChat = () => {
        currentSessionId = Date.now();
        const newSession = { id: currentSessionId, title: "Nova Conversa", messages: [] };
        sessions.push(newSession);
        saveSessions();
        document.getElementById('chatBox').innerHTML = '';
        addMessage("Onawa! Sou a IA-ZÉNIA. Estou conectada via redes neurais públicas. O que vamos criar hoje?", false);
        renderHistory();
    };

    async function fetchAIResponse(prompt) {
        // Tenta a Pollinations primeiro, se falhar, vai para a Hercai (Pública)
        try {
            const res = await fetch(API_ENDPOINTS[0](prompt));
            if (!res.ok) throw new Error();
            return await res.text();
        } catch (e) {
            console.log("Servidor principal instável, tentando backup...");
            try {
                const res = await fetch(API_ENDPOINTS[2](`Responda como IA-ZÉNIA do Lubango: ${prompt}`));
                const data = await res.json();
                return data.reply || data.content;
            } catch (e2) {
                return "Kapiango! Todos os meus servidores estão ocupados agora. Tenta de novo em 1 minuto?";
            }
        }
    }

    window.handleSend = async (textOverride = null, isSystem = false) => {
        const input = document.getElementById('userInput');
        const text = (textOverride || input.value).trim();
        if (!text) return;

        if (!isSystem) {
            addMessage(text, true);
            input.value = '';
            input.style.height = 'auto';
        }

        const loadMsg = addMessage("Zénia está a pensar...", false);
        
        const systemPrompt = `Você é IA-ZÉNIA, uma IA do Lubango, Angola. Seja prestativa e use gírias leves angolanas. Pergunta: ${text}`;
        const responseText = await fetchAIResponse(systemPrompt);
        
        loadMsg.remove();
        addMessage(responseText, false);
        
        const session = sessions.find(s => s.id === currentSessionId);
        if (session) {
            if (session.messages.length === 0) session.title = text.substring(0, 25);
            session.messages.push({ role: 'user', text: text }, { role: 'ai', text: responseText });
            saveSessions();
            renderHistory();
        }
    };

    // --- RESTANTE DAS FUNÇÕES (Mantendo Visão e UI) ---
    function addMessage(text, isUser) {
        const chatBox = document.getElementById('chatBox');
        const wrapper = document.createElement('div');
        wrapper.className = `msg-wrapper ${isUser ? 'user-wrapper' : 'ai-wrapper'}`;
        wrapper.innerHTML = `<div class="msg ${isUser ? 'user-msg' : 'ai-msg'}">${isUser ? escapeHTML(text) : formatMarkdown(text)}</div>`;
        chatBox.appendChild(wrapper);
        chatBox.scrollTop = chatBox.scrollHeight;
        return wrapper;
    }

    function formatMarkdown(t) {
        return t.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/### (.*?)\n/g, '<h3 class="text-blue-400 font-bold">$1</h3>')
                .replace(/\n/g, '<br>');
    }

    function escapeHTML(s) { return s.replace(/&/g, '&amp;').replace(/</g, '&lt;'); }
    function saveSessions() { localStorage.setItem('zenia_sessions', JSON.stringify(sessions)); }
    function renderHistory() {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        [...sessions].reverse().slice(0, 10).forEach(s => {
            const item = document.createElement('div');
            item.className = `p-3 rounded-xl cursor-pointer text-sm truncate mb-1 ${s.id === currentSessionId ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' : 'text-slate-400 hover:bg-white/5'}`;
            item.innerText = s.title;
            item.onclick = () => loadSession(s.id);
            list.appendChild(item);
        });
    }
    function loadSession(id) {
        currentSessionId = id;
        const session = sessions.find(s => s.id === id);
        document.getElementById('chatBox').innerHTML = '';
        session.messages.forEach(m => addMessage(m.text, m.role === 'user'));
        renderHistory();
    }
</script>
