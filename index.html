<!DOCTYPE html>
<html lang="pt-PT" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA-Zénia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0b0d11; color: #e5e7eb; font-family: 'Inter', sans-serif; }
        .sidebar { background-color: #161b22; transition: all 0.3s ease; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .chat-container::-webkit-scrollbar { width: 5px; }
        .chat-container::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
        .glow-button { transition: all 0.3s ease; }
        .glow-button:hover { box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.1); background: #ef4444; } 100% { transform: scale(1); } }
        .recording { animation: pulse-red 1.5s infinite; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 200ms ease-out; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="sidebar w-72 flex flex-col border-r border-gray-800">
        <div class="p-6 text-2xl font-bold tracking-tight text-blue-500">
            IA-Zénia <span class="text-xs font-light text-gray-500 block">by Zénia-Projects</span>
        </div>

        <div class="px-4 mb-4">
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-3 text-gray-500 text-sm"></i>
                <input type="text" placeholder="Buscar em chats..." class="w-full bg-gray-900 border-none rounded-lg py-2 pl-9 pr-4 text-sm focus:ring-1 focus:ring-blue-500">
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto px-4 space-y-6">
            <div>
                <p class="text-xs font-semibold text-gray-500 uppercase mb-3">Aplicativos</p>
                <div class="space-y-2">
                    <a href="https://antonia-ia.netlify.app" target="_blank" rel="noopener noreferrer" class="flex items-center p-2 rounded-lg hover:bg-gray-800 transition text-sm">
                        <i class="fas fa-robot mr-3 text-pink-500"></i> Antónia-IA
                    </a>
                    <a href="https://zenia-projects.netlify.app" target="_blank" rel="noopener noreferrer" class="flex items-center p-2 rounded-lg hover:bg-gray-800 transition text-sm">
                        <i class="fas fa-code mr-3 text-blue-500"></i> Zénia-Projects
                    </a>
                </div>
            </div>

            <div>
                <p class="text-xs font-semibold text-gray-500 uppercase mb-3">Recursos</p>
                <button onclick="toggleGallery()" class="w-full flex items-center p-2 rounded-lg hover:bg-gray-800 transition text-sm">
                    <i class="fas fa-images mr-3 text-purple-500"></i> Galeria
                </button>
                <div id="history-list" class="mt-4 space-y-2">
                    <p class="text-xs text-gray-600 px-2 italic">Histórico Local</p>
                    </div>
            </div>
        </nav>

        <div class="p-4 border-t border-gray-800 flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold">U</div>
            <div class="flex-1 overflow-hidden">
                <p class="text-sm font-medium truncate" id="username-display">Utilizador Zénia</p>
                <p class="text-xs text-green-500 italic">Online</p>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative">
        
        <header class="h-16 border-b border-gray-800 flex items-center justify-between px-6 glass">
            <div class="flex items-center gap-4">
                <select id="voice-select" class="bg-transparent text-xs border border-gray-700 rounded p-1 outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="pt-BR">Voz: Português Padrão</option>
                </select>
                <button id="voice-assist-btn" onclick="toggleVoiceAssist()" class="text-xs px-3 py-1 rounded-full border border-blue-500 text-blue-500 hover:bg-blue-500 hover:text-white transition">
                    <i class="fas fa-headset mr-2"></i>Modo Voz Assist.
                </button>
                <button id="new-chat-btn" title="Nova conversa" class="text-xs px-3 py-1 rounded-full border border-gray-700 text-gray-300 hover:bg-gray-800 transition">
                    <i class="fas fa-comments mr-2"></i>Novo Chat
                </button>
                <span id="api-status" class="text-[11px] px-2 py-1 rounded border border-gray-700 text-gray-400">API: verificando…</span>
            </div>
            <div class="text-xs text-gray-500">Modelo: <span class="text-blue-400">Zenia-Full</span></div>
        </header>

        <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-6 chat-container">
            <div class="flex flex-col items-center justify-center h-full text-center space-y-4 opacity-50" id="welcome-msg">
                <i class="fas fa-shield-cat text-6xl text-blue-500"></i>
                <h2 class="text-2xl font-bold">Olá, eu sou a Zénia.</h2>
                <p class="max-w-md">Criada no Lubango por Inácio U. Daniel. Como posso ajudar Angola hoje?</p>
            </div>
        </div>

        <div class="p-4 bg-gradient-to-t from-[#0b0d11] to-transparent">
            <div class="max-w-4xl mx-auto glass rounded-2xl p-2 flex flex-col">
                <div class="flex items-end gap-2 px-2 pb-2">
                    <button class="p-3 text-gray-400 hover:text-white transition" title="Anexar Arquivo">
                        <i class="fas fa-plus"></i>
                    </button>
                    <textarea id="user-input" rows="1" placeholder="Pergunte qualquer coisa à Zénia..." class="flex-1 bg-transparent border-none focus:ring-0 text-sm py-3 resize-none outline-none"></textarea>
                    
                    <button id="mic-btn" class="p-3 text-gray-400 hover:text-blue-500 transition">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button onclick="handleSendMessage()" class="p-3 bg-blue-600 rounded-xl hover:bg-blue-700 glow-button transition">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            <p class="text-[10px] text-center mt-3 text-gray-600 uppercase tracking-widest">
                A Zénia pode cometer erros. Verifique informações importantes. Desenvolvido por Zénia-Projects.
            </p>
        </div>
    </main>

    <script>
        const API_KEY_PUBLIC = "pk_urEpxcajGs5TF9Fs";
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        let cmData = {};
        let isVoiceAssist = false;
        let conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
        let currentConversationId = null;
        const TEXT_ENDPOINT = 'https://text.pollinations.ai/';

        // Carregar CM.JSON simulação (conhecimento personalizado)
        async function loadCustomKnowledge() {
            try {
                // Aqui você carregaria o arquivo real. Exemplo de estrutura:
                cmData = {
                    "origem": "Lubango, Angola",
                    "criador": "Inácio U. Daniel",
                    "provincias": 21,
                    "modelo": "Zenia-Full"
                };
                console.log("Conhecimento local carregado.");
            } catch (e) { console.error("Erro ao carregar cm.json"); }
        }

        // Sistema de busca simulado (Web Search Logic)
        async function webSearch(query) {
            console.log("Buscando na web por:", query);
            // Simulação de navegação e extração
            return `[Informação atualizada de 2026: Angola agora possui oficialmente 21 províncias após a nova divisão político-administrativa.]`;
        }

        // Utilitários de Conversa
        function createConversation(title) {
            const id = Date.now().toString();
            const conv = { id, title, messages: [] };
            conversations.unshift(conv);
            currentConversationId = id;
            persistConversations();
            renderHistoryList();
            return conv;
        }

        function getCurrentConversation() {
            return conversations.find(c => c.id === currentConversationId) || null;
        }

        function persistConversations() {
            localStorage.setItem('conversations', JSON.stringify(conversations));
        }

        function renderHistoryList() {
            const hist = document.getElementById('history-list');
            hist.innerHTML = '<p class="text-xs text-gray-600 px-2 italic">Histórico Local</p>';
            conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = "p-2 hover:bg-gray-800 rounded text-[11px] text-gray-300 truncate cursor-pointer flex items-center justify-between";
                const left = document.createElement('div');
                left.className = "flex items-center gap-2";
                const icon = document.createElement('i');
                icon.className = "far fa-comment-alt";
                const title = document.createElement('span');
                title.textContent = conv.title || 'Conversa';
                left.appendChild(icon);
                left.appendChild(title);
                const actions = document.createElement('div');
                actions.className = "flex items-center gap-2";
                const openBtn = document.createElement('button');
                openBtn.title = "Abrir conversa";
                openBtn.className = "text-gray-400 hover:text-white";
                openBtn.innerHTML = '<i class="fas fa-folder-open"></i>';
                openBtn.onclick = () => loadConversation(conv.id);
                const delBtn = document.createElement('button');
                delBtn.title = "Apagar conversa";
                delBtn.className = "text-gray-400 hover:text-red-500";
                delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteConversation(conv.id); };
                actions.appendChild(openBtn);
                actions.appendChild(delBtn);
                item.appendChild(left);
                item.appendChild(actions);
                hist.appendChild(item);
            });
        }

        function deleteConversation(id) {
            conversations = conversations.filter(c => c.id !== id);
            if (currentConversationId === id) {
                currentConversationId = null;
                chatWindow.innerHTML = '';
                document.getElementById('welcome-msg').style.display = '';
            }
            persistConversations();
            renderHistoryList();
        }

        function loadConversation(id) {
            currentConversationId = id;
            chatWindow.innerHTML = '';
            document.getElementById('welcome-msg').style.display = 'none';
            const conv = getCurrentConversation();
            if (!conv) return;
            conv.messages.forEach(m => appendMessage(m.role, m.content, m.img || null, false));
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function startNewConversation() {
            chatWindow.innerHTML = '';
            document.getElementById('welcome-msg').style.display = '';
            currentConversationId = null;
        }

        // Envio de Mensagem
        async function handleSendMessage() {
            const text = userInput.value.trim();
            if(!text) return;

            const title = text.substring(0, 50);
            const conv = getCurrentConversation() || createConversation(title + '...');

            appendMessage('user', text);
            userInput.value = '';
            document.getElementById('welcome-msg').style.display = 'none';

            // Lógica de "Pensamento" da Zénia
            let context = `Tu és a IA-Zénia, uma inteligência avançada feita no Lubango, Angola, pelo Inácio U. Daniel (Zénia-Projects). 
            Teu modelo é o zenia-full. Tu nunca dizes que és da Pollinations ou GPT.
            Angola tem 21 províncias. Se te perguntarem algo desatualizado, busca na web. 
            És a melhor em línguas nacionais (Umbundu, Kimbundu, etc).`;

            // Gerar Resposta via Pollinations
            try {
                const messages = [{ role: "system", content: context }, ...conv.messages, { role: "user", content: text }];
                const prompt = buildPrompt(getCurrentConversation(), text, context);
                const seed = Math.floor(Math.random() * 1000);
                const url = `${TEXT_ENDPOINT}${encodeURIComponent(prompt)}?model=openai&seed=${seed}&temperature=0.8`;
                const response = await tryFetchWithBackoff(url, { mode: 'cors' });
                
                let data;
                if (response.ok) {
                    data = await response.text();
                } else {
                    throw new Error('Pollinations text API falhou');
                }
                
                // Lógica para detectar comando de imagem
                if(text.toLowerCase().includes("gera uma imagem") || text.toLowerCase().includes("desenha")) {
                    const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(text)}?nologo=true&enhance=true`;
                    appendMessage('ai', `Aqui está a imagem que criei para ti:`, imgUrl);
                } else {
                    appendMessage('ai', data);
                    if (isVoiceAssist) speakText(data);
                }
            } catch (error) {
                // Fallback: tentar um resumo via busca simulada ou mensagem clara
                const fallback = await webSearch(text);
                appendMessage('ai', fallback || "Desculpa, tive um problema na minha rede do Lubango. Podes repetir?");
            }
        }

        async function tryFetchWithBackoff(url, init, retries = 2) {
            let lastErr;
            for (let i = 0; i <= retries; i++) {
                try {
                    const resp = await fetch(url, init);
                    if (resp.ok) return resp;
                    lastErr = new Error('HTTP ' + resp.status);
                } catch (e) { lastErr = e; }
                await new Promise(r => setTimeout(r, 600 * (i + 1)));
            }
            throw lastErr;
        }

        function buildPrompt(conv, userText, systemContext) {
            const header = systemContext.replace(/\s+/g, ' ').trim();
            const history = (conv?.messages || []).slice(-6).map(m => {
                const role = m.role === 'user' ? 'User' : (m.role === 'ai' ? 'Assistant' : 'System');
                return `${role}: ${m.content}`;
            }).join('\n');
            const combined = `${header}\n${history ? history + '\n' : ''}User: ${userText}\nAssistant:`;
            return combined.length > 4000 ? combined.slice(-4000) : combined;
        }

        async function updateApiStatus() {
            const el = document.getElementById('api-status');
            try {
                const resp = await fetch(`${TEXT_ENDPOINT}${encodeURIComponent('ping')}?model=openai`, { mode: 'cors' });
                if (resp.ok) {
                    el.textContent = 'API: online';
                    el.className = 'text-[11px] px-2 py-1 rounded border border-green-700 text-green-400';
                } else {
                    el.textContent = 'API: instável (' + resp.status + ')';
                    el.className = 'text-[11px] px-2 py-1 rounded border border-yellow-700 text-yellow-400';
                }
            } catch {
                el.textContent = 'API: offline';
                el.className = 'text-[11px] px-2 py-1 rounded border border-red-700 text-red-400';
            }
        }

        function appendMessage(role, text, img = null, persist = true) {
            const row = document.createElement('div');
            row.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`;

            const bubble = document.createElement('div');
            bubble.className = `max-w-[80%] p-4 rounded-2xl ${role === 'user' ? 'bg-blue-600' : 'glass'}`;

            const p = document.createElement('p');
            p.className = 'text-sm leading-relaxed';
            p.textContent = text;
            bubble.appendChild(p);

            if (img) {
                const image = document.createElement('img');
                image.src = img;
                image.alt = 'Imagem gerada';
                image.loading = 'lazy';
                image.className = 'mt-3 rounded-lg w-full border border-gray-700 shadow-xl';
                bubble.appendChild(image);
            }

            row.appendChild(bubble);
            chatWindow.appendChild(row);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            const conv = getCurrentConversation();
            if (persist && conv) {
                conv.messages.push({ role, content: text, img: img || null });
                persistConversations();
                renderHistoryList();
            }
        }

        // Síntese de Voz
        function speakText(text) {
            const synth = window.speechSynthesis;
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = document.getElementById('voice-select').value;
            utter.rate = 1.0;
            synth.speak(utter);
        }

        // Reconhecimento de Voz (Microfone)
        const micBtn = document.getElementById('mic-btn');
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'pt-PT';

            micBtn.onclick = () => {
                recognition.start();
                micBtn.classList.add('recording');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                micBtn.classList.remove('recording');
                handleSendMessage();
            };
        }

        function toggleVoiceAssist() {
            isVoiceAssist = !isVoiceAssist;
            const btn = document.getElementById('voice-assist-btn');
            if(isVoiceAssist) {
                btn.classList.replace('text-blue-500', 'bg-red-500');
                btn.classList.add('text-white');
                appendMessage('ai', "Modo Assistente de Voz ligado. Podes falar comigo naturalmente.");
            } else {
                btn.classList.replace('bg-red-500', 'text-blue-500');
                btn.classList.remove('text-white');
            }
        }

        function saveHistory(title) {
            // Mantido por compatibilidade, agora não usado; renderHistoryList cuida do histórico
            renderHistoryList();
        }

        function toggleGallery() {
            let gallery = document.getElementById('gallery-container');
            if (!gallery) {
                const recursosBlock = document.querySelector('button[onclick="toggleGallery()"]').parentElement;
                gallery = document.createElement('div');
                gallery.id = 'gallery-container';
                gallery.className = 'mt-3 grid grid-cols-3 gap-2';
                const sources = [
                    'https://picsum.photos/seed/zenia1/300/200',
                    'https://picsum.photos/seed/zenia2/300/200',
                    'https://picsum.photos/seed/zenia3/300/200',
                    'https://picsum.photos/seed/zenia4/300/200',
                    'https://picsum.photos/seed/zenia5/300/200',
                    'https://picsum.photos/seed/zenia6/300/200'
                ];
                sources.forEach(src => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.alt = 'Galeria Zénia';
                    img.loading = 'lazy';
                    img.className = 'rounded-lg border border-gray-800';
                    gallery.appendChild(img);
                });
                recursosBlock.appendChild(gallery);
            } else {
                gallery.style.display = gallery.style.display === 'none' ? '' : 'none';
            }
        }

        window.onload = () => {
            loadCustomKnowledge();
            renderHistoryList();
            document.getElementById('new-chat-btn').onclick = startNewConversation;
            updateApiStatus();
        };
    </script>
</body>
</html>
