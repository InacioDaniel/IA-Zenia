<!DOCTYPE html>
<html lang="pt-AO">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>IA-Z√©nia by Z√©nia-Projects</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
/* =========================================
   TEMA BLUE FUTURISTA - VARI√ÅVEIS
========================================= */
:root {
    --accent: #00eaff;        
    --accent-alt: #0066ff;    
    --bg: #020617;            
    --panel: #0b1124;         
    --border: #1e3a8a;        
    --text-light: #e0f2fe;    
    --text-dark: #020617;     
    --neon-glow: 0 0 15px rgba(0, 234, 255, 0.6), 0 0 30px rgba(0, 102, 255, 0.4);
}

.text-blue-500 { color: var(--accent) !important; }
.text-red-500 { color: #ff3366 !important; }
.border-zinc-800 { border-color: var(--border) !important; }
.bg-black\/30 { background-color: rgba(2, 6, 23, 0.5) !important; }

body { 
    background: linear-gradient(135deg, var(--bg) 0%, #000000 100%); 
    color: var(--text-light); 
    font-family: 'Plus Jakarta Sans', sans-serif; 
    margin: 0; height: 100vh; display: flex; overflow: hidden; 
}

/* SIDEBAR */
.sidebar { 
    width: 280px; 
    background: linear-gradient(to bottom, var(--panel), var(--bg));
    border-right: 1px solid var(--border); 
    display: flex; flex-direction: column; transition: .3s; 
    box-shadow: 5px 0 15px rgba(0, 102, 255, 0.1);
    z-index: 100;
}
@media(max-width:768px){ 
    .sidebar{position:fixed;left:-100%;top:0;height:100%; width: 85%; max-width: 300px; box-shadow: 10px 0 50px rgba(0,0,0,0.8);} 
    .sidebar.active{left:0;} 
    .sidebar-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); backdrop-filter: blur(3px);
        z-index: 90; display: none; opacity: 0; transition: opacity .3s;
    }
    .sidebar-overlay.active { display: block; opacity: 1; }
}

.main-content { flex:1; display:flex; flex-direction:column; overflow:hidden; width:100%; position: relative; }

/* CHAT AREA */
.chat-container { 
    flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; 
    background: radial-gradient(circle at center, #0b1124 0%, var(--bg) 70%);
}

/* HISTORY ITEMS */
.hist-item { 
    padding: 12px; border-radius: 12px; background: rgba(11, 17, 36, 0.6); margin-bottom: 10px; cursor: pointer; 
    border: 1px solid var(--border); font-size: 13px; display: flex; justify-content: space-between; align-items: center; transition: all .3s ease; 
}
.hist-item:hover { 
    border-color: var(--accent); 
    background: linear-gradient(to right, rgba(0, 234, 255, 0.1), rgba(0, 102, 255, 0.2));
    box-shadow: 0 0 15px rgba(0, 234, 255, 0.2);
    transform: translateX(2px);
}
.hist-item.active { 
    border-color: var(--accent-alt); 
    background: linear-gradient(to right, rgba(0, 102, 255, 0.3), rgba(11, 17, 36, 0.8));
    box-shadow: var(--neon-glow); 
}
.hist-item button { color: #666; transition: .2s; }
.hist-item button:hover { color: #ff3366; }

/* BUTTONS */
.btn-new { 
    background: linear-gradient(135deg, var(--accent), var(--accent-alt)); 
    color: #fff; 
    padding: 12px; border-radius: 12px; font-weight: 800; text-align: center; margin-bottom: 20px; cursor: pointer; transition: .3s; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    box-shadow: 0 4px 15px rgba(0, 102, 255, 0.3);
}
.btn-new:hover { transform: translateY(-2px) scale(1.02); box-shadow: var(--neon-glow); }

.btn-close-sidebar {
    display: none;
    margin-bottom: 15px; padding: 10px; 
    background: rgba(255, 51, 102, 0.2); border: 1px solid #ff3366; 
    color: #ff3366; font-weight: bold; border-radius: 8px; text-align: center; cursor: pointer;
}
@media(max-width:768px){ .btn-close-sidebar{display:block;} }

/* MESSAGES */
.msg-wrapper { display:flex; flex-direction:column; max-width:90%; gap:5px; position:relative; animation:fadeIn .3s ease; }
.msg { 
    padding: 15px; border-radius: 18px; line-height: 1.6; font-size: 14px; word-wrap: break-word; transition: .3s;
    backdrop-filter: blur(5px);
}
.ai-msg { 
    align-self: flex-start; 
    border: 1px solid var(--border);
    border-left: 4px solid var(--accent); 
    background: linear-gradient(135deg, var(--panel), rgba(2, 6, 23, 0.8));
    color: var(--text-light); 
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}
.user-msg { 
    align-self: flex-end; 
    background: linear-gradient(135deg, var(--accent-alt), var(--accent)); 
    color: #fff; 
    border: none; 
    box-shadow: 0 5px 15px rgba(0, 102, 255, 0.4);
}
.msg-controls { display:flex; gap:12px; margin-top:4px; padding:0 10px; font-size:11px; color:#64748b; }
.ctrl-btn { cursor:pointer; transition:.2s; } .ctrl-btn:hover { color:var(--accent); }

/* CODE BLOCKS */
.code-container { border-radius:12px; overflow:hidden; margin:15px 0; border:1px solid var(--border); background: #000; width:100%; box-shadow: 0 0 20px rgba(0, 102, 255, 0.1); }
.code-header { background: var(--panel); padding:8px 15px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); }
.code-header span { color: var(--accent) !important; }
.btn-action { font-size:10px; font-weight:bold; padding:4px 8px; border-radius:6px; background: rgba(0, 102, 255, 0.2); color: var(--accent); border:1px solid var(--border); cursor:pointer; transition:.2s; }
.btn-action:hover { background: var(--accent); color: var(--text-dark); box-shadow: var(--neon-glow); }

/* INPUT AREA - REESTRUTURADO */
.footer-input { 
    background: linear-gradient(to top, var(--bg) 0%, rgba(11, 17, 36, 0.95) 100%);
    padding: env(safe-area-inset-bottom, 10px) 10px 10px 10px; 
    border-top: 1px solid var(--border); 
}
.footer-input-inner { 
    max-width: 860px; margin: 0 auto; 
    background: rgba(11, 17, 36, 0.5);
    border-radius: 20px; padding: 8px; 
    border: 1px solid var(--border); 
    display: flex; flex-direction: column; gap: 8px; 
    backdrop-filter: blur(10px);
    box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
}

.voice-bar { display:flex; align-items:center; gap:8px; padding:6px 10px; background: rgba(2, 6, 23, 0.6); border-radius:12px; border:1px solid var(--border); width:100%; box-sizing:border-box; }
.voice-bar select { background: transparent; color: var(--accent); border: none; font-size: 12px; outline: none; cursor: pointer; flex: 1; }
.voice-bar select option { background: var(--panel); color: var(--text-light); }
.voice-bar label { font-size: 11px; color: #64748b; white-space: nowrap; }

/* LINHA DE INPUT E BOT√ïES */
.input-row { display: flex; gap: 8px; width: 100%; align-items: flex-end; }

textarea { 
    flex:1; min-width:0; 
    background:transparent; border:none; outline:none; 
    color:var(--text-light); font-size:15px; 
    padding:10px; max-height:120px; resize:none; 
    font-family:inherit; 
}
textarea::placeholder { color: #475569; }

/* Bot√µes de A√ß√£o */
button.action-btn { 
    width: 44px; height: 44px;
    border-radius: 12px; font-weight: bold; transition: .3s; 
    border: none; cursor: pointer; font-size: 18px; 
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
}
/* Bot√£o Enviar */
button.send-btn {
    background: linear-gradient(135deg, var(--accent), var(--accent-alt)); 
    color: #fff; 
    box-shadow: 0 0 10px rgba(0, 234, 255, 0.3);
}
button.send-btn:hover { transform: scale(1.05); box-shadow: var(--neon-glow); }

/* Bot√£o Upload Imagem */
button.upload-btn {
    background: rgba(255, 255, 255, 0.1);
    color: var(--accent);
    border: 1px solid var(--border);
    position: relative;
}
button.upload-btn:hover { background: rgba(0, 234, 255, 0.1); border-color: var(--accent); }
/* Indicador de imagem carregada */
.img-badge { position: absolute; top: -5px; right: -5px; width: 12px; height: 12px; background: #00ffe7; border-radius: 50%; border: 2px solid #000; display: none; }

/* PREVIEW DA IMAGEM NO CHAT */
.img-preview-msg { max-width: 200px; border-radius: 12px; border: 1px solid var(--border); margin-top: 5px; display: block; }

/* IMAGE LOADER & ART */
.img-loader { width:100%; aspect-ratio:1/1; background: linear-gradient(90deg, var(--panel) 25%, var(--border) 50%, var(--panel) 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; color: var(--accent); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
.art-img { border-radius:12px; border:1px solid var(--border); margin:10px 0; max-width:100%; box-shadow: 0 0 30px rgba(0, 102, 255, 0.2); display:none; }

/* AUDIO PLAYER */
.audio-player { 
    display: flex; align-items: center; gap: 10px; 
    background: linear-gradient(135deg, var(--panel), rgba(30, 58, 138, 0.3));
    border: 1px solid var(--border); 
    border-radius: 14px; padding: 12px 14px; margin: 8px 0; width: 100%; box-sizing: border-box; 
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}
.audio-player .play-btn { 
    width: 40px; height: 40px; border-radius: 50%; 
    background: linear-gradient(135deg, var(--accent), var(--accent-alt)); 
    border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 17px; 
    color: #fff; transition: .2s; flex-shrink: 0; box-shadow: 0 0 10px rgba(0, 234, 255, 0.4);
}
.audio-player .audio-info { min-width: 0; flex-shrink: 1; max-width: 140px; }
.audio-player .audio-label { font-size: 12px; color: var(--accent); font-weight: 600; }
.audio-player .audio-voice { font-size: 10px; color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.audio-player .progress-wrap { flex: 1; display: flex; flex-direction: column; gap: 4px; min-width: 0; }
.audio-player .audio-progress-bg { height: 4px; background: rgba(0,0,0,0.3); border-radius: 2px; position: relative; cursor: pointer; overflow: hidden; }
.audio-player .audio-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-alt)); border-radius: 2px; }
.audio-player .audio-time { font-size: 10px; color: #94a3b8; text-align: right; }
.audio-player .dl-btn { background: rgba(0, 102, 255, 0.1); border: 1px solid var(--border); color: var(--accent); border-radius: 8px; padding: 5px 9px; font-size: 11px; cursor: pointer; transition: .2s; white-space: nowrap; flex-shrink: 0; }

/* ANIMATIONS */
@keyframes fadeIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
@keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* RESPONSIVE FIXES */
@media(max-width:768px){
    .chat-container{padding:15px} .msg{font-size:14px}
    .footer-input-inner { gap: 6px; }
    .voice-bar { order: -1; } /* Voice bar no topo */
}
</style>
</head>
<body>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<aside class="sidebar p-4" id="sidebar">
    <button class="btn-close-sidebar" onclick="toggleSidebar()">‚úï FECHAR MENU</button>

    <div class="btn-new" onclick="startNewChat()">+ NOVA CONVERSA</div>
    <h2 class="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">Hist√≥rico Local</h2>
    <div id="historyList" class="flex-1 overflow-y-auto pr-1 custom-scrollbar"></div>
    <div class="mt-auto pt-4 border-t border-slate-800 space-y-2">
        <h2 class="text-[9px] font-bold text-slate-500 uppercase mb-2">Minhas Irm√£s</h2>
        <a href="https://zenia-projects.netlify.app" target="_blank" class="block text-xs text-blue-400 hover:text-blue-300 transition">üåê Zenia Projects</a>
        <a href="https://ia-zenia.netlify.app" target="_blank" class="block text-xs text-blue-400 hover:text-blue-300 transition">üåê IA-Z√©nia Web</a>
    </div>
</aside>

<main class="main-content">
    <header class="p-4 border-b border-slate-800 flex justify-between items-center bg-black/30 backdrop-blur-md z-10">
        <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="md:hidden text-white font-bold text-lg">‚ò∞</button>
            <h1 class="text-xl font-black italic tracking-wider">IA-Z√âNIA <span class="text-blue-500 text-xs font-normal" style="text-shadow: 0 0 10px rgba(0,234,255,0.5);">ALL.ANGOLA</span></h1>
        </div>
        <button onclick="clearAllData()" class="text-[10px] text-red-500 font-bold hover:underline tracking-wider transition hover:text-red-400">APAGAR TUDO</button>
    </header>

    <div id="chatBox" class="chat-container custom-scrollbar"></div>

    <div class="footer-input z-20">
        <div class="footer-input-inner">
            <div class="voice-bar">
                <label>üé§ Voz:</label>
                <select id="voiceSelect">
                    <option value="nova">Nova ‚Äì Bright</option>
                    <option value="alloy">Alloy ‚Äì Neutral</option>
                    <option value="echo">Echo ‚Äì Deep</option>
                    <option value="shimmer">Shimmer ‚Äì Soft</option>
                    <option value="native">üåê Voz Nativa (Offline)</option>
                </select>
            </div>
            
            <div class="input-row">
                <input type="file" id="imgUpload" accept="image/*" hidden onchange="handleImageUpload(this)">
                <button class="action-btn upload-btn" onclick="document.getElementById('imgUpload').click()" title="Carregar Imagem">
                    üìé
                    <span id="imgBadge" class="img-badge"></span>
                </button>
                
                <textarea id="userInput" placeholder="Escreva aqui..." oninput="autoGrow(this)"></textarea>
                
                <button class="action-btn send-btn" onclick="handleSend()">üöÄ</button>
            </div>
        </div>
    </div>
</main>

<div style="position:fixed;top:10px;right:15px;padding:8px 15px;background:rgba(2, 6, 23, 0.8);color:var(--accent);border:1px solid var(--accent);border-radius:20px;font-size:12px;font-weight:bold;backdrop-filter:blur(10px);box-shadow:0 0 20px rgba(0, 234, 255, 0.3);z-index:9999; letter-spacing: 1px;">
    üîµ <span id="viewsNumber">0</span> VISITANTES
</div>

<script>
/* ============================================================
   GLOBALS
============================================================ */
const chatBox     = document.getElementById('chatBox');
const historyList = document.getElementById('historyList');
const userInput   = document.getElementById('userInput');
const voiceSelect = document.getElementById('voiceSelect');
const sidebarOverlay = document.getElementById('sidebarOverlay');
const imgBadge    = document.getElementById('imgBadge');

let sessions        = JSON.parse(localStorage.getItem('zenia_sessions')||'[]');
let currentSessionId = null;
const codeStore     = new Map();
let  codeIdCounter  = 0;
let currentImageBase64 = null; // Armazena a imagem carregada

/* ============================================================
   SYSTEM PROMPT
============================================================ */
const ZENIA_SYSTEM = `Voc√™ √© IA-Z√âNIA do Lubango. Criada por @inacio.u.daniel fundador do z√©nia-projects.
1. Angola possui 21 prov√≠ncias.
2. Modo CRIADOR ativa-se com c√≥digo especial.
3. Se receber uma imagem, analise-a com detalhe e responda ao pedido do usu√°rio sobre ela.
4. Geras imagens ultra realistas se pedido.
5. Se o usu√°rio pedir m√∫sica, escreva letra de m√∫sica.`;

/* ============================================================
   DETECTION
============================================================ */
function isImageRequest(q){ return /desenha|gera\s*(uma\s*)?(imagem|arte|foto)/i.test(q); }
function isAudioRequest(q){ return /^(l√™\s+em\s+voz\s+alta|fala|diz|√°udio)/i.test(q); }
function isMusicRequest(q){ return /cria\s*(uma\s*)?(m√∫sica|canc√£o)|canta/i.test(q); }
function extractAudioText(q){ return q.trim().replace(/^(l√™\s+em\s+voz\s+alta|fala|diz|√°udio\s+de|audio\s+de|sintetiza|narrar|narra|read\s+aloud|say|speak|tts|text\s+to\s+speech)\s*[:\-]?\s*/i,'').trim(); }

/* ============================================================
   UTILS & SIDEBAR
============================================================ */
function toggleSidebar(){ 
    document.getElementById("sidebar").classList.toggle("active"); 
    sidebarOverlay.classList.toggle("active");
}
function autoGrow(el){ el.style.height="auto"; el.style.height=el.scrollHeight+"px"; }
function escapeHTML(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
function formatTime(s){ if(isNaN(s))return'0:00'; var m=Math.floor(s/60),sec=Math.floor(s%60); return m+':'+(sec<10?'0':'')+sec; }

// Visitor Counter
(function(){
    let v = localStorage.getItem("zenia_global_views");
    v = v ? parseInt(v)+1 : 1;
    localStorage.setItem("zenia_global_views", v);
    document.getElementById("viewsNumber").textContent = v;
})();

/* ============================================================
   SESSION
============================================================ */
function init(){
    renderHistory();
    sessions.length>0 ? loadSession(sessions[sessions.length-1].id) : startNewChat();
}

function startNewChat(){
    currentSessionId=Date.now(); chatBox.innerHTML='';
    addMessage("Onawa ! Sou a IA-Z√âNIA. Posso analisar imagens, criar m√∫sicas ou conversar. O que faremos?",false);
    renderHistory();
}

// Constr√≥i o hist√≥rico para a API (Formato OpenAI JSON)
function buildMessages(query, imageBase64){
    var s = sessions.find(x => x.id === currentSessionId);
    var msgs = [{role: "system", content: ZENIA_SYSTEM}];
    
    // Adiciona hist√≥rico recente (apenas texto para economizar)
    if(s) {
        s.messages.slice(-10).forEach(m => {
            msgs.push({role: m.role === 'user' ? 'user' : 'assistant', content: m.text});
        });
    }

    // Mensagem Atual
    var userContent = [{ type: "text", text: query }];
    if(imageBase64) {
        userContent.push({
            type: "image_url",
            image_url: { url: imageBase64 }
        });
    }

    msgs.push({ role: "user", content: userContent });
    return msgs;
}

function saveSession(q,a){
    var s=sessions.find(function(x){return x.id===currentSessionId});
    if(!s){ s={id:currentSessionId,title:q.substring(0,24)+'‚Ä¶',messages:[]}; sessions.push(s); }
    s.messages.push({role:'user',text:q},{role:'ai',text:a});
    localStorage.setItem('zenia_sessions',JSON.stringify(sessions));
    renderHistory();
}

function renderHistory(){
    historyList.innerHTML='';
    sessions.slice().reverse().forEach(function(s){
        var item=document.createElement('div');
        item.className='hist-item'+(s.id===currentSessionId?' active':'');
        item.innerHTML='<span>'+escapeHTML(s.title)+'</span><button onclick="deleteSession(event,'+s.id+')">‚ùå</button>';
        item.onclick=function(){ loadSession(s.id); };
        historyList.appendChild(item);
    });
}

function loadSession(id){
    currentSessionId=id;
    var s=sessions.find(function(x){return x.id===id});
    chatBox.innerHTML='';
    if(s) s.messages.forEach(function(m){
        if(m.role==='ai'){
            // Processa respostas salvas
            if(m.text.includes('[IMAGEM:')){ var url=m.text.match(/\[IMAGEM: (.*?)\]/)[1]; processResponse('![ARTE]('+url+')',""); }
            else processResponse(m.text,"");
        } else {
            // Se tiver imagem na msg do usuario
            if(m.text.startsWith('[IMG]')) {
                 addMessage("üìé [Imagem Enviada Anteriormente]", true);
            } else {
                 addMessage(m.text,true);
            }
        }
    });
    renderHistory();
}

function deleteSession(e,id){ e.stopPropagation(); sessions=sessions.filter(function(s){return s.id!==id}); localStorage.setItem('zenia_sessions',JSON.stringify(sessions)); startNewChat(); }
function clearAllData(){ if(confirm("Limpar tudo?")){ localStorage.clear(); location.reload(); } }

/* ============================================================
   IMAGE UPLOAD LOGIC
============================================================ */
function handleImageUpload(input){
    if(input.files && input.files[0]){
        var reader = new FileReader();
        reader.onload = function(e){
            currentImageBase64 = e.target.result;
            imgBadge.style.display = 'block'; // Mostra bolinha verde
            userInput.placeholder = "Imagem carregada! Descreva o que quer saber sobre ela...";
        }
        reader.readAsDataURL(input.files[0]);
    }
}

/* ============================================================
   HANDLE SEND ‚Äî PRINCIPAL (AGORA COM POST API)
============================================================ */
async function handleSend(textOverride){
    var query=(textOverride||userInput.value).trim();
    if(!query && !currentImageBase64) return;

    // 1. UI: Mostrar Mensagem do Usu√°rio
    var userMsgWrapper = document.createElement('div');
    userMsgWrapper.className = 'msg-wrapper user-wrapper';
    var contentHTML = escapeHTML(query);
    
    if(currentImageBase64) {
        contentHTML += `<br><img src="${currentImageBase64}" class="img-preview-msg">`;
        userInput.placeholder = "Escreva aqui...";
        imgBadge.style.display = 'none';
    }
    userMsgWrapper.innerHTML = `<div class="msg user-msg">${contentHTML}</div>`;
    chatBox.appendChild(userMsgWrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
    
    userInput.value=''; userInput.style.height='auto';

    // 2. Comandos Especiais (M√∫sica, √Åudio, Imagem Gerada)
    if(isMusicRequest(query)){ /* ... (Mesma l√≥gica de antes, abreviada para focar na API) ... */ 
        callMusicAPI(query); return; 
    }
    if(isImageRequest(query)){
        var loadI=addMessage("üé® Z√©nia est√° a pintar‚Ä¶",false);
        var seed = Math.floor(Math.random()*99999);
        var imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(query)}?width=1024&height=1024&seed=${seed}&nologo=true&model=flux`;
        loadI.remove();
        processResponse('![ARTE]('+imgUrl+')',query);
        return;
    }

    // 3. API POST (TEXTO + VIS√ÉO) - A GRANDE MUDAN√áA
    var loadT = addMessage("Z√©nia est√° a analisar...", false);
    
    try {
        var messages = buildMessages(query, currentImageBase64);
        
        // Usamos o endpoint POST da Pollinations (compat√≠vel com OpenAI) que √© Gr√°tis
        var response = await fetch('https://text.pollinations.ai/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                messages: messages,
                model: 'openai', // Pollinations encaminha para GPT-4o-mini ou similar com vis√£o
                jsonMode: false
            })
        });

        var data = await response.text(); // Pollinations retorna texto direto ou JSON stream
        // Limpeza b√°sica se vier JSON sujo
        if(data.startsWith('data: ')) data = data.replace(/data: /g, '');
        
        loadT.remove();
        processResponse(data, currentImageBase64 ? '[IMG] '+query : query);
        
        // Limpar imagem da mem√≥ria ap√≥s envio
        currentImageBase64 = null; 
        document.getElementById('imgUpload').value = ""; 

    } catch(e) {
        loadT.querySelector('.msg').innerText = '‚ö†Ô∏è Erro na conex√£o com a IA.';
        console.error(e);
    }
}

/* ============================================================
   AUXILIARY FUNCTIONS (Music, Audio)
============================================================ */
async function callMusicAPI(query){
    var loadM = addMessage("üéµ Criando letra...", false);
    try {
        var prompt = "Escreva uma letra de m√∫sica curta sobre: " + query;
        var res = await fetch('https://text.pollinations.ai/'+encodeURIComponent(prompt));
        var text = await res.text();
        loadM.remove();
        processResponse("üéµ **Letra:**\n" + text, query);
        var loadA = addMessage("üéµ Gravando...", false);
        await generateAudio(text, query, loadA, true);
    } catch(e) { loadM.innerText="Erro."; }
}

async function generateAudio(text, originalQuery, loadingWrapper, isMusic){
    var voice=voiceSelect.value;
    if(voice === 'native') {
        loadingWrapper.remove();
        speakNative(text, originalQuery);
        return;
    }
    var url=`https://text.pollinations.ai/${encodeURIComponent(text)}?model=openai-audio&voice=${voice}`;
    try{
        var res=await fetch(url);
        if(!res.ok) throw new Error('Busy');
        var blob=await res.blob();
        var objUrl=URL.createObjectURL(blob);
        loadingWrapper.remove();
        createAudioPlayer(objUrl, voice, text, originalQuery, isMusic);
    } catch(err){
        loadingWrapper.remove();
        speakNative(text, originalQuery);
    }
}

function speakNative(text, originalQuery){
    var u = new SpeechSynthesisUtterance(text);
    u.lang = 'pt-PT'; u.rate = 1.1;
    window.speechSynthesis.speak(u);
    // Placeholder visual simples
    var w = document.createElement('div'); w.className='msg-wrapper ai-wrapper';
    w.innerHTML='<div class="msg ai-msg">üîä (Voz Nativa)</div>';
    chatBox.appendChild(w);
}

function createAudioPlayer(src, voice, text, originalQuery, isMusic){
    var wrapper=document.createElement('div');
    wrapper.className='msg-wrapper ai-wrapper';
    var icon = isMusic ? 'üéµ' : 'üîä';
    var player=document.createElement('div');
    player.className='audio-player';
    if(isMusic) player.style.borderColor = 'var(--accent-alt)';
    player.innerHTML=
        '<button class="play-btn" onclick="this.parentElement.nextSibling.play()">‚ñ∂</button>'+
        '<div class="audio-info"><div class="audio-label">'+icon+' √Åudio</div></div>';
    wrapper.appendChild(player);
    var audio=document.createElement('audio');
    audio.src=src;
    wrapper.appendChild(audio);
    chatBox.appendChild(wrapper);
    chatBox.scrollTop=chatBox.scrollHeight;
}

/* ============================================================
   RENDER RESPONSE
============================================================ */
function processResponse(text,query){
    var wrapper=document.createElement('div');
    wrapper.className='msg-wrapper ai-wrapper';

    // Check Imagem Gerada
    var imgMatch=text.match(/!\[.*?\]\((.*?)\)/);
    if(imgMatch){
        var img=document.createElement('img');
        img.src=imgMatch[1]; img.className='art-img'; img.style.display='block';
        wrapper.appendChild(img);
        text=text.replace(imgMatch[0],'');
    }

    // Render Texto/Markdown
    var d=document.createElement('div');
    d.className='msg ai-msg';
    d.innerHTML=formatAI(escapeHTML(text));
    wrapper.appendChild(d);

    chatBox.appendChild(wrapper);
    if(query) saveSession(query, text+(imgMatch?' [IMAGEM: '+imgMatch[1]+']':''));
    chatBox.scrollTop=chatBox.scrollHeight;
}

function formatAI(t){ return t.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\n/g,'<br>'); }
function createCodeBlock(code,lang){ /* Simplificado para brevidade, usar o anterior se precisar destacar c√≥digo */ }

init();
</script>
</body>
</html>
