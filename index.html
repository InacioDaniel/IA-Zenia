<!DOCTYPE html>
<html lang="pt-PT" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA-Zénia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0b0d11; color: #e5e7eb; font-family: 'Inter', sans-serif; }
        .sidebar { background-color: #161b22; transition: all 0.3s ease; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .chat-container::-webkit-scrollbar { width: 5px; }
        .chat-container::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
        .glow-button { transition: all 0.3s ease; }
        .glow-button:hover { box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }

        /* CORRIGIDO: animação pulse-red corretamente nomeada */
        @keyframes pulse-red {
            0%   { transform: scale(1); background: transparent; }
            50%  { transform: scale(1.1); background: #ef4444; color: white; }
            100% { transform: scale(1); background: transparent; }
        }
        .recording { animation: pulse-red 1.5s infinite; border-radius: 9999px; }

        @keyframes fade-in { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 200ms ease-out; }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ADICIONADO: item do histórico com layout flex correto */
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        /* ADICIONADO: status badges */
        .status-ok   { color: #22c55e; border-color: #22c55e40; }
        .status-err  { color: #ef4444; border-color: #ef444440; }
        .status-wait { color: #9ca3af; border-color: #4b556340; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="sidebar w-72 flex flex-col border-r border-gray-800">
        <div class="p-6 text-2xl font-bold tracking-tight text-blue-500">
            IA-Zénia <span class="text-xs font-light text-gray-500 block">by Zénia-Projects</span>
        </div>

        <div class="px-4 mb-4">
            <button onclick="startNewConversation()" class="w-full bg-blue-600/10 hover:bg-blue-600/20 text-blue-500 border border-blue-500/30 rounded-lg py-2 text-sm font-medium transition flex items-center justify-center gap-2">
                <i class="fas fa-plus"></i> Novo Chat
            </button>
        </div>

        <div class="px-4 mb-4">
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-3 text-gray-500 text-sm"></i>
                <!-- CORRIGIDO: input de busca com outline correto -->
                <input id="search-input" type="text" placeholder="Buscar em chats..."
                    class="w-full bg-gray-900 border border-gray-700 rounded-lg py-2 pl-9 pr-4 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
                    oninput="filterHistory(this.value)">
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto px-4 space-y-6">
            <div>
                <p class="text-xs font-semibold text-gray-500 uppercase mb-3">Aplicativos</p>
                <div class="space-y-2">
                    <a href="https://antonia-ia.netlify.app" target="_blank" rel="noopener noreferrer"
                        class="flex items-center p-2 rounded-lg hover:bg-gray-800 transition text-sm">
                        <i class="fas fa-robot mr-3 text-pink-500"></i> Antónia-IA
                    </a>
                    <a href="https://zenia-projects.netlify.app" target="_blank" rel="noopener noreferrer"
                        class="flex items-center p-2 rounded-lg hover:bg-gray-800 transition text-sm">
                        <i class="fas fa-code mr-3 text-blue-500"></i> Zénia-Projects
                    </a>
                </div>
            </div>

            <div>
                <p class="text-xs font-semibold text-gray-500 uppercase mb-3">Recursos</p>
                <button onclick="toggleGallery()" class="w-full flex items-center p-2 rounded-lg hover:bg-gray-800 transition text-sm">
                    <i class="fas fa-images mr-3 text-purple-500"></i> Galeria
                </button>
                <div id="history-list" class="mt-4 space-y-1">
                    <p class="text-xs text-gray-600 px-2 italic">Histórico Local</p>
                </div>
            </div>
        </nav>

        <div class="p-4 border-t border-gray-800 flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold flex-shrink-0">U</div>
            <div class="flex-1 overflow-hidden">
                <p class="text-sm font-medium truncate" id="username-display">Utilizador Zénia</p>
                <p class="text-xs text-green-500 italic">Online</p>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden">

        <header class="h-16 border-b border-gray-800 flex items-center justify-between px-6 glass flex-shrink-0">
            <div class="flex items-center gap-4 flex-wrap">
                <!-- CORRIGIDO: select de voz populado dinamicamente via JS -->
                <select id="voice-select" class="bg-transparent text-xs border border-gray-700 rounded p-1 outline-none focus:ring-1 focus:ring-blue-500 max-w-[180px]">
                    <option value="">Voz padrão</option>
                </select>
                <button id="voice-assist-btn" onclick="toggleVoiceAssist()"
                    class="text-xs px-3 py-1 rounded-full border border-blue-500 text-blue-500 hover:bg-blue-500 hover:text-white transition">
                    <i class="fas fa-headset mr-2"></i>Modo Voz Assist.
                </button>
                <!-- CORRIGIDO: status com classes dinâmicas adequadas -->
                <span id="api-status" class="text-[11px] px-2 py-1 rounded border status-wait">API: verificando…</span>
            </div>
            <div class="text-xs text-gray-500 flex-shrink-0">Modelo: <span class="text-blue-400">Zenia-Full</span></div>
        </header>

        <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-6 chat-container">
            <div class="flex flex-col items-center justify-center h-full text-center space-y-4 opacity-50" id="welcome-msg">
                <i class="fas fa-shield-cat text-6xl text-blue-500"></i>
                <h2 class="text-2xl font-bold">Olá, eu sou a Zénia.</h2>
                <p class="max-w-md">Criada no Lubango por Inácio U. Daniel. Como posso ajudar Angola hoje?</p>
            </div>
        </div>

        <div class="p-4 bg-gradient-to-t from-[#0b0d11] to-transparent flex-shrink-0">
            <div class="max-w-4xl mx-auto glass rounded-2xl p-2 flex flex-col">
                <div class="flex items-end gap-2 px-2 pb-2">
                    <button class="p-3 text-gray-400 hover:text-white transition" title="Anexar Arquivo">
                        <i class="fas fa-plus"></i>
                    </button>
                    <!-- CORRIGIDO: textarea com auto-resize e Enter para enviar -->
                    <textarea id="user-input" rows="1"
                        placeholder="Pergunte qualquer coisa à Zénia..."
                        class="flex-1 bg-transparent border-none focus:ring-0 text-sm py-3 resize-none outline-none"
                        style="max-height: 120px; overflow-y: auto;"></textarea>

                    <button id="mic-btn" class="p-3 text-gray-400 hover:text-blue-500 transition" title="Microfone">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="send-btn" onclick="handleSendMessage()"
                        class="p-3 bg-blue-600 rounded-xl hover:bg-blue-700 glow-button transition min-w-[44px] flex items-center justify-center">
                        <i class="fas fa-paper-plane" id="send-icon"></i>
                    </button>
                </div>
            </div>
            <p class="text-[10px] text-center mt-3 text-gray-600 uppercase tracking-widest">
                A Zénia pode cometer erros. Verifique informações importantes. Desenvolvido por Zénia-Projects.
            </p>
        </div>
    </main>

    <script>
        // ─── CONFIGURAÇÃO ────────────────────────────────────────────────────────────
        const API_KEY       = "pk_urEpxcajGs5TF9Fs"; // Substitua pelo seu token secreto
        const CHAT_ENDPOINT = "https://gen.pollinations.ai/v1/chat/completions";

        // ─── ESTADO ──────────────────────────────────────────────────────────────────
        const chatWindow = document.getElementById('chat-window');
        const userInput  = document.getElementById('user-input');
        const sendBtn    = document.getElementById('send-btn');
        const sendIcon   = document.getElementById('send-icon');

        let isVoiceAssist        = false;
        let conversations        = JSON.parse(localStorage.getItem('conversations') || '[]');
        let currentConversationId = null;

        // ─── GESTÃO DE CONVERSAS ──────────────────────────────────────────────────────

        function createConversation(title) {
            const id   = Date.now().toString();
            const conv = { id, title, messages: [] };
            conversations.unshift(conv);
            currentConversationId = id;
            persistConversations();
            renderHistoryList();
            return conv;
        }

        function getCurrentConversation() {
            return conversations.find(c => c.id === currentConversationId) || null;
        }

        function persistConversations() {
            localStorage.setItem('conversations', JSON.stringify(conversations));
        }

        // CORRIGIDO: renderHistoryList com estrutura flex correta e sem bugs de layout
        function renderHistoryList(filter = '') {
            const hist = document.getElementById('history-list');
            hist.innerHTML = '<p class="text-xs text-gray-600 px-2 italic mb-1">Histórico Local</p>';

            const filtered = filter
                ? conversations.filter(c => c.title.toLowerCase().includes(filter.toLowerCase()))
                : conversations;

            if (filtered.length === 0) {
                const empty = document.createElement('p');
                empty.className = 'text-xs text-gray-600 px-2 italic';
                empty.textContent = filter ? 'Nenhum resultado.' : 'Sem conversas ainda.';
                hist.appendChild(empty);
                return;
            }

            filtered.forEach(conv => {
                const isActive = conv.id === currentConversationId;

                const item = document.createElement('div');
                item.className = [
                    'history-item p-2 rounded-lg cursor-pointer text-[11px] text-gray-300',
                    'hover:bg-gray-800 transition',
                    isActive ? 'bg-gray-800/60 border-l-2 border-blue-500 text-blue-400' : ''
                ].join(' ');

                // Parte esquerda: ícone + título
                const left = document.createElement('div');
                left.className = 'flex items-center gap-2 overflow-hidden flex-1';
                left.onclick = () => loadConversation(conv.id);

                const icon = document.createElement('i');
                icon.className = 'far fa-comment-alt flex-shrink-0 text-gray-500';

                const title = document.createElement('span');
                title.className = 'truncate';
                title.textContent = conv.title || 'Conversa';

                left.appendChild(icon);
                left.appendChild(title);

                // Botão de apagar
                const delBtn = document.createElement('button');
                delBtn.title = 'Apagar conversa';
                delBtn.className = 'text-gray-600 hover:text-red-500 transition flex-shrink-0';
                delBtn.innerHTML = '<i class="fas fa-trash text-xs"></i>';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteConversation(conv.id);
                };

                item.appendChild(left);
                item.appendChild(delBtn);
                hist.appendChild(item);
            });
        }

        // ADICIONADO: função de filtro chamada pelo input de busca
        function filterHistory(value) {
            renderHistoryList(value);
        }

        function deleteConversation(id) {
            conversations = conversations.filter(c => c.id !== id);
            persistConversations();
            if (currentConversationId === id) {
                startNewConversation();
            } else {
                renderHistoryList();
            }
        }

        function loadConversation(id) {
            currentConversationId = id;
            chatWindow.innerHTML = '';
            const welcomeMsg = document.getElementById('welcome-msg');
            if (welcomeMsg) welcomeMsg.style.display = 'none';

            const conv = getCurrentConversation();
            if (!conv) return;

            conv.messages.forEach(m => {
                if (m.role !== 'system') {
                    renderMessageUI(m.role === 'user' ? 'user' : 'ai', m.content, m.img || null);
                }
            });

            renderHistoryList();
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function startNewConversation() {
            chatWindow.innerHTML = '';
            // Recria a mensagem de boas-vindas se necessário
            let welcomeMsg = document.getElementById('welcome-msg');
            if (!welcomeMsg) {
                welcomeMsg = document.createElement('div');
                welcomeMsg.id = 'welcome-msg';
                welcomeMsg.className = 'flex flex-col items-center justify-center h-full text-center space-y-4 opacity-50';
                welcomeMsg.innerHTML = `
                    <i class="fas fa-shield-cat text-6xl text-blue-500"></i>
                    <h2 class="text-2xl font-bold">Olá, eu sou a Zénia.</h2>
                    <p class="max-w-md">Criada no Lubango por Inácio U. Daniel. Como posso ajudar Angola hoje?</p>
                `;
                chatWindow.appendChild(welcomeMsg);
            } else {
                welcomeMsg.style.display = 'flex';
            }

            currentConversationId = null;
            renderHistoryList();
        }

        // ─── ENVIO DE MENSAGEM ────────────────────────────────────────────────────────

        async function handleSendMessage() {
            const text = userInput.value.trim();
            if (!text || sendBtn.disabled) return;

            let conv = getCurrentConversation();
            if (!conv) {
                conv = createConversation(text.substring(0, 35) + (text.length > 35 ? '…' : ''));
            }

            // Esconde boas-vindas
            const welcomeMsg = document.getElementById('welcome-msg');
            if (welcomeMsg) welcomeMsg.style.display = 'none';

            renderMessageUI('user', text);
            userInput.value = '';
            autoResize(userInput);
            setLoading(true);

            const systemMsg = {
                role: "system",
                content: "Tu és a IA-Zénia, uma inteligência avançada feita no Lubango, Angola, pelo Inácio U. Daniel (Zénia-Projects). Teu modelo é o zenia-full. Angola tem 21 províncias. És especialista em línguas nacionais angolanas."
            };

            const messages = [systemMsg, ...conv.messages, { role: "user", content: text }];

            try {
                const response = await fetch(CHAT_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        messages,
                        model: "openai",
                        modalities: ["text"],
                        max_tokens: 1200,
                        temperature: 1,
                        top_p: 1,
                        stream: false,
                        frequency_penalty: 0,
                        presence_penalty: 0,
                        response_format: { type: "text" },
                        seed: -1,
                        stop: "",
                        tools: [],
                        function_call: "none",
                        functions: []
                    })
                });

                if (!response.ok) {
                    const errBody = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText}. ${errBody}`);
                }

                const data = await response.json();

                // CORRIGIDO: verificação defensiva da resposta
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error("Resposta da API em formato inesperado.");
                }

                const aiResponse = data.choices[0].message.content;

                conv.messages.push({ role: "user", content: text });
                conv.messages.push({ role: "assistant", content: aiResponse });
                persistConversations();

                renderMessageUI('ai', aiResponse);
                if (isVoiceAssist) speakText(aiResponse);

                // Atualiza status como OK após sucesso
                setApiStatus('ok');

            } catch (error) {
                console.error("Erro na API:", error);
                renderMessageUI('ai', `⚠️ Erro ao comunicar com a IA: ${error.message}. Tente novamente.`);
                setApiStatus('error');
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            sendBtn.disabled = isLoading;
            if (isLoading) {
                sendIcon.className = 'loading-spinner';
            } else {
                sendIcon.className = 'fas fa-paper-plane';
            }
        }

        function renderMessageUI(role, text, img = null) {
            const row = document.createElement('div');
            row.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`;

            const bubble = document.createElement('div');
            bubble.className = `max-w-[80%] p-4 rounded-2xl text-sm leading-relaxed ${role === 'user' ? 'bg-blue-600' : 'glass'}`;
            // CORRIGIDO: preserva quebras de linha nas mensagens
            bubble.style.whiteSpace = 'pre-wrap';
            bubble.style.wordBreak = 'break-word';
            bubble.textContent = text;

            if (img) {
                const image = document.createElement('img');
                image.src = img;
                image.alt = 'Imagem gerada';
                image.loading = 'lazy';
                image.className = 'mt-3 rounded-lg w-full border border-gray-700 shadow-xl';
                bubble.appendChild(image);
            }

            row.appendChild(bubble);
            chatWindow.appendChild(row);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // ─── SÍNTESE DE VOZ ───────────────────────────────────────────────────────────

        // CORRIGIDO: populamos as vozes do sistema no select
        function populateVoices() {
            const sel = document.getElementById('voice-select');
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) return;

            sel.innerHTML = '';
            voices.forEach((v, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = `${v.name} (${v.lang})`;
                if (v.lang.startsWith('pt')) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        if (typeof speechSynthesis !== 'undefined') {
            speechSynthesis.onvoiceschanged = populateVoices;
            populateVoices();
        }

        function speakText(text) {
            if (typeof speechSynthesis === 'undefined') return;
            speechSynthesis.cancel(); // Para fala anterior se houver

            const utter = new SpeechSynthesisUtterance(text);
            const voices = speechSynthesis.getVoices();
            const selIdx = parseInt(document.getElementById('voice-select').value);

            if (!isNaN(selIdx) && voices[selIdx]) {
                utter.voice = voices[selIdx];
                utter.lang  = voices[selIdx].lang;
            } else {
                utter.lang = 'pt-PT';
            }

            utter.rate = 1.0;
            utter.pitch = 1.0;
            speechSynthesis.speak(utter);
        }

        // ─── RECONHECIMENTO DE VOZ ────────────────────────────────────────────────────

        const micBtn = document.getElementById('mic-btn');

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'pt-PT';

            let isListening = false;

            micBtn.onclick = () => {
                if (isListening) {
                    recognition.stop();
                    return;
                }
                try {
                    recognition.start();
                    isListening = true;
                    micBtn.classList.add('recording');
                    micBtn.title = 'A ouvir... (clique para parar)';
                } catch (e) {
                    console.warn("Erro ao iniciar reconhecimento:", e);
                }
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                autoResize(userInput);
                isListening = false;
                micBtn.classList.remove('recording');
                micBtn.title = 'Microfone';
                handleSendMessage();
            };

            // CORRIGIDO: handler de erro no reconhecimento de voz
            recognition.onerror = (event) => {
                console.warn("Erro no reconhecimento de voz:", event.error);
                isListening = false;
                micBtn.classList.remove('recording');
                micBtn.title = 'Microfone';
                if (event.error !== 'no-speech') {
                    renderMessageUI('ai', `⚠️ Erro no microfone: ${event.error}. Verifique as permissões do browser.`);
                }
            };

            recognition.onend = () => {
                isListening = false;
                micBtn.classList.remove('recording');
                micBtn.title = 'Microfone';
            };
        } else {
            micBtn.disabled = true;
            micBtn.title = 'Reconhecimento de voz não suportado neste browser';
            micBtn.classList.add('opacity-30', 'cursor-not-allowed');
        }

        // ─── MODO ASSISTENTE DE VOZ ───────────────────────────────────────────────────

        // CORRIGIDO: toggleVoiceAssist usando classList.toggle de forma segura
        function toggleVoiceAssist() {
            isVoiceAssist = !isVoiceAssist;
            const btn = document.getElementById('voice-assist-btn');

            if (isVoiceAssist) {
                btn.classList.remove('text-blue-500', 'border-blue-500', 'hover:bg-blue-500', 'hover:text-white');
                btn.classList.add('bg-red-600', 'text-white', 'border-red-600');
                renderMessageUI('ai', "Modo Assistente de Voz ligado. Podes falar comigo naturalmente.");
            } else {
                btn.classList.remove('bg-red-600', 'border-red-600');
                btn.classList.add('text-blue-500', 'border-blue-500', 'hover:bg-blue-500', 'hover:text-white');
                speechSynthesis.cancel();
            }
        }

        // ─── GALERIA ──────────────────────────────────────────────────────────────────

        function toggleGallery() {
            let gallery = document.getElementById('gallery-container');
            if (!gallery) {
                const recursos = document.querySelector('button[onclick="toggleGallery()"]').parentElement;
                gallery = document.createElement('div');
                gallery.id = 'gallery-container';
                gallery.className = 'mt-3 grid grid-cols-3 gap-2';

                const seeds = ['zenia1','zenia2','zenia3','zenia4','zenia5','zenia6'];
                seeds.forEach(seed => {
                    const img = document.createElement('img');
                    img.src = `https://picsum.photos/seed/${seed}/300/200`;
                    img.alt = 'Galeria Zénia';
                    img.loading = 'lazy';
                    img.className = 'rounded-lg border border-gray-800 hover:opacity-80 transition cursor-pointer';
                    gallery.appendChild(img);
                });
                recursos.appendChild(gallery);
            } else {
                gallery.style.display = gallery.style.display === 'none' ? '' : 'none';
            }
        }

        // ─── STATUS DA API ────────────────────────────────────────────────────────────

        // CORRIGIDO: updateApiStatus agora existe e funciona corretamente
        function setApiStatus(state) {
            const el = document.getElementById('api-status');
            el.className = 'text-[11px] px-2 py-1 rounded border';
            if (state === 'ok') {
                el.classList.add('status-ok');
                el.textContent = 'API: ativa ✓';
            } else if (state === 'error') {
                el.classList.add('status-err');
                el.textContent = 'API: erro ✗';
            } else {
                el.classList.add('status-wait');
                el.textContent = 'API: verificando…';
            }
        }

        async function updateApiStatus() {
            setApiStatus('wait');
            try {
                const response = await fetch(CHAT_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        messages: [{ role: "user", content: "ping" }],
                        model: "openai",
                        max_tokens: 5,
                        temperature: 0
                    })
                });
                setApiStatus(response.ok ? 'ok' : 'error');
            } catch {
                setApiStatus('error');
            }
        }

        // ─── TEXTAREA AUTO-RESIZE ─────────────────────────────────────────────────────

        // ADICIONADO: auto-resize do textarea ao digitar
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }

        userInput.addEventListener('input', () => autoResize(userInput));

        // CORRIGIDO: Enter para enviar (Shift+Enter para nova linha)
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });

        // ─── INICIALIZAÇÃO ────────────────────────────────────────────────────────────

        window.onload = () => {
            renderHistoryList();
            if (conversations.length > 0) {
                loadConversation(conversations[0].id);
            }
            updateApiStatus();
            setInterval(updateApiStatus, 30000);
        };
    </script>
</body>
</html>
