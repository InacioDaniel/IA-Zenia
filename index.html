<!DOCTYPE html>
<html lang="pt-PT" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA-Zénia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos omitidos para brevidade */
    </style>
</head>
<body class="flex h-screen overflow-hidden">
    <!-- Sidebar e Conteúdo omitidos para brevidade -->
    <script>
        const API_KEY = "pk_urEpxcajGs5TF9Fs";
        const CHAT_ENDPOINT = "https://enter.pollinations.ai/v1/chat/completions"; // Endpoint atualizado
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const sendIcon = document.getElementById('send-icon');
        let isVoiceAssist = false;
        let conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
        let currentConversationId = null;

        // Gestão de Conversas
        function createConversation(title) {
            const id = Date.now().toString();
            const conv = { id, title, messages: [] };
            conversations.unshift(conv);
            currentConversationId = id;
            persistConversations();
            renderHistoryList();
            return conv;
        }

        function getCurrentConversation() {
            return conversations.find(c => c.id === currentConversationId) || null;
        }

        function persistConversations() {
            localStorage.setItem('conversations', JSON.stringify(conversations));
        }

        function renderHistoryList() {
            const hist = document.getElementById('history-list');
            hist.innerHTML = '<p class="text-xs text-gray-600 px-2 italic">Histórico Local</p>';
            conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = `p-2 hover:bg-gray-800 rounded text-[11px] text-gray-300 truncate cursor-pointer ${conv.id === currentConversationId ? 'bg-gray-800/50 border-l-2 border-blue-500 text-blue-400' : ''}`;
                
                const left = document.createElement('div');
                left.className = "flex items-center gap-2 overflow-hidden flex-1";
                left.onclick = () => loadConversation(conv.id);
                
                const icon = document.createElement('i');
                icon.className = "far fa-comment-alt flex-shrink-0";
                const title = document.createElement('span');
                title.className = "truncate";
                title.textContent = conv.title || 'Conversa';
                
                left.appendChild(icon);
                left.appendChild(title);
                
                const delBtn = document.createElement('button');
                delBtn.title = "Apagar conversa";
                delBtn.className = "text-gray-500 hover:text-red-500 ml-2";
                delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteConversation(conv.id); };
                
                item.appendChild(left);
                item.appendChild(delBtn);
                hist.appendChild(item);
            });
        }

        function deleteConversation(id) {
            conversations = conversations.filter(c => c.id !== id);
            if (currentConversationId === id) {
                startNewConversation();
            } else {
                persistConversations();
                renderHistoryList();
            }
        }

        function loadConversation(id) {
            currentConversationId = id;
            chatWindow.innerHTML = '';
            document.getElementById('welcome-msg').style.display = 'none';
            const conv = getCurrentConversation();
            if (!conv) return;
            conv.messages.forEach(m => {
                if(m.role !== 'system') {
                    renderMessageUI(m.role === 'user' ? 'user' : 'ai', m.content, m.img || null);
                }
            });
            renderHistoryList();
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function startNewConversation() {
            chatWindow.innerHTML = '';
            document.getElementById('welcome-msg').style.display = 'flex';
            currentConversationId = null;
            renderHistoryList();
        }

        async function handleSendMessage() {
            const text = userInput.value.trim();
            if(!text || sendBtn.disabled) return;

            let conv = getCurrentConversation();
            if (!conv) {
                conv = createConversation(text.substring(0, 30) + (text.length > 30 ? '...' : ''));
            }

            renderMessageUI('user', text);
            userInput.value = '';
            document.getElementById('welcome-msg').style.display = 'none';
            setLoading(true);

            const systemMsg = { 
                role: "system", 
                content: "Tu és a IA-Zénia, uma inteligência avançada feita no Lubango, Angola, pelo Inácio U. Daniel (Zénia-Projects). Teu modelo é o zenia-full. Angola tem 21 províncias. És especialista em línguas nacionais angolanas." 
            };

            const messages = [systemMsg, ...conv.messages, { role: "user", content: text }];

            try {
                const response = await fetch(CHAT_ENDPOINT, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'openai',
                        messages: messages,
                        max_tokens: 1200,
                        seed: Math.floor(Math.random() * 1000)
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro: ${response.statusText}`);
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                conv.messages.push({ role: "user", content: text });
                conv.messages.push({ role: "assistant", content: aiResponse });
                persistConversations();

                renderMessageUI('ai', aiResponse);
                if (isVoiceAssist) speakText(aiResponse);
            } catch (error) {
                console.error("API Error:", error);
                renderMessageUI('ai', "Ocorreu um erro ao comunicar com a IA. Tente novamente.");
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            sendBtn.disabled = isLoading;
            sendIcon.className = isLoading ? "loading-spinner" : "fas fa-paper-plane";
        }

        function renderMessageUI(role, text, img = null) {
            const row = document.createElement('div');
            row.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`;

            const bubble = document.createElement('div');
            bubble.className = `max-w-[80%] p-4 rounded-2xl ${role === 'user' ? 'bg-blue-600' : 'glass'}`;

            const p = document.createElement('p');
            p.className = 'text-sm leading-relaxed';
            p.textContent = text;
            bubble.appendChild(p);

            if (img) {
                const image = document.createElement('img');
                image.src = img;
                image.alt = 'Imagem gerada';
                image.loading = 'lazy';
                image.className = 'mt-3 rounded-lg w-full border border-gray-700 shadow-xl';
                bubble.appendChild(image);
            }

            row.appendChild(bubble);
            chatWindow.appendChild(row);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Outras funções omitidas para brevidade
    </script>
</body>
</html>
