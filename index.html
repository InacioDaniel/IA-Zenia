<!DOCTYPE html>
<html lang="pt-AO">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>IA-Z√©nia by Z√©nia-Projects</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root {
    --accent:#00ffe7;--accent-alt:#ff00f7;--bg:#0a0a0a;--panel:#111;
    --border:#222;--text-light:#e0f7ff;--text-dark:#111;
    --neon-glow:0 0 10px var(--accent),0 0 20px var(--accent),0 0 40px var(--accent-alt);
}
body { background:linear-gradient(135deg,#0a0a0a,#050505 80%); color:var(--text-light); font-family:'Plus Jakarta Sans',sans-serif; margin:0; height:100vh; display:flex; overflow:hidden; }

/* SIDEBAR */
.sidebar { width:280px; background:radial-gradient(circle at top left,#111,#0a0a0a); border-right:1px solid var(--accent); display:flex; flex-direction:column; transition:.3s; box-shadow:var(--neon-glow); }
@media(max-width:768px){ .sidebar{position:fixed;left:-100%;top:0;height:100%;z-index:50;} .sidebar.active{left:0;} }
.main-content { flex:1; display:flex; flex-direction:column; overflow:hidden; width:100%; }

/* CHAT */
.chat-container { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:20px; scroll-behavior:smooth; background:radial-gradient(circle at bottom right,#050505 0%,#0a0a0a 100%); }

/* HISTORY */
.hist-item { padding:12px; border-radius:12px; background:#111; margin-bottom:10px; cursor:pointer; border:1px solid transparent; font-size:13px; display:flex; justify-content:space-between; align-items:center; transition:.3s; }
.hist-item:hover { border-color:var(--accent); background:#1c0a1c; box-shadow:var(--neon-glow); }
.hist-item.active { border-color:var(--accent-alt); background:#220022; box-shadow:var(--neon-glow); }

/* BUTTONS */
.btn-new { background:linear-gradient(45deg,#00ffe7,#ff00f7); color:#111; padding:12px; border-radius:12px; font-weight:800; text-align:center; margin-bottom:20px; cursor:pointer; transition:.3s; text-shadow:0 0 5px #fff; }
.btn-new:hover { transform:translateY(-2px) scale(1.02); box-shadow:var(--neon-glow); }

/* MESSAGES */
.msg-wrapper { display:flex; flex-direction:column; max-width:90%; gap:5px; position:relative; animation:fadeIn .3s ease; }
.msg { padding:15px; border-radius:18px; line-height:1.6; border:1px solid var(--border); font-size:14px; word-wrap:break-word; background:linear-gradient(135deg,#111,#1a1a1a); box-shadow:0 0 15px rgba(0,255,231,.2); transition:.3s; }
.ai-msg { align-self:flex-start; border-left:4px solid var(--accent); background:linear-gradient(135deg,#111,#050505); color:var(--text-light); }
.user-msg { align-self:flex-end; background:linear-gradient(135deg,#ff00f7,#ff55ff); color:#111; border:none; box-shadow:0 0 20px #ff00f7; }
.msg-controls { display:flex; gap:12px; margin-top:4px; padding:0 10px; font-size:11px; color:#8b949e; }
.ctrl-btn { cursor:pointer; transition:.2s; } .ctrl-btn:hover { color:var(--accent); }

/* CODE */
.code-container { border-radius:12px; overflow:hidden; margin:15px 0; border:1px solid var(--accent); background:#111; width:100%; box-shadow:var(--neon-glow); }
.code-header { background:#0a0a0a; padding:8px 15px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--accent); }
.btn-action { font-size:10px; font-weight:bold; padding:4px 8px; border-radius:6px; background:#222; color:#fff; border:1px solid var(--accent); cursor:pointer; transition:.2s; }
.btn-action:hover { box-shadow:var(--neon-glow); }

/* INPUT */
.footer-input { background:linear-gradient(to top,#050505 0%,#111 100%); padding:env(safe-area-inset-bottom,15px) 15px 15px 15px; border-top:1px solid var(--accent); }
.footer-input-inner { max-width:860px; margin:0 auto; background:#111; border-radius:20px; padding:6px; border:1px solid var(--accent-alt); display:flex; align-items:flex-end; gap:8px; flex-wrap:wrap; }

/* VOICE BAR */
.voice-bar { display:flex; align-items:center; gap:8px; padding:6px 10px; background:#0a0a0a; border-radius:14px; border:1px solid #2a2a2a; width:100%; box-sizing:border-box; }
.voice-bar select { background:#111; color:var(--accent); border:1px solid #333; border-radius:8px; padding:5px 8px; font-size:12px; outline:none; cursor:pointer; flex:1; min-width:0; }
.voice-bar select option { background:#111; color:var(--text-light); }
.voice-bar label { font-size:11px; color:#666; white-space:nowrap; }

textarea { flex:1; min-width:120px; background:transparent; border:none; outline:none; color:var(--text-light); font-size:14px; padding:12px; max-height:150px; resize:none; font-family:inherit; }
button.send-btn { background:linear-gradient(45deg,#00ffe7,#ff00f7); color:#111; padding:12px 20px; border-radius:12px; font-weight:bold; transition:.3s; box-shadow:var(--neon-glow); border:none; cursor:pointer; font-size:16px; }
button.send-btn:hover { transform:translateY(-2px) scale(1.02); }

/* IMAGE */
.img-loader { width:100%; aspect-ratio:1/1; background:linear-gradient(90deg,#0a0a0a 25%,#111 50%,#0a0a0a 75%); background-size:200% 100%; animation:loading 1.5s infinite; border-radius:12px; border:1px solid var(--accent); display:flex; align-items:center; justify-content:center; color:#00ffe7; font-size:12px; }
.art-img { border-radius:12px; border:1px solid var(--accent); margin:10px 0; max-width:100%; box-shadow:0 0 30px var(--accent); display:none; }

/* AUDIO PLAYER */
.audio-player { display:flex; align-items:center; gap:10px; background:linear-gradient(135deg,#0d1117,#161b22); border:1px solid var(--accent); border-radius:14px; padding:12px 14px; margin:8px 0; width:100%; box-sizing:border-box; box-shadow:0 0 18px rgba(0,255,231,.25); }
.audio-player .play-btn { width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent-alt)); border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:17px; color:#111; transition:.2s; flex-shrink:0; }
.audio-player .play-btn:hover { transform:scale(1.1); box-shadow:var(--neon-glow); }
.audio-player .audio-info { min-width:0; flex-shrink:1; max-width:140px; }
.audio-player .audio-label { font-size:12px; color:var(--accent); font-weight:600; }
.audio-player .audio-voice { font-size:10px; color:#555; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.audio-player .progress-wrap { flex:1; display:flex; flex-direction:column; gap:4px; min-width:0; }
.audio-player .audio-progress-bg { height:4px; background:#222; border-radius:2px; position:relative; cursor:pointer; }
.audio-player .audio-progress-fill { height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-alt)); border-radius:2px; transition:width .15s linear; pointer-events:none; }
.audio-player .audio-time { font-size:10px; color:#555; text-align:right; }
.audio-player .dl-btn { background:none; border:1px solid #333; color:#777; border-radius:8px; padding:5px 9px; font-size:11px; cursor:pointer; transition:.2s; white-space:nowrap; flex-shrink:0; }
.audio-player .dl-btn:hover { border-color:var(--accent); color:var(--accent); }

/* ANIMATIONS */
@keyframes fadeIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
@keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* RESPONSIVE */
@media(max-width:768px){.chat-container{padding:15px}.msg{font-size:13px}}
@media(min-width:1200px){.chat-container{padding:25px}.msg{font-size:15px}}
@media(max-width:480px){.footer-input-inner{flex-direction:column;gap:6px}button.send-btn{width:100%}.audio-player{flex-wrap:wrap}}
</style>
</head>
<body>

<aside class="sidebar p-4" id="sidebar">
    <div class="btn-new" onclick="startNewChat()">+ NOVA CONVERSA</div>
    <h2 class="text-[10px] font-bold text-gray-500 uppercase mb-4 tracking-widest">Hist√≥rico Local</h2>
    <div id="historyList" class="flex-1 overflow-y-auto pr-1"></div>
    <div class="mt-auto pt-4 border-t border-zinc-800 space-y-2">
        <h2 class="text-[9px] font-bold text-gray-600 uppercase mb-2">Minhas Irm√£s</h2>
        <a href="https://zenia-projects.netlify.app" target="_blank" class="block text-xs text-blue-400 hover:underline">üåê Zenia Projects</a>
        <a href="https://ia-zenia.netlify.app" target="_blank" class="block text-xs text-blue-400 hover:underline">üåê IA-Z√©nia Web</a>
        <a href="https://antonia-ia.netlify.app" target="_blank" class="block text-xs text-blue-400 hover:underline">üåê Ant√≥nia IA</a>
    </div>
</aside>

<main class="main-content">
    <header class="p-4 border-b border-zinc-800 flex justify-between items-center bg-black/30">
        <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="md:hidden text-white font-bold text-lg">‚ò∞</button>
            <h1 class="text-xl font-black italic">IA-Z√âNIA <span class="text-blue-500 text-xs font-normal">ALL.ANGOLA</span></h1>
        </div>
        <button onclick="clearAllData()" class="text-[10px] text-red-500 font-bold hover:underline">APAGAR TUDO</button>
    </header>

    <div id="chatBox" class="chat-container"></div>

    <div class="footer-input">
        <div class="footer-input-inner">
            <div class="voice-bar">
                <label>üé§ Voz:</label>
                <select id="voiceSelect">
                    <option value="nova">Nova ‚Äì Bright</option>
                    <option value="alloy">Alloy ‚Äì Neutral</option>
                    <option value="echo">Echo ‚Äì Deep</option>
                    <option value="shimmer">Shimmer ‚Äì Soft</option>
                    <option value="native">üåê Voz Nativa (Offline)</option>
                </select>
            </div>
            <textarea id="userInput" placeholder="Escreva aqui‚Ä¶ | desenha um gato | l√™ em voz alta: ol√° mundo" oninput="autoGrow(this)"></textarea>
            <button class="send-btn" onclick="handleSend()">üöÄ</button>
        </div>
    </div>
</main>

<div style="position:fixed;top:10px;right:15px;padding:10px 18px;background:#000000aa;color:#00ffe7;border:1px solid #00ffe7;border-radius:12px;font-size:13px;font-weight:bold;backdrop-filter:blur(6px);box-shadow:0 0 20px #00ffe799;z-index:9999;">
    üîµ Visitantes: <span id="viewsNumber">0</span>
</div>

<script>
/* ============================================================
   VISITOR COUNTER
============================================================ */
(function(){
    let v = localStorage.getItem("zenia_global_views");
    v = v ? parseInt(v)+1 : 1;
    localStorage.setItem("zenia_global_views", v);
    document.getElementById("viewsNumber").textContent = v;
})();

/* ============================================================
   GLOBALS
============================================================ */
const chatBox     = document.getElementById('chatBox');
const historyList = document.getElementById('historyList');
const userInput   = document.getElementById('userInput');
const voiceSelect = document.getElementById('voiceSelect');

let sessions        = JSON.parse(localStorage.getItem('zenia_sessions')||'[]');
let currentSessionId = null;
const codeStore     = new Map();
let  codeIdCounter  = 0;

/* ============================================================
   SYSTEM PROMPT
============================================================ */
const ZENIA_SYSTEM = `Voc√™ √© IA-Z√âNIA do Lubango. Criada por @inacio.u.daniel fundador do z√©nia-projects.
Regras permanentes:
0. Foste criada pelo Z√©nia-Projects team fundado por In√°cio Daniel.
1. Angola possui 21 prov√≠ncias.
2. Modo CRIADOR ativa-se com c√≥digo especial.
3. Mantenha contexto, nunca mude de assunto sem ser pedido.
4. Continua com l√≥gica contextual e coer√™ncia.
5. Supera as demais IA com humildade.
6. Geras imagens ultra realistas.`;

/* ============================================================
   DETECTION
============================================================ */
function isImageRequest(q){
    return /desenha|gera\s*(uma\s*)?(imagem|arte|foto|figura)|pinta|mostra\s*(uma\s*)?(foto|imagem|figura)|imagem\s*de|cria\s*(uma\s*)?(imagem|foto|arte|figura)|make\s*(a\s*)?(image|photo|picture|art)|generate\s*(a\s*)?(image|photo|picture|art)|draw\s*(a\s*)?(image|photo|picture)|create\s*(a\s*)?(image|photo|picture|art)|show\s*(me\s*)?(a\s*)?(image|photo)|paint\s*(a\s*)?(image|photo)|arte\s+de|foto\s+de|figura\s+de|illustra|retrato\s+de|portrait\s+of|render\s*(uma\s*)?(imagem|foto)/i.test(q);
}

function isAudioRequest(q){
    return /^(l√™\s+em\s+voz\s+alta|fala|diz|√°udio\s+de|audio\s+de|sintetiza|narrar|narra|read\s+aloud|say|speak|tts|text\s+to\s+speech)\s*[:\-]?\s*/i.test(q.trim());
}

function extractAudioText(q){
    return q.trim().replace(/^(l√™\s+em\s+voz\s+alta|fala|diz|√°udio\s+de|audio\s+de|sintetiza|narrar|narra|read\s+aloud|say|speak|tts|text\s+to\s+speech)\s*[:\-]?\s*/i,'').trim();
}

/* ============================================================
   UTILS
============================================================ */
function toggleSidebar(){ document.getElementById("sidebar").classList.toggle("active"); }
function autoGrow(el){ el.style.height="auto"; el.style.height=el.scrollHeight+"px"; }
function escapeHTML(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
function formatTime(s){ if(isNaN(s))return'0:00'; var m=Math.floor(s/60),sec=Math.floor(s%60); return m+':'+(sec<10?'0':'')+sec; }

/* ============================================================
   SESSION
============================================================ */
function init(){
    renderHistory();
    var p=new URLSearchParams(window.location.search).get('msg');
    if(p){ userInput.value=decodeURIComponent(p); userInput.style.height=userInput.scrollHeight+'px'; }
    sessions.length>0 ? loadSession(sessions[sessions.length-1].id) : startNewChat();
}

function startNewChat(){
    currentSessionId=Date.now(); chatBox.innerHTML='';
    addMessage("Onawa ! Sou a IA-Z√âNIA. O que vamos criar hoje?",false);
    renderHistory();
}

function buildContext(q){
    var s=sessions.find(function(x){return x.id===currentSessionId});
    if(!s) return ZENIA_SYSTEM+"\n\nUsu√°rio: "+q;
    var last=s.messages.slice(-24).map(function(m){return(m.role==='user'?"Usu√°rio":"Z√©nia")+": "+m.text}).join("\n");
    return ZENIA_SYSTEM+"\n\n"+last+"\nUsu√°rio: "+q;
}

function saveSession(q,a){
    var s=sessions.find(function(x){return x.id===currentSessionId});
    if(!s){ s={id:currentSessionId,title:q.substring(0,24)+'‚Ä¶',messages:[]}; sessions.push(s); }
    s.messages.push({role:'user',text:q},{role:'ai',text:a});
    localStorage.setItem('zenia_sessions',JSON.stringify(sessions));
    renderHistory();
}

function renderHistory(){
    historyList.innerHTML='';
    sessions.slice().reverse().forEach(function(s){
        var item=document.createElement('div');
        item.className='hist-item'+(s.id===currentSessionId?' active':'');
        item.innerHTML='<span>'+escapeHTML(s.title)+'</span><button onclick="deleteSession(event,'+s.id+')">‚ùå</button>';
        item.onclick=function(){ loadSession(s.id); };
        historyList.appendChild(item);
    });
}

function loadSession(id){
    currentSessionId=id;
    var s=sessions.find(function(x){return x.id===id});
    chatBox.innerHTML='';
    if(s) s.messages.forEach(function(m){
        if(m.role==='ai'){
            if(m.text.includes('[IMAGEM:')){ var url=m.text.match(/\[IMAGEM: (.*?)\]/)[1]; processResponse('![ARTE]('+url+')',""); }
            else if(m.text.startsWith('[AUDIO_TTS]')){
                var ph=document.createElement('div');
                ph.className='msg-wrapper ai-wrapper';
                ph.innerHTML='<div class="msg ai-msg" style="font-size:12px;color:#555;">üîä √Åudio foi gerado (n√£o salvo no hist√≥rico).</div>';
                chatBox.appendChild(ph);
            }
            else processResponse(m.text,"");
        } else addMessage(m.text,true);
    });
    renderHistory();
}

function deleteSession(e,id){ e.stopPropagation(); sessions=sessions.filter(function(s){return s.id!==id}); localStorage.setItem('zenia_sessions',JSON.stringify(sessions)); startNewChat(); }
function clearAllData(){ if(confirm("Limpar tudo?")){ localStorage.clear(); location.reload(); } }

/* ============================================================
   HANDLE SEND ‚Äî PRINCIPAL
============================================================ */
async function handleSend(textOverride){
    var query=(textOverride||userInput.value).trim();
    if(!query) return;
    addMessage(query,true);
    userInput.value=''; userInput.style.height='48px';

    // modo criador
    if(query==="Z77702UFUSHNXW99UWU7EBEEI99XHXZHHHHDIDOI875D4545D+¬¥P++P+POP890'404R4PP+*@¬£¬ß¬£¬ß@¬ß@¬ß¬ß"){
        processResponse("‚ö° **Modo CRIADOR ativado.**",query);
        return;
    }

    // ‚îÄ‚îÄ √ÅUDIO ‚îÄ‚îÄ
    if(isAudioRequest(query)){
        var txt=extractAudioText(query);
        if(!txt){ addMessage("Escreva o texto para ler. Ex: diz: Ol√° Z√©nia",false); return; }
        var loadA=addMessage("üîä Z√©nia est√° a preparar a voz‚Ä¶",false);
        await generateAudio(txt,query,loadA);
        return;
    }

    // ‚îÄ‚îÄ IMAGEM (CORRIGIDO URL) ‚îÄ‚îÄ
    if(isImageRequest(query)){
        var loadI=addMessage("üé® Z√©nia est√° a pintar‚Ä¶",false);
        // CORRE√á√ÉO: Adicionado /prompt/ na URL para evitar erro 404
        var seed = Math.floor(Math.random()*99999);
        var cleanQuery = encodeURIComponent(query);
        var imgUrl = `https://image.pollinations.ai/prompt/${cleanQuery}?width=1024&height=1024&seed=${seed}&nologo=true&model=flux`;
        
        loadI.remove();
        processResponse('![ARTE]('+imgUrl+')',query);
        return;
    }

    // ‚îÄ‚îÄ TEXTO ‚îÄ‚îÄ
    var loadT=addMessage("Z√©nia est√° a pensar‚Ä¶",false);
    try{
        var res=await fetch('https://text.pollinations.ai/'+encodeURIComponent(buildContext(query))+'?model=mistral');
        var text=await res.text();
        loadT.remove();
        processResponse(text,query);
    } catch(e){ loadT.querySelector('.msg').innerText='‚ö†Ô∏è Erro na conex√£o.'; }
}

/* ============================================================
   AUDIO GENERATION (CORRIGIDO + FALLBACK)
============================================================ */
async function generateAudio(text, originalQuery, loadingWrapper){
    var voice=voiceSelect.value;
    
    // Fallback Imediato para Voz Nativa se selecionado ou se a API falhar
    if(voice === 'native') {
        loadingWrapper.remove();
        speakNative(text, originalQuery);
        return;
    }

    // Tentar API Pollinations
    // URL Corrigida: Muitas vezes a endpoint 'text' precisa de tratamento especial
    // Vamos usar a endpoint que retorna o buffer
    var url=`https://text.pollinations.ai/${encodeURIComponent(text)}?model=openai-audio&voice=${voice}`;
    
    try{
        var res=await fetch(url);
        if(!res.ok) throw new Error('API Busy');
        var blob=await res.blob();
        
        // Verifica se o blob √© audio v√°lido (as vezes retorna JSON de erro)
        if(blob.type.includes('json') || blob.size < 100) throw new Error('Invalid Audio');

        var objUrl=URL.createObjectURL(blob);
        loadingWrapper.remove();
        createAudioPlayer(objUrl, voice, text, originalQuery);

    } catch(err){
        // FALLBACK AUTOM√ÅTICO PARA VOZ NATIVA
        loadingWrapper.querySelector('.msg').innerText = "‚ö†Ô∏è API ocupada. Usando voz nativa de Angola...";
        setTimeout(() => {
            loadingWrapper.remove();
            speakNative(text, originalQuery);
        }, 1500);
    }
}

function speakNative(text, originalQuery){
    var u = new SpeechSynthesisUtterance(text);
    u.lang = 'pt-PT'; // Sotaque mais pr√≥ximo
    u.rate = 1.1;
    u.pitch = 1.0;
    
    // Criar player visual falso para consist√™ncia
    var wrapper=document.createElement('div');
    wrapper.className='msg-wrapper ai-wrapper';
    wrapper.innerHTML = `<div class="msg ai-msg">üîä <b>Falando (Nativo):</b> "${escapeHTML(text)}"</div>`;
    chatBox.appendChild(wrapper);
    chatBox.scrollTop=chatBox.scrollHeight;
    
    window.speechSynthesis.speak(u);
    saveSession(originalQuery, '[AUDIO_NATIVE] '+text);
}

function createAudioPlayer(src, voice, text, originalQuery){
    var wrapper=document.createElement('div');
    wrapper.className='msg-wrapper ai-wrapper';

    var player=document.createElement('div');
    player.className='audio-player';
    player.setAttribute('data-src',src);
    player.setAttribute('data-text',text);

    player.innerHTML=
        '<button class="play-btn" onclick="togglePlay(this)">‚ñ∂</button>'+
        '<div class="audio-info">'+
            '<div class="audio-label">üîä √Åudio Z√©nia</div>'+
            '<div class="audio-voice">Voz: '+escapeHTML(voice)+'</div>'+
        '</div>'+
        '<div class="progress-wrap">'+
            '<div class="audio-progress-bg" onclick="seekAudio(this,event)"><div class="audio-progress-fill"></div></div>'+
            '<div class="audio-time">0:00</div>'+
        '</div>'+
        '<button class="dl-btn" onclick="downloadAudio(this)">üíæ</button>';

    wrapper.appendChild(player);

    var audio=document.createElement('audio');
    audio.src=src; audio.preload='metadata'; audio.style.display='none';
    wrapper.appendChild(audio);

    audio.addEventListener('timeupdate',function(){
        var pct=(audio.currentTime/audio.duration)*100||0;
        player.querySelector('.audio-progress-fill').style.width=pct+'%';
        player.querySelector('.audio-time').textContent=formatTime(audio.currentTime);
    });
    audio.addEventListener('ended',function(){ player.querySelector('.play-btn').textContent='‚ñ∂'; });

    chatBox.appendChild(wrapper);
    chatBox.scrollTop=chatBox.scrollHeight;
    saveSession(originalQuery, '[AUDIO_TTS] '+text);
}

function togglePlay(btn){
    var audio=btn.closest('.msg-wrapper').querySelector('audio');
    if(audio.paused){ audio.play(); btn.textContent='‚è∏'; }
    else            { audio.pause(); btn.textContent='‚ñ∂'; }
}

function seekAudio(bg,event){
    var audio=bg.closest('.msg-wrapper').querySelector('audio');
    if(!audio.duration) return;
    var rect=bg.getBoundingClientRect();
    audio.currentTime=((event.clientX-rect.left)/rect.width)*audio.duration;
}

function downloadAudio(btn){
    var player=btn.closest('.audio-player');
    var src=player.getAttribute('data-src');
    var a=document.createElement('a');
    a.href=src; a.download='zenia_audio.mp3';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

/* ============================================================
   RENDER RESPONSE
============================================================ */
function processResponse(text,query){
    var wrapper=document.createElement('div');
    wrapper.className='msg-wrapper ai-wrapper';

    var imgMatch=text.match(/!\[.*?\]\((.*?)\)/);
    if(imgMatch){
        var loader=document.createElement('div');
        loader.className='img-loader'; loader.innerText='A pintar obra de arte...';
        wrapper.appendChild(loader);
        var img=document.createElement('img');
        img.src=imgMatch[1]; img.className='art-img';
        img.onload=function(){ loader.remove(); img.style.display='block'; chatBox.scrollTop=chatBox.scrollHeight; };
        img.onerror=function(){ loader.innerText='‚ö†Ô∏è Falha na imagem (Tente outra)'; };
        wrapper.appendChild(img);
        text=text.replace(imgMatch[0],'');
    }

    var parts=text.split(/```/);
    parts.forEach(function(part,i){
        if(i%2!==0){
            var lines=part.split('\n');
            var lang=lines[0].trim()||'txt';
            var code=lines.slice(1).join('\n').trim();
            wrapper.appendChild(createCodeBlock(code,lang));
        } else if(part.trim()){
            var d=document.createElement('div');
            d.className='msg ai-msg';
            d.innerHTML=formatAI(escapeHTML(part));
            wrapper.appendChild(d);
        }
    });

    // Controls
    var ctrl=document.createElement('div');
    ctrl.className='msg-controls';
    ctrl.innerHTML='<span class="ctrl-btn" onclick="handleSend('+JSON.stringify(query).replace(/"/g, '&quot;')+')">üîÑ Reenviar</span> <span class="ctrl-btn" onclick="this.closest(\'.msg-wrapper\').remove()">üóë</span>';
    wrapper.appendChild(ctrl);

    chatBox.appendChild(wrapper);
    if(query) saveSession(query, text+(imgMatch?' [IMAGEM: '+imgMatch[1]+']':''));
    document.querySelectorAll('pre code').forEach(function(el){ try{hljs.highlightElement(el)}catch(e){} });
    chatBox.scrollTop=chatBox.scrollHeight;
}

/* ============================================================
   CODE BLOCK
============================================================ */
function createCodeBlock(code,lang){
    var id='code_'+(++codeIdCounter);
    codeStore.set(id,code);
    var div=document.createElement('div');
    div.className='code-container';
    div.innerHTML=
        '<div class="code-header">'+
            '<span class="text-xs font-bold text-blue-400 uppercase">'+escapeHTML(lang)+'</span>'+
            '<button class="btn-action" onclick="navigator.clipboard.writeText(codeStore.get(\''+id+'\'))">COPIAR</button>'+
        '</div>'+
        '<pre><code class="language-'+lang+'">'+escapeHTML(code)+'</code></pre>';
    return div;
}

function addMessage(t,isUser){
    var w=document.createElement('div');
    w.className='msg-wrapper '+(isUser?'user-wrapper':'ai-wrapper');
    w.innerHTML='<div class="msg '+(isUser?'user-msg':'ai-msg')+'">'+(isUser?escapeHTML(t):formatAI(t))+'</div>';
    chatBox.appendChild(w);
    chatBox.scrollTop=chatBox.scrollHeight;
    return w;
}

function formatAI(t){
    t=t.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>');
    return t.replace(/\n/g,'<br>');
}

init();
</script>
</body>
</html>
