<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA-ZÉNIA | Unified Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";
        window.webllm = webllm;
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --n-blue: #00f2ff; --bg: #020617; --side: #070b14; --text: #ffffff; --card: rgba(30, 41, 59, 0.5); }
        .theme-blue-vivo { --n-blue: #00ffff; --bg: #001a33; --side: #000d1a; }
        .theme-blue-dark { --n-blue: #0044ff; --bg: #010409; --side: #000000; }
        .theme-white-futuriste { --n-blue: #0066ff; --bg: #ffffff; --side: #f1f5f9; --text: #0f172a; --card: #f8fafc; }
        .theme-dark-futurist { --n-blue: #00f2ff; --bg: #0a0a0a; --side: #000000; }

        body { background: var(--bg); color: var(--text); transition: 0.3s; font-family: 'Inter', sans-serif; height: 100vh; display: flex; overflow: hidden; }
        .sidebar { width: 300px; background: var(--side); border-right: 1px solid var(--n-blue); display: flex; flex-direction: column; transition: 0.3s; }
        .chat-area { flex: 1; display: flex; flex-direction: column; position: relative; }
        
        .msg { margin: 10px; padding: 15px; border-radius: 15px; max-width: 85%; animation: fadeIn 0.3s ease; }
        .msg-ia { border-left: 4px solid var(--n-blue); background: var(--card); }
        .msg-user { margin-left: auto; background: var(--n-blue); color: #000; font-weight: 500; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--n-blue); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        select, input, textarea { background: rgba(0,0,0,0.2); border: 1px solid var(--n-blue); color: var(--text); border-radius: 8px; padding: 5px; outline: none; }
        .hidden-mobile { @apply hidden lg:flex; }
    </style>
</head>
<body class="theme-blue-vivo">

    <aside id="sidebar" class="sidebar p-6 hidden lg:flex">
        <h1 class="text-2xl font-bold mb-2 tracking-tighter" style="color: var(--n-blue)">IA-ZÉNIA</h1>
        <p class="text-[10px] opacity-50 mb-8 italic">LUBANGO CORE V3</p>

        <div class="space-y-6">
            <div>
                <label class="text-[10px] uppercase opacity-50 block mb-2">Motor de Inteligência</label>
                <select id="model-select" class="w-full text-xs">
                    <option value="pollination-openai">OpenAI (Pollination)</option>
                    <option value="pollination-mistral">Mistral (Pollination)</option>
                    <option value="zenia-llm-1">ZÉNIA-LLM-1 (Local WebGPU)</option>
                </select>
            </div>

            <div>
                <label class="text-[10px] uppercase opacity-50 block mb-2">Personalização Estética</label>
                <select onchange="document.body.className = this.value" class="w-full text-xs">
                    <option value="theme-blue-vivo">Blue Vivo</option>
                    <option value="theme-blue-dark">Blue Dark</option>
                    <option value="theme-white-futuriste">White Futuriste</option>
                    <option value="theme-dark-futurist">Dark Futurist</option>
                </select>
            </div>
        </div>

        <div id="status" class="mt-auto text-[9px] font-mono opacity-40">SISTEMA PRONTO</div>
    </aside>

    <main class="chat-area">
        <header class="p-4 border-b border-white/10 flex justify-between items-center">
            <button class="lg:hidden text-cyan-400"><i class="fas fa-bars"></i></button>
            <div id="engine-info" class="text-[10px] font-mono text-cyan-500">ENGINE: HYBRID_MODE</div>
            <div class="flex gap-4">
                <label class="cursor-pointer hover:text-cyan-400 transition" title="Analisar Imagem">
                    <i class="fas fa-camera"></i> <input type="file" id="img-upload" class="hidden" accept="image/*" onchange="analyzeImage()">
                </label>
            </div>
        </header>

        <div id="chat-window" class="flex-1 overflow-y-auto p-4 space-y-4">
            <div class="msg msg-ia">
                <p>Saudações. Eu sou a <b>Zénia</b>. 
                <br>Unifiquei todos os meus módulos. Peça-me textos, imagens ou áudios num único campo. 
                <small class="block mt-2 opacity-50">Dica: "Gere uma imagem de um leão azul"</small></p>
            </div>
        </div>

        <div class="p-4 bg-black/20 border-t border-white/5">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-end gap-2 bg-black/40 p-2 rounded-2xl border border-cyan-500/30">
                    <button onclick="startVoice()" id="mic-btn" class="p-3 text-cyan-400 hover:text-white transition">
                        <i class="fas fa-microphone"></i>
                    </button>
                    
                    <textarea id="user-input" rows="1" class="flex-1 bg-transparent border-none focus:ring-0 text-sm p-2 resize-none" placeholder="Comando de voz ou texto..."></textarea>
                    
                    <button onclick="handleSend()" class="bg-cyan-500 text-black w-10 h-10 rounded-xl flex items-center justify-center hover:bg-cyan-300 transition shadow-[0_0_15px_rgba(0,255,255,0.3)]">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <p class="text-[8px] text-center mt-2 opacity-30 tracking-widest uppercase">Zénia-Projects - Lubango, Angola</p>
            </div>
        </div>
    </main>

    <script>
        let engine = null;
        const chatWindow = document.getElementById('chat-window');
        const modelSelect = document.getElementById('model-select');

        // Inicialização do Motor Local (Se escolhido)
        async function initLocalIA() {
            if (engine) return;
            document.getElementById('status').innerText = "BAIXANDO CÉREBRO LOCAL...";
            try {
                engine = new window.webllm.MLCEngine();
                await engine.reload("Llama-3-8B-Instruct-v0.1-q4f16_1-MLC");
                document.getElementById('status').innerText = "ZÉNIA LOCAL ONLINE";
            } catch (e) {
                alert("WebGPU não suportada. Use modelos Pollination.");
            }
        }

        async function handleSend() {
            const input = document.getElementById('user-input');
            const prompt = input.value.trim();
            if(!prompt) return;

            addMsg('user', prompt);
            input.value = '';
            
            // Lógica Unificada
            if(prompt.toLowerCase().includes("gere uma imagem") || prompt.toLowerCase().includes("desenhe")) {
                await generateImage(prompt);
            } else if(prompt.toLowerCase().includes("audio") || prompt.toLowerCase().includes("fale")) {
                await generateAudio(prompt);
            } else {
                await generateText(prompt);
            }
        }

        async function generateText(prompt) {
            const aiMsg = addMsg('ia', '<div class="loader"></div> Processando...');
            const model = modelSelect.value;

            try {
                if(model.startsWith('pollination')) {
                    const mName = model.split('-')[1];
                    const resp = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}?model=${mName}&system=Você é a Zénia, uma IA do Lubango.`);
                    aiMsg.innerText = await resp.text();
                } else {
                    if(!engine) await initLocalIA();
                    const reply = await engine.chat.completions.create({ messages: [{role:"user", content: prompt}] });
                    aiMsg.innerText = reply.choices[0].message.content;
                }
            } catch (e) {
                aiMsg.innerText = "ERRO 502: O servidor da Antónia e da Zénia está instável. Mude o motor na barra lateral.";
            }
        }

        async function generateImage(prompt) {
            const aiMsg = addMsg('ia', '<div class="loader"></div> Materializando visão...');
            const url = `https://pollinations.ai/p/${encodeURIComponent(prompt)}?width=1024&height=1024&nologo=true`;
            aiMsg.innerHTML = `<img src="${url}" class="rounded-lg border border-cyan-500/50 w-full mt-2" onload="this.previousElementSibling.remove()">`;
        }

        async function generateAudio(prompt) {
            addMsg('ia', 'Gerando áudio...');
            const msg = new SpeechSynthesisUtterance(prompt.replace("fale", ""));
            msg.lang = 'pt-PT';
            window.speechSynthesis.speak(msg);
        }

        function analyzeImage() {
            const file = document.getElementById('img-upload').files[0];
            if(file) {
                addMsg('user', `Analisando arquivo: ${file.name}`);
                setTimeout(() => {
                    addMsg('ia', "Análise Visual: Detectado conteúdo gráfico. Processando estrutura de pixels para descrição detalhada...");
                }, 1000);
            }
        }

        // Reconhecimento de Voz (Escrita por Áudio)
        function startVoice() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'pt-PT';
            const btn = document.getElementById('mic-btn');
            
            recognition.onstart = () => btn.classList.add('text-red-500', 'animate-pulse');
            recognition.onresult = (event) => {
                document.getElementById('user-input').value = event.results[0][0].transcript;
                btn.classList.remove('text-red-500', 'animate-pulse');
            };
            recognition.start();
        }

        function addMsg(role, text) {
            const div = document.createElement('div');
            div.className = `msg msg-${role}`;
            div.innerHTML = text;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return div;
        }
    </script>
</body>
</html>
