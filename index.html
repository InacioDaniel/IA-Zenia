<!DOCTYPE html>
<html lang="pt-PT" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA-Zénia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        body { background-color: #0b0d11; color: #e5e7eb; font-family: 'Inter', sans-serif; }
        .sidebar { background-color: #161b22; }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .chat-container::-webkit-scrollbar { width: 5px; }
        .chat-container::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
        .glow-button:hover { box-shadow: 0 0 15px rgba(59,130,246,0.5); }
        @keyframes pulse-red { 50% { background:#ef4444;color:#fff;transform:scale(1.1); } }
        .recording { animation: pulse-red 1.5s infinite; border-radius: 9999px; }
        @keyframes fade-in { from { opacity:0;transform:translateY(4px); } to { opacity:1;transform:translateY(0); } }
        .animate-fade-in { animation: fade-in 200ms ease-out; }
        .loading-spinner {
            width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);
            border-radius:50%;border-top-color:#fff;
            animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;
        }
        @keyframes spin { to { transform:rotate(360deg); } }

        /* História */
        .history-item { display:flex;align-items:center;justify-content:space-between;gap:8px; }

        /* Status */
        .status-ok   { color:#22c55e;border-color:#22c55e40; }
        .status-err  { color:#ef4444;border-color:#ef444440; }
        .status-wait { color:#9ca3af;border-color:#4b556340; }

        /* Blocos de código */
        .code-block { position:relative;background:#0d1117;border:1px solid #30363d;border-radius:10px;margin:12px 0;overflow:hidden; }
        .code-header { display:flex;align-items:center;justify-content:space-between;background:#161b22;border-bottom:1px solid #30363d;padding:5px 12px; }
        .code-lang-label { font-family:monospace;font-size:11px;text-transform:uppercase;letter-spacing:.07em;color:#58a6ff;font-weight:600; }
        .copy-btn { background:#21262d;border:1px solid #30363d;color:#8b949e;border-radius:6px;padding:2px 8px;font-size:11px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:4px; }
        .copy-btn:hover { background:#30363d;color:#e6edf3; }
        .code-block pre { margin:0!important;padding:14px 16px!important;overflow-x:auto;font-size:13px!important;line-height:1.65!important;background:transparent!important; }
        .code-block pre code.hljs { background:transparent!important;padding:0!important;font-size:inherit!important; }

        /* Linhas de erro em amarelo */
        .error-line { background:rgba(251,191,36,0.08);display:block; }
        .error-line .hljs-keyword,.error-line .hljs-built_in,.error-line .hljs-string,
        .error-line .hljs-number,.error-line .hljs-comment,.error-line span { color:#fbbf24!important; }
        .error-marker { color:#fbbf24;font-weight:bold; }

        /* Código inline */
        .inline-code { background:rgba(110,118,129,0.2);border-radius:4px;padding:1px 6px;font-family:monospace;font-size:12px;color:#e6edf3; }

        /* Badge web */
        .web-badge { display:inline-flex;align-items:center;gap:5px;background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.3);border-radius:20px;padding:3px 10px;font-size:11px;color:#60a5fa;margin-bottom:8px; }

        /* Media cards */
        .media-card { background:#0d1117;border:1px solid #30363d;border-radius:10px;overflow:hidden;margin:10px 0; }
        .media-card img { width:100%;display:block; }
        .media-card-label { padding:6px 12px;font-size:11px;color:#8b949e;background:#161b22;border-top:1px solid #30363d; }
        .media-actions { display:flex;gap:8px;padding:8px 12px;background:#161b22;border-top:1px solid #30363d; }
        .media-btn { font-size:11px;padding:3px 10px;border-radius:6px;cursor:pointer;border:1px solid #30363d;background:#21262d;color:#8b949e;transition:all .2s;text-decoration:none;display:inline-flex;align-items:center;gap:4px; }
        .media-btn:hover { background:#30363d;color:#e6edf3; }

        /* Toolbar de modo */
        .toolbar-btn { padding:5px 10px;border-radius:8px;border:1px solid #30363d;background:transparent;color:#6b7280;font-size:12px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px; }
        .toolbar-btn:hover { background:#1f2937;color:#e5e7eb;border-color:#4b5563; }
        .toolbar-btn.active { background:#1d3461;color:#60a5fa;border-color:#3b82f6; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

<!-- SIDEBAR -->
<aside class="sidebar w-72 flex flex-col border-r border-gray-800">
    <div class="p-6 text-2xl font-bold tracking-tight text-blue-500">
        IA-Zénia <span class="text-xs font-light text-gray-500 block">by Zénia-Projects</span>
    </div>
    <div class="px-4 mb-4">
        <button onclick="startNewConversation()" class="w-full bg-blue-600/10 hover:bg-blue-600/20 text-blue-500 border border-blue-500/30 rounded-lg py-2 text-sm font-medium transition flex items-center justify-center gap-2">
            <i class="fas fa-plus"></i> Novo Chat
        </button>
    </div>
    <div class="px-4 mb-4">
        <div class="relative">
            <i class="fas fa-search absolute left-3 top-3 text-gray-500 text-sm"></i>
            <input id="search-input" type="text" placeholder="Buscar em chats..."
                class="w-full bg-gray-900 border border-gray-700 rounded-lg py-2 pl-9 pr-4 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
                oninput="filterHistory(this.value)">
        </div>
    </div>
    <nav class="flex-1 overflow-y-auto px-4 space-y-6">
        <div>
            <p class="text-xs font-semibold text-gray-500 uppercase mb-3">Aplicativos</p>
            <div class="space-y-2">
                <a href="https://antonia-ia.netlify.app" target="_blank" rel="noopener noreferrer" class="flex items-center p-2 rounded-lg hover:bg-gray-800 transition text-sm">
                    <i class="fas fa-robot mr-3 text-pink-500"></i> Antónia-IA
                </a>
                <a href="https://zenia-projects.netlify.app" target="_blank" rel="noopener noreferrer" class="flex items-center p-2 rounded-lg hover:bg-gray-800 transition text-sm">
                    <i class="fas fa-code mr-3 text-blue-500"></i> Zénia-Projects
                </a>
            </div>
        </div>
        <div>
            <p class="text-xs font-semibold text-gray-500 uppercase mb-3">Recursos</p>
            <button onclick="toggleGallery()" class="w-full flex items-center p-2 rounded-lg hover:bg-gray-800 transition text-sm">
                <i class="fas fa-images mr-3 text-purple-500"></i> Galeria
            </button>
            <div id="history-list" class="mt-4 space-y-1">
                <p class="text-xs text-gray-600 px-2 italic">Histórico Local</p>
            </div>
        </div>
    </nav>
    <div class="p-4 border-t border-gray-800 flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold flex-shrink-0">U</div>
        <div class="flex-1 overflow-hidden">
            <p class="text-sm font-medium truncate" id="username-display">Utilizador Zénia</p>
            <p class="text-xs text-green-500 italic">Online</p>
        </div>
    </div>
</aside>

<!-- MAIN -->
<main class="flex-1 flex flex-col relative overflow-hidden">
    <header class="h-16 border-b border-gray-800 flex items-center justify-between px-6 glass flex-shrink-0">
        <div class="flex items-center gap-3 flex-wrap">
            <select id="voice-select" class="bg-transparent text-xs border border-gray-700 rounded p-1 outline-none focus:ring-1 focus:ring-blue-500 max-w-[150px]">
                <option value="">Voz padrão</option>
            </select>
            <button id="voice-assist-btn" onclick="toggleVoiceAssist()" class="text-xs px-3 py-1 rounded-full border border-blue-500 text-blue-500 hover:bg-blue-500 hover:text-white transition">
                <i class="fas fa-headset mr-1"></i>Voz Assist.
            </button>
            <span id="api-status" class="text-[11px] px-2 py-1 rounded border status-wait">API: verificando…</span>
            <span id="web-status" class="hidden text-[11px] px-2 py-1 rounded border border-yellow-500/40 text-yellow-400">
                <i class="fas fa-globe mr-1"></i>A pesquisar web…
            </span>
        </div>
        <div class="flex items-center gap-2 flex-shrink-0">
            <label class="text-xs text-gray-500">Modelo:</label>
            <select id="model-select" class="bg-transparent text-xs border border-gray-700 rounded p-1 outline-none focus:ring-1 focus:ring-blue-500 text-blue-400">
                <option value="openai">openai (geral)</option>
                <option value="qwen-coder" selected>qwen-coder (código)</option>
                <option value="openai-large">openai-large (avançado)</option>
                <option value="mistral">mistral</option>
                <option value="deepseek">deepseek</option>
            </select>
        </div>
    </header>

    <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-6 chat-container">
        <div class="flex flex-col items-center justify-center h-full text-center space-y-4 opacity-50" id="welcome-msg">
            <i class="fas fa-shield-cat text-6xl text-blue-500"></i>
            <h2 class="text-2xl font-bold">Olá, eu sou a Zénia.</h2>
            <p class="max-w-sm text-sm">Criada no Lubango por Inácio U. Daniel.<br>Código · Imagens · Áudio · Pesquisa Web</p>
        </div>
    </div>

    <div class="p-4 bg-gradient-to-t from-[#0b0d11] to-transparent flex-shrink-0">
        <div class="max-w-4xl mx-auto">
            <div class="flex gap-2 mb-2 px-1 flex-wrap">
                <button id="btn-mode-chat"  onclick="setMode('chat')"  class="toolbar-btn active"><i class="fas fa-comment"></i> Chat</button>
                <button id="btn-mode-image" onclick="setMode('image')" class="toolbar-btn"><i class="fas fa-image text-purple-400"></i> Imagem</button>
                <button id="btn-mode-audio" onclick="setMode('audio')" class="toolbar-btn"><i class="fas fa-music text-green-400"></i> Áudio</button>
                <button id="btn-mode-web"   onclick="setMode('web')"   class="toolbar-btn"><i class="fas fa-globe text-yellow-400"></i> Web</button>
            </div>
            <div class="glass rounded-2xl p-2">
                <div class="flex items-end gap-2 px-2 pb-2">
                    <textarea id="user-input" rows="1" placeholder="Pergunte qualquer coisa à Zénia…"
                        class="flex-1 bg-transparent border-none focus:ring-0 text-sm py-3 resize-none outline-none"
                        style="max-height:120px;overflow-y:auto;"></textarea>
                    <button id="mic-btn" class="p-3 text-gray-400 hover:text-blue-500 transition" title="Microfone">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="send-btn" onclick="handleSendMessage()" class="p-3 bg-blue-600 rounded-xl hover:bg-blue-700 glow-button transition min-w-[44px] flex items-center justify-center">
                        <i class="fas fa-paper-plane" id="send-icon"></i>
                    </button>
                </div>
            </div>
            <p class="text-[10px] text-center mt-2 text-gray-600 uppercase tracking-widest">
                A Zénia verifica na web para info actualizada · Desenvolvido por Zénia-Projects
            </p>
        </div>
    </div>
</main>

<script>
// ═══════════════════════════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════════════════════════
const API_KEY       = "pk_urEpxcajGs5TF9Fs";
const CHAT_ENDPOINT = "https://gen.pollinations.ai/v1/chat/completions";
const IMG_BASE      = "https://image.pollinations.ai/prompt/";
const TTS_BASE      = "https://text.pollinations.ai/";

const chatWindow = document.getElementById('chat-window');
const userInput  = document.getElementById('user-input');
const sendBtn    = document.getElementById('send-btn');
const sendIcon   = document.getElementById('send-icon');

let isVoiceAssist = false;
let currentMode   = 'chat';
let conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
let currentConversationId = null;

// ═══════════════════════════════════════════════════════════
// MODO
// ═══════════════════════════════════════════════════════════
function setMode(mode) {
    currentMode = mode;
    const ph = {
        chat:  'Pergunte qualquer coisa à Zénia…',
        image: 'Descreve a imagem que queres gerar… (ex: pôr do sol em Luanda)',
        audio: 'Que música ou áudio queres? (ex: jazz relaxante, chuva tropical)',
        web:   'O que queres pesquisar na internet?'
    };
    userInput.placeholder = ph[mode] || ph.chat;
    ['chat','image','audio','web'].forEach(m =>
        document.getElementById('btn-mode-' + m).classList.toggle('active', m === mode)
    );
}

// ═══════════════════════════════════════════════════════════
// CONVERSAS
// ═══════════════════════════════════════════════════════════
function createConversation(title) {
    const id   = Date.now().toString();
    const conv = { id, title, messages: [] };
    conversations.unshift(conv);
    currentConversationId = id;
    persistConversations();
    renderHistoryList();
    return conv;
}
function getCurrentConversation() {
    return conversations.find(c => c.id === currentConversationId) || null;
}
function persistConversations() {
    localStorage.setItem('conversations', JSON.stringify(conversations));
}
function filterHistory(v) { renderHistoryList(v); }

function renderHistoryList(filter) {
    filter = filter || '';
    const hist = document.getElementById('history-list');
    hist.innerHTML = '<p class="text-xs text-gray-600 px-2 italic mb-1">Histórico Local</p>';
    const list = filter
        ? conversations.filter(c => c.title.toLowerCase().includes(filter.toLowerCase()))
        : conversations;
    if (!list.length) {
        const e = document.createElement('p');
        e.className = 'text-xs text-gray-600 px-2 italic';
        e.textContent = filter ? 'Nenhum resultado.' : 'Sem conversas ainda.';
        hist.appendChild(e); return;
    }
    list.forEach(function(conv) {
        const isActive = conv.id === currentConversationId;
        const item = document.createElement('div');
        item.className = 'history-item p-2 rounded-lg cursor-pointer text-[11px] text-gray-300 hover:bg-gray-800 transition'
            + (isActive ? ' bg-gray-800/60 border-l-2 border-blue-500 text-blue-400' : '');
        const left = document.createElement('div');
        left.className = 'flex items-center gap-2 overflow-hidden flex-1';
        left.onclick = function() { loadConversation(conv.id); };
        const icon  = document.createElement('i'); icon.className = 'far fa-comment-alt flex-shrink-0 text-gray-500';
        const title = document.createElement('span'); title.className = 'truncate'; title.textContent = conv.title || 'Conversa';
        left.appendChild(icon); left.appendChild(title);
        const del = document.createElement('button');
        del.title = 'Apagar'; del.className = 'text-gray-600 hover:text-red-500 transition flex-shrink-0';
        del.innerHTML = '<i class="fas fa-trash text-xs"></i>';
        del.onclick = function(e) { e.stopPropagation(); deleteConversation(conv.id); };
        item.appendChild(left); item.appendChild(del);
        hist.appendChild(item);
    });
}

function deleteConversation(id) {
    conversations = conversations.filter(c => c.id !== id);
    persistConversations();
    if (currentConversationId === id) startNewConversation();
    else renderHistoryList();
}

function loadConversation(id) {
    currentConversationId = id;
    chatWindow.innerHTML = '';
    hideWelcome();
    const conv = getCurrentConversation();
    if (!conv) return;
    conv.messages.forEach(function(m) {
        if (m.role !== 'system') renderMessageUI(m.role === 'user' ? 'user' : 'ai', m.content);
    });
    renderHistoryList();
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

function startNewConversation() {
    chatWindow.innerHTML = '';
    showWelcome();
    currentConversationId = null;
    renderHistoryList();
}

function hideWelcome() {
    var w = document.getElementById('welcome-msg');
    if (w) w.style.display = 'none';
}
function showWelcome() {
    var w = document.getElementById('welcome-msg');
    if (!w) {
        w = document.createElement('div');
        w.id = 'welcome-msg';
        w.className = 'flex flex-col items-center justify-center h-full text-center space-y-4 opacity-50';
        w.innerHTML = '<i class="fas fa-shield-cat text-6xl text-blue-500"></i><h2 class="text-2xl font-bold">Olá, eu sou a Zénia.</h2><p class="max-w-md text-sm">Criada no Lubango por Inácio U. Daniel.</p>';
        chatWindow.appendChild(w);
    } else { w.style.display = 'flex'; }
}

// ═══════════════════════════════════════════════════════════
// PESQUISA WEB — DuckDuckGo Instant Answers (sem chave, CORS livre)
// ═══════════════════════════════════════════════════════════
function needsWebSearch(text) {
    return /\b(2024|2025|2026|agora|hoje|actual|atualiz|recente|latest|current|version|versão|preço|price|quem é|presidente|notícia|news|lançamento|release|update|framework|library|npm|pip)\b/i.test(text);
}

async function webSearch(query) {
    var el = document.getElementById('web-status');
    el.classList.remove('hidden');
    try {
        var url = 'https://api.duckduckgo.com/?q=' + encodeURIComponent(query) + '&format=json&no_html=1&skip_disambig=1';
        var res  = await fetch(url);
        var data = await res.json();
        var parts = [];
        if (data.Answer)       parts.push('Resposta directa: ' + data.Answer);
        if (data.AbstractText) parts.push(data.AbstractText);
        if (data.RelatedTopics) {
            data.RelatedTopics.slice(0, 4).forEach(function(t) {
                if (t.Text) parts.push('• ' + t.Text);
            });
        }
        el.classList.add('hidden');
        var date = new Date().toLocaleDateString('pt-PT');
        return parts.length > 0
            ? '[PESQUISA WEB — ' + date + ' — "' + query + '"]:\n' + parts.join('\n')
            : '[Pesquisa web sem resultados relevantes para "' + query + '"]';
    } catch (err) {
        el.classList.add('hidden');
        return '[Pesquisa web indisponível: ' + err.message + ']';
    }
}

// ═══════════════════════════════════════════════════════════
// GERAÇÃO DE IMAGEM — Pollinations gratuito
// ═══════════════════════════════════════════════════════════
async function generateImage(prompt) {
    var seed    = Math.floor(Math.random() * 999999);
    var url     = IMG_BASE + encodeURIComponent(prompt) + '?width=768&height=512&seed=' + seed + '&nologo=true';

    var row = document.createElement('div');
    row.className = 'flex justify-start animate-fade-in';
    var card = document.createElement('div');
    card.className = 'media-card max-w-[80%]';
    card.innerHTML = '<div class="p-4 flex items-center gap-3 text-sm text-gray-400"><span class="loading-spinner"></span> A gerar imagem…</div>';
    row.appendChild(card); chatWindow.appendChild(row);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    var img = new Image();
    img.onload = function() {
        card.innerHTML =
            '<img src="' + url + '" alt="' + escHtml(prompt) + '" loading="lazy">' +
            '<div class="media-card-label"><i class="fas fa-image mr-1"></i>' + escHtml(prompt) + '</div>' +
            '<div class="media-actions">' +
                '<button class="media-btn" onclick="window.open(\'' + url + '\',\'_blank\')"><i class="fas fa-external-link-alt"></i> Abrir</button>' +
                '<a href="' + url + '" download="zenia-image.jpg" class="media-btn"><i class="fas fa-download"></i> Guardar</a>' +
            '</div>';
        chatWindow.scrollTop = chatWindow.scrollHeight;
    };
    img.onerror = function() {
        card.innerHTML = '<div class="p-4 text-yellow-400 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i>Imagem não gerada. Tenta uma descrição diferente.</div>';
    };
    img.src = url;
}

// ═══════════════════════════════════════════════════════════
// GERAÇÃO DE ÁUDIO — Pollinations TTS
// ═══════════════════════════════════════════════════════════
async function generateAudio(prompt) {
    var ttsText  = 'Aqui está o áudio que pediste sobre: ' + prompt;
    var audioUrl = TTS_BASE + encodeURIComponent(ttsText) + '?model=openai-audio&voice=alloy';
    var imgUrl   = IMG_BASE + encodeURIComponent('sound wave music equalizer dark neon') + '?width=600&height=160&nologo=true&seed=' + Date.now();

    var row = document.createElement('div');
    row.className = 'flex justify-start animate-fade-in';
    var card = document.createElement('div');
    card.className = 'media-card max-w-[85%] w-full';
    card.innerHTML =
        '<img src="' + imgUrl + '" alt="audio" style="height:100px;object-fit:cover;width:100%">' +
        '<div class="p-3">' +
            '<div class="text-xs text-green-400 mb-2"><i class="fas fa-music mr-1"></i>' + escHtml(prompt) + '</div>' +
            '<audio controls style="width:100%;border-radius:6px"><source src="' + audioUrl + '" type="audio/mpeg">Browser sem suporte.</audio>' +
        '</div>' +
        '<div class="media-actions">' +
            '<a href="' + audioUrl + '" download="zenia-audio.mp3" class="media-btn"><i class="fas fa-download"></i> Guardar</a>' +
        '</div>';
    row.appendChild(card); chatWindow.appendChild(row);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    renderMessageUI('ai', 'Audio gerado para: **' + prompt + '**\n\nPodes ouvir e descarregar acima. Para músicas com instrumentação complexa, experimenta Suno AI ou Udio.');
}

// ═══════════════════════════════════════════════════════════
// FETCH COM RETRY
// ═══════════════════════════════════════════════════════════
async function fetchWithRetry(messages, model, attempt) {
    attempt = attempt || 1;
    var MAX = 3;
    var ctrl  = new AbortController();
    var timer = setTimeout(function() { ctrl.abort(); }, 60000);

    try {
        var res = await fetch(CHAT_ENDPOINT, {
            method: 'POST',
            signal: ctrl.signal,
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + API_KEY },
            body: JSON.stringify({
                messages: messages,
                model: model,
                max_tokens: 4096,
                temperature: model === 'qwen-coder' ? 0.3 : 0.7,
                top_p: 1,
                stream: false,
                frequency_penalty: 0,
                presence_penalty: 0
            })
        });
        clearTimeout(timer);

        if (!res.ok) {
            var errText = await res.text();
            if (res.status === 429 && attempt < MAX) {
                await new Promise(function(r) { setTimeout(r, 2000 * attempt); });
                return fetchWithRetry(messages, model, attempt + 1);
            }
            throw new Error('HTTP ' + res.status + ': ' + errText);
        }

        var data    = await res.json();
        if (!data.choices || !data.choices[0] || !data.choices[0].message) throw new Error('Formato inesperado da API.');
        var content = (data.choices[0].message.content || '').trim();

        if (!content && attempt < MAX) {
            var chain = ['qwen-coder','openai-large','mistral','openai'];
            var next  = chain[(chain.indexOf(model) + 1) % chain.length];
            console.warn('Resposta vazia com "' + model + '", tentando "' + next + '"…');
            return fetchWithRetry(messages, next, attempt + 1);
        }
        if (!content) throw new Error('Resposta vazia após várias tentativas. Tenta reformular.');
        return content;

    } catch (err) {
        clearTimeout(timer);
        if (err.name === 'AbortError') {
            if (attempt < MAX) return fetchWithRetry(messages, model, attempt + 1);
            throw new Error('Tempo esgotado. Verifica a ligação.');
        }
        throw err;
    }
}

// ═══════════════════════════════════════════════════════════
// ENVIO — ROUTER PRINCIPAL
// ═══════════════════════════════════════════════════════════
async function handleSendMessage() {
    var text = userInput.value.trim();
    if (!text || sendBtn.disabled) return;

    var conv = getCurrentConversation();
    if (!conv) conv = createConversation(text.substring(0, 35) + (text.length > 35 ? '…' : ''));

    hideWelcome();
    renderMessageUI('user', text);
    userInput.value = '';
    autoResize(userInput);
    setLoading(true);

    // MODO IMAGEM
    if (currentMode === 'image' || /\b(gera?|cria?|faz|draw|desenha?|pinta?)\s+(uma?\s+)?(imagem|foto|image|picture|ilustra)/i.test(text)) {
        var imgPrompt = text.replace(/\b(gera?|cria?|faz|draw|desenha?|pinta?)\s+(uma?\s+)?(imagem|foto|image|picture|ilustra[çc][ãa]o)[\s:]*/i, '').trim() || text;
        await generateImage(imgPrompt);
        setLoading(false); return;
    }

    // MODO ÁUDIO
    if (currentMode === 'audio' || /\b(gera?|cria?|faz|toca?|compõe?)\s+(uma?\s+)?(música|musica|music|áudio|audio|som|song|beat)/i.test(text)) {
        var audPrompt = text.replace(/\b(gera?|cria?|faz|toca?|compõe?)\s+(uma?\s+)?(música|musica|music|áudio|audio|som|song|beat)[\s:]*/i, '').trim() || text;
        await generateAudio(audPrompt);
        setLoading(false); return;
    }

    var typingEl = renderTypingIndicator();

    try {
        // PESQUISA WEB automática para tópicos que podem estar desactualizados
        var webCtx = '';
        if (currentMode === 'web' || needsWebSearch(text)) {
            webCtx = await webSearch(text);
        }

        var today = new Date().toLocaleDateString('pt-PT');
        var systemMsg = {
            role: 'system',
            content: 'Tu és a IA-Zénia, criada no Lubango, Angola, por Inácio U. Daniel (Zénia-Projects). Modelo: zenia-full. Angola tem 21 províncias.\n\n'
                + 'REGRAS:\n'
                + '1. CÓDIGO: Sempre código completo e funcional em blocos ```linguagem. Nunca recuses.\n'
                + '2. ERROS: Marca problemas no código com "⚠️ ERRO:" antes da linha.\n'
                + '3. WEB: Se receberes [PESQUISA WEB...], usa SEMPRE essa info actualizada e diz que verificaste na internet.\n'
                + '4. DATA: Hoje é ' + today + '. O teu treino tem limite — usa dados web quando disponíveis.\n'
                + '5. Respondes em Português de Angola.'
        };

        var userContent = webCtx ? (webCtx + '\n\nPergunta: ' + text) : text;
        var messages = [systemMsg].concat(conv.messages).concat([{ role: 'user', content: userContent }]);

        // Auto-detecta pedidos de código
        var codeRx = /\b(código|code|script|função|function|html|css|javascript|python|java|typescript|sql|php|bash|react|vue|angular|api|algoritmo|classe|array|loop|def|const|let|import|component|bug|debug|implement)\b/i;
        var manualModel = document.getElementById('model-select').value;
        var autoModel   = codeRx.test(text) ? 'qwen-coder' : manualModel;

        var aiResponse = await fetchWithRetry(messages, autoModel);

        typingEl.remove();
        conv.messages.push({ role: 'user', content: text });
        conv.messages.push({ role: 'assistant', content: aiResponse });
        persistConversations();

        renderMessageUI('ai', aiResponse, !!webCtx);
        if (isVoiceAssist) speakText(aiResponse.replace(/```[\s\S]*?```/g, 'bloco de código omitido'));
        setApiStatus('ok');

    } catch (err) {
        typingEl.remove();
        console.error(err);
        renderMessageUI('ai', '⚠️ ' + err.message);
        setApiStatus('error');
    } finally {
        setLoading(false);
    }
}

// ═══════════════════════════════════════════════════════════
// SYNTAX HIGHLIGHTING + FORMATAÇÃO
// ═══════════════════════════════════════════════════════════
function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function highlightCode(code, lang) {
    try {
        if (lang && hljs.getLanguage(lang)) return hljs.highlight(code, { language: lang }).value;
        return hljs.highlightAuto(code).value;
    } catch(e) { return escHtml(code); }
}

// Marca linhas com padrões de erro — ficam em amarelo via CSS .error-line
function markErrorLines(html) {
    var errorPatterns = /error|exception|traceback|syntaxerror|typeerror|nameerror|valueerror|runtimeerror|referenceerror|undefined is not|cannot read|null pointer|segfault|failed|fatal|⚠️/i;
    return html.split('\n').map(function(line) {
        // Texto visível sem tags HTML
        var plain = line.replace(/<[^>]+>/g, '');
        return errorPatterns.test(plain) ? '<span class="error-line">' + line + '</span>' : line;
    }).join('\n');
}

function formatMessage(raw) {
    // 1. Blocos de código
    var html = raw.replace(/```([^\n`]*)\n?([\s\S]*?)```/g, function(_, lang, code) {
        lang = (lang || '').trim().toLowerCase();
        var highlighted = markErrorLines(highlightCode(code.trimEnd(), lang));
        var id = 'cb' + Math.random().toString(36).slice(2);
        return '<div class="code-block">'
            + '<div class="code-header">'
            +   '<span class="code-lang-label">' + (lang || 'código') + '</span>'
            +   '<button class="copy-btn" id="' + id + '-btn" onclick="copyCode(\'' + id + '\')">'
            +     '<i class="fas fa-copy"></i> Copiar'
            +   '</button>'
            + '</div>'
            + '<pre><code id="' + id + '" class="hljs">' + highlighted + '</code></pre>'
            + '</div>';
    });

    // 2. Código inline
    html = html.replace(/`([^`\n]+)`/g, '<code class="inline-code">$1</code>');
    // 3. Negrito
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    // 4. Itálico
    html = html.replace(/\*([^*\n]+)\*/g, '<em>$1</em>');
    // 5. Marcadores de erro em amarelo
    html = html.replace(/(⚠️\s*ERRO:[^\n<]*)/g, '<span class="error-marker">$1</span>');
    // 6. Quebras de linha
    html = html.replace(/\n/g, '<br>');

    return html;
}

function copyCode(id) {
    var el = document.getElementById(id);
    if (!el) return;
    navigator.clipboard.writeText(el.innerText).then(function() {
        var btn = document.getElementById(id + '-btn');
        if (btn) {
            btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
            setTimeout(function() { btn.innerHTML = '<i class="fas fa-copy"></i> Copiar'; }, 2000);
        }
    });
}

// ═══════════════════════════════════════════════════════════
// RENDER MENSAGEM
// ═══════════════════════════════════════════════════════════
function renderMessageUI(role, text, fromWeb) {
    fromWeb = fromWeb || false;
    var row = document.createElement('div');
    row.className = 'flex ' + (role === 'user' ? 'justify-end' : 'justify-start') + ' animate-fade-in';

    var bubble = document.createElement('div');
    bubble.className = 'max-w-[82%] p-4 rounded-2xl text-sm leading-relaxed ' + (role === 'user' ? 'bg-blue-600' : 'glass');
    bubble.style.wordBreak = 'break-word';

    if (role === 'ai') {
        if (fromWeb) {
            var badge = document.createElement('div');
            badge.className = 'web-badge';
            badge.innerHTML = '<i class="fas fa-globe"></i> Verificado na internet agora';
            bubble.appendChild(badge);
        }
        var content = document.createElement('div');
        content.innerHTML = formatMessage(text);
        bubble.appendChild(content);
    } else {
        bubble.style.whiteSpace = 'pre-wrap';
        bubble.textContent = text;
    }

    row.appendChild(bubble);
    chatWindow.appendChild(row);
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

function renderTypingIndicator() {
    var row = document.createElement('div');
    row.className = 'flex justify-start animate-fade-in';
    row.id = 'typing-indicator';
    row.innerHTML = '<div class="glass p-4 rounded-2xl flex items-center gap-2 text-sm text-gray-400"><span class="loading-spinner"></span><span>Zénia está a processar…</span></div>';
    chatWindow.appendChild(row);
    chatWindow.scrollTop = chatWindow.scrollHeight;
    return row;
}

function setLoading(on) {
    sendBtn.disabled = on;
    sendIcon.className = on ? 'loading-spinner' : 'fas fa-paper-plane';
}

// ═══════════════════════════════════════════════════════════
// SÍNTESE DE VOZ
// ═══════════════════════════════════════════════════════════
function populateVoices() {
    var sel    = document.getElementById('voice-select');
    var voices = speechSynthesis.getVoices();
    if (!voices.length) return;
    sel.innerHTML = '';
    voices.forEach(function(v, i) {
        var opt = document.createElement('option');
        opt.value = i; opt.textContent = v.name + ' (' + v.lang + ')';
        if (v.lang.startsWith('pt')) opt.selected = true;
        sel.appendChild(opt);
    });
}
if (typeof speechSynthesis !== 'undefined') {
    speechSynthesis.onvoiceschanged = populateVoices;
    populateVoices();
}

function speakText(text) {
    if (typeof speechSynthesis === 'undefined') return;
    speechSynthesis.cancel();
    var utter  = new SpeechSynthesisUtterance(text);
    var voices = speechSynthesis.getVoices();
    var idx    = parseInt(document.getElementById('voice-select').value);
    if (!isNaN(idx) && voices[idx]) { utter.voice = voices[idx]; utter.lang = voices[idx].lang; }
    else utter.lang = 'pt-PT';
    utter.rate = 1.0; speechSynthesis.speak(utter);
}

// ═══════════════════════════════════════════════════════════
// RECONHECIMENTO DE VOZ
// ═══════════════════════════════════════════════════════════
var micBtn = document.getElementById('mic-btn');
if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
    var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    var recognition = new SR();
    recognition.lang = 'pt-PT'; recognition.continuous = false;
    var listening = false;

    micBtn.onclick = function() {
        if (listening) { recognition.stop(); return; }
        try { recognition.start(); listening = true; micBtn.classList.add('recording'); } catch(e) {}
    };
    recognition.onresult = function(e) {
        userInput.value = e.results[0][0].transcript;
        autoResize(userInput); listening = false; micBtn.classList.remove('recording');
        handleSendMessage();
    };
    recognition.onerror = function(e) {
        listening = false; micBtn.classList.remove('recording');
        if (e.error !== 'no-speech') renderMessageUI('ai', '⚠️ Erro no microfone: ' + e.error);
    };
    recognition.onend = function() { listening = false; micBtn.classList.remove('recording'); };
} else {
    micBtn.disabled = true; micBtn.classList.add('opacity-30','cursor-not-allowed');
}

// ═══════════════════════════════════════════════════════════
// VOZ ASSIST
// ═══════════════════════════════════════════════════════════
function toggleVoiceAssist() {
    isVoiceAssist = !isVoiceAssist;
    var btn = document.getElementById('voice-assist-btn');
    if (isVoiceAssist) {
        btn.classList.remove('text-blue-500','border-blue-500','hover:bg-blue-500','hover:text-white');
        btn.classList.add('bg-red-600','text-white','border-red-600');
        renderMessageUI('ai', 'Modo Assistente de Voz ligado. Podes falar comigo.');
    } else {
        btn.classList.remove('bg-red-600','border-red-600');
        btn.classList.add('text-blue-500','border-blue-500','hover:bg-blue-500','hover:text-white');
        if (typeof speechSynthesis !== 'undefined') speechSynthesis.cancel();
    }
}

// ═══════════════════════════════════════════════════════════
// GALERIA
// ═══════════════════════════════════════════════════════════
function toggleGallery() {
    var g = document.getElementById('gallery-container');
    if (!g) {
        var parent = document.querySelector('button[onclick="toggleGallery()"]').parentElement;
        g = document.createElement('div'); g.id = 'gallery-container'; g.className = 'mt-3 grid grid-cols-3 gap-2';
        ['zenia1','zenia2','zenia3','zenia4','zenia5','zenia6'].forEach(function(seed) {
            var img = document.createElement('img');
            img.src = 'https://picsum.photos/seed/' + seed + '/300/200'; img.loading = 'lazy';
            img.className = 'rounded-lg border border-gray-800 hover:opacity-80 transition cursor-pointer';
            g.appendChild(img);
        });
        parent.appendChild(g);
    } else { g.style.display = g.style.display === 'none' ? '' : 'none'; }
}

// ═══════════════════════════════════════════════════════════
// API STATUS
// ═══════════════════════════════════════════════════════════
function setApiStatus(state) {
    var el  = document.getElementById('api-status');
    var map = { ok: ['status-ok','API: ativa ✓'], error: ['status-err','API: erro ✗'], wait: ['status-wait','API: verificando…'] };
    var cfg = map[state] || map.wait;
    el.className = 'text-[11px] px-2 py-1 rounded border ' + cfg[0];
    el.textContent = cfg[1];
}

async function updateApiStatus() {
    setApiStatus('wait');
    try {
        var r = await fetch(CHAT_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + API_KEY },
            body: JSON.stringify({ messages: [{ role: 'user', content: 'ping' }], model: 'openai', max_tokens: 5, stream: false })
        });
        setApiStatus(r.ok ? 'ok' : 'error');
    } catch { setApiStatus('error'); }
}

// ═══════════════════════════════════════════════════════════
// TEXTAREA AUTO-RESIZE + ENTER
// ═══════════════════════════════════════════════════════════
function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}
userInput.addEventListener('input', function() { autoResize(userInput); });
userInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); }
});

// ═══════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════
window.onload = function() {
    renderHistoryList();
    if (conversations.length > 0) loadConversation(conversations[0].id);
    updateApiStatus();
    setInterval(updateApiStatus, 30000);
};
</script>
</body>
</html>
