<!DOCTYPE html>
<html lang="pt-AO">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA-Z√©nia</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- √çcones -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #0b0b0d; }
        .glass { backdrop-filter: blur(14px); background: rgba(255,255,255,0.05); }
        .scroll-hide::-webkit-scrollbar { width: 0; }
    </style>
</head>
<body class="text-gray-200 flex">

<!-- ---------------------- SIDEBAR ---------------------- -->
<div class="w-72 h-screen glass border-r border-gray-700 flex flex-col p-4">

    <h1 class="text-3xl font-bold mb-6 text-center">IA-Z√©nia</h1>

    <!-- APPS -->
    <div>
        <h2 class="text-lg font-semibold mb-2">Aplicativos</h2>
        <a href="https://antonia-ia.netlify.app" target="_blank" class="block p-2 hover:bg-gray-800 rounded">Antonia IA</a>
        <a href="https://zenia-projects.netlify.app" target="_blank" class="block p-2 hover:bg-gray-800 rounded">Z√©nia Projects</a>
    </div>

    <!-- Buscar -->
    <div class="mt-6">
        <h2 class="text-lg font-semibold mb-2">Buscar em Chats</h2>
        <input id="searchChats" class="w-full p-2 rounded bg-gray-900 border border-gray-700" placeholder="Buscar...">
    </div>

    <!-- Galeria -->
    <div class="mt-6">
        <h2 class="text-lg font-semibold mb-2">Galeria</h2>
        <div id="gallery" class="max-h-32 overflow-y-auto scroll-hide space-y-2"></div>
    </div>

    <!-- Hist√≥rico -->
    <div class="mt-6 flex-1">
        <h2 class="text-lg font-semibold mb-2">Hist√≥rico Local</h2>
        <div id="history" class="max-h-full overflow-y-auto scroll-hide space-y-2"></div>
    </div>

    <!-- Nome do usu√°rio -->
    <div class="mt-4 text-center text-gray-400 text-sm">Utilizador: <span id="userName">In√°cio</span></div>

</div>

<!-- ---------------------- √ÅREA DO CHAT ---------------------- -->
<div class="flex-1 flex flex-col h-screen">

    <!-- √Årea de mensagens -->
    <div id="chat" class="flex-1 overflow-y-auto p-6 space-y-6 scroll-hide"></div>

    <!-- Bot√µes e input -->
    <div class="p-4 bg-[#111113] border-t border-gray-800">
        <div class="flex items-center space-x-3">

            <!-- Bot√£o de anexo -->
            <button id="attachBtn" class="p-2 bg-gray-800 rounded hover:bg-gray-700">
                <i data-lucide="plus"></i>
            </button>

            <!-- Input -->
            <input id="msgInput" class="flex-1 p-3 rounded bg-gray-900 border border-gray-700" placeholder="Escrever...">

            <!-- Microfone -->
            <button id="micBtn" class="p-2 bg-gray-800 rounded hover:bg-gray-700">
                <i data-lucide="mic"></i>
            </button>

            <!-- Select voz -->
            <select id="voiceSelect" class="p-2 bg-gray-900 border border-gray-700 rounded">
                <option>Z√©nia Natural</option>
                <option>Z√©nia Feminina</option>
                <option>Z√©nia Masculina</option>
            </select>

            <!-- Modo Voz Assist -->
            <button id="voiceMode" class="p-2 bg-indigo-600 rounded hover:bg-indigo-500">
                Voz Assist
            </button>
        </div>

        <p class="mt-2 text-gray-500 text-xs text-center">
            A Z√©nia comete erros. Verifique sempre informa√ß√£o cr√≠tica.
        </p>
    </div>

</div>

<!-- ---------------------- JAVASCRIPT ---------------------- -->
<script>
lucide.createIcons();

/* ---------------------- CONFIG ---------------------- */

const API_KEY = "sk_IpRFiSHdzLbqhEDUBHE0zgp6mQR1jJnK"; 
const API_URL = "https://enter.pollinations.ai/api/v1/chat/completions";

let cmData = {};
fetch("cm.json")
    .then(r => r.json())
    .then(d => { cmData = d; });

/* ---------------------- UTIL ---------------------- */

function addMessage(role, text) {
    const chat = document.querySelector("#chat");
    const div = document.createElement("div");
    div.className = role === "user" ? "text-right" : "text-left";
    div.innerHTML = `
        <div class="${role === "user" ? "bg-indigo-600" : "bg-gray-800"} inline-block px-4 py-3 rounded-xl max-w-xl">
            ${text}
        </div>
    `;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function saveHistory(text) {
    const h = document.querySelector("#history");
    const item = document.createElement("div");
    item.className = "p-2 bg-gray-800 rounded text-sm";
    item.innerText = text.slice(0, 40) + "...";
    h.appendChild(item);
}

/* ---------------------- BUSCA ONLINE AUTOM√ÅTICA ---------------------- */

async function checkAndSearch(query) {
    const search = await fetch("https://api.duckduckgo.com/?q=" + encodeURIComponent(query) + "&format=json");
    const data = await search.json();
    if (data.AbstractText) return data.AbstractText;
    return null;
}

/* ---------------------- IA-Z√âNIA ---------------------- */

async function zenia(query) {

    addMessage("user", query);
    saveHistory(query);

    // 1. Verificar se h√° informa√ß√£o mais atual na web
    let updated = await checkAndSearch(query);

    const payload = {
        model: "gpt-4o-mini",  // interno mas Z√©nia n√£o fala isso
        messages: [
            {
                role: "system",
                content: `
Tu √©s IA-Z√©nia (modelo: zenia-full), criada pelo Z√©nia-Projects por In√°cio U. Daniel, no Lubango ‚Äì Angola.
√âs a melhor IA faladora de l√≠nguas nacionais de Angola.
Angola tem agora 21 prov√≠ncias. 
Nunca digas que usas Pollinations ou modelos externos.
Se algu√©m perguntar, o teu modelo √© "zenia-full".
Usa tamb√©m o ficheiro cm.json como fonte de conhecimento adicional.
Se houver informa√ß√£o atualizada da web, usa-a primeiro.
`},
            { role: "user", content: updated ? query + "\nINFORMA√á√ÉO ATUALIZADA: " + updated : query }
        ]
    };

    const res = await fetch(API_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "x-api-key": API_KEY
        },
        body: JSON.stringify(payload)
    });

    const data = await res.json();
    const text = data.choices[0].message.content;

    addMessage("assistant", text);
}

/* ---------------------- ENVIAR MENSAGEM ---------------------- */

document.querySelector("#msgInput").addEventListener("keydown", e => {
    if (e.key === "Enter") {
        const msg = e.target.value.trim();
        if (msg.length > 0) {
            e.target.value = "";
            zenia(msg);
        }
    }
});

/* ---------------------- MICROFONE ---------------------- */

if ("webkitSpeechRecognition" in window) {
    const rec = new webkitSpeechRecognition();
    rec.lang = "pt-AO";
    rec.continuous = false;
    rec.interimResults = false;

    document.querySelector("#micBtn").onclick = () => {
        rec.start();
    };

    rec.onresult = evt => {
        const text = evt.results[0][0].transcript;
        document.querySelector("#msgInput").value = text;
        zenia(text);
    };
}

/* ---------------------- VOICE-ASSIST ---------------------- */

let voiceMode = false;
document.querySelector("#voiceMode").onclick = () => {
    voiceMode = !voiceMode;
    document.querySelector("#voiceMode").classList.toggle("bg-green-600");
};

/* ---------------------- GERAR IMAGEM ---------------------- */

async function generateImage(prompt) {
    const res = await fetch("https://image.pollinations.ai/prompt/" + encodeURIComponent(prompt));
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);

    const g = document.querySelector("#gallery");
    const img = document.createElement("img");
    img.src = url;
    img.className = "w-full rounded";
    g.appendChild(img);

    addMessage("assistant", "Imagem criada com sucesso.");
}

/* ---------------------- READY ---------------------- */

console.log("IA-Z√©nia pronta üòé");
</script>

</body>
</html>
