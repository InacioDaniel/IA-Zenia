<!DOCTYPE html>
<html lang="pt-AO">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>IA-ZÃ©nia by ZÃ©nia-Projects</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
/* =========================================
Â  Â TEMA BLUE FUTURISTA - VARIÃVEIS
========================================= */
:root {
Â  Â  --accent: #00eaff;Â  Â  Â  Â Â 
Â  Â  --accent-alt: #0066ff;Â  Â Â 
Â  Â  --bg: #020617;Â  Â  Â  Â  Â  Â Â 
Â  Â  --panel: #0b1124;Â  Â  Â  Â  Â 
Â  Â  --border: #1e3a8a;Â  Â  Â  Â Â 
Â  Â  --text-light: #e0f2fe;Â  Â Â 
Â  Â  --text-dark: #020617;Â  Â  Â 
Â  Â  --neon-glow: 0 0 15px rgba(0, 234, 255, 0.6), 0 0 30px rgba(0, 102, 255, 0.4);
}

.text-blue-500 { color: var(--accent) !important; }
.text-red-500 { color: #ff3366 !important; }
.border-zinc-800 { border-color: var(--border) !important; }
.bg-black\/30 { background-color: rgba(2, 6, 23, 0.5) !important; }

body {Â 
Â  Â  background: linear-gradient(135deg, var(--bg) 0%, #000000 100%);Â 
Â  Â  color: var(--text-light);Â 
Â  Â  font-family: 'Plus Jakarta Sans', sans-serif;Â 
Â  Â  margin: 0; height: 100vh; display: flex; overflow: hidden;Â 
}

/* SIDEBAR */
.sidebar {Â 
Â  Â  width: 280px;Â 
Â  Â  background: linear-gradient(to bottom, var(--panel), var(--bg));
Â  Â  border-right: 1px solid var(--border);Â 
Â  Â  display: flex; flex-direction: column; transition: .3s;Â 
Â  Â  box-shadow: 5px 0 15px rgba(0, 102, 255, 0.1);
Â  Â  z-index: 100;
}
@media(max-width:768px){Â 
Â  Â  .sidebar{position:fixed;left:-100%;top:0;height:100%; width: 85%; max-width: 300px; box-shadow: 10px 0 50px rgba(0,0,0,0.8);}Â 
Â  Â  .sidebar.active{left:0;}Â 
Â  Â  .sidebar-overlay {
Â  Â  Â  Â  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
Â  Â  Â  Â  background: rgba(0,0,0,0.7); backdrop-filter: blur(3px);
Â  Â  Â  Â  z-index: 90; display: none; opacity: 0; transition: opacity .3s;
Â  Â  }
Â  Â  .sidebar-overlay.active { display: block; opacity: 1; }
}

.main-content { flex:1; display:flex; flex-direction:column; overflow:hidden; width:100%; position: relative; }

/* CHAT AREA */
.chat-container {Â 
Â  Â  flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth;Â 
Â  Â  background: radial-gradient(circle at center, #0b1124 0%, var(--bg) 70%);
}

.hist-item {Â 
Â  Â  padding: 12px; border-radius: 12px; background: rgba(11, 17, 36, 0.6); margin-bottom: 10px; cursor: pointer;Â 
Â  Â  border: 1px solid var(--border); font-size: 13px; display: flex; justify-content: space-between; align-items: center; transition: all .3s ease;Â 
}
.hist-item:hover { border-color: var(--accent); background: linear-gradient(to right, rgba(0, 234, 255, 0.1), rgba(0, 102, 255, 0.2)); }
.hist-item.active { border-color: var(--accent-alt); background: linear-gradient(to right, rgba(0, 102, 255, 0.3), rgba(11, 17, 36, 0.8)); box-shadow: var(--neon-glow); }
.hist-item button { color: #666; transition: .2s; } .hist-item button:hover { color: #ff3366; }

.btn-new {Â 
Â  Â  background: linear-gradient(135deg, var(--accent), var(--accent-alt));Â 
Â  Â  color: #fff; padding: 12px; border-radius: 12px; font-weight: 800; text-align: center; margin-bottom: 20px; cursor: pointer; transition: .3s;Â 
Â  Â  text-shadow: 0 1px 2px rgba(0,0,0,0.3); box-shadow: 0 4px 15px rgba(0, 102, 255, 0.3);
}
.btn-new:hover { transform: translateY(-2px) scale(1.02); box-shadow: var(--neon-glow); }

.btn-close-sidebar {
Â  Â  display: none; margin-bottom: 15px; padding: 10px; background: rgba(255, 51, 102, 0.2); border: 1px solid #ff3366;Â 
Â  Â  color: #ff3366; font-weight: bold; border-radius: 8px; text-align: center; cursor: pointer;
}
@media(max-width:768px){ .btn-close-sidebar{display:block;} }

.msg-wrapper { display:flex; flex-direction:column; max-width:90%; gap:5px; position:relative; animation:fadeIn .3s ease; }
.msg { padding: 15px; border-radius: 18px; line-height: 1.6; font-size: 14px; word-wrap: break-word; transition: .3s; backdrop-filter: blur(5px); }
.ai-msg { align-self: flex-start; border: 1px solid var(--border); border-left: 4px solid var(--accent); background: linear-gradient(135deg, var(--panel), rgba(2, 6, 23, 0.8)); color: var(--text-light); }
.user-msg { align-self: flex-end; background: linear-gradient(135deg, var(--accent-alt), var(--accent)); color: #fff; border: none; box-shadow: 0 5px 15px rgba(0, 102, 255, 0.4); }
.msg-controls { display:flex; gap:12px; margin-top:4px; padding:0 10px; font-size:11px; color:#64748b; }
.ctrl-btn { cursor:pointer; transition:.2s; } .ctrl-btn:hover { color:var(--accent); }

.code-container { border-radius:12px; overflow:hidden; margin:15px 0; border:1px solid var(--border); background: #000; width:100%; box-shadow: 0 0 20px rgba(0, 102, 255, 0.1); }
.code-header { background: var(--panel); padding:8px 15px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); }
.btn-action { font-size:10px; font-weight:bold; padding:4px 8px; border-radius:6px; background: rgba(0, 102, 255, 0.2); color: var(--accent); border:1px solid var(--border); cursor:pointer; transition:.2s; }

/* INPUT MOBILE FIXED */
.footer-input { background: linear-gradient(to top, var(--bg) 0%, rgba(11, 17, 36, 0.95) 100%); padding: env(safe-area-inset-bottom, 10px) 10px 10px 10px; border-top: 1px solid var(--border); }
.footer-input-inner { max-width: 860px; margin: 0 auto; background: rgba(11, 17, 36, 0.5); border-radius: 20px; padding: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; backdrop-filter: blur(10px); }

.voice-bar { display:flex; align-items:center; gap:8px; padding:6px 10px; background: rgba(2, 6, 23, 0.6); border-radius:12px; border:1px solid var(--border); width:100%; box-sizing:border-box; }
.voice-bar select { background: transparent; color: var(--accent); border: none; font-size: 12px; outline: none; cursor: pointer; flex: 1; }
.voice-bar option { background: var(--panel); }

.input-row { display: flex; gap: 8px; width: 100%; align-items: center; }
textarea { flex:1; min-width:0; background:transparent; border:none; outline:none; color:var(--text-light); font-size:15px; padding:10px; max-height:120px; resize:none; font-family:inherit; }

button.action-btn { width: 40px; height: 40px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: .3s; }
button.send-btn { background: linear-gradient(135deg, var(--accent), var(--accent-alt)); color: #fff; box-shadow: 0 0 10px rgba(0, 234, 255, 0.3); }
button.upload-btn { background: rgba(255, 255, 255, 0.1); color: var(--accent); border: 1px solid var(--border); }

/* IMAGEM E MODELO LOADER */
.img-preview-msg { max-width: 200px; border-radius: 12px; border: 1px solid var(--border); margin-top: 5px; }
.vision-status { font-size: 11px; color: var(--accent); margin-top: 5px; font-style: italic; display: flex; align-items: center; gap: 5px; }
.vision-status.loading::after { content: ''; width: 10px; height: 10px; border: 2px solid var(--accent); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }

@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
@keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* AUDIO PLAYER */
.audio-player { display: flex; align-items: center; gap: 10px; background: linear-gradient(135deg, var(--panel), rgba(30, 58, 138, 0.3)); border: 1px solid var(--border); border-radius: 14px; padding: 12px 14px; margin: 8px 0; width: 100%; box-sizing: border-box; }
.play-btn { width: 35px; height: 35px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-alt)); border: none; cursor: pointer; color: #fff; flex-shrink: 0; }
.progress-wrap { flex: 1; display: flex; flex-direction: column; gap: 4px; }
.audio-progress-bg { height: 4px; background: rgba(0,0,0,0.3); position: relative; cursor: pointer; }
.audio-progress-fill { height: 100%; width: 0%; background: var(--accent); }
.audio-time { font-size: 10px; color: #aaa; text-align: right; }

@media(max-width:768px){ .chat-container{padding:15px} .footer-input-inner { gap: 6px; } .voice-bar { order: -1; } }
</style>
</head>
<body>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="window.toggleSidebar()"></div>

<aside class="sidebar p-4" id="sidebar">
Â  Â  <button class="btn-close-sidebar" onclick="window.toggleSidebar()">âœ• FECHAR MENU</button>
Â  Â  <div class="btn-new" onclick="window.startNewChat()">+ NOVA CONVERSA</div>
Â  Â  <h2 class="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">HistÃ³rico Local</h2>
Â  Â  <div id="historyList" class="flex-1 overflow-y-auto pr-1 custom-scrollbar"></div>
Â  Â  <div class="mt-auto pt-4 border-t border-slate-800 space-y-2">
Â  Â  Â  Â  <h2 class="text-[9px] font-bold text-slate-500 uppercase mb-2">Links</h2>
Â  Â  Â  Â  <a href="https://zenia-projects.netlify.app" target="_blank" class="block text-xs text-blue-400">ğŸŒ Zenia Projects</a>
Â  Â  </div>
</aside>

<main class="main-content">
Â  Â  <header class="p-4 border-b border-slate-800 flex justify-between items-center bg-black/30 backdrop-blur-md z-10">
Â  Â  Â  Â  <div class="flex items-center gap-4">
Â  Â  Â  Â  Â  Â  <button onclick="window.toggleSidebar()" class="md:hidden text-white font-bold text-lg">â˜°</button>
Â  Â  Â  Â  Â  Â  <h1 class="text-xl font-black italic tracking-wider">IA-ZÃ‰NIA <span class="text-blue-500 text-xs font-normal" style="text-shadow: 0 0 10px rgba(0,234,255,0.5);">VISION</span></h1>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button onclick="window.clearAllData()" class="text-[10px] text-red-500 font-bold hover:underline">APAGAR TUDO</button>
Â  Â  </header>

Â  Â  <div id="chatBox" class="chat-container custom-scrollbar"></div>

Â  Â  <div class="footer-input z-20">
Â  Â  Â  Â  <div class="footer-input-inner">
Â  Â  Â  Â  Â  Â  <div class="voice-bar">
Â  Â  Â  Â  Â  Â  Â  Â  <label>ğŸ¤ Voz:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="voiceSelect">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="nova">Nova</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="alloy">Alloy</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="echo">Echo</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="shimmer">Shimmer</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="native">ğŸŒ Voz Nativa</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="input-row">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="imgUpload" accept="image/*" hidden>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn upload-btn" onclick="document.getElementById('imgUpload').click()" title="Carregar Imagem">ğŸ‘ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="userInput" placeholder="Mostra-me uma foto ou escreve..." oninput="autoGrow(this)"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn send-btn" onclick="window.handleSend()">ğŸš€</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</main>

<div style="position:fixed;top:10px;right:15px;padding:8px 15px;background:rgba(2, 6, 23, 0.8);color:var(--accent);border:1px solid var(--accent);border-radius:20px;font-size:12px;font-weight:bold;backdrop-filter:blur(10px);z-index:9999;">
Â  Â  ğŸ”µ <span id="viewsNumber">0</span> VISITANTES
</div>

<script type="module">
/* ============================================================
Â  Â IMPORTS & SETUP (Transformers.js)
============================================================ */
// Importa biblioteca de VisÃ£o diretamente do CDN (Sem API KEY, roda local/browser)
import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.16.0';

// Configura para nÃ£o buscar modelos locais, mas sim do Hub (cacheado no browser)
env.allowLocalModels = false;
env.useBrowserCache = true;

// VariÃ¡vel para guardar o modelo carregado
let visionPipeline = null;

/* ============================================================
Â  Â FUNÃ‡Ã•ES GLOBAIS (Expondo para o HTML)
============================================================ */
window.toggleSidebar = function(){Â 
Â  Â  document.getElementById("sidebar").classList.toggle("active");Â 
Â  Â  document.getElementById("sidebarOverlay").classList.toggle("active");
}
window.autoGrow = function(el){ el.style.height="auto"; el.style.height=el.scrollHeight+"px"; }
window.clearAllData = function(){ if(confirm("Apagar tudo?")){ localStorage.clear(); location.reload(); } }
window.startNewChat = startNewChat;
window.handleSend = handleSend;

/* ============================================================
Â  Â VISITOR COUNTER
============================================================ */
(function(){
Â  Â  let v = localStorage.getItem("zenia_global_views");
Â  Â  v = v ? parseInt(v)+1 : 1;
Â  Â  localStorage.setItem("zenia_global_views", v);
Â  Â  document.getElementById("viewsNumber").textContent = v;
})();

/* ============================================================
Â  Â GLOBALS
============================================================ */
const chatBoxÂ  Â  Â = document.getElementById('chatBox');
const historyList = document.getElementById('historyList');
const userInputÂ  Â = document.getElementById('userInput');
const voiceSelect = document.getElementById('voiceSelect');
const imgUploadÂ  Â = document.getElementById('imgUpload');

let sessionsÂ  Â  Â  Â  = JSON.parse(localStorage.getItem('zenia_sessions')||'[]');
let currentSessionId = null;
const codeStoreÂ  Â  Â = new Map();
letÂ  codeIdCounterÂ  = 0;

/* ============================================================
Â  Â IMAGE ANALYSIS LOGIC (REAL VISION)
============================================================ */
// Event Listener para Upload
imgUpload.addEventListener('change', async function(e){
Â  Â  if(e.target.files && e.target.files[0]){
Â  Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â Â 
Â  Â  Â  Â  reader.onload = async function(event){
Â  Â  Â  Â  Â  Â  const imageUrl = event.target.result;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 1. Mostrar imagem no chat
Â  Â  Â  Â  Â  Â  const msgId = 'img-' + Date.now();
Â  Â  Â  Â  Â  Â  const wrapper = addMessage(`ğŸ“ Imagem carregada:<br><img src="${imageUrl}" class="img-preview-msg"><div id="${msgId}" class="vision-status loading">A carregar modelo de visÃ£o neuronal...</div>`, true);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. Processar com Transformers.js
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const statusEl = document.getElementById(msgId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Carregar modelo se ainda nÃ£o existe (primeira vez demora)
Â  Â  Â  Â  Â  Â  Â  Â  if(!visionPipeline){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.innerText = "A baixar modelo de IA (sÃ³ 1Âª vez)...";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Usando um modelo leve de Image Captioning
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  visionPipeline = await pipeline('image-to-text', 'Xenova/vit-gpt2-image-captioning');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  statusEl.innerText = "A analisar pixeis...";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Analisar a imagem
Â  Â  Â  Â  Â  Â  Â  Â  const output = await visionPipeline(imageUrl);
Â  Â  Â  Â  Â  Â  Â  Â  const description = output[0].generated_text; // Ex: "a cat sitting on a table"
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.className = "vision-status";
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.innerText = `âœ… Detectado: "${description}"`;

Â  Â  Â  Â  Â  Â  Â  Â  // 3. Enviar contexto para o cÃ©rebro da ZÃ©nia (Mistral)
Â  Â  Â  Â  Â  Â  Â  Â  // O Mistral nÃ£o vÃª a imagem, mas nÃ³s passamos a descriÃ§Ã£o do que a visÃ£o detectou
Â  Â  Â  Â  Â  Â  Â  Â  const hiddenPrompt = `[CONTEXTO DE VISÃƒO: O usuÃ¡rio enviou uma imagem. A minha rede neural de visÃ£o detectou: "${description}". Use isso como base, mas responda em PortuguÃªs de Angola.] O que vÃªs nesta imagem?`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  window.handleSend(hiddenPrompt, true); // true = modo sistema (nÃ£o mostra texto balÃ£o)

Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(msgId).innerText = "âŒ Erro ao processar imagem (Navegador incompatÃ­vel?)";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  }
});

/* ============================================================
Â  Â SYSTEM PROMPT
============================================================ */
const ZENIA_SYSTEM = `VocÃª Ã© IA-ZÃ‰NIA do Lubango.
1. Se receberes [CONTEXTO DE VISÃƒO], descreva a imagem baseada na detecÃ§Ã£o em inglÃªs traduzindo para PortuguÃªs de forma natural e criativa.
2. NÃ£o diga "O texto diz que Ã© um gato", diga "Eu vejo um gato...".
3. Geras imagens se pedirem.
4. Crias mÃºsicas se pedirem.`;

/* ============================================================
Â  Â CORE FUNCTIONS
============================================================ */
function init(){
Â  Â  renderHistory();
Â  Â  sessions.length>0 ? loadSession(sessions[sessions.length-1].id) : startNewChat();
}

function startNewChat(){
Â  Â  currentSessionId=Date.now(); chatBox.innerHTML='';
Â  Â  addMessage("Onawa ! Sou a IA-ZÃ‰NIA. Posso 'ver' imagens agora. Mostra-me algo!",false);
Â  Â  renderHistory();
}

async function handleSend(textOverride, isSystemPrompt){
Â  Â  const query = (textOverride || userInput.value).trim();
Â  Â  if(!query) return;

Â  Â  if(!isSystemPrompt) {
Â  Â  Â  Â  addMessage(query, true);
Â  Â  Â  Â  userInput.value=''; userInput.style.height='auto';
Â  Â  }

Â  Â  // Comandos Especiais
Â  Â  if(isMusicRequest(query)) { handleMusic(query); return; }
Â  Â  if(isImageRequest(query)) { handleImageGen(query); return; }
Â  Â  if(isAudioRequest(query)) { handleTTS(query); return; }

Â  Â  // Texto Normal (Brain)
Â  Â  const loadT = addMessage("ZÃ©nia estÃ¡ a analisar...", false);
Â  Â Â 
Â  Â  // Construir contexto
Â  Â  const context = buildContext(query);
Â  Â Â 
Â  Â  try{
Â  Â  Â  Â  const res = await fetch('https://text.pollinations.ai/'+encodeURIComponent(context)+'?model=mistral');
Â  Â  Â  Â  const text = await res.text();
Â  Â  Â  Â  loadT.remove();
Â  Â  Â  Â  processResponse(text, query);
Â  Â  } catch(e){Â 
Â  Â  Â  Â  loadT.querySelector('.msg').innerText='âš ï¸ Erro na conexÃ£o.';Â 
Â  Â  }
}

/* ============================================================
Â  Â HANDLERS ESPECÃFICOS
============================================================ */
async function handleMusic(query){
Â  Â  const loadM = addMessage("ğŸµ A compor letra...", false);
Â  Â  const prompt = "Escreve letra de mÃºsica sobre: " + query;
Â  Â  const res = await fetch('https://text.pollinations.ai/'+encodeURIComponent(prompt));
Â  Â  const lyrics = await res.text();
Â  Â  loadM.remove();
Â  Â  processResponse("ğŸµ **MÃºsica:**\n\n"+lyrics, query);
Â  Â  // Auto-play TTS
Â  Â  generateAudio(lyrics.substring(0, 200), query, null, true);Â 
}

function handleImageGen(query){
Â  Â  const loadI = addMessage("ğŸ¨ A pintar...", false);
Â  Â  const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(query)}?width=1024&height=1024&nologo=true&model=flux`;
Â  Â  loadI.remove();
Â  Â  processResponse(`![ARTE](${url})`, query);
}

function handleTTS(query){
Â  Â  const txt = query.replace(/^(fala|diz|lÃª)\s*[:\-]?\s*/i,'');
Â  Â  generateAudio(txt, query, addMessage("ğŸ”Š A gravar...", false), false);
}

/* ============================================================
Â  Â AUDIO & UTILS
============================================================ */
async function generateAudio(text, originalQuery, loadingWrapper, isMusic){
Â  Â  const voice = voiceSelect.value;
Â  Â  if(loadingWrapper) loadingWrapper.remove();
Â  Â Â 
Â  Â  if(voice === 'native'){
Â  Â  Â  Â  const u = new SpeechSynthesisUtterance(text);
Â  Â  Â  Â  u.lang = 'pt-PT'; u.rate = 1.1;
Â  Â  Â  Â  window.speechSynthesis.speak(u);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // Usando API Pollinations TTS
Â  Â  const url = `https://text.pollinations.ai/${encodeURIComponent(text)}?model=openai-audio&voice=${voice}`;
Â  Â  createAudioPlayer(url, voice, text, isMusic);
}

function createAudioPlayer(src, voice, text, isMusic){
Â  Â  const wrapper = document.createElement('div');
Â  Â  wrapper.className = 'msg-wrapper ai-wrapper';
Â  Â  wrapper.innerHTML = `
Â  Â  Â  Â  <div class="audio-player" style="${isMusic?'border-color:var(--accent-alt)':''}">
Â  Â  Â  Â  Â  Â  <button class="play-btn" onclick="this.nextElementSibling.play()">â–¶</button>
Â  Â  Â  Â  Â  Â  <audio src="${src}" onended="this.previousElementSibling.innerText='â–¶'" onplay="this.previousElementSibling.innerText='â¸'"></audio>
Â  Â  Â  Â  Â  Â  <div class="progress-wrap">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="audio-label">${isMusic?'ğŸµ MÃºsica':'ğŸ”Š Ãudio'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="audio-voice">${voice}</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;
Â  Â  chatBox.appendChild(wrapper);
Â  Â  chatBox.scrollTop = chatBox.scrollHeight;
}

/* ============================================================
Â  Â HELPERS (Context, Hist, UI)
============================================================ */
function buildContext(q){
Â  Â  const s = sessions.find(x => x.id===currentSessionId);
Â  Â  let hist = "";
Â  Â  if(s) hist = s.messages.slice(-6).map(m => (m.role==='user'?'User':'AI')+': '+m.text).join('\n');
Â  Â  return `${ZENIA_SYSTEM}\n\nHistÃ³rico:\n${hist}\n\nUsuÃ¡rio: ${q}`;
}

function processResponse(text, query){
Â  Â  const wrapper = document.createElement('div');
Â  Â  wrapper.className='msg-wrapper ai-wrapper';
Â  Â Â 
Â  Â  // Check imagem
Â  Â  const imgMatch = text.match(/!\[.*?\]\((.*?)\)/);
Â  Â  if(imgMatch){
Â  Â  Â  Â  wrapper.innerHTML += `<img src="${imgMatch[1]}" class="art-img" style="display:block" onload="this.scrollIntoView()">`;
Â  Â  Â  Â  text = text.replace(imgMatch[0], '');
Â  Â  }
Â  Â Â 
Â  Â  if(text.trim()) wrapper.innerHTML += `<div class="msg ai-msg">${formatAI(escapeHTML(text))}</div>`;
Â  Â Â 
Â  Â  chatBox.appendChild(wrapper);
Â  Â  chatBox.scrollTop=chatBox.scrollHeight;
Â  Â Â 
Â  Â  // Save session logic here (simplified)
Â  Â  if(currentSessionId){
Â  Â  Â  Â  const s = sessions.find(x => x.id===currentSessionId);
Â  Â  Â  Â  if(s) {
Â  Â  Â  Â  Â  Â  s.messages.push({role:'user',text:query}, {role:'ai',text:text});
Â  Â  Â  Â  Â  Â  localStorage.setItem('zenia_sessions',JSON.stringify(sessions));
Â  Â  Â  Â  Â  Â  renderHistory();
Â  Â  Â  Â  }
Â  Â  }
}

function addMessage(t, isUser){
Â  Â  const w=document.createElement('div');
Â  Â  w.className='msg-wrapper '+(isUser?'user-wrapper':'ai-wrapper');
Â  Â  w.innerHTML='<div class="msg '+(isUser?'user-msg':'ai-msg')+'">'+(isUser?t:formatAI(t))+'</div>';
Â  Â  chatBox.appendChild(w);
Â  Â  chatBox.scrollTop=chatBox.scrollHeight;
Â  Â  return w;
}

function renderHistory(){
Â  Â  historyList.innerHTML='';
Â  Â  sessions.slice().reverse().forEach(s => {
Â  Â  Â  Â  const item=document.createElement('div');
Â  Â  Â  Â  item.className='hist-item'+(s.id===currentSessionId?' active':'');
Â  Â  Â  Â  item.innerHTML=`<span>${escapeHTML(s.title || 'Conversa')}</span>`;
Â  Â  Â  Â  item.onclick = () => { currentSessionId=s.id; chatBox.innerHTML=''; s.messages.forEach(m => addMessage(m.text, m.role==='user')); renderHistory(); };
Â  Â  Â  Â  historyList.appendChild(item);
Â  Â  });
}

function isImageRequest(q){ return /desenha|gera\s*(uma\s*)?(imagem|arte)/i.test(q); }
function isMusicRequest(q){ return /cria\s*mÃºsica|letra/i.test(q); }
function isAudioRequest(q){ return /fala|diz|lÃª/i.test(q); }
function formatAI(t){ return t.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\n/g,'<br>'); }
function escapeHTML(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

// Iniciar
init();

</script>
</body>
</html>

