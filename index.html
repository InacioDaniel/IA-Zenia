<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA-Z√âNIA | Lubango Core</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background: #010409; color: #e6edf3; font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; display: flex; overflow: hidden; margin: 0; }
        .sidebar { width: 280px; background: #0d1117; border-right: 1px solid #30363d; display: flex; flex-direction: column; }
        .history-item { padding: 10px; border-radius: 8px; cursor: pointer; font-size: 13px; margin-bottom: 5px; transition: 0.2s; border: 1px solid transparent; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .history-item:hover { background: #161b22; border-color: #30363d; }
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; }
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .msg-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .ai-wrapper { align-self: flex-start; }
        .user-wrapper { align-self: flex-end; }
        .msg { padding: 15px; border-radius: 18px; line-height: 1.6; border: 1px solid #30363d; }
        .user-msg { background: #1f6feb; border: none; }
        .ai-msg { background: #161b22; }

        /* Estilo para Blocos de C√≥digo e Canvas */
        .container-box { background: #0d1117; border: 1px solid #30363d; border-radius: 12px; overflow: hidden; margin-top: 10px; width: 100%; max-width: 500px; }
        .box-header { background: #161b22; padding: 8px; display: flex; gap: 5px; border-bottom: 1px solid #30363d; }
        .tool-btn { font-size: 10px; padding: 5px 10px; border-radius: 4px; background: #21262d; color: #c9d1d9; font-weight: bold; border: 1px solid #30363d; }
        .tool-btn:hover { background: #30363d; }
        
        /* Efeito de Progresso no Canvas */
        .canvas-container { position: relative; width: 250px; height: 250px; margin: 10px auto; background: #000; }
        .canvas-loading { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); color: #58a6ff; font-size: 10px; font-weight: bold; z-index: 10; }
        .progress-bar { width: 60%; height: 4px; background: #30363d; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .progress-fill { width: 0%; height: 100%; background: #58a6ff; transition: width 0.5s; }
        
        pre { padding: 15px; overflow-x: auto; font-size: 12px; color: #79c0ff; max-height: 300px; }
        iframe { width: 100%; height: 300px; border: none; display: none; background: white; }
        .active { display: block !important; }

        .sister-link { font-size: 12px; color: #58a6ff; display: block; padding: 8px; border-radius: 6px; text-decoration: none; }
    </style>
</head>
<body>

    <aside class="sidebar p-4">
        <div class="mb-8">
            <h2 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Hist√≥rico Local</h2>
            <div id="historyList"></div>
        </div>
        <div class="mt-auto border-t border-[#30363d] pt-4">
            <h2 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Irm√£s Z√©nia</h2>
            <a href="https://zenia-projects.netlify.app" target="_blank" class="sister-link">üåê Zenia Projects</a>
            <a href="https://ia-zenia.netlify.app" target="_blank" class="sister-link">üåê IA-Z√©nia Web</a>
            <a href="https://antonia-ia.netlify.app" target="_blank" class="sister-link">üåê Ant√≥nia IA</a>
        </div>
    </aside>

    <main class="main-content">
        <header class="p-4 border-b border-[#30363d] bg-[#0d1117] flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black">IA-Z√âNIA <span class="text-blue-500">2026</span></h1>
                <p class="text-[9px] text-gray-500">NATURAL DO <span class="text-white">LUBANGO</span></p>
            </div>
        </header>

        <div id="chatBox" class="chat-container"></div>

        <div class="p-4 bg-[#0d1117]">
            <div class="max-w-4xl mx-auto flex gap-2 bg-[#161b22] border border-[#30363d] rounded-2xl p-2">
                <textarea id="userInput" placeholder="Desenha um por do sol no Lubango..." class="flex-1 bg-transparent border-none outline-none p-2 text-sm text-white h-12 resize-none" maxlength="12000"></textarea>
                <button onclick="handleSend()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 rounded-xl font-bold">Enviar</button>
            </div>
        </div>
    </main>

    <script>
        const chatBox = document.getElementById('chatBox');
        
        function saveToHistory(q) {
            let hist = JSON.parse(localStorage.getItem('zenia_hist') || '[]');
            if(!hist.includes(q)) hist.push(q);
            localStorage.setItem('zenia_hist', JSON.stringify(hist.slice(-15)));
            renderHistory();
        }

        function renderHistory() {
            const hist = JSON.parse(localStorage.getItem('zenia_hist') || '[]');
            document.getElementById('historyList').innerHTML = hist.map(h => `<div class="history-item" onclick="document.getElementById('userInput').value='${h}'">${h}</div>`).reverse().join('');
        }

        async function handleSend() {
            const val = document.getElementById('userInput').value.trim();
            if(!val) return;
            
            addMsg(val, true);
            saveToHistory(val);
            document.getElementById('userInput').value = '';
            
            const isDraw = val.toLowerCase().includes('desenha') || val.toLowerCase().includes('gere imagem');
            const loading = addMsg("IA-Z√âNIA processando...", false);

            try {
                // Usando modelo 'flux' ou 'mistral' que s√£o melhores para evitar o erro 502 de Cloudflare
                const sys = `Nome: IA-Z√âNIA. Cidade: Lubango. Irm√£s: zenia-projects, ia-zenia, antonia-ia. Se for desenho, responda apenas o c√≥digo JS para canvas ID 'zeniaCanvas' (250x250).`;
                const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(sys + "\n" + val)}?model=mistral&cache=false`);
                const text = await res.text();
                loading.remove();

                if(isDraw && text.includes('```')) {
                    const code = text.match(/```(?:javascript|js)?([\s\S]*?)```/)[1];
                    createCanvasBox(code);
                } else if(text.includes('```html')) {
                    const html = text.match(/```html([\s\S]*?)```/)[1];
                    createCodeBox(html);
                } else {
                    addMsg(text, false);
                }
            } catch(e) { loading.innerText = "Erro na sinapse. Tente novamente."; }
        }

        function createCanvasBox(code) {
            const id = 'c' + Date.now();
            const wrapper = document.createElement('div');
            wrapper.className = 'msg-wrapper ai-wrapper';
            wrapper.innerHTML = `
                <div class="container-box">
                    <div class="box-header">
                        <button class="tool-btn" onclick="copyCode(\`${code.replace(/`/g, '\\`')}\`)">COPIAR</button>
                        <button class="tool-btn text-red-500" onclick="this.closest('.msg-wrapper').remove()">APAGAR</button>
                    </div>
                    <div class="canvas-container">
                        <div id="loader-${id}" class="canvas-loading">
                            <div>DESENHANDO...<div class="progress-bar"><div id="fill-${id}" class="progress-fill"></div></div></div>
                        </div>
                        <canvas id="canvas-${id}" width="250" height="250" style="background:white"></canvas>
                    </div>
                </div>`;
            chatBox.appendChild(wrapper);
            
            // Efeito de Progresso
            let p = 0;
            const interval = setInterval(() => {
                p += 10;
                document.getElementById(`fill-${id}`).style.width = p + '%';
                if(p >= 100) {
                    clearInterval(interval);
                    document.getElementById(`loader-${id}`).remove();
                    // Executa o desenho no canvas espec√≠fico
                    const canvasCode = code.replace(/zeniaCanvas/g, `canvas-${id}`);
                    try { eval(canvasCode); } catch(e) {}
                }
            }, 150);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function createCodeBox(html) {
            const id = 'f' + Date.now();
            const wrapper = document.createElement('div');
            wrapper.className = 'msg-wrapper ai-wrapper';
            wrapper.innerHTML = `
                <div class="container-box">
                    <div class="box-header">
                        <button class="tool-btn" onclick="toggleView('${id}', 'code')">C√ìDIGO</button>
                        <button class="tool-btn" onclick="toggleView('${id}', 'preview')">PREVISUALIZAR</button>
                        <button class="tool-btn" onclick="copyCode(\`${html.replace(/`/g, '\\`')}\`)">COPIAR</button>
                        <button class="tool-btn text-red-500" onclick="this.closest('.msg-wrapper').remove()">APAGAR</button>
                    </div>
                    <pre id="code-${id}" class="active"><code>${html.replace(/</g, '&lt;')}</code></pre>
                    <iframe id="prev-${id}"></iframe>
                </div>`;
            chatBox.appendChild(wrapper);
            document.getElementById(`prev-${id}`).srcdoc = html;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function toggleView(id, mode) {
            const code = document.getElementById(`code-${id}`);
            const prev = document.getElementById(`prev-${id}`);
            if(mode === 'code') { code.classList.add('active'); prev.classList.remove('active'); }
            else { code.classList.remove('active'); prev.classList.add('active'); }
        }

        function copyCode(txt) {
            navigator.clipboard.writeText(txt);
            alert("Copiado!");
        }

        function addMsg(txt, user) {
            const w = document.createElement('div');
            w.className = `msg-wrapper ${user ? 'user-wrapper' : 'ai-wrapper'}`;
            const clean = txt.replace(/Support Pollinations.*/gs, "").replace(/Ant√≠nia/gi, "IA-Z√âNIA");
            w.innerHTML = `<div class="msg ${user ? 'user-msg' : 'ai-msg'}">${clean.replace(/\n/g, '<br>')}</div>`;
            chatBox.appendChild(w);
            chatBox.scrollTop = chatBox.scrollHeight;
            return w;
        }

        renderHistory();
    </script>
</body>
</html>
