<!DOCTYPE html>
<html lang="pt-AO">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>IA-Z√©nia by Z√©nia-Projects</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
/* =========================================
   TEMA BLUE FUTURISTA - VARI√ÅVEIS
========================================= */
:root {
    --accent: #00eaff;        
    --accent-alt: #0066ff;    
    --bg: #020617;            
    --panel: #0b1124;         
    --border: #1e3a8a;        
    --text-light: #e0f2fe;    
    --text-dark: #020617;     
    --neon-glow: 0 0 15px rgba(0, 234, 255, 0.6), 0 0 30px rgba(0, 102, 255, 0.4);
}

.text-blue-500 { color: var(--accent) !important; }
.text-red-500 { color: #ff3366 !important; }
.border-zinc-800 { border-color: var(--border) !important; }
.bg-black\/30 { background-color: rgba(2, 6, 23, 0.5) !important; }

* {
    box-sizing: border-box;
}

body { 
    background: linear-gradient(135deg, var(--bg) 0%, #000000 100%); 
    color: var(--text-light); 
    font-family: 'Plus Jakarta Sans', sans-serif; 
    margin: 0; 
    height: 100vh; 
    display: flex; 
    overflow: hidden; 
}

/* SIDEBAR */
.sidebar { 
    width: 280px; 
    background: linear-gradient(to bottom, var(--panel), var(--bg));
    border-right: 1px solid var(--border); 
    display: flex; 
    flex-direction: column; 
    transition: .3s; 
    box-shadow: 5px 0 15px rgba(0, 102, 255, 0.1);
    z-index: 100;
}

@media(max-width:768px){ 
    .sidebar {
        position: fixed;
        left: -100%;
        top: 0;
        height: 100%; 
        width: 85%; 
        max-width: 300px; 
        box-shadow: 10px 0 50px rgba(0,0,0,0.8);
        transition: left 0.3s ease;
    }
    .sidebar.active {
        left: 0;
    }
    .sidebar-overlay {
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%;
        background: rgba(0,0,0,0.7); 
        backdrop-filter: blur(3px);
        z-index: 90; 
        display: none; 
        opacity: 0; 
        transition: opacity .3s;
    }
    .sidebar-overlay.active { 
        display: block; 
        opacity: 1; 
    }
}

.main-content { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    overflow: hidden; 
    width: 100%; 
    position: relative; 
}

/* CHAT AREA */
.chat-container { 
    flex: 1; 
    overflow-y: auto; 
    padding: 20px; 
    display: flex; 
    flex-direction: column; 
    gap: 20px; 
    scroll-behavior: smooth; 
    background: radial-gradient(circle at center, #0b1124 0%, var(--bg) 70%);
}

.hist-item { 
    padding: 12px; 
    border-radius: 12px; 
    background: rgba(11, 17, 36, 0.6); 
    margin-bottom: 10px; 
    cursor: pointer; 
    border: 1px solid var(--border); 
    font-size: 13px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    transition: all .3s ease; 
    word-break: break-word;
}

.hist-item:hover { 
    border-color: var(--accent); 
    background: linear-gradient(to right, rgba(0, 234, 255, 0.1), rgba(0, 102, 255, 0.2)); 
}

.hist-item.active { 
    border-color: var(--accent-alt); 
    background: linear-gradient(to right, rgba(0, 102, 255, 0.3), rgba(11, 17, 36, 0.8)); 
    box-shadow: var(--neon-glow); 
}

.btn-new { 
    background: linear-gradient(135deg, var(--accent), var(--accent-alt)); 
    color: #fff; 
    padding: 12px; 
    border-radius: 12px; 
    font-weight: 800; 
    text-align: center; 
    margin-bottom: 20px; 
    cursor: pointer; 
    transition: .3s; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.3); 
    box-shadow: 0 4px 15px rgba(0, 102, 255, 0.3);
    border: none;
}

.btn-new:hover { 
    transform: translateY(-2px) scale(1.02); 
    box-shadow: var(--neon-glow); 
}

.btn-new:active {
    transform: translateY(0) scale(1);
}

.btn-close-sidebar {
    display: none; 
    margin-bottom: 15px; 
    padding: 10px; 
    background: rgba(255, 51, 102, 0.2); 
    border: 1px solid #ff3366; 
    color: #ff3366; 
    font-weight: bold; 
    border-radius: 8px; 
    text-align: center; 
    cursor: pointer;
}

@media(max-width:768px){ 
    .btn-close-sidebar{
        display: block;
    }
}

.msg-wrapper { 
    display: flex; 
    flex-direction: column; 
    max-width: 90%; 
    gap: 5px; 
    position: relative; 
    animation: fadeIn .3s ease; 
}

.msg-wrapper.user-wrapper {
    align-self: flex-end;
}

.msg-wrapper.ai-wrapper {
    align-self: flex-start;
}

.msg { 
    padding: 15px; 
    border-radius: 18px; 
    line-height: 1.6; 
    font-size: 14px; 
    word-wrap: break-word; 
    transition: .3s; 
    backdrop-filter: blur(5px); 
    white-space: pre-wrap;
}

.ai-msg { 
    border: 1px solid var(--border); 
    border-left: 4px solid var(--accent); 
    background: linear-gradient(135deg, var(--panel), rgba(2, 6, 23, 0.8)); 
    color: var(--text-light); 
}

.user-msg { 
    background: linear-gradient(135deg, var(--accent-alt), var(--accent)); 
    color: #fff; 
    border: none; 
    box-shadow: 0 5px 15px rgba(0, 102, 255, 0.4); 
}

/* CONTROLES DE MENSAGEM */
.msg-controls { 
    display: flex; 
    gap: 10px; 
    margin-top: 8px; 
    padding: 0 10px; 
    font-size: 12px; 
    opacity: 0; 
    transition: opacity .3s; 
}

.msg-wrapper:hover .msg-controls { 
    opacity: 1; 
}

.ctrl-btn { 
    cursor: pointer; 
    transition: .2s; 
    color: #64748b; 
    padding: 4px 8px; 
    border-radius: 6px;
    background: rgba(0, 234, 255, 0.1); 
    border: 1px solid var(--border);
    font-size: 14px;
    line-height: 1;
}

.ctrl-btn:hover { 
    color: var(--accent); 
    background: rgba(0, 234, 255, 0.2); 
}

.ctrl-btn:active {
    transform: scale(0.95);
}

/* CODE BLOCKS */
.code-container { 
    border-radius: 12px; 
    overflow: hidden; 
    margin: 15px 0; 
    border: 1px solid var(--border); 
    background: #000; 
    width: 100%; 
    box-shadow: 0 0 20px rgba(0, 102, 255, 0.1); 
}

.code-header { 
    background: var(--panel); 
    padding: 8px 15px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    border-bottom: 1px solid var(--border); 
}

.btn-action { 
    font-size: 10px; 
    font-weight: bold; 
    padding: 4px 8px; 
    border-radius: 6px; 
    background: rgba(0, 102, 255, 0.2); 
    color: var(--accent); 
    border: 1px solid var(--border); 
    cursor: pointer; 
    transition: .2s; 
}

.btn-action:hover {
    background: rgba(0, 102, 255, 0.3);
}

/* INPUT AREA */
.footer-input { 
    background: linear-gradient(to top, var(--bg) 0%, rgba(11, 17, 36, 0.95) 100%); 
    padding: env(safe-area-inset-bottom, 10px) 10px 10px 10px; 
    border-top: 1px solid var(--border); 
}

.footer-input-inner { 
    max-width: 860px; 
    margin: 0 auto; 
    background: rgba(11, 17, 36, 0.5); 
    border-radius: 20px; 
    padding: 8px; 
    border: 1px solid var(--border); 
    display: flex; 
    flex-direction: column; 
    gap: 8px; 
    backdrop-filter: blur(10px); 
}

.voice-bar { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    padding: 6px 10px; 
    background: rgba(2, 6, 23, 0.6); 
    border-radius: 12px; 
    border: 1px solid var(--border); 
    width: 100%; 
    box-sizing: border-box; 
}

.voice-bar select { 
    background: transparent; 
    color: var(--accent); 
    border: none; 
    font-size: 12px; 
    outline: none; 
    cursor: pointer; 
    flex: 1; 
}

.voice-bar option { 
    background: var(--panel); 
    color: var(--text-light);
}

.input-row { 
    display: flex; 
    gap: 8px; 
    width: 100%; 
    align-items: flex-end;
}

textarea { 
    flex: 1; 
    min-width: 0; 
    background: transparent; 
    border: none; 
    outline: none; 
    color: var(--text-light); 
    font-size: 15px; 
    padding: 10px; 
    max-height: 120px; 
    resize: none; 
    font-family: inherit; 
}

textarea::placeholder {
    color: rgba(224, 242, 254, 0.5);
}

button.action-btn { 
    width: 40px; 
    height: 40px; 
    border-radius: 12px; 
    font-weight: bold; 
    border: none; 
    cursor: pointer; 
    font-size: 18px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    flex-shrink: 0; 
    transition: .3s; 
}

button.action-btn:active {
    transform: scale(0.95);
}

button.send-btn { 
    background: linear-gradient(135deg, var(--accent), var(--accent-alt)); 
    color: #fff; 
    box-shadow: 0 0 10px rgba(0, 234, 255, 0.3); 
}

button.upload-btn { 
    background: rgba(255, 255, 255, 0.1); 
    color: var(--accent); 
    border: 1px solid var(--border); 
}

button.upload-btn:hover {
    background: rgba(255, 255, 255, 0.15);
}

/* IMAGEM */
.img-preview-msg { 
    max-width: 200px; 
    border-radius: 12px; 
    border: 1px solid var(--border); 
    margin-top: 5px;
    display: block;
}

.vision-status { 
    font-size: 11px; 
    color: var(--accent); 
    margin-top: 5px; 
    font-style: italic; 
    display: flex; 
    align-items: center; 
    gap: 5px; 
}

.vision-status.loading::after { 
    content: ''; 
    width: 10px; 
    height: 10px; 
    border: 2px solid var(--accent); 
    border-top-color: transparent; 
    border-radius: 50%; 
    animation: spin 1s linear infinite; 
}

/* AUDIO PLAYER */
.audio-player { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    background: linear-gradient(135deg, var(--panel), rgba(30, 58, 138, 0.3)); 
    border: 1px solid var(--border); 
    border-radius: 14px; 
    padding: 12px 14px; 
    margin: 8px 0; 
    width: 100%; 
    box-sizing: border-box; 
}

.play-btn { 
    width: 35px; 
    height: 35px; 
    border-radius: 50%; 
    background: linear-gradient(135deg, var(--accent), var(--accent-alt)); 
    border: none; 
    cursor: pointer; 
    color: #fff; 
    flex-shrink: 0; 
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.play-btn:hover {
    opacity: 0.9;
}

.progress-wrap { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    gap: 4px; 
}

.audio-progress-bg { 
    height: 4px; 
    background: rgba(0,0,0,0.3); 
    position: relative; 
    cursor: pointer; 
    border-radius: 2px;
}

.audio-progress-fill { 
    height: 100%; 
    width: 0%; 
    background: var(--accent); 
    border-radius: 2px;
}

.audio-time { 
    font-size: 10px; 
    color: #aaa; 
    text-align: right; 
}

/* ANIMATIONS */
@keyframes spin { 
    to { transform: rotate(360deg); } 
}

@keyframes fadeIn {
    0% { opacity: 0; transform: translateY(10px); }
    100% { opacity: 1; transform: translateY(0); }
}

#titleRotator {
    transition: opacity 0.3s ease-in-out;
}

/* MODAL DE EDI√á√ÉO */
.modal-overlay {
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background: rgba(0, 0, 0, 0.8); 
    z-index: 1000; 
    align-items: center; 
    justify-content: center;
}

.modal-overlay.active { 
    display: flex; 
}

.modal-content {
    background: var(--panel); 
    border: 1px solid var(--border); 
    border-radius: 16px;
    padding: 20px; 
    max-width: 600px; 
    width: 90%; 
    box-shadow: var(--neon-glow);
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header { 
    font-size: 16px; 
    font-weight: bold; 
    color: var(--accent); 
    margin-bottom: 15px; 
}

.modal-textarea {
    width: 100%; 
    background: rgba(0, 0, 0, 0.3); 
    color: var(--text-light);
    border: 1px solid var(--border); 
    border-radius: 8px; 
    padding: 12px;
    font-family: inherit; 
    font-size: 14px; 
    min-height: 150px; 
    resize: vertical;
}

.modal-textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 10px rgba(0, 234, 255, 0.2);
}

.modal-buttons { 
    display: flex; 
    gap: 10px; 
    justify-content: flex-end; 
    margin-top: 15px; 
}

.modal-btn { 
    padding: 8px 16px; 
    border-radius: 8px; 
    border: none; 
    cursor: pointer; 
    font-weight: bold; 
    transition: .2s; 
}

.modal-btn-save { 
    background: linear-gradient(135deg, var(--accent), var(--accent-alt)); 
    color: #fff; 
}

.modal-btn-save:hover {
    opacity: 0.9;
}

.modal-btn-cancel { 
    background: rgba(255, 51, 102, 0.2); 
    color: #ff3366; 
    border: 1px solid #ff3366; 
}

.modal-btn-cancel:hover {
    background: rgba(255, 51, 102, 0.3);
}

/* RESPONSIVE */
@media(max-width:768px){ 
    .chat-container { 
        padding: 15px; 
    } 
    .footer-input-inner { 
        gap: 6px; 
    } 
    .voice-bar { 
        order: -1; 
    }
    .modal-content { 
        max-width: 95%;
        max-height: 90vh;
    }
    .msg-wrapper {
        max-width: 100%;
    }
}

/* SCROLLBAR STYLING */
.chat-container::-webkit-scrollbar,
#historyList::-webkit-scrollbar {
    width: 6px;
}

.chat-container::-webkit-scrollbar-track,
#historyList::-webkit-scrollbar-track {
    background: transparent;
}

.chat-container::-webkit-scrollbar-thumb,
#historyList::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
}

.chat-container::-webkit-scrollbar-thumb:hover,
#historyList::-webkit-scrollbar-thumb:hover {
    background: var(--accent);
}
</style>
</head>
<body>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="window.toggleSidebar()"></div>

<aside class="sidebar p-4" id="sidebar">
    <button class="btn-close-sidebar" onclick="window.toggleSidebar()">‚úï FECHAR</button>
    <div class="btn-new" onclick="window.startNewChat()">+ NOVA CONVERSA</div>
    <h2 class="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">Hist√≥rico Local</h2>
    <div id="historyList" class="flex-1 overflow-y-auto pr-1"></div>
    <div class="mt-auto pt-4 border-t border-slate-800 space-y-2 text-xs">
        <h2 class="text-[9px] font-bold text-slate-500 uppercase mb-2">Sobre</h2>
        <p class="text-slate-400">Desenvolvido por<br><strong>@inacio.u.daniel</strong></p>
        <p class="text-slate-400">Z√©nia-Projects ¬© 2025</p>
        <a href="https://zenia-projects.netlify.app" target="_blank" class="block text-blue-400 hover:text-blue-300">üåê Zenia Projects</a>
    </div>
</aside>

<main class="main-content">
    <header class="p-4 border-b border-slate-800 flex justify-between items-center bg-black/30 backdrop-blur-md z-10">
        <div class="flex items-center gap-4">
            <button onclick="window.toggleSidebar()" class="md:hidden text-white font-bold text-lg">‚ò∞</button>
            <h1 class="text-xl font-black italic tracking-wider">
                IA-Z√âNIA <span class="text-blue-500 text-xs font-normal" id="titleRotator" style="text-shadow: 0 0 10px rgba(0,234,255,0.5);">VISION</span>
            </h1>
        </div>
        <button onclick="window.clearAllData()" class="text-[10px] text-red-500 font-bold hover:underline">APAGAR TUDO</button>
    </header>

    <div id="chatBox" class="chat-container"></div>

    <div class="footer-input z-20">
        <div class="footer-input-inner">
            <div class="voice-bar">
                <label>üé§ Voz:</label>
                <select id="voiceSelect">
                    <option value="nova">Nova</option>
                    <option value="alloy">Alloy</option>
                    <option value="echo">Echo</option>
                    <option value="shimmer">Shimmer</option>
                    <option value="native">üåê Nativa</option>
                </select>
            </div>
            
            <div class="input-row">
                <input type="file" id="imgUpload" accept="image/*" hidden>
                <button class="action-btn upload-btn" onclick="document.getElementById('imgUpload').click()" title="Carregar Imagem">üëÅÔ∏è</button>
                <textarea id="userInput" placeholder="Mostra-me uma foto ou escreve..." oninput="window.autoGrow(this)"></textarea>
                <button class="action-btn send-btn" onclick="window.handleSend()">üöÄ</button>
            </div>
        </div>
    </div>
</main>

<!-- Modal de Edi√ß√£o -->
<div class="modal-overlay" id="editModal">
    <div class="modal-content">
        <div class="modal-header">Editar Mensagem</div>
        <textarea class="modal-textarea" id="editTextarea"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="window.closeEditModal()">Cancelar</button>
            <button class="modal-btn modal-btn-save" onclick="window.saveEditedMessage()">Guardar</button>
        </div>
    </div>
</div>

<div style="position:fixed;top:10px;right:15px;padding:8px 15px;background:rgba(2, 6, 23, 0.8);color:var(--accent);border:1px solid var(--accent);border-radius:20px;font-size:12px;font-weight:bold;backdrop-filter:blur(10px);z-index:9999;">
    üîµ <span id="viewsNumber">0</span> VISITANTES
</div>

<script type="module">
/* ============================================================
   IMPORTS & SETUP (Transformers.js)
============================================================ */
import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.16.0';
env.allowLocalModels = false;
env.useBrowserCache = true;

let visionPipeline = null;

/* ============================================================
   VARI√ÅVEIS GLOBAIS
============================================================ */
const chatBox     = document.getElementById('chatBox');
const historyList = document.getElementById('historyList');
const userInput   = document.getElementById('userInput');
const voiceSelect = document.getElementById('voiceSelect');
const imgUpload   = document.getElementById('imgUpload');
const editModal   = document.getElementById('editModal');
const editTextarea = document.getElementById('editTextarea');

let sessions        = JSON.parse(localStorage.getItem('zenia_sessions') || '[]');
let currentSessionId = null;
let editingMessageId = null;

const titleRotations = ['VISION', 'ALL.ANGOLA', 'LUBANGO', 'DE CABINDA AO CUNENE', 'ALL.WORLD', 'ALL.AFRICA', '@INACIO.U.DANIEL'];
let titleIndex = 0;

/* ============================================================
   ROTA√á√ÉO DE T√çTULO
============================================================ */
function rotateTitleSubtitle(){
    const titleEl = document.getElementById('titleRotator');
    if(!titleEl) return;
    
    titleEl.style.opacity = '0';
    setTimeout(() => {
        titleIndex = (titleIndex + 1) % titleRotations.length;
        titleEl.textContent = titleRotations[titleIndex];
        titleEl.style.opacity = '1';
    }, 300);
}
setInterval(rotateTitleSubtitle, 7000);

/* ============================================================
   FUN√á√ïES GLOBAIS PARA HTML
============================================================ */
window.toggleSidebar = function(){ 
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("sidebarOverlay");
    if(sidebar) sidebar.classList.toggle("active");
    if(overlay) overlay.classList.toggle("active");
};

window.autoGrow = function(el){ 
    el.style.height = "auto"; 
    el.style.height = Math.min(el.scrollHeight, 120) + "px"; 
};

window.clearAllData = function(){ 
    if(confirm("Tem a certeza que quer apagar tudo?")){ 
        try {
            localStorage.clear(); 
            location.reload(); 
        } catch(e) {
            console.error("Erro ao limpar dados:", e);
        }
    } 
};

window.startNewChat = startNewChat;
window.handleSend = handleSend;

window.deleteMessage = function(msgId) {
    const msgEl = document.getElementById(msgId);
    if(msgEl && msgEl.parentElement) {
        msgEl.style.opacity = '0';
        msgEl.style.transform = 'scale(0.95)';
        setTimeout(() => {
            if(msgEl.parentElement) {
                msgEl.parentElement.remove();
            }
        }, 300);
    }
};

window.editMessage = function(msgId) {
    const msgEl = document.getElementById(msgId);
    if(msgEl) {
        const msgText = msgEl.textContent || '';
        editTextarea.value = msgText;
        editingMessageId = msgId;
        editModal.classList.add('active');
        editTextarea.focus();
        editTextarea.select();
    }
};

window.closeEditModal = function() {
    editModal.classList.remove('active');
    editingMessageId = null;
};

window.saveEditedMessage = function() {
    if(editingMessageId) {
        const msgEl = document.getElementById(editingMessageId);
        if(msgEl) {
            msgEl.textContent = editTextarea.value;
        }
    }
    window.closeEditModal();
};

window.speakMessage = function(msgId) {
    const msgEl = document.getElementById(msgId);
    if(msgEl) {
        const text = msgEl.textContent || '';
        const voice = voiceSelect.value;
        
        if(voice === 'native') {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-PT';
            utterance.rate = 1.1;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        } else {
            console.log('TTS para voz:', voice);
        }
    }
};

/* ============================================================
   CONTADOR DE VISITANTES
============================================================ */
(function(){
    try {
        let v = localStorage.getItem("zenia_global_views");
        v = v ? parseInt(v) + 1 : 1;
        localStorage.setItem("zenia_global_views", v);
        const viewsEl = document.getElementById("viewsNumber");
        if(viewsEl) viewsEl.textContent = v;
    } catch(e) {
        console.error("Erro no contador:", e);
    }
})();

/* ============================================================
   SYSTEM PROMPT
============================================================ */
const ZENIA_SYSTEM = `Voc√™ √© IA-Z√âNIA, assistente inteligente criada por @inacio.u.daniel do Lubango.
Caracter√≠sticas:
- Responda sempre em Portugu√™s de Angola
- Seja natural, amig√°vel e criativa
- Suporte an√°lise de imagens quando fornecidas
- Possa gerar imagens, m√∫sicas e √°udio quando solicitado
- Mantenha coer√™ncia contextual em conversas
- Seja conciso mas informativo`;

/* ============================================================
   FUN√á√ïES CORE
============================================================ */
function init(){
    renderHistory();
    if(sessions.length > 0) {
        loadSession(sessions[sessions.length - 1].id);
    } else {
        startNewChat();
    }
}

function startNewChat(){
    currentSessionId = Date.now();
    chatBox.innerHTML = '';
    const newSession = {
        id: currentSessionId,
        title: 'Nova Conversa',
        messages: []
    };
    sessions.push(newSession);
    try {
        localStorage.setItem('zenia_sessions', JSON.stringify(sessions));
    } catch(e) {
        console.error("Erro ao guardar sess√£o:", e);
    }
    addMessage("Ol√°! Sou a IA-Z√©nia. Posso ajud√°-lo com respostas, an√°lise de imagens, gera√ß√£o de arte e muito mais. Como posso ser √∫til? üöÄ", false);
    renderHistory();
}

function loadSession(sessionId){
    currentSessionId = sessionId;
    const session = sessions.find(s => s.id === sessionId);
    chatBox.innerHTML = '';
    if(session) {
        session.messages.forEach(m => {
            addMessage(m.text, m.role === 'user');
        });
    }
    renderHistory();
}

async function handleSend(textOverride, isSystemPrompt){
    const query = (textOverride || userInput.value).trim();
    if(!query) return;

    if(!isSystemPrompt) {
        addMessage(query, true);
        userInput.value = '';
        userInput.style.height = 'auto';
    }

    // Detectar comandos especiais
    if(isImageRequest(query)) { 
        handleImageGen(query);
        return;
    }
    if(isMusicRequest(query)) {
        handleMusic(query);
        return;
    }
    if(isAudioRequest(query)) {
        handleTTS(query);
        return;
    }

    // Resposta normal via API
    const loadMsg = addMessage("Z√©nia est√° processando...", false);
    
    try {
        const context = buildContext(query);
      const encodedContext = encodeURIComponent(context);
      const res = await fetch(`https://text.pollinations.ai/?model=mistral&prompt=${encodedContext}`);

        if(!res.ok) {
            throw new Error(`API Error: ${res.status}`);
        }
        
        const text = await res.text();
        if(loadMsg && loadMsg.parentElement) {
            loadMsg.parentElement.remove();
        }
        processResponse(text, query);
    } catch(e) {
        console.error("Erro:", e);
        if(loadMsg && loadMsg.parentElement) {
            const msgDiv = loadMsg.querySelector('.msg');
            if(msgDiv) {
                msgDiv.textContent = '‚ö†Ô∏è Erro na conex√£o. Tente novamente mais tarde.';
            }
        }
    }
}

/* ============================================================
   HANDLERS ESPECIAIS
============================================================ */
async function handleMusic(query){
    const loadMsg = addMessage("üéµ A compor m√∫sica...", false);
    const prompt = "Escreve uma letra de m√∫sica criativa sobre: " + query;
    
    try {
        const res = await fetch('https://text.pollinations.ai/' + encodeURIComponent(prompt));
        if(!res.ok) throw new Error('Erro ao buscar m√∫sica');
        const lyrics = await res.text();
        if(loadMsg && loadMsg.parentElement) {
            loadMsg.parentElement.remove();
        }
        processResponse("üéµ **M√∫sica:**\n\n" + lyrics, query);
    } catch(e) {
        console.error("Erro na m√∫sica:", e);
        if(loadMsg && loadMsg.parentElement) {
            const msgDiv = loadMsg.querySelector('.msg');
            if(msgDiv) msgDiv.textContent = "‚ùå Erro ao criar m√∫sica";
        }
    }
}

function handleImageGen(query){
    const loadMsg = addMessage("üé® A gerar imagem...", false);
    const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(query)}?width=1024&height=1024&nologo=true&model=flux`;
    if(loadMsg && loadMsg.parentElement) {
        loadMsg.parentElement.remove();
    }
    processResponse(`![Imagem Gerada](${url})`, query);
}

function handleTTS(query){
    const txt = query.replace(/^(fala|diz|l√™)\s*[:\-]?\s*/i, '');
    generateAudio(txt, query);
}

/* ============================================================
   PROCESSAMENTO DE RESPOSTA
============================================================ */
function processResponse(text, query){
    const wrapper = document.createElement('div');
    wrapper.className = 'msg-wrapper ai-wrapper';
    
    // ‚úÖ CORRIGIDO: Detectar imagens em markdown corretamente
    const imgMatch = text.match(/!\[.*?\]\((.*?)\)/);
    if(imgMatch) {
        const img = document.createElement('img');
        img.src = imgMatch[1];
        img.className = 'img-preview-msg';
        img.onerror = function() {
            this.style.display = 'none';
        };
        wrapper.appendChild(img);
        text = text.replace(imgMatch[0], '').trim();
    }
    
    if(text.length > 0) {
        const msgId = 'ai-' + Date.now();
        const msgDiv = document.createElement('div');
        msgDiv.id = msgId;
        msgDiv.className = 'msg ai-msg';
        msgDiv.textContent = text;  // ‚úÖ CORRIGIDO: Usar textContent em vez de innerText
        wrapper.appendChild(msgDiv);
        
        // ‚úÖ CORRIGIDO: Adicionar controles apenas ap√≥s criar a mensagem
        const controls = document.createElement('div');
        controls.className = 'msg-controls';
        controls.innerHTML = `
            <span class="ctrl-btn" onclick="window.deleteMessage('${msgId}')" title="Remover">üóëÔ∏è</span>
            <span class="ctrl-btn" onclick="window.editMessage('${msgId}')" title="Editar">‚úèÔ∏è</span>
            <span class="ctrl-btn" onclick="window.speakMessage('${msgId}')" title="Ler em voz alta">üîä</span>
        `;
        wrapper.appendChild(controls);
    }
    
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
    
    // Guardar na sess√£o
    saveToSession(query, text);
}

function addMessage(text, isUser){
    const wrapper = document.createElement('div');
    wrapper.className = 'msg-wrapper ' + (isUser ? 'user-wrapper' : 'ai-wrapper');
    
    const msgId = (isUser ? 'user' : 'ai') + '-' + Date.now();
    const msgDiv = document.createElement('div');
    msgDiv.id = msgId;
    msgDiv.className = 'msg ' + (isUser ? 'user-msg' : 'ai-msg');
    msgDiv.textContent = text;  // ‚úÖ CORRIGIDO: Usar textContent
    wrapper.appendChild(msgDiv);
    
    // Adicionar controles para mensagens do usu√°rio
    if(isUser) {
        const controls = document.createElement('div');
        controls.className = 'msg-controls';
        controls.innerHTML = `
            <span class="ctrl-btn" onclick="window.deleteMessage('${msgId}')" title="Remover">üóëÔ∏è</span>
            <span class="ctrl-btn" onclick="window.editMessage('${msgId}')" title="Editar">‚úèÔ∏è</span>
        `;
        wrapper.appendChild(controls);
    }
    
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
    return wrapper;
}

/* ============================================================
   HELPERS
============================================================ */
function buildContext(q){
    const session = sessions.find(x => x.id === currentSessionId);
    let hist = "";
    if(session) {
        hist = session.messages
            .slice(-6)
            .map(m => (m.role === 'user' ? 'Usu√°rio' : 'Z√©nia') + ': ' + m.text)
            .join('\n');
    }
    return `${ZENIA_SYSTEM}\n\nHist√≥rico:\n${hist}\n\nUsu√°rio: ${q}`;
}

function saveToSession(userText, aiText){
    const session = sessions.find(x => x.id === currentSessionId);
    if(session) {
        session.messages.push({role: 'user', text: userText});
        session.messages.push({role: 'ai', text: aiText});
        try {
            localStorage.setItem('zenia_sessions', JSON.stringify(sessions));
        } catch(e) {
            console.error("Erro ao guardar sess√£o:", e);
        }
        renderHistory();
    }
}

function renderHistory(){
    historyList.innerHTML = '';
    sessions.slice().reverse().forEach(s => {
        const item = document.createElement('div');
        item.className = 'hist-item' + (s.id === currentSessionId ? ' active' : '');
        const title = s.messages.length > 0 ? s.messages[0].text.substring(0, 30) : 'Conversa';
        item.textContent = title + '...';
        item.onclick = (e) => {
            e.stopPropagation();
            loadSession(s.id);
        };
        historyList.appendChild(item);
    });
}

function isImageRequest(q){ 
    return /desenha|gera\s*(uma\s*)?(imagem|arte|quadro|pintura)/i.test(q); 
}

function isMusicRequest(q){ 
    return /cria\s*m√∫sica|letra|canta|comp√µe/i.test(q); 
}

function isAudioRequest(q){ 
    return /^(fala|diz|l√™)\s*[:\-]?/i.test(q); 
}

async function generateAudio(text, originalQuery){
    const voice = voiceSelect.value;
    
    if(voice === 'native') {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'pt-PT';
        utterance.rate = 1.1;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
    } else {
        console.log('Gerando √°udio com voz:', voice);
        // TODO: Implementar integra√ß√£o com API TTS
    }
}

/* ============================================================
   EVENT LISTENERS
============================================================ */
imgUpload.addEventListener('change', async function(e){
    if(e.target.files && e.target.files[0]){
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = async function(event){
            const imageUrl = event.target.result;
            
            // ‚úÖ CORRIGIDO: Criar imagem como elemento, n√£o como string HTML
            const wrapper = document.createElement('div');
            wrapper.className = 'msg-wrapper user-wrapper';
            
            const textDiv = document.createElement('div');
            textDiv.className = 'msg user-msg';
            textDiv.textContent = 'üìé Imagem carregada';
            wrapper.appendChild(textDiv);
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.className = 'img-preview-msg';
            wrapper.appendChild(img);
            
            chatBox.appendChild(wrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            try {
                const statusMsg = addMessage("Analisando imagem com IA...", false);
                
                if(!visionPipeline){
                    statusMsg.querySelector('.msg').textContent = "Carregando modelo de vis√£o...";
                    visionPipeline = await pipeline('image-to-text', 'Xenova/vit-gpt2-image-captioning');
                }
                
                const output = await visionPipeline(imageUrl);
                const description = output[0].generated_text;
                
                if(statusMsg && statusMsg.parentElement) {
                    statusMsg.parentElement.remove();
                }
                processResponse(`An√°lise da imagem: "${description}"\n\nVejo uma ${description}.`, 'Analisar imagem');
                
            } catch (err) {
                console.error("Erro na an√°lise:", err);
                if(statusMsg && statusMsg.parentElement) {
                    const msgDiv = statusMsg.querySelector('.msg');
                    if(msgDiv) msgDiv.textContent = "‚ùå Erro ao analisar imagem (navegador incompat√≠vel ou modelo indispon√≠vel)";
                }
            }
        };
        
        reader.onerror = function(){
            addMessage("‚ùå Erro ao ler arquivo", false);
        };
        
        reader.readAsDataURL(file);
        imgUpload.value = '';
    }
});

// Fechar modal ao clicar fora
editModal.addEventListener('click', function(e){
    if(e.target === editModal) {
        window.closeEditModal();
    }
});

// Fechar modal com Esc
document.addEventListener('keydown', function(e){
    if(e.key === 'Escape' && editModal.classList.contains('active')) {
        window.closeEditModal();
    }
});

// Enter para enviar mensagem
userInput.addEventListener('keydown', function(e){
    if(e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        window.handleSend();
    }
});

// Iniciar aplica√ß√£o
init();

</script>
</body>
</html>
